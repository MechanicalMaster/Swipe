This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.github/
  workflows/
    build-apk.yml
android/
  app/
    src/
      androidTest/
        java/
          com/
            getcapacitor/
              myapp/
                ExampleInstrumentedTest.java
      main/
        java/
          com/
            swipe/
              app/
                MainActivity.java
        res/
          drawable/
            ic_launcher_background.xml
            splash.png
          drawable-land-hdpi/
            splash.png
          drawable-land-ldpi/
            splash.png
          drawable-land-mdpi/
            splash.png
          drawable-land-night-hdpi/
            splash.png
          drawable-land-night-ldpi/
            splash.png
          drawable-land-night-mdpi/
            splash.png
          drawable-land-night-xhdpi/
            splash.png
          drawable-land-night-xxhdpi/
            splash.png
          drawable-land-night-xxxhdpi/
            splash.png
          drawable-land-xhdpi/
            splash.png
          drawable-land-xxhdpi/
            splash.png
          drawable-land-xxxhdpi/
            splash.png
          drawable-night/
            splash.png
          drawable-port-hdpi/
            splash.png
          drawable-port-ldpi/
            splash.png
          drawable-port-mdpi/
            splash.png
          drawable-port-night-hdpi/
            splash.png
          drawable-port-night-ldpi/
            splash.png
          drawable-port-night-mdpi/
            splash.png
          drawable-port-night-xhdpi/
            splash.png
          drawable-port-night-xxhdpi/
            splash.png
          drawable-port-night-xxxhdpi/
            splash.png
          drawable-port-xhdpi/
            splash.png
          drawable-port-xxhdpi/
            splash.png
          drawable-port-xxxhdpi/
            splash.png
          drawable-v24/
            ic_launcher_foreground.xml
          layout/
            activity_main.xml
          mipmap-anydpi-v26/
            ic_launcher_round.xml
            ic_launcher.xml
          mipmap-hdpi/
            ic_launcher_background.png
            ic_launcher_foreground.png
            ic_launcher_round.png
            ic_launcher.png
          mipmap-ldpi/
            ic_launcher_background.png
            ic_launcher_foreground.png
            ic_launcher_round.png
            ic_launcher.png
          mipmap-mdpi/
            ic_launcher_background.png
            ic_launcher_foreground.png
            ic_launcher_round.png
            ic_launcher.png
          mipmap-xhdpi/
            ic_launcher_background.png
            ic_launcher_foreground.png
            ic_launcher_round.png
            ic_launcher.png
          mipmap-xxhdpi/
            ic_launcher_background.png
            ic_launcher_foreground.png
            ic_launcher_round.png
            ic_launcher.png
          mipmap-xxxhdpi/
            ic_launcher_background.png
            ic_launcher_foreground.png
            ic_launcher_round.png
            ic_launcher.png
          values/
            ic_launcher_background.xml
            strings.xml
            styles.xml
          xml/
            file_paths.xml
        AndroidManifest.xml
      test/
        java/
          com/
            getcapacitor/
              myapp/
                ExampleUnitTest.java
    .gitignore
    build.gradle
    capacitor.build.gradle
    proguard-rules.pro
  gradle/
    wrapper/
      gradle-wrapper.jar
      gradle-wrapper.properties
  .gitignore
  build.gradle
  capacitor.settings.gradle
  gradle.properties
  gradlew
  gradlew.bat
  settings.gradle
  variables.gradle
cypress/
  e2e/
    sanity.cy.js
  support/
    e2e.js
docs/
  ICON_DESIGN_GUIDE.md
public/
  images/
    templates/
      detailed_front.png
      minimal_front.png
      weight_front.png
  templates/
    classic-preview.svg
    classic.svg
    elegant.svg
    modern-preview.svg
    modern.svg
  bg-pattern.png
  file.svg
  globe.svg
  hero-dashboard.png
  landing-bg.jpg
  manifest.json
  next.svg
  vercel.svg
  window.svg
resources/
  icon.png
  splash.png
src/
  api/
    backendClient.js
  app/
    admin/
      create-shop/
        page.js
        page.module.css
      create-user/
        page.js
        page.module.css
    attendance/
      history/
        page.js
      page.js
      page.module.css
    bills/
      purchase/
        create/
          page.js
      page.js
      page.module.css
    coming-soon/
      page.js
    invoice/
      create/
        select-customer/
          page.js
        select-product/
          page.js
        page.js
      edit/
        page.js
      view/
        page.js
    more/
      bills/
        expenses/
          create/
            page.js
            page.module.css
          page.js
          page.module.css
      company/
        page.js
        page.module.css
      diagnostics/
        page.js
        page.module.css
      label-templates/
        page.js
        page.module.css
      masters/
        products/
          page.js
          page.module.css
        page.js
      profile/
        page.js
        page.module.css
      server-config/
        page.js
      templates/
        lending/
          page.js
        page.js
      page.js
      page.module.css
    parties/
      customer/
        add/
          page.js
        edit/
          page.js
          page.module.css
        view/
          page.js
      payment/
        create/
          page.js
          page.module.css
      vendor/
        add/
          page.js
        edit/
          page.js
          page.module.css
        view/
          page.js
      form.module.css
      page.js
      page.module.css
    products/
      add/
        page.js
      bulk-upload/
        page.js
        page.module.css
      components/
        __tests__/
          ProductCard.test.js
        FilterBar.js
        FilterBar.module.css
        Pagination.js
        Pagination.module.css
        ProductCard.js
        ProductCard.module.css
      edit/
        page.js
      page.js
      page.module.css
    purchase/
      create/
        select-vendor/
          page.js
        page.js
    reports/
      page.js
      page.module.css
    favicon.ico
    globals.css
    layout.js
    page.js
    page.module.css
    template.js
  components/
    __tests__/
      BottomNav.test.js
    AppBootstrap/
      AppBootstrap.js
      AppBootstrap.module.css
    Auth/
      AuthWrapper.js
      AuthWrapper.module.css
      LoginFlow.js
      LoginFlow.module.css
    Expenses/
      AddCategoryModal.js
      CategoryModal.js
    icons/
      index.js
    InvoiceTemplates/
      index.js
      Template1.js
      Template2.js
      Template3.js
    LandingPage/
      LandingPage.js
      LandingPage.module.css
    ServerConfig/
      ServerSetup.js
      ServerSetup.module.css
    AddressBottomSheet.js
    AnimatedButton.js
    AuthenticatedImage.js
    BackButtonHandler.js
    BarcodeScanner.js
    BarcodeScanner.module.css
    BottomNav.js
    BottomNav.module.css
    BottomSheet.js
    BottomSheet.module.css
    CancelInvoiceModal.js
    ComingSoon.js
    ComingSoon.module.css
    ImagePicker.js
    InvoiceBottomSheet.js
    InvoiceForm.js
    InvoiceForm.module.css
    InvoiceTemplate.js
    PartyListItem.js
    PurchaseForm.js
    PurchaseForm.module.css
    ScanResultModal.js
    ScanResultModal.module.css
    Toast.js
    TransactionCard.js
  lib/
    data/
      tagTemplates.js
    db/
      index.js
    hooks/
      useAuthenticatedImage.js
      useBackButton.js
    logger/
      __tests__/
        logger.test.js
      storage/
        capacitorFs.ts
        index.ts
        indexedDb.ts
      config.ts
      context.ts
      events.ts
      export.ts
      index.ts
      logger.ts
      redact.ts
      types.ts
    services/
      bulkUploadService.js
    store/
      __tests__/
        homeStore.test.js
        invoiceStore.test.js
        productStore.test.js
      attendanceStore.js
      authStore.js
      expenseStore.js
      homeStore.js
      invoiceStore.js
      masterStore.js
      partyStore.js
      paymentStore.js
      productStore.js
      purchaseStore.js
      settingsStore.js
    utils/
      __tests__/
        exportUtils.test.js
        numberToWords.test.js
        tax.test.js
      exportUtils.js
      invoiceActions.js
      isDiagnosticsEnabled.js
      numberToWords.js
      pdf.js
      tax.js
    animations.js
.eslintrc.json
.gitignore
back_int.md
capacitor.config.json
cypress.config.js
integration.md
jest.config.js
jest.setup.js
jsconfig.json
Landingpage.jpg
next.config.mjs
package.json
parse.js
README.md
schema.md
style_guide.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/components/AuthenticatedImage.js">
'use client';

import { useAuthenticatedImage } from '@/lib/hooks/useAuthenticatedImage';

/**
 * Image component that loads images with authentication
 * Automatically handles Authorization header and blob URL management
 * 
 * @param {Object} props
 * @param {string} props.src - Image URL from API (e.g., "/api/photos/uuid")
 * @param {string} [props.alt] - Alt text for the image
 * @param {string} [props.className] - CSS class name
 * @param {React.ReactNode} [props.fallback] - Fallback content when loading or on error
 * @param {Object} [props.style] - Inline styles
 */
export default function AuthenticatedImage({
    src: imageUrl,
    alt = '',
    className = '',
    fallback = null,
    style = {},
    ...rest
}) {
    const { src, loading, error } = useAuthenticatedImage(imageUrl);

    // Show fallback while loading or on error
    if (loading || error || !src) {
        return fallback;
    }

    return (
        <img
            src={src}
            alt={alt}
            className={className}
            style={style}
            {...rest}
        />
    );
}
</file>

<file path="src/lib/hooks/useAuthenticatedImage.js">
'use client';

import { useState, useEffect } from 'react';
import { api } from '@/api/backendClient';

/**
 * Hook to load an authenticated image and return a blob URL
 * @param {string} imageUrl - The image URL from API (e.g., "/api/photos/uuid")
 * @returns {{ src: string | null, loading: boolean, error: string | null }}
 */
export function useAuthenticatedImage(imageUrl) {
    const [src, setSrc] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    useEffect(() => {
        if (!imageUrl) {
            setLoading(false);
            return;
        }

        let blobUrl = null;
        let cancelled = false;

        const loadImage = async () => {
            try {
                setLoading(true);
                setError(null);

                const fullUrl = api.photos.getFullUrl(imageUrl);
                const token = localStorage.getItem('auth_token');

                const response = await fetch(fullUrl, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });

                if (!response.ok) {
                    throw new Error(`Failed to load image: ${response.status}`);
                }

                const blob = await response.blob();

                if (!cancelled) {
                    blobUrl = URL.createObjectURL(blob);
                    setSrc(blobUrl);
                }
            } catch (err) {
                if (!cancelled) {
                    console.error('Image load failed:', err);
                    setError(err.message);
                }
            } finally {
                if (!cancelled) {
                    setLoading(false);
                }
            }
        };

        loadImage();

        // Cleanup: revoke blob URL when component unmounts or URL changes
        return () => {
            cancelled = true;
            if (blobUrl) {
                URL.revokeObjectURL(blobUrl);
            }
        };
    }, [imageUrl]);

    return { src, loading, error };
}

/**
 * Standalone function to load authenticated image (for non-hook contexts)
 * Remember to call URL.revokeObjectURL() when done to prevent memory leaks
 * @param {string} imageUrl - The image URL from API
 * @returns {Promise<string>} Blob URL for the image
 */
export async function loadAuthenticatedImage(imageUrl) {
    if (!imageUrl) return null;

    const fullUrl = api.photos.getFullUrl(imageUrl);
    const token = localStorage.getItem('auth_token');

    const response = await fetch(fullUrl, {
        headers: token ? { 'Authorization': `Bearer ${token}` } : {}
    });

    if (!response.ok) {
        throw new Error(`Failed to load image: ${response.status}`);
    }

    const blob = await response.blob();
    return URL.createObjectURL(blob);
}

export default useAuthenticatedImage;
</file>

<file path="android/app/src/androidTest/java/com/getcapacitor/myapp/ExampleInstrumentedTest.java">
package com.getcapacitor.myapp;

import static org.junit.Assert.*;

import android.content.Context;
import androidx.test.ext.junit.runners.AndroidJUnit4;
import androidx.test.platform.app.InstrumentationRegistry;
import org.junit.Test;
import org.junit.runner.RunWith;

/**
 * Instrumented test, which will execute on an Android device.
 *
 * @see <a href="http://d.android.com/tools/testing">Testing documentation</a>
 */
@RunWith(AndroidJUnit4.class)
public class ExampleInstrumentedTest {

    @Test
    public void useAppContext() throws Exception {
        // Context of the app under test.
        Context appContext = InstrumentationRegistry.getInstrumentation().getTargetContext();

        assertEquals("com.getcapacitor.app", appContext.getPackageName());
    }
}
</file>

<file path="android/app/src/main/java/com/swipe/app/MainActivity.java">
package com.swipe.app;

import com.getcapacitor.BridgeActivity;

public class MainActivity extends BridgeActivity {}
</file>

<file path="android/app/src/main/res/drawable/ic_launcher_background.xml">
<?xml version="1.0" encoding="utf-8"?>
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="108dp"
    android:height="108dp"
    android:viewportHeight="108"
    android:viewportWidth="108">
    <path
        android:fillColor="#26A69A"
        android:pathData="M0,0h108v108h-108z" />
    <path
        android:fillColor="#00000000"
        android:pathData="M9,0L9,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,0L19,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M29,0L29,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M39,0L39,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M49,0L49,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M59,0L59,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M69,0L69,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M79,0L79,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M89,0L89,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M99,0L99,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,9L108,9"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,19L108,19"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,29L108,29"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,39L108,39"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,49L108,49"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,59L108,59"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,69L108,69"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,79L108,79"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,89L108,89"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,99L108,99"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,29L89,29"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,39L89,39"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,49L89,49"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,59L89,59"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,69L89,69"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,79L89,79"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M29,19L29,89"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M39,19L39,89"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M49,19L49,89"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M59,19L59,89"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M69,19L69,89"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M79,19L79,89"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
</vector>
</file>

<file path="android/app/src/main/res/drawable-v24/ic_launcher_foreground.xml">
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:aapt="http://schemas.android.com/aapt"
    android:width="108dp"
    android:height="108dp"
    android:viewportHeight="108"
    android:viewportWidth="108">
    <path
        android:fillType="evenOdd"
        android:pathData="M32,64C32,64 38.39,52.99 44.13,50.95C51.37,48.37 70.14,49.57 70.14,49.57L108.26,87.69L108,109.01L75.97,107.97L32,64Z"
        android:strokeColor="#00000000"
        android:strokeWidth="1">
        <aapt:attr name="android:fillColor">
            <gradient
                android:endX="78.5885"
                android:endY="90.9159"
                android:startX="48.7653"
                android:startY="61.0927"
                android:type="linear">
                <item
                    android:color="#44000000"
                    android:offset="0.0" />
                <item
                    android:color="#00000000"
                    android:offset="1.0" />
            </gradient>
        </aapt:attr>
    </path>
    <path
        android:fillColor="#FFFFFF"
        android:fillType="nonZero"
        android:pathData="M66.94,46.02L66.94,46.02C72.44,50.07 76,56.61 76,64L32,64C32,56.61 35.56,50.11 40.98,46.06L36.18,41.19C35.45,40.45 35.45,39.3 36.18,38.56C36.91,37.81 38.05,37.81 38.78,38.56L44.25,44.05C47.18,42.57 50.48,41.71 54,41.71C57.48,41.71 60.78,42.57 63.68,44.05L69.11,38.56C69.84,37.81 70.98,37.81 71.71,38.56C72.44,39.3 72.44,40.45 71.71,41.19L66.94,46.02ZM62.94,56.92C64.08,56.92 65,56.01 65,54.88C65,53.76 64.08,52.85 62.94,52.85C61.8,52.85 60.88,53.76 60.88,54.88C60.88,56.01 61.8,56.92 62.94,56.92ZM45.06,56.92C46.2,56.92 47.13,56.01 47.13,54.88C47.13,53.76 46.2,52.85 45.06,52.85C43.92,52.85 43,53.76 43,54.88C43,56.01 43.92,56.92 45.06,56.92Z"
        android:strokeColor="#00000000"
        android:strokeWidth="1" />
</vector>
</file>

<file path="android/app/src/main/res/layout/activity_main.xml">
<?xml version="1.0" encoding="utf-8"?>
<androidx.coordinatorlayout.widget.CoordinatorLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context=".MainActivity">

    <WebView
        android:layout_width="match_parent"
        android:layout_height="match_parent" />
</androidx.coordinatorlayout.widget.CoordinatorLayout>
</file>

<file path="android/app/src/main/res/values/ic_launcher_background.xml">
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="ic_launcher_background">#FFFFFF</color>
</resources>
</file>

<file path="android/app/src/main/res/values/strings.xml">
<?xml version='1.0' encoding='utf-8'?>
<resources>
    <string name="app_name">Swipe</string>
    <string name="title_activity_main">Swipe</string>
    <string name="package_name">com.swipe.app</string>
    <string name="custom_url_scheme">com.swipe.app</string>
</resources>
</file>

<file path="android/app/src/main/res/values/styles.xml">
<?xml version="1.0" encoding="utf-8"?>
<resources>

    <!-- Base application theme. -->
    <style name="AppTheme" parent="Theme.AppCompat.Light.DarkActionBar">
        <!-- Customize your theme here. -->
        <item name="colorPrimary">@color/colorPrimary</item>
        <item name="colorPrimaryDark">@color/colorPrimaryDark</item>
        <item name="colorAccent">@color/colorAccent</item>
    </style>

    <style name="AppTheme.NoActionBar" parent="Theme.AppCompat.DayNight.NoActionBar">
        <item name="windowActionBar">false</item>
        <item name="windowNoTitle">true</item>
        <item name="android:background">@null</item>
    </style>


    <style name="AppTheme.NoActionBarLaunch" parent="Theme.SplashScreen">
        <item name="android:background">@drawable/splash</item>
    </style>
</resources>
</file>

<file path="android/app/src/test/java/com/getcapacitor/myapp/ExampleUnitTest.java">
package com.getcapacitor.myapp;

import static org.junit.Assert.*;

import org.junit.Test;

/**
 * Example local unit test, which will execute on the development machine (host).
 *
 * @see <a href="http://d.android.com/tools/testing">Testing documentation</a>
 */
public class ExampleUnitTest {

    @Test
    public void addition_isCorrect() throws Exception {
        assertEquals(4, 2 + 2);
    }
}
</file>

<file path="android/app/.gitignore">
/build/*
!/build/.npmkeep
</file>

<file path="android/app/build.gradle">
apply plugin: 'com.android.application'

android {
    namespace "com.swipe.app"
    compileSdk rootProject.ext.compileSdkVersion
    defaultConfig {
        applicationId "com.swipe.app"
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 1
        versionName "1.0"
        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        aaptOptions {
             // Files and dirs to omit from the packaged assets dir, modified to accommodate modern web apps.
             // Default: https://android.googlesource.com/platform/frameworks/base/+/282e181b58cf72b6ca770dc7ca5f91f135444502/tools/aapt/AaptAssets.cpp#61
            ignoreAssetsPattern '!.svn:!.git:!.ds_store:!*.scc:.*:!CVS:!thumbs.db:!picasa.ini:!*~'
        }
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}

repositories {
    flatDir{
        dirs '../capacitor-cordova-android-plugins/src/main/libs', 'libs'
    }
}

dependencies {
    implementation fileTree(include: ['*.jar'], dir: 'libs')
    implementation "androidx.appcompat:appcompat:$androidxAppCompatVersion"
    implementation "androidx.coordinatorlayout:coordinatorlayout:$androidxCoordinatorLayoutVersion"
    implementation "androidx.core:core-splashscreen:$coreSplashScreenVersion"
    implementation project(':capacitor-android')
    testImplementation "junit:junit:$junitVersion"
    androidTestImplementation "androidx.test.ext:junit:$androidxJunitVersion"
    androidTestImplementation "androidx.test.espresso:espresso-core:$androidxEspressoCoreVersion"
    implementation project(':capacitor-cordova-android-plugins')
}

apply from: 'capacitor.build.gradle'

try {
    def servicesJSON = file('google-services.json')
    if (servicesJSON.text) {
        apply plugin: 'com.google.gms.google-services'
    }
} catch(Exception e) {
    logger.info("google-services.json not found, google-services plugin not applied. Push Notifications won't work")
}
</file>

<file path="android/app/capacitor.build.gradle">
// DO NOT EDIT THIS FILE! IT IS GENERATED EACH TIME "capacitor update" IS RUN

android {
  compileOptions {
      sourceCompatibility JavaVersion.VERSION_21
      targetCompatibility JavaVersion.VERSION_21
  }
}

apply from: "../capacitor-cordova-android-plugins/cordova.variables.gradle"
dependencies {


}


if (hasProperty('postBuildExtras')) {
  postBuildExtras()
}
</file>

<file path="android/app/proguard-rules.pro">
# Add project specific ProGuard rules here.
# You can control the set of applied configuration files using the
# proguardFiles setting in build.gradle.
#
# For more details, see
#   http://developer.android.com/guide/developing/tools/proguard.html

# If your project uses WebView with JS, uncomment the following
# and specify the fully qualified class name to the JavaScript interface
# class:
#-keepclassmembers class fqcn.of.javascript.interface.for.webview {
#   public *;
#}

# Uncomment this to preserve the line number information for
# debugging stack traces.
#-keepattributes SourceFile,LineNumberTable

# If you keep the line number information, uncomment this to
# hide the original source file name.
#-renamesourcefileattribute SourceFile
</file>

<file path="android/gradle/wrapper/gradle-wrapper.properties">
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.11.1-all.zip
networkTimeout=10000
validateDistributionUrl=true
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
</file>

<file path="android/.gitignore">
# Using Android gitignore template: https://github.com/github/gitignore/blob/HEAD/Android.gitignore

# Built application files
*.apk
*.aar
*.ap_
*.aab

# Files for the ART/Dalvik VM
*.dex

# Java class files
*.class

# Generated files
bin/
gen/
out/
#  Uncomment the following line in case you need and you don't have the release build type files in your app
# release/

# Gradle files
.gradle/
build/

# Local configuration file (sdk path, etc)
local.properties

# Proguard folder generated by Eclipse
proguard/

# Log Files
*.log

# Android Studio Navigation editor temp files
.navigation/

# Android Studio captures folder
captures/

# IntelliJ
*.iml
.idea/workspace.xml
.idea/tasks.xml
.idea/gradle.xml
.idea/assetWizardSettings.xml
.idea/dictionaries
.idea/libraries
# Android Studio 3 in .gitignore file.
.idea/caches
.idea/modules.xml
# Comment next line if keeping position of elements in Navigation Editor is relevant for you
.idea/navEditor.xml

# Keystore files
# Uncomment the following lines if you do not want to check your keystore files in.
#*.jks
#*.keystore

# External native build folder generated in Android Studio 2.2 and later
.externalNativeBuild
.cxx/

# Google Services (e.g. APIs or Firebase)
# google-services.json

# Freeline
freeline.py
freeline/
freeline_project_description.json

# fastlane
fastlane/report.xml
fastlane/Preview.html
fastlane/screenshots
fastlane/test_output
fastlane/readme.md

# Version control
vcs.xml

# lint
lint/intermediates/
lint/generated/
lint/outputs/
lint/tmp/
# lint/reports/

# Android Profiling
*.hprof

# Cordova plugins for Capacitor
capacitor-cordova-android-plugins

# Copied web assets
app/src/main/assets/public

# Generated Config files
app/src/main/assets/capacitor.config.json
app/src/main/assets/capacitor.plugins.json
app/src/main/res/xml/config.xml
</file>

<file path="android/build.gradle">
// Top-level build file where you can add configuration options common to all sub-projects/modules.

buildscript {
    
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:8.7.2'
        classpath 'com.google.gms:google-services:4.4.2'

        // NOTE: Do not place your application dependencies here; they belong
        // in the individual module build.gradle files
    }
}

apply from: "variables.gradle"

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
</file>

<file path="android/capacitor.settings.gradle">
// DO NOT EDIT THIS FILE! IT IS GENERATED EACH TIME "capacitor update" IS RUN
include ':capacitor-android'
project(':capacitor-android').projectDir = new File('../node_modules/@capacitor/android/capacitor')
</file>

<file path="android/gradle.properties">
# Project-wide Gradle settings.

# IDE (e.g. Android Studio) users:
# Gradle settings configured through the IDE *will override*
# any settings specified in this file.

# For more details on how to configure your build environment visit
# http://www.gradle.org/docs/current/userguide/build_environment.html

# Specifies the JVM arguments used for the daemon process.
# The setting is particularly useful for tweaking memory settings.
org.gradle.jvmargs=-Xmx1536m

# When configured, Gradle will run in incubating parallel mode.
# This option should only be used with decoupled projects. More details, visit
# http://www.gradle.org/docs/current/userguide/multi_project_builds.html#sec:decoupled_projects
# org.gradle.parallel=true

# AndroidX package structure to make it clearer which packages are bundled with the
# Android operating system, and which are packaged with your app's APK
# https://developer.android.com/topic/libraries/support-library/androidx-rn
android.useAndroidX=true
</file>

<file path="android/gradlew">
#!/bin/sh

#
# Copyright © 2015-2021 the original authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
#

##############################################################################
#
#   Gradle start up script for POSIX generated by Gradle.
#
#   Important for running:
#
#   (1) You need a POSIX-compliant shell to run this script. If your /bin/sh is
#       noncompliant, but you have some other compliant shell such as ksh or
#       bash, then to run this script, type that shell name before the whole
#       command line, like:
#
#           ksh Gradle
#
#       Busybox and similar reduced shells will NOT work, because this script
#       requires all of these POSIX shell features:
#         * functions;
#         * expansions «$var», «${var}», «${var:-default}», «${var+SET}»,
#           «${var#prefix}», «${var%suffix}», and «$( cmd )»;
#         * compound commands having a testable exit status, especially «case»;
#         * various built-in commands including «command», «set», and «ulimit».
#
#   Important for patching:
#
#   (2) This script targets any POSIX shell, so it avoids extensions provided
#       by Bash, Ksh, etc; in particular arrays are avoided.
#
#       The "traditional" practice of packing multiple parameters into a
#       space-separated string is a well documented source of bugs and security
#       problems, so this is (mostly) avoided, by progressively accumulating
#       options in "$@", and eventually passing that to Java.
#
#       Where the inherited environment variables (DEFAULT_JVM_OPTS, JAVA_OPTS,
#       and GRADLE_OPTS) rely on word-splitting, this is performed explicitly;
#       see the in-line comments for details.
#
#       There are tweaks for specific operating systems such as AIX, CygWin,
#       Darwin, MinGW, and NonStop.
#
#   (3) This script is generated from the Groovy template
#       https://github.com/gradle/gradle/blob/HEAD/platforms/jvm/plugins-application/src/main/resources/org/gradle/api/internal/plugins/unixStartScript.txt
#       within the Gradle project.
#
#       You can find Gradle at https://github.com/gradle/gradle/.
#
##############################################################################

# Attempt to set APP_HOME

# Resolve links: $0 may be a link
app_path=$0

# Need this for daisy-chained symlinks.
while
    APP_HOME=${app_path%"${app_path##*/}"}  # leaves a trailing /; empty if no leading path
    [ -h "$app_path" ]
do
    ls=$( ls -ld "$app_path" )
    link=${ls#*' -> '}
    case $link in             #(
      /*)   app_path=$link ;; #(
      *)    app_path=$APP_HOME$link ;;
    esac
done

# This is normally unused
# shellcheck disable=SC2034
APP_BASE_NAME=${0##*/}
# Discard cd standard output in case $CDPATH is set (https://github.com/gradle/gradle/issues/25036)
APP_HOME=$( cd -P "${APP_HOME:-./}" > /dev/null && printf '%s
' "$PWD" ) || exit

# Use the maximum available, or set MAX_FD != -1 to use that value.
MAX_FD=maximum

warn () {
    echo "$*"
} >&2

die () {
    echo
    echo "$*"
    echo
    exit 1
} >&2

# OS specific support (must be 'true' or 'false').
cygwin=false
msys=false
darwin=false
nonstop=false
case "$( uname )" in                #(
  CYGWIN* )         cygwin=true  ;; #(
  Darwin* )         darwin=true  ;; #(
  MSYS* | MINGW* )  msys=true    ;; #(
  NONSTOP* )        nonstop=true ;;
esac

CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar


# Determine the Java command to use to start the JVM.
if [ -n "$JAVA_HOME" ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
        # IBM's JDK on AIX uses strange locations for the executables
        JAVACMD=$JAVA_HOME/jre/sh/java
    else
        JAVACMD=$JAVA_HOME/bin/java
    fi
    if [ ! -x "$JAVACMD" ] ; then
        die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
    fi
else
    JAVACMD=java
    if ! command -v java >/dev/null 2>&1
    then
        die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
    fi
fi

# Increase the maximum file descriptors if we can.
if ! "$cygwin" && ! "$darwin" && ! "$nonstop" ; then
    case $MAX_FD in #(
      max*)
        # In POSIX sh, ulimit -H is undefined. That's why the result is checked to see if it worked.
        # shellcheck disable=SC2039,SC3045
        MAX_FD=$( ulimit -H -n ) ||
            warn "Could not query maximum file descriptor limit"
    esac
    case $MAX_FD in  #(
      '' | soft) :;; #(
      *)
        # In POSIX sh, ulimit -n is undefined. That's why the result is checked to see if it worked.
        # shellcheck disable=SC2039,SC3045
        ulimit -n "$MAX_FD" ||
            warn "Could not set maximum file descriptor limit to $MAX_FD"
    esac
fi

# Collect all arguments for the java command, stacking in reverse order:
#   * args from the command line
#   * the main class name
#   * -classpath
#   * -D...appname settings
#   * --module-path (only if needed)
#   * DEFAULT_JVM_OPTS, JAVA_OPTS, and GRADLE_OPTS environment variables.

# For Cygwin or MSYS, switch paths to Windows format before running java
if "$cygwin" || "$msys" ; then
    APP_HOME=$( cygpath --path --mixed "$APP_HOME" )
    CLASSPATH=$( cygpath --path --mixed "$CLASSPATH" )

    JAVACMD=$( cygpath --unix "$JAVACMD" )

    # Now convert the arguments - kludge to limit ourselves to /bin/sh
    for arg do
        if
            case $arg in                                #(
              -*)   false ;;                            # don't mess with options #(
              /?*)  t=${arg#/} t=/${t%%/*}              # looks like a POSIX filepath
                    [ -e "$t" ] ;;                      #(
              *)    false ;;
            esac
        then
            arg=$( cygpath --path --ignore --mixed "$arg" )
        fi
        # Roll the args list around exactly as many times as the number of
        # args, so each arg winds up back in the position where it started, but
        # possibly modified.
        #
        # NB: a `for` loop captures its iteration list before it begins, so
        # changing the positional parameters here affects neither the number of
        # iterations, nor the values presented in `arg`.
        shift                   # remove old arg
        set -- "$@" "$arg"      # push replacement arg
    done
fi


# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'

# Collect all arguments for the java command:
#   * DEFAULT_JVM_OPTS, JAVA_OPTS, JAVA_OPTS, and optsEnvironmentVar are not allowed to contain shell fragments,
#     and any embedded shellness will be escaped.
#   * For example: A user cannot expect ${Hostname} to be expanded, as it is an environment variable and will be
#     treated as '${Hostname}' itself on the command line.

set -- \
        "-Dorg.gradle.appname=$APP_BASE_NAME" \
        -classpath "$CLASSPATH" \
        org.gradle.wrapper.GradleWrapperMain \
        "$@"

# Stop when "xargs" is not available.
if ! command -v xargs >/dev/null 2>&1
then
    die "xargs is not available"
fi

# Use "xargs" to parse quoted args.
#
# With -n1 it outputs one arg per line, with the quotes and backslashes removed.
#
# In Bash we could simply go:
#
#   readarray ARGS < <( xargs -n1 <<<"$var" ) &&
#   set -- "${ARGS[@]}" "$@"
#
# but POSIX shell has neither arrays nor command substitution, so instead we
# post-process each arg (as a line of input to sed) to backslash-escape any
# character that might be a shell metacharacter, then use eval to reverse
# that process (while maintaining the separation between arguments), and wrap
# the whole thing up as a single "set" statement.
#
# This will of course break if any of these variables contains a newline or
# an unmatched quote.
#

eval "set -- $(
        printf '%s\n' "$DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS" |
        xargs -n1 |
        sed ' s~[^-[:alnum:]+,./:=@_]~\\&~g; ' |
        tr '\n' ' '
    )" '"$@"'

exec "$JAVACMD" "$@"
</file>

<file path="android/gradlew.bat">
@rem
@rem Copyright 2015 the original author or authors.
@rem
@rem Licensed under the Apache License, Version 2.0 (the "License");
@rem you may not use this file except in compliance with the License.
@rem You may obtain a copy of the License at
@rem
@rem      https://www.apache.org/licenses/LICENSE-2.0
@rem
@rem Unless required by applicable law or agreed to in writing, software
@rem distributed under the License is distributed on an "AS IS" BASIS,
@rem WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@rem See the License for the specific language governing permissions and
@rem limitations under the License.
@rem
@rem SPDX-License-Identifier: Apache-2.0
@rem

@if "%DEBUG%"=="" @echo off
@rem ##########################################################################
@rem
@rem  Gradle startup script for Windows
@rem
@rem ##########################################################################

@rem Set local scope for the variables with windows NT shell
if "%OS%"=="Windows_NT" setlocal

set DIRNAME=%~dp0
if "%DIRNAME%"=="" set DIRNAME=.
@rem This is normally unused
set APP_BASE_NAME=%~n0
set APP_HOME=%DIRNAME%

@rem Resolve any "." and ".." in APP_HOME to make it shorter.
for %%i in ("%APP_HOME%") do set APP_HOME=%%~fi

@rem Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
set DEFAULT_JVM_OPTS="-Xmx64m" "-Xms64m"

@rem Find java.exe
if defined JAVA_HOME goto findJavaFromJavaHome

set JAVA_EXE=java.exe
%JAVA_EXE% -version >NUL 2>&1
if %ERRORLEVEL% equ 0 goto execute

echo. 1>&2
echo ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH. 1>&2
echo. 1>&2
echo Please set the JAVA_HOME variable in your environment to match the 1>&2
echo location of your Java installation. 1>&2

goto fail

:findJavaFromJavaHome
set JAVA_HOME=%JAVA_HOME:"=%
set JAVA_EXE=%JAVA_HOME%/bin/java.exe

if exist "%JAVA_EXE%" goto execute

echo. 1>&2
echo ERROR: JAVA_HOME is set to an invalid directory: %JAVA_HOME% 1>&2
echo. 1>&2
echo Please set the JAVA_HOME variable in your environment to match the 1>&2
echo location of your Java installation. 1>&2

goto fail

:execute
@rem Setup the command line

set CLASSPATH=%APP_HOME%\gradle\wrapper\gradle-wrapper.jar


@rem Execute Gradle
"%JAVA_EXE%" %DEFAULT_JVM_OPTS% %JAVA_OPTS% %GRADLE_OPTS% "-Dorg.gradle.appname=%APP_BASE_NAME%" -classpath "%CLASSPATH%" org.gradle.wrapper.GradleWrapperMain %*

:end
@rem End local scope for the variables with windows NT shell
if %ERRORLEVEL% equ 0 goto mainEnd

:fail
rem Set variable GRADLE_EXIT_CONSOLE if you need the _script_ return code instead of
rem the _cmd.exe /c_ return code!
set EXIT_CODE=%ERRORLEVEL%
if %EXIT_CODE% equ 0 set EXIT_CODE=1
if not ""=="%GRADLE_EXIT_CONSOLE%" exit %EXIT_CODE%
exit /b %EXIT_CODE%

:mainEnd
if "%OS%"=="Windows_NT" endlocal

:omega
</file>

<file path="android/settings.gradle">
include ':app'
include ':capacitor-cordova-android-plugins'
project(':capacitor-cordova-android-plugins').projectDir = new File('./capacitor-cordova-android-plugins/')

apply from: 'capacitor.settings.gradle'
</file>

<file path="android/variables.gradle">
ext {
    minSdkVersion = 23
    compileSdkVersion = 35
    targetSdkVersion = 35
    androidxActivityVersion = '1.9.2'
    androidxAppCompatVersion = '1.7.0'
    androidxCoordinatorLayoutVersion = '1.2.0'
    androidxCoreVersion = '1.15.0'
    androidxFragmentVersion = '1.8.4'
    coreSplashScreenVersion = '1.0.1'
    androidxWebkitVersion = '1.12.1'
    junitVersion = '4.13.2'
    androidxJunitVersion = '1.2.1'
    androidxEspressoCoreVersion = '3.6.1'
    cordovaAndroidVersion = '10.1.1'
}
</file>

<file path="cypress/e2e/sanity.cy.js">
/// <reference types="cypress" />

describe('Swipe App Sanity Tests', () => {
    beforeEach(() => {
        // Visit the home page before each test
        cy.visit('/');
    });

    describe('Home Page', () => {
        it('should load the home page successfully', () => {
            // Verify the page loads without errors
            cy.url().should('include', '/');
        });

        it('should display the bottom navigation', () => {
            // Check for all navigation items
            cy.contains('Home').should('be.visible');
            cy.contains('Bills').should('be.visible');
            cy.contains('Products').should('be.visible');
            cy.contains('Parties').should('be.visible');
            cy.contains('More').should('be.visible');
        });
    });

    describe('Navigation', () => {
        it('should navigate to Products page', () => {
            cy.contains('Products').click();
            cy.url().should('include', '/products');
        });

        it('should navigate to Bills page', () => {
            cy.contains('Bills').click();
            cy.url().should('include', '/bills');
        });

        it('should navigate to Parties page', () => {
            cy.contains('Parties').click();
            cy.url().should('include', '/parties');
        });

        it('should navigate to More page', () => {
            cy.contains('More').click();
            cy.url().should('include', '/more');
        });

        it('should navigate back to Home from Products', () => {
            // Navigate away from home
            cy.contains('Products').click();
            cy.url().should('include', '/products');

            // Navigate back to home
            cy.contains('Home').click();
            cy.url().should('eq', Cypress.config().baseUrl + '/');
        });
    });

    describe('Products Page', () => {
        beforeEach(() => {
            cy.visit('/products');
        });

        it('should load the products page', () => {
            cy.url().should('include', '/products');
        });

        it('should have a way to add new products', () => {
            // Look for add/create button or link
            cy.get('body').then(($body) => {
                // Check if there's a visible add button or the page loads properly
                expect($body.length).to.be.greaterThan(0);
            });
        });
    });

    describe('Responsive Design', () => {
        it('should display correctly on mobile viewport', () => {
            // Default viewport is already mobile (390x844)
            cy.viewport(390, 844);
            cy.visit('/');

            // Bottom nav should be visible
            cy.contains('Home').should('be.visible');
        });

        it('should display correctly on tablet viewport', () => {
            cy.viewport(768, 1024);
            cy.visit('/');

            // Page should still work
            cy.contains('Home').should('be.visible');
        });
    });
});
</file>

<file path="cypress/support/e2e.js">
// Cypress E2E support file
// This file runs before every single spec file

// Import commands
// import './commands';

// Prevent Cypress from failing tests on uncaught exceptions from the app
Cypress.on('uncaught:exception', (err, runnable) => {
    // Return false to prevent the error from failing the test
    // This is useful for third-party script errors
    return false;
});

// Global before hook - runs once before all tests
before(() => {
    // Clear local storage and session storage
    cy.clearLocalStorage();
    cy.clearAllSessionStorage();
});

// Before each test
beforeEach(() => {
    // Log the current test name for debugging
    cy.log(`Running: ${Cypress.currentTest.title}`);
});

// After each test
afterEach(() => {
    // Add any cleanup logic here
});
</file>

<file path="docs/ICON_DESIGN_GUIDE.md">
# Icon Design Guide

## Overview
Custom SVG icons for the Swipe application featuring a modern, minimal line style with subtle gold accents.

## Color Palette

| Color | Hex | Usage |
|-------|-----|-------|
| Primary Gray | `#666666` | Main strokes, outlines, borders |
| Gold Accent | `#D4AF37` | Key details, checkmarks, highlights |
| Gold Light | `#E5C76B` | Optional lighter gold variant |

## Grid & Sizing

- **Canvas**: 30×30 px
- **Padding**: 2.5 px on all sides
- **Drawable area**: ~25×25 px centered
- No strokes should touch the outer padding

## Stroke Specifications

```
stroke-width: 2.25
stroke-linecap: round
stroke-linejoin: round
fill: none (except small accent fills)
```

## Color Rules

1. **Primary strokes**: `#666666` at 100% opacity
2. **Accent strokes/fills**: `#D4AF37` at 100% opacity
3. **Accent usage**: 10–20% of icon area only
4. Use gold for: checkmarks, pointers, trend lines, key highlights
5. Keep main shapes and borders in gray

## Shape Language

- Use simple geometric primitives
- Circles, rounded rectangles, straight lines, simple curves
- No drop shadows, gradients, or 3D effects
- Maintain consistent visual weight across all icons

## React Component Template

```jsx
export const IconName = ({ size = 24, className }) => (
  <svg 
    width={size} 
    height={size} 
    viewBox="0 0 24 24" 
    fill="none"
    strokeWidth="1.75"
    strokeLinecap="round"
    strokeLinejoin="round"
    className={className}
  >
    {/* Gray elements */}
    <path stroke="#666666" d="..." />
    
    {/* Gold accent */}
    <path stroke="#D4AF37" d="..." />
  </svg>
);
```

## Icon Set Reference

| Icon | Gray Elements | Gold Accent |
|------|---------------|-------------|
| Invoice | Document + lines | Top header line |
| Purchase | Cart body + wheels | Plus sign |
| Quotation | Clipboard + lines | Header bar |
| DailyLogin | Calendar + grid | Checkmark |
| LendingBill | Archive box | Arrow accent |
| Expenses | Wallet outline | Coin symbol |
| ProFormaInvoice | Calculator | Display accent |
| PaymentsTimeline | Document/card | Checkmark |
| Reports | Clock + ticks | Clock hands |
| Insights | X/Y axis | Trend line |
| InvoiceTemplates | Document + lines | Title line |
| DocumentSettings | Gear shape | Center hub |

## Adding New Icons

1. Follow the 24×24 canvas with 2 px padding
2. Use 1.75 px stroke with rounded caps/joins
3. Keep most strokes gray (`#666666`)
4. Reserve gold (`#D4AF37`) for 1–2 key details only
5. Match visual weight of existing icons
6. Export with `fill="none"` at root level
</file>

<file path="public/templates/classic-preview.svg">
<svg width="600" height="850" viewBox="0 0 600 850" xmlns="http://www.w3.org/2000/svg">
  <rect width="600" height="850" fill="white"/>
  
  <!-- Header -->
  <text x="40" y="60" font-family="serif" font-size="24" font-weight="bold" fill="#990099">Godrej</text>
  <text x="40" y="80" font-family="sans-serif" font-size="9">GSTIN: 27ABCCS2942R1ZR</text>
  <text x="40" y="95" font-family="sans-serif" font-size="9">Hyderabad, Telangana</text>
  
  <text x="560" y="60" font-family="sans-serif" font-size="12" fill="#2563eb" text-anchor="end">TAX INVOICE</text>
  <text x="560" y="75" font-family="sans-serif" font-size="8" fill="#666" text-anchor="end">ORIGINAL FOR RECIPIENT</text>

  <!-- Bill To -->
  <text x="40" y="140" font-family="sans-serif" font-size="10" font-weight="bold">Bill To:</text>
  <text x="40" y="155" font-family="sans-serif" font-size="10">Vishal Sharma</text>
  <text x="40" y="170" font-family="sans-serif" font-size="9">GSTIN: 27ABCCS2942R1ZR</text>
  <text x="40" y="185" font-family="sans-serif" font-size="9">Gachibowli, Hyderabad</text>
  
  <text x="450" y="140" font-family="sans-serif" font-size="9" text-anchor="end">Invoice #:</text>
  <text x="560" y="140" font-family="sans-serif" font-size="9" font-weight="bold" text-anchor="end">INV-1</text>
  <text x="450" y="155" font-family="sans-serif" font-size="9" text-anchor="end">Invoice Date:</text>
  <text x="560" y="155" font-family="sans-serif" font-size="9" text-anchor="end">16 Jun 2023</text>

  <!-- Table Header -->
  <rect x="40" y="220" width="520" height="20" fill="#2563eb"/>
  <text x="50" y="234" font-family="sans-serif" font-size="9" fill="white" font-weight="bold">Item</text>
  <text x="300" y="234" font-family="sans-serif" font-size="9" fill="white" font-weight="bold">HSN/SAC</text>
  <text x="400" y="234" font-family="sans-serif" font-size="9" fill="white" font-weight="bold" text-anchor="end">Rate/Item</text>
  <text x="460" y="234" font-family="sans-serif" font-size="9" fill="white" font-weight="bold" text-anchor="end">Qty</text>
  <text x="550" y="234" font-family="sans-serif" font-size="9" fill="white" font-weight="bold" text-anchor="end">Amount</text>

  <!-- Table Row 1 -->
  <text x="50" y="260" font-family="sans-serif" font-size="10" font-weight="bold">Full Back Lounge Chair</text>
  <text x="50" y="275" font-family="sans-serif" font-size="9" fill="#666">Adjustable armrest, Carbon blue</text>
  
  <!-- Product Images Placeholder -->
  <rect x="50" y="290" width="40" height="40" fill="#eee"/>
  <rect x="100" y="290" width="40" height="40" fill="#eee"/>
  <rect x="150" y="290" width="40" height="40" fill="#eee"/>
  
  <text x="300" y="260" font-family="sans-serif" font-size="9">112233</text>
  <text x="400" y="260" font-family="sans-serif" font-size="9" text-anchor="end">11,999.00</text>
  <text x="460" y="260" font-family="sans-serif" font-size="9" text-anchor="end">1</text>
  <text x="550" y="260" font-family="sans-serif" font-size="9" text-anchor="end">11,999.00</text>
  
  <line x1="40" y1="340" x2="560" y2="340" stroke="#eee" stroke-width="1"/>

  <!-- Table Row 2 -->
  <text x="50" y="360" font-family="sans-serif" font-size="10">Table Decors</text>
  <text x="300" y="360" font-family="sans-serif" font-size="9">212232</text>
  <text x="400" y="360" font-family="sans-serif" font-size="9" text-anchor="end">499.00</text>
  <text x="460" y="360" font-family="sans-serif" font-size="9" text-anchor="end">1</text>
  <text x="550" y="360" font-family="sans-serif" font-size="9" text-anchor="end">499.00</text>
  
  <line x1="40" y1="380" x2="560" y2="380" stroke="#2563eb" stroke-width="1"/>

  <!-- Totals -->
  <text x="450" y="400" font-family="sans-serif" font-size="9" text-anchor="end">Taxable Amount</text>
  <text x="550" y="400" font-family="sans-serif" font-size="9" text-anchor="end">12,498.00</text>
  
  <text x="450" y="415" font-family="sans-serif" font-size="9" text-anchor="end">CGST 9.0%</text>
  <text x="550" y="415" font-family="sans-serif" font-size="9" text-anchor="end">1,124.82</text>
  
  <text x="450" y="430" font-family="sans-serif" font-size="9" text-anchor="end">SGST 9.0%</text>
  <text x="550" y="430" font-family="sans-serif" font-size="9" text-anchor="end">1,124.82</text>
  
  <text x="450" y="450" font-family="sans-serif" font-size="12" font-weight="bold" text-anchor="end">Total</text>
  <text x="550" y="450" font-family="sans-serif" font-size="12" font-weight="bold" text-anchor="end">₹14,748.00</text>
  
  <line x1="40" y1="460" x2="560" y2="460" stroke="#2563eb" stroke-width="1"/>
  
  <!-- Footer -->
  <text x="40" y="480" font-family="sans-serif" font-size="10" font-weight="bold">Pay using UPI:</text>
  <rect x="40" y="490" width="60" height="60" fill="white" stroke="#000"/>
  <rect x="45" y="495" width="50" height="50" fill="#000"/>
  
  <text x="120" y="490" font-family="sans-serif" font-size="9" font-weight="bold">Bank Details:</text>
  <text x="120" y="505" font-family="sans-serif" font-size="9">Bank: YES BANK</text>
  
  <circle cx="520" cy="510" r="15" stroke="#2563eb" stroke-width="1" fill="none"/>
  <text x="520" y="513" font-family="sans-serif" font-size="6" fill="#2563eb" text-anchor="middle">SIGNATURE</text>
</svg>
</file>

<file path="public/templates/classic.svg">
<svg width="200" height="280" viewBox="0 0 200 280" xmlns="http://www.w3.org/2000/svg">
  <rect width="200" height="280" fill="white"/>
  <rect x="20" y="20" width="160" height="260" fill="none" stroke="black" stroke-width="1"/>
  <text x="100" y="50" font-family="serif" font-size="16" text-anchor="middle">INVOICE</text>
  <line x1="20" y1="60" x2="180" y2="60" stroke="black" stroke-width="0.5"/>
  <rect x="30" y="80" width="140" height="100" fill="none" stroke="black" stroke-width="0.5"/>
  <line x1="30" y1="100" x2="170" y2="100" stroke="black" stroke-width="0.5"/>
  <rect x="100" y="200" width="70" height="40" fill="none" stroke="black" stroke-width="0.5"/>
</svg>
</file>

<file path="public/templates/elegant.svg">
<svg width="200" height="280" viewBox="0 0 200 280" xmlns="http://www.w3.org/2000/svg">
  <rect width="200" height="280" fill="white"/>
  <rect x="0" y="0" width="200" height="60" fill="#1e293b"/>
  <text x="20" y="40" font-family="serif" font-size="14" fill="white">INVOICE</text>
  <rect x="20" y="80" width="80" height="30" fill="#f1f5f9"/>
  <rect x="20" y="130" width="160" height="1" fill="#e2e8f0"/>
  <rect x="20" y="150" width="160" height="1" fill="#e2e8f0"/>
  <rect x="20" y="170" width="160" height="1" fill="#e2e8f0"/>
  <rect x="120" y="200" width="60" height="40" fill="#f8fafc"/>
</svg>
</file>

<file path="public/templates/modern-preview.svg">
<svg width="600" height="850" viewBox="0 0 600 850" xmlns="http://www.w3.org/2000/svg">
  <rect width="600" height="850" fill="white"/>
  
  <!-- Header -->
  <text x="40" y="50" font-family="sans-serif" font-size="12" font-weight="bold" fill="#2563eb">TAX INVOICE</text>
  <text x="40" y="70" font-family="sans-serif" font-size="18" font-weight="bold">Amazon</text>
  <text x="40" y="90" font-family="sans-serif" font-size="10" fill="#666">GSTIN: 29ABCDE1234F1Z5</text>
  <text x="40" y="105" font-family="sans-serif" font-size="10" fill="#666">Hyderabad, Telangana, 500032</text>
  
  <text x="450" y="70" font-family="sans-serif" font-size="24" font-weight="bold" text-anchor="end">amazon</text>
  <path d="M400 80 Q 425 90 450 80" stroke="#ff9900" stroke-width="2" fill="none"/>

  <!-- Invoice Details -->
  <line x1="40" y1="130" x2="560" y2="130" stroke="#eee" stroke-width="1"/>
  
  <text x="40" y="150" font-family="sans-serif" font-size="10" font-weight="bold">Invoice #: INV-1</text>
  <text x="40" y="165" font-family="sans-serif" font-size="10">Invoice Date: 16 Jun 2023</text>
  
  <text x="300" y="150" font-family="sans-serif" font-size="10" font-weight="bold">Bill To:</text>
  <text x="300" y="165" font-family="sans-serif" font-size="10">Amit Agarwal</text>
  <text x="300" y="180" font-family="sans-serif" font-size="10" fill="#666">Hitech City, Hyderabad</text>

  <!-- Table Header -->
  <rect x="40" y="210" width="520" height="25" fill="#f3f4f6"/>
  <text x="50" y="227" font-family="sans-serif" font-size="10" font-weight="bold">Item</text>
  <text x="350" y="227" font-family="sans-serif" font-size="10" font-weight="bold" text-anchor="end">Rate</text>
  <text x="420" y="227" font-family="sans-serif" font-size="10" font-weight="bold" text-anchor="end">Qty</text>
  <text x="550" y="227" font-family="sans-serif" font-size="10" font-weight="bold" text-anchor="end">Amount</text>

  <!-- Table Row 1 -->
  <text x="50" y="255" font-family="sans-serif" font-size="10" font-weight="bold">Samsung Galaxy F23</text>
  <text x="50" y="270" font-family="sans-serif" font-size="9" fill="#666">HSN: 8517</text>
  <text x="50" y="285" font-family="sans-serif" font-size="9" fill="#666">Color: Aqua Green</text>
  <text x="350" y="255" font-family="sans-serif" font-size="10" text-anchor="end">14,406.93</text>
  <text x="420" y="255" font-family="sans-serif" font-size="10" text-anchor="end">1</text>
  <text x="550" y="255" font-family="sans-serif" font-size="10" text-anchor="end">16,999.00</text>
  <line x1="40" y1="300" x2="560" y2="300" stroke="#eee" stroke-width="1"/>

  <!-- Table Row 2 -->
  <text x="50" y="320" font-family="sans-serif" font-size="10" font-weight="bold">Samsung 45W Travel Adapter</text>
  <text x="50" y="335" font-family="sans-serif" font-size="9" fill="#666">HSN: 8504</text>
  <text x="350" y="320" font-family="sans-serif" font-size="10" text-anchor="end">2,117.80</text>
  <text x="420" y="320" font-family="sans-serif" font-size="10" text-anchor="end">1</text>
  <text x="550" y="320" font-family="sans-serif" font-size="10" text-anchor="end">2,499.00</text>
  <line x1="40" y1="350" x2="560" y2="350" stroke="#eee" stroke-width="1"/>

  <!-- Totals -->
  <text x="450" y="380" font-family="sans-serif" font-size="10" text-anchor="end">Taxable Amount</text>
  <text x="550" y="380" font-family="sans-serif" font-size="10" text-anchor="end">16,523.73</text>
  
  <text x="450" y="400" font-family="sans-serif" font-size="10" text-anchor="end">IGST 18.0%</text>
  <text x="550" y="400" font-family="sans-serif" font-size="10" text-anchor="end">2,974.27</text>
  
  <line x1="400" y1="410" x2="560" y2="410" stroke="#000" stroke-width="1"/>
  <text x="450" y="430" font-family="sans-serif" font-size="12" font-weight="bold" text-anchor="end">Total</text>
  <text x="550" y="430" font-family="sans-serif" font-size="12" font-weight="bold" text-anchor="end">₹19,498.00</text>
  
  <!-- Footer -->
  <rect x="40" y="460" width="80" height="80" fill="white" stroke="#000"/>
  <rect x="45" y="465" width="70" height="70" fill="#000"/> <!-- QR Code Placeholder -->
  
  <text x="140" y="470" font-family="sans-serif" font-size="10" font-weight="bold">Bank Details:</text>
  <text x="140" y="485" font-family="sans-serif" font-size="9">Bank: YES BANK</text>
  <text x="140" y="500" font-family="sans-serif" font-size="9">Account #: 85789999222445</text>
  
  <circle cx="500" cy="480" r="20" stroke="#2563eb" stroke-width="2" fill="none"/>
  <text x="500" y="485" font-family="sans-serif" font-size="8" fill="#2563eb" text-anchor="middle">SIGNATURE</text>
</svg>
</file>

<file path="public/templates/modern.svg">
<svg width="200" height="280" viewBox="0 0 200 280" xmlns="http://www.w3.org/2000/svg">
  <rect width="200" height="280" fill="white"/>
  <rect x="0" y="20" width="200" height="4" fill="#2563eb"/>
  <rect x="20" y="40" width="60" height="10" fill="#2563eb"/>
  <rect x="20" y="60" width="40" height="4" fill="#9ca3af"/>
  <rect x="120" y="40" width="60" height="20" fill="#f3f4f6"/>
  <rect x="20" y="90" width="160" height="20" fill="#f3f4f6"/>
  <rect x="20" y="120" width="160" height="4" fill="#e5e7eb"/>
  <rect x="20" y="130" width="160" height="4" fill="#e5e7eb"/>
  <rect x="20" y="140" width="160" height="4" fill="#e5e7eb"/>
  <rect x="100" y="160" width="80" height="40" fill="#f9fafb"/>
</svg>
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/manifest.json">
{
  "name": "Swipe Invoice App",
  "short_name": "Swipe",
  "description": "Offline-first Invoice App for MSMEs",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#000000",
  "icons": [
    {
      "src": "/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="src/app/admin/create-shop/page.js">
'use client';

import { useState } from 'react';
import { api } from '@/api/backendClient';
import styles from './page.module.css';

export default function CreateShopPage() {
    const [formData, setFormData] = useState({
        shopName: '',
        adminPhone: '',
        adminName: '',
        setupSecret: ''
    });
    const [status, setStatus] = useState('idle'); // idle, loading, success, error
    const [message, setMessage] = useState('');
    const [result, setResult] = useState(null);

    const handleChange = (field) => (e) => {
        setFormData(prev => ({ ...prev, [field]: e.target.value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();

        // Validation
        if (!formData.shopName.trim()) {
            setStatus('error');
            setMessage('Shop name is required');
            return;
        }
        if (!formData.adminPhone.trim() || formData.adminPhone.replace(/\D/g, '').length !== 10) {
            setStatus('error');
            setMessage('Please enter a valid 10-digit phone number');
            return;
        }
        if (!formData.setupSecret.trim()) {
            setStatus('error');
            setMessage('Setup secret is required');
            return;
        }

        setStatus('loading');
        setMessage('');

        try {
            const response = await api.setup.bootstrap({
                shopName: formData.shopName.trim(),
                adminPhone: formData.adminPhone.replace(/\D/g, ''),
                setupSecret: formData.setupSecret
            });

            setStatus('success');
            setMessage('Shop created successfully!');
            setResult(response);
        } catch (error) {
            setStatus('error');
            setMessage(error.message || 'Failed to create shop. Please check your setup secret.');
        }
    };

    return (
        <div className={styles.container}>
            <div className={styles.card}>
                <h1 className={styles.title}>Create Shop</h1>
                <p className={styles.subtitle}>
                    Set up a new shop with an admin user.<br />
                    This is a one-time setup operation.
                </p>

                <form onSubmit={handleSubmit}>
                    <div className={styles.inputGroup}>
                        <label className={styles.label}>Shop Name *</label>
                        <input
                            type="text"
                            className={styles.input}
                            placeholder="e.g., My Jewelry Store"
                            value={formData.shopName}
                            onChange={handleChange('shopName')}
                            disabled={status === 'loading' || status === 'success'}
                        />
                    </div>

                    <div className={styles.inputGroup}>
                        <label className={styles.label}>Admin Phone Number *</label>
                        <input
                            type="tel"
                            className={styles.input}
                            placeholder="10-digit mobile number"
                            value={formData.adminPhone}
                            onChange={handleChange('adminPhone')}
                            maxLength={10}
                            disabled={status === 'loading' || status === 'success'}
                        />
                    </div>

                    <div className={styles.inputGroup}>
                        <label className={styles.label}>Admin Name (optional)</label>
                        <input
                            type="text"
                            className={styles.input}
                            placeholder="e.g., John Doe"
                            value={formData.adminName}
                            onChange={handleChange('adminName')}
                            disabled={status === 'loading' || status === 'success'}
                        />
                    </div>

                    <div className={styles.inputGroup}>
                        <label className={styles.label}>Setup Secret *</label>
                        <input
                            type="password"
                            className={styles.input}
                            placeholder="Enter setup password"
                            value={formData.setupSecret}
                            onChange={handleChange('setupSecret')}
                            disabled={status === 'loading' || status === 'success'}
                        />
                    </div>

                    <button
                        type="submit"
                        className={styles.button}
                        disabled={status === 'loading' || status === 'success'}
                    >
                        {status === 'loading' ? 'Creating...' : 'Create Shop'}
                    </button>
                </form>

                {message && (
                    <div className={`${styles.message} ${styles[status]}`}>
                        {message}
                    </div>
                )}

                {result && status === 'success' && (
                    <div className={styles.successDetails}>
                        <p><strong>Shop ID:</strong> {result.shop?.id}</p>
                        <p><strong>Shop Name:</strong> {result.shop?.name}</p>
                        <p><strong>Admin User ID:</strong> {result.user?.id}</p>
                        <p><strong>Admin Phone:</strong> {result.user?.phone}</p>
                        <p><strong>Role:</strong> {result.user?.role}</p>
                    </div>
                )}

                <a href="/" className={styles.backLink}>← Back to Home</a>
            </div>
        </div>
    );
}
</file>

<file path="src/app/admin/create-shop/page.module.css">
.container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 24px;
    background: var(--background);
}

.card {
    background: var(--card-bg);
    padding: 32px 24px;
    border-radius: 20px;
    width: 100%;
    max-width: 440px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.title {
    font-size: 24px;
    font-weight: 700;
    color: var(--foreground);
    margin-bottom: 8px;
    text-align: center;
}

.subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 32px;
    text-align: center;
    line-height: 1.5;
}

.inputGroup {
    margin-bottom: 16px;
}

.label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--foreground);
    margin-bottom: 6px;
}

.input {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid var(--border);
    border-radius: 12px;
    font-size: 16px;
    outline: none;
    background: #F9FAFB;
    transition: border-color 0.2s, background 0.2s;
}

.input:focus {
    border-color: var(--primary);
    background: white;
}

.button {
    width: 100%;
    padding: 16px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
    transition: opacity 0.2s;
}

.button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.button:hover:not(:disabled) {
    opacity: 0.9;
}

.message {
    margin-top: 16px;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 14px;
    text-align: center;
}

.error {
    background: #FEF2F2;
    color: #DC2626;
}

.success {
    background: #F0FDF4;
    color: #16A34A;
}

.successDetails {
    margin-top: 16px;
    padding: 16px;
    background: #F9FAFB;
    border-radius: 12px;
    font-size: 13px;
    text-align: left;
}

.successDetails p {
    margin: 6px 0;
    color: var(--text-secondary);
}

.successDetails strong {
    color: var(--foreground);
}

.backLink {
    display: block;
    margin-top: 20px;
    text-align: center;
    color: var(--primary);
    font-size: 14px;
    font-weight: 600;
    text-decoration: none;
}

.backLink:hover {
    text-decoration: underline;
}
</file>

<file path="src/app/admin/create-user/page.js">
'use client';

import { useState } from 'react';
import { api } from '@/api/backendClient';
import styles from './page.module.css';

export default function CreateUserPage() {
    const [formData, setFormData] = useState({
        phone: '',
        name: '',
        role: 'SALES'
    });
    const [status, setStatus] = useState('idle'); // idle, loading, success, error
    const [message, setMessage] = useState('');
    const [result, setResult] = useState(null);

    const handleChange = (field) => (e) => {
        setFormData(prev => ({ ...prev, [field]: e.target.value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();

        // Validation
        if (!formData.phone.trim() || formData.phone.replace(/\D/g, '').length !== 10) {
            setStatus('error');
            setMessage('Please enter a valid 10-digit phone number');
            return;
        }

        setStatus('loading');
        setMessage('');

        try {
            const response = await api.auth.createUser({
                phone: formData.phone.replace(/\D/g, ''),
                name: formData.name.trim() || undefined,
                role: formData.role
            });

            setStatus('success');
            setMessage('User created successfully!');
            setResult(response);

            // Reset form for next user
            setFormData({
                phone: '',
                name: '',
                role: 'SALES'
            });
        } catch (error) {
            setStatus('error');
            if (error.status === 401) {
                setMessage('You must be logged in as an admin to create users');
            } else if (error.status === 403) {
                setMessage('You do not have permission to create users. Admin access required.');
            } else {
                setMessage(error.message || 'Failed to create user');
            }
        }
    };

    const handleCreateAnother = () => {
        setStatus('idle');
        setMessage('');
        setResult(null);
    };

    return (
        <div className={styles.container}>
            <div className={styles.card}>
                <h1 className={styles.title}>Create User</h1>
                <p className={styles.subtitle}>
                    Add a new user to your shop.<br />
                    You must be logged in as an admin.
                </p>

                <form onSubmit={handleSubmit}>
                    <div className={styles.inputGroup}>
                        <label className={styles.label}>Phone Number *</label>
                        <input
                            type="tel"
                            className={styles.input}
                            placeholder="10-digit mobile number"
                            value={formData.phone}
                            onChange={handleChange('phone')}
                            maxLength={10}
                            disabled={status === 'loading'}
                        />
                    </div>

                    <div className={styles.inputGroup}>
                        <label className={styles.label}>Name (optional)</label>
                        <input
                            type="text"
                            className={styles.input}
                            placeholder="e.g., Sales Person"
                            value={formData.name}
                            onChange={handleChange('name')}
                            disabled={status === 'loading'}
                        />
                    </div>

                    <div className={styles.inputGroup}>
                        <label className={styles.label}>Role</label>
                        <select
                            className={styles.select}
                            value={formData.role}
                            onChange={handleChange('role')}
                            disabled={status === 'loading'}
                        >
                            <option value="SALES">SALES - Can create and update records</option>
                            <option value="ADMIN">ADMIN - Full access including delete and settings</option>
                        </select>
                    </div>

                    <button
                        type="submit"
                        className={styles.button}
                        disabled={status === 'loading'}
                    >
                        {status === 'loading' ? 'Creating...' : 'Create User'}
                    </button>
                </form>

                {message && (
                    <div className={`${styles.message} ${styles[status]}`}>
                        {message}
                    </div>
                )}

                {result && status === 'success' && (
                    <>
                        <div className={styles.successDetails}>
                            <p><strong>User ID:</strong> {result.id}</p>
                            <p><strong>Phone:</strong> {result.phone}</p>
                            <p><strong>Name:</strong> {result.name || '(not set)'}</p>
                            <p><strong>Role:</strong> {result.role}</p>
                        </div>
                        <button
                            type="button"
                            className={styles.button}
                            onClick={handleCreateAnother}
                            style={{ marginTop: '12px' }}
                        >
                            Create Another User
                        </button>
                    </>
                )}

                <div className={styles.note}>
                    💡 Users can log in with their phone number after being created.
                </div>

                <a href="/" className={styles.backLink}>← Back to Home</a>
            </div>
        </div>
    );
}
</file>

<file path="src/app/admin/create-user/page.module.css">
.container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 24px;
    background: var(--background);
}

.card {
    background: var(--card-bg);
    padding: 32px 24px;
    border-radius: 20px;
    width: 100%;
    max-width: 440px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.title {
    font-size: 24px;
    font-weight: 700;
    color: var(--foreground);
    margin-bottom: 8px;
    text-align: center;
}

.subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 32px;
    text-align: center;
    line-height: 1.5;
}

.inputGroup {
    margin-bottom: 16px;
}

.label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--foreground);
    margin-bottom: 6px;
}

.input {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid var(--border);
    border-radius: 12px;
    font-size: 16px;
    outline: none;
    background: #F9FAFB;
    transition: border-color 0.2s, background 0.2s;
}

.input:focus {
    border-color: var(--primary);
    background: white;
}

.select {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid var(--border);
    border-radius: 12px;
    font-size: 16px;
    outline: none;
    background: #F9FAFB;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 18px;
}

.select:focus {
    border-color: var(--primary);
    background-color: white;
}

.button {
    width: 100%;
    padding: 16px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
    transition: opacity 0.2s;
}

.button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.button:hover:not(:disabled) {
    opacity: 0.9;
}

.message {
    margin-top: 16px;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 14px;
    text-align: center;
}

.error {
    background: #FEF2F2;
    color: #DC2626;
}

.success {
    background: #F0FDF4;
    color: #16A34A;
}

.successDetails {
    margin-top: 16px;
    padding: 16px;
    background: #F9FAFB;
    border-radius: 12px;
    font-size: 13px;
    text-align: left;
}

.successDetails p {
    margin: 6px 0;
    color: var(--text-secondary);
}

.successDetails strong {
    color: var(--foreground);
}

.backLink {
    display: block;
    margin-top: 20px;
    text-align: center;
    color: var(--primary);
    font-size: 14px;
    font-weight: 600;
    text-decoration: none;
}

.backLink:hover {
    text-decoration: underline;
}

.note {
    margin-top: 16px;
    padding: 12px;
    background: #FFFBEB;
    border-radius: 10px;
    font-size: 13px;
    color: #92400E;
    text-align: center;
}
</file>

<file path="src/app/attendance/page.module.css">
.container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    background-color: #f8f9fa;
}

.header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background-color: #fff;
    border-bottom: 1px solid #eee;
}

.backButton {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
}

.title {
    font-size: 18px;
    font-weight: 600;
    color: #000;
}

.subtext {
    font-size: 12px;
    color: #666;
    margin-top: 2px;
}

.content {
    padding: 16px;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Status Card */
.statusCard {
    background: #fff;
    border-radius: 12px;
    padding: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border: 1px solid #eee;
    min-height: 200px;
}

.dateDisplay {
    font-size: 16px;
    color: #666;
    margin-bottom: 8px;
    font-weight: 500;
}

.loginButton {
    background: #2563eb;
    color: #fff;
    border: none;
    padding: 16px 32px;
    border-radius: 32px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: transform 0.1s;
}

.loginButton:active {
    transform: scale(0.98);
}

.disabledButton {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #bbf7d0;
    cursor: default;
}

.successBadge {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.successIcon {
    font-size: 48px;
    color: #166534;
}

.timeDisplay {
    font-size: 32px;
    font-weight: 700;
    color: #111;
    font-variant-numeric: tabular-nums;
}

.statusLabel {
    font-size: 14px;
    color: #166534;
    font-weight: 600;
    background: #dcfce7;
    padding: 4px 12px;
    border-radius: 12px;
}

/* History Section */
.historySection {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #eee;
}

.sectionHeader {
    padding: 16px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sectionTitle {
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

.viewAllLink {
    font-size: 14px;
    color: #2563eb;
    text-decoration: none;
    font-weight: 500;
}

.historyList {
    display: flex;
    flex-direction: column;
}

.historyItem {
    padding: 16px;
    border-bottom: 1px solid #f3f4f6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.historyItem:last-child {
    border-bottom: none;
}

.historyDate {
    font-weight: 500;
    color: #333;
}

.historyTime {
    font-size: 14px;
    color: #666;
}

.statusTag {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 4px;
    background: #dcfce7;
    color: #166534;
    font-weight: 500;
}

.emptyState {
    padding: 32px;
    text-align: center;
    color: #9ca3af;
    font-size: 14px;
}
</file>

<file path="src/app/bills/purchase/create/page.js">
'use client';

import PurchaseForm from '@/components/PurchaseForm';

export default function CreatePurchasePage() {
    return <PurchaseForm />;
}
</file>

<file path="src/app/bills/page.module.css">
.container {
    padding: 16px;
    padding-bottom: 80px;
    background: var(--background);
    min-height: 100vh;
}

.tabs {
    display: flex;
    background: var(--card-bg);
    padding: 0 16px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 10;
    overflow-x: auto;
}

.tab {
    padding: 16px;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    white-space: nowrap;
    font-size: 14px;
}

.activeTab {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

.summaryCard {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 16px;
    /* Card Radius */
    margin: 16px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.summaryLabel {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
    /* Medium */
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.summaryAmount {
    font-size: 18px;
    font-weight: 700;
    /* Bold */
    color: var(--foreground);
}

.pending {
    color: #EF4444;
    /* Red for pending */
}

.filterRow {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    overflow-x: auto;
    padding-bottom: 4px;
}

.filterChip {
    padding: 8px 16px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    white-space: nowrap;
}

.activeFilter {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.emptyState {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    text-align: center;
    background: var(--primary-light);
    border-radius: 16px;
    min-height: 200px;
    border: 1px dashed var(--primary);
}

.emptyText {
    color: var(--primary);
    font-weight: 700;
    margin-bottom: 8px;
    font-size: 16px;
}

.emptySub {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 16px;
    max-width: 250px;
    line-height: 1.4;
}

.link {
    color: var(--primary);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
}

.fab {
    position: fixed;
    bottom: 80px;
    right: 16px;
    background: var(--primary);
    color: white;
    padding: 12px 24px;
    border-radius: 24px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 20;
}

.listItem {
    background: var(--card-bg);
    padding: 16px;
    border-radius: 16px;
    /* Card Radius */
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.itemMain {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.itemTitle {
    font-weight: 600;
    color: var(--foreground);
    font-size: 14px;
    display: flex;
    align-items: center;
}

.itemSub {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
}

.itemAmount {
    font-weight: 700;
    color: var(--foreground);
    font-size: 16px;
}

.status {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 12px;
    background: #FEE2E2;
    color: #991B1B;
    margin-left: 8px;
    font-weight: 600;
}
</file>

<file path="src/app/coming-soon/page.js">
'use client';

import ComingSoon from '@/components/ComingSoon';

export default function ComingSoonPage() {
    return <ComingSoon />;
}
</file>

<file path="src/app/more/bills/expenses/create/page.js">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { FiChevronLeft, FiCalendar, FiChevronDown, FiCamera, FiUpload, FiCheck } from 'react-icons/fi';
import { FaPlayCircle } from 'react-icons/fa';
import { useExpenseStore } from '@/lib/store/expenseStore';
import CategoryModal from '@/components/Expenses/CategoryModal';
import AddCategoryModal from '@/components/Expenses/AddCategoryModal';
import styles from './page.module.css';

export default function CreateExpensePage() {
    const router = useRouter();
    const { addExpense } = useExpenseStore();

    const [amount, setAmount] = useState('');
    const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
    const [category, setCategory] = useState('');
    const [isPaid, setIsPaid] = useState(true);
    const [paymentType, setPaymentType] = useState('Cash');
    const [paymentDate, setPaymentDate] = useState(new Date().toISOString().split('T')[0]);
    const [description, setDescription] = useState('');

    const [showCategoryModal, setShowCategoryModal] = useState(false);
    const [showAddCategoryModal, setShowAddCategoryModal] = useState(false);
    const [categoryToEdit, setCategoryToEdit] = useState(null);

    const handleCreate = () => {
        if (!amount || !category) {
            alert('Please enter amount and select a category');
            return;
        }

        addExpense({
            amount,
            date,
            category,
            isPaid,
            paymentType: isPaid ? paymentType : null,
            paymentDate: isPaid ? paymentDate : null,
            description,
        });

        router.back();
    };

    const handleEditCategory = (cat) => {
        setCategoryToEdit(cat);
        setShowCategoryModal(false);
        setShowAddCategoryModal(true);
    };

    return (
        <div className={styles.container}>
            <header className={styles.header}>
                <div className={styles.headerLeft}>
                    <button onClick={() => router.back()} className={styles.backButton}>
                        <FiChevronLeft />
                    </button>
                    <h1 className={styles.title}>Create Expense</h1>
                </div>
                <FaPlayCircle className={styles.playButton} />
            </header>

            <div className={styles.content}>
                <div className={styles.formGroup}>
                    <label className={styles.label}>Enter Expense Amount</label>
                    <input
                        type="number"
                        value={amount}
                        onChange={(e) => setAmount(e.target.value)}
                        className={styles.input}
                        placeholder="0.00"
                    />
                </div>

                <div className={styles.formGroup}>
                    <label className={styles.label}>Expense Date</label>
                    <div className={styles.dateInputContainer}>
                        <input
                            type="date"
                            value={date}
                            onChange={(e) => setDate(e.target.value)}
                            className={styles.input}
                        />
                        <FiCalendar className={styles.calendarIcon} />
                    </div>
                </div>

                <div className={styles.formGroup}>
                    <button
                        className={`${styles.selectButton} ${category ? styles.selected : ''}`}
                        onClick={() => setShowCategoryModal(true)}
                    >
                        {category || 'Select Category'}
                        <FiChevronDown />
                    </button>
                </div>

                <div className={styles.toggleContainer}>
                    <label className={styles.toggleLabel}>Mark as Paid</label>
                    <label className={styles.toggleSwitch}>
                        <input
                            type="checkbox"
                            checked={isPaid}
                            onChange={(e) => setIsPaid(e.target.checked)}
                        />
                        <span className={styles.slider}></span>
                    </label>
                </div>

                {isPaid && (
                    <>
                        <div className={styles.formGroup}>
                            <label className={styles.label}>Select Type <span style={{ color: 'red' }}>*</span></label>
                            <div className={styles.paymentTypes}>
                                {['UPI', 'Cash', 'Card', 'Net Banking', 'Cheque', 'EMI'].map((type) => (
                                    <button
                                        key={type}
                                        className={`${styles.paymentType} ${paymentType === type ? styles.active : ''}`}
                                        onClick={() => setPaymentType(type)}
                                    >
                                        {paymentType === type && <div className={styles.checkIcon}><FiCheck /></div>}
                                        {type}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className={styles.formGroup}>
                            <label className={styles.label}>Payment date</label>
                            <div className={styles.dateInputContainer}>
                                <input
                                    type="date"
                                    value={paymentDate}
                                    onChange={(e) => setPaymentDate(e.target.value)}
                                    className={styles.input}
                                />
                                <FiCalendar className={styles.calendarIcon} />
                            </div>
                        </div>
                    </>
                )}

                <div className={styles.formGroup}>
                    <label className={styles.label}>Description</label>
                    <textarea
                        value={description}
                        onChange={(e) => setDescription(e.target.value)}
                        className={styles.textArea}
                        placeholder="Expense Description"
                    />
                </div>

                <div className={styles.formGroup}>
                    <label className={styles.label}>Attachments</label>
                    <div className={styles.attachmentButtons}>
                        <button className={styles.attachButton}>
                            <FiCamera /> Camera
                        </button>
                        <button className={styles.attachButton}>
                            <FiUpload /> Upload File
                        </button>
                    </div>
                </div>
            </div>

            <div className={styles.footer}>
                <button onClick={handleCreate} className={styles.createButton}>
                    Create <FiChevronLeft style={{ transform: 'rotate(180deg)' }} />
                </button>
            </div>

            {showCategoryModal && (
                <CategoryModal
                    onClose={() => setShowCategoryModal(false)}
                    onSelect={(cat) => {
                        setCategory(cat);
                        setShowCategoryModal(false);
                    }}
                    onEdit={handleEditCategory}
                />
            )}

            {showAddCategoryModal && (
                <AddCategoryModal
                    onClose={() => setShowAddCategoryModal(false)}
                    categoryToEdit={categoryToEdit}
                />
            )}
        </div>
    );
}
</file>

<file path="src/app/more/bills/expenses/create/page.module.css">
.container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background-color: #f8f9fa;
}

.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background-color: #fff;
    border-bottom: 1px solid #eee;
}

.headerLeft {
    display: flex;
    align-items: center;
}

.backButton {
    background: none;
    border: none;
    font-size: 24px;
    margin-right: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
}

.title {
    font-size: 18px;
    font-weight: 600;
    color: #000;
}

.playButton {
    color: #d32f2f;
    font-size: 24px;
    cursor: pointer;
}

.content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.formGroup {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.label {
    font-size: 12px;
    color: #666;
    margin-left: 4px;
}

.input {
    padding: 12px 16px;
    border: 1px solid #eee;
    border-radius: 8px;
    font-size: 16px;
    background-color: #f5f5f5;
    outline: none;
}

.input:focus {
    background-color: #fff;
    border-color: #2962ff;
}

.dateInputContainer {
    position: relative;
}

.calendarIcon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #2962ff;
    pointer-events: none;
}

.selectButton {
    padding: 12px 16px;
    border: 1px solid #eee;
    border-radius: 8px;
    font-size: 16px;
    background-color: #f5f5f5;
    color: #666;
    text-align: left;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

.selectButton.selected {
    color: #000;
}

.toggleContainer {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.toggleLabel {
    font-size: 14px;
    font-weight: 500;
    color: #333;
}

.toggleSwitch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 24px;
}

.toggleSwitch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 24px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked+.slider {
    background-color: #2962ff;
}

input:checked+.slider:before {
    transform: translateX(24px);
}

.paymentTypes {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.paymentType {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    border: none;
    cursor: pointer;
    background-color: #eee;
    color: #333;
    display: flex;
    align-items: center;
    gap: 6px;
}

.paymentType.active {
    background-color: #e8f5e9;
    color: #2e7d32;
    font-weight: 500;
}

.checkIcon {
    font-size: 12px;
}

.textArea {
    padding: 12px 16px;
    border: 1px solid #eee;
    border-radius: 8px;
    font-size: 16px;
    background-color: #fff;
    outline: none;
    min-height: 100px;
    resize: none;
}

.attachmentButtons {
    display: flex;
    gap: 16px;
}

.attachButton {
    flex: 1;
    padding: 12px;
    border: 1px solid #eee;
    border-radius: 8px;
    background-color: #fff;
    color: #2962ff;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
}

.footer {
    padding: 16px;
    background-color: #fff;
    border-top: 1px solid #eee;
}

.createButton {
    width: 100%;
    padding: 14px;
    background-color: #2962ff;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

/* Modal Styles */
.modalOverlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: flex-end;
    z-index: 1000;
}

.modalContent {
    background-color: #fff;
    width: 100%;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        transform: translateY(100%);
    }

    to {
        transform: translateY(0);
    }
}

.modalHeader {
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
}

.modalTitle {
    font-size: 18px;
    font-weight: 600;
    color: #000;
}

.closeButton {
    background: none;
    border: none;
    font-size: 24px;
    color: #666;
    cursor: pointer;
}

.modalBody {
    padding: 16px;
    overflow-y: auto;
    flex: 1;
}

.modalSearch {
    display: flex;
    align-items: center;
    background-color: #f5f5f5;
    padding: 10px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
}

.modalSearchInput {
    border: none;
    background: none;
    outline: none;
    flex: 1;
    margin-left: 8px;
    font-size: 14px;
}

.categoryList {
    display: flex;
    flex-direction: column;
}

.categoryItem {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f5f5f5;
    cursor: pointer;
}

.categoryName {
    font-size: 16px;
    color: #333;
}

.editIcon {
    color: #666;
    font-size: 16px;
}

.modalFooter {
    padding: 16px;
    border-top: 1px solid #eee;
}

.addCategoryButton {
    width: 100%;
    padding: 14px;
    background-color: #2962ff;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}

.deleteButton {
    flex: 1;
    padding: 14px;
    background-color: #d32f2f;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}

.saveButton {
    flex: 1;
    padding: 14px;
    background-color: #2962ff;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}

.modalActions {
    display: flex;
    gap: 16px;
}
</file>

<file path="src/app/more/bills/expenses/page.js">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { FiChevronLeft, FiSearch, FiChevronDown, FiPlus } from 'react-icons/fi';
import { useExpenseStore } from '@/lib/store/expenseStore';
import styles from './page.module.css';

export default function ExpensesPage() {
    const router = useRouter();
    const { expenses } = useExpenseStore();
    const [activeTab, setActiveTab] = useState('All Transactions');
    const [searchQuery, setSearchQuery] = useState('');

    const filteredExpenses = expenses.filter((expense) => {
        const matchesSearch = expense.category.toLowerCase().includes(searchQuery.toLowerCase()) ||
            (expense.description && expense.description.toLowerCase().includes(searchQuery.toLowerCase()));

        if (activeTab === 'All Transactions') return matchesSearch;
        if (activeTab === 'Paid') return matchesSearch && expense.isPaid;
        if (activeTab === 'Pending') return matchesSearch && !expense.isPaid;
        if (activeTab === 'Cancelled') return matchesSearch && expense.status === 'cancelled'; // Assuming we add cancelled status later
        return matchesSearch;
    });

    const totalAmount = expenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
    const pendingAmount = expenses.filter(exp => !exp.isPaid).reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);

    const formatDate = (dateString) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    };

    return (
        <div className={styles.container}>
            <header className={styles.header}>
                <button onClick={() => router.back()} className={styles.backButton}>
                    <FiChevronLeft />
                </button>
                <h1 className={styles.title}>Expenses</h1>
            </header>

            <div className={styles.content}>
                <div className={styles.searchSection}>
                    <FiSearch color="#888" size={18} />
                    <input
                        type="text"
                        placeholder="Search..."
                        className={styles.searchInput}
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                    <button className={styles.filterButton}>
                        This Year <FiChevronDown />
                    </button>
                </div>

                <div className={styles.summaryCard}>
                    <div className={styles.summaryHeader}>
                        <div className={styles.summaryLabel}>Total Amount <FiChevronDown /></div>
                        <div className={styles.pendingLabel}>Pending</div>
                    </div>
                    <div className={styles.summaryHeader}>
                        <div className={styles.totalAmount}>{totalAmount.toFixed(2)}</div>
                        <div className={styles.pendingAmount}>{pendingAmount.toFixed(2)}</div>
                    </div>
                </div>

                <div className={styles.tabs}>
                    {['All Transactions', 'Paid', 'Pending', 'Cancelled'].map((tab) => (
                        <button
                            key={tab}
                            className={`${styles.tab} ${activeTab === tab ? styles.active : ''}`}
                            onClick={() => setActiveTab(tab)}
                        >
                            {tab}
                            {tab === 'All Transactions' && <span className={styles.tabCount}>{expenses.length}</span>}
                        </button>
                    ))}
                </div>

                <div className={styles.transactionList}>
                    {filteredExpenses.map((expense, index) => (
                        <div key={expense.id} className={styles.transactionCard}>
                            <div className={styles.cardHeader}>
                                <span className={styles.cardId}>#{expenses.length - index}</span>
                                <span className={styles.cardAmount}>₹{parseFloat(expense.amount).toFixed(2)}</span>
                            </div>
                            <div className={styles.cardHeader}>
                                <span className={styles.cardCategory}>{expense.category}</span>
                                <span className={`${styles.cardStatus} ${expense.isPaid ? styles.statusPaid : styles.statusPending}`}>
                                    {expense.isPaid ? 'paid' : 'pending'}
                                </span>
                            </div>
                            <div className={styles.cardDate}>{formatDate(expense.date)}</div>
                        </div>
                    ))}
                </div>
            </div>

            <Link href="/more/bills/expenses/create" className={styles.createButton}>
                <FiPlus /> CREATE EXPENSE
            </Link>
        </div>
    );
}
</file>

<file path="src/app/more/bills/expenses/page.module.css">
.container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background-color: #f8f9fa;
}

.header {
    display: flex;
    align-items: center;
    padding: 16px;
    background-color: #fff;
    border-bottom: 1px solid #eee;
}

.backButton {
    background: none;
    border: none;
    font-size: 24px;
    margin-right: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
}

.title {
    font-size: 18px;
    font-weight: 600;
    color: #000;
}

.content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.searchSection {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: #fff;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.searchInput {
    border: none;
    outline: none;
    font-size: 14px;
    flex: 1;
    margin-left: 8px;
}

.filterButton {
    background: none;
    border: none;
    font-size: 14px;
    font-weight: 500;
    color: #333;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
}

.summaryCard {
    background-color: #fff;
    padding: 16px;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.summaryHeader {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.summaryLabel {
    font-size: 14px;
    color: #333;
    display: flex;
    align-items: center;
    gap: 4px;
}

.pendingLabel {
    font-size: 14px;
    color: #333;
}

.totalAmount {
    font-size: 18px;
    font-weight: 700;
    color: #000;
}

.pendingAmount {
    font-size: 18px;
    font-weight: 700;
    color: #e53935;
    text-align: right;
}

.tabs {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 4px;
}

.tab {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    white-space: nowrap;
    background-color: #eee;
    color: #666;
}

.tab.active {
    background-color: #2962ff;
    color: #fff;
}

.tabCount {
    background-color: #fff;
    color: #2962ff;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    margin-left: 6px;
}

.tab.active .tabCount {
    background-color: #fff;
    color: #2962ff;
}

.transactionList {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.transactionCard {
    background-color: #fff;
    padding: 16px;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.cardHeader {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.cardId {
    font-size: 12px;
    color: #666;
}

.cardAmount {
    font-size: 16px;
    font-weight: 600;
    color: #000;
}

.cardCategory {
    font-size: 15px;
    font-weight: 500;
    color: #333;
}

.cardStatus {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 500;
    text-transform: uppercase;
}

.statusPaid {
    background-color: #e8f5e9;
    color: #2e7d32;
}

.statusPending {
    background-color: #ffebee;
    color: #c62828;
}

.cardDate {
    font-size: 12px;
    color: #888;
}

.createButton {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #2962ff;
    color: #fff;
    border: none;
    border-radius: 24px;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(41, 98, 255, 0.3);
    cursor: pointer;
    z-index: 100;
    text-decoration: none;
}
</file>

<file path="src/app/more/diagnostics/page.js">
'use client';

import { useState, useEffect, useCallback, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { FiArrowLeft, FiDownload, FiChevronDown, FiChevronUp, FiRefreshCw } from 'react-icons/fi';
import { DIAGNOSTICS_ENABLED } from '@/lib/utils/isDiagnosticsEnabled';
import styles from './page.module.css';

const LOG_LEVELS = ['debug', 'info', 'warn', 'error', 'audit'];
const PAGE_SIZE = 50;

export default function DiagnosticsPage() {
    const router = useRouter();

    // Guard: Return null if diagnostics not enabled (dead code in prod)
    if (!DIAGNOSTICS_ENABLED) {
        return null;
    }

    const [logs, setLogs] = useState([]);
    const [total, setTotal] = useState(0);
    const [hasMore, setHasMore] = useState(false);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // Filters
    const [selectedLevels, setSelectedLevels] = useState([]);
    const [eventSearch, setEventSearch] = useState('');
    const [startDate, setStartDate] = useState('');
    const [endDate, setEndDate] = useState('');
    const [offset, setOffset] = useState(0);

    // UI State
    const [expandedLogs, setExpandedLogs] = useState(new Set());
    const [showExportDialog, setShowExportDialog] = useState(false);
    const [excludeAudit, setExcludeAudit] = useState(false);
    const [exporting, setExporting] = useState(false);

    // Load logs
    const loadLogs = useCallback(async (resetOffset = true) => {
        setLoading(true);
        setError(null);

        try {
            // Dynamic import to support tree-shaking
            const { getDevice } = await import('@/lib/logger/context');
            const device = getDevice();

            let storage;
            if (device !== 'web') {
                const { CapacitorStorage } = await import('@/lib/logger/storage/capacitorFs');
                storage = new CapacitorStorage();
            } else {
                const { IndexedDbStorage } = await import('@/lib/logger/storage/indexedDb');
                storage = new IndexedDbStorage();
            }
            await storage.init();

            const currentOffset = resetOffset ? 0 : offset;

            const result = await storage.query({
                levels: selectedLevels.length > 0 ? selectedLevels : undefined,
                event: eventSearch || undefined,
                startTime: startDate ? new Date(startDate).toISOString() : undefined,
                endTime: endDate ? new Date(endDate + 'T23:59:59').toISOString() : undefined,
                limit: PAGE_SIZE,
                offset: currentOffset,
            });

            if (resetOffset) {
                setLogs(result.entries);
                setOffset(PAGE_SIZE);
            } else {
                setLogs(prev => [...prev, ...result.entries]);
                setOffset(prev => prev + PAGE_SIZE);
            }

            setTotal(result.total);
            setHasMore(result.hasMore);
        } catch (e) {
            console.error('Failed to load logs:', e);
            setError('Failed to load logs. Please try again.');
        } finally {
            setLoading(false);
        }
    }, [selectedLevels, eventSearch, startDate, endDate, offset]);

    // Initial load
    useEffect(() => {
        loadLogs(true);
    }, []);

    // Reload when filters change
    useEffect(() => {
        const timer = setTimeout(() => {
            loadLogs(true);
        }, 300); // Debounce

        return () => clearTimeout(timer);
    }, [selectedLevels, eventSearch, startDate, endDate]);

    // Toggle level filter
    const toggleLevel = (level) => {
        setSelectedLevels(prev =>
            prev.includes(level)
                ? prev.filter(l => l !== level)
                : [...prev, level]
        );
    };

    // Toggle log expansion
    const toggleExpand = (timestamp) => {
        setExpandedLogs(prev => {
            const next = new Set(prev);
            if (next.has(timestamp)) {
                next.delete(timestamp);
            } else {
                next.add(timestamp);
            }
            return next;
        });
    };

    // Export handler
    const handleExport = async () => {
        if (excludeAudit) {
            setShowExportDialog(true);
        } else {
            await performExport(true);
        }
    };

    const performExport = async (includeAudit) => {
        setExporting(true);
        setShowExportDialog(false);

        try {
            const { exportOrShareLogs } = await import('@/lib/logger/export');
            await exportOrShareLogs({
                includeAudit,
                applyRedaction: true,
                format: 'json',
            });
        } catch (e) {
            console.error('Export failed:', e);
            setError('Failed to export logs. Please try again.');
        } finally {
            setExporting(false);
        }
    };

    const formatTimestamp = (iso) => {
        const date = new Date(iso);
        return date.toLocaleString();
    };

    return (
        <div className={styles.container}>
            <div className={styles.header}>
                <button className={styles.backButton} onClick={() => router.back()}>
                    <FiArrowLeft size={20} />
                </button>
                <h1 className={styles.title}>Diagnostics</h1>
            </div>

            {error && <div className={styles.error}>{error}</div>}

            {/* Filters */}
            <div className={styles.filterBar}>
                <div className={styles.filterRow}>
                    {LOG_LEVELS.map(level => (
                        <button
                            key={level}
                            className={`${styles.levelChip} ${styles[level]} ${selectedLevels.includes(level) ? styles.active : ''}`}
                            onClick={() => toggleLevel(level)}
                        >
                            {level}
                        </button>
                    ))}
                </div>
                <div className={styles.filterRow}>
                    <input
                        type="text"
                        className={styles.searchInput}
                        placeholder="Search events..."
                        value={eventSearch}
                        onChange={e => setEventSearch(e.target.value)}
                    />
                </div>
                <div className={styles.filterRow}>
                    <input
                        type="date"
                        className={styles.dateInput}
                        value={startDate}
                        onChange={e => setStartDate(e.target.value)}
                        placeholder="Start date"
                    />
                    <span style={{ color: 'var(--text-muted)' }}>to</span>
                    <input
                        type="date"
                        className={styles.dateInput}
                        value={endDate}
                        onChange={e => setEndDate(e.target.value)}
                        placeholder="End date"
                    />
                </div>
            </div>

            {/* Actions */}
            <div className={styles.actions}>
                <button
                    className={`${styles.exportButton} ${styles.primary}`}
                    onClick={handleExport}
                    disabled={exporting}
                >
                    <FiDownload size={16} />
                    {exporting ? 'Exporting...' : 'Export Logs'}
                </button>
                <button className={styles.exportButton} onClick={() => loadLogs(true)} disabled={loading}>
                    <FiRefreshCw size={16} />
                    Refresh
                </button>
            </div>

            {/* Stats */}
            <div className={styles.stats}>
                Showing {logs.length} of {total} logs
            </div>

            {/* Log List */}
            {loading && logs.length === 0 ? (
                <div className={styles.loading}>Loading logs...</div>
            ) : logs.length === 0 ? (
                <div className={styles.empty}>No logs found matching your filters.</div>
            ) : (
                <div className={styles.logList}>
                    {logs.map(log => (
                        <div
                            key={log.timestamp}
                            className={styles.logCard}
                            onClick={() => toggleExpand(log.timestamp)}
                        >
                            <div className={styles.logHeader}>
                                <span className={`${styles.levelBadge} ${styles[log.level]}`}>
                                    {log.level}
                                </span>
                                <span className={styles.timestamp}>{formatTimestamp(log.timestamp)}</span>
                            </div>
                            <div className={styles.eventName}>{log.event}</div>
                            <div className={styles.sessionInfo}>
                                Session: {log.sessionId?.slice(0, 8)}... | {log.device} | v{log.appVersion}
                            </div>

                            {Object.keys(log.context || {}).length > 0 && (
                                <div className={styles.contextWrapper}>
                                    <div className={styles.contextToggle}>
                                        {expandedLogs.has(log.timestamp) ? (
                                            <>
                                                <FiChevronUp size={14} /> Hide Context
                                            </>
                                        ) : (
                                            <>
                                                <FiChevronDown size={14} /> Show Context
                                            </>
                                        )}
                                    </div>
                                    {expandedLogs.has(log.timestamp) && (
                                        <pre className={styles.contextJson}>
                                            {JSON.stringify(log.context, null, 2)}
                                        </pre>
                                    )}
                                </div>
                            )}
                        </div>
                    ))}

                    {hasMore && (
                        <div className={styles.loadMore} onClick={() => loadLogs(false)}>
                            {loading ? 'Loading...' : 'Load More'}
                        </div>
                    )}
                </div>
            )}

            {/* Export Confirmation Dialog */}
            {showExportDialog && (
                <div className={styles.overlay} onClick={() => setShowExportDialog(false)}>
                    <div className={styles.dialog} onClick={e => e.stopPropagation()}>
                        <div className={styles.dialogTitle}>Exclude Audit Logs?</div>
                        <div className={styles.dialogText}>
                            You have chosen to exclude audit logs from the export. Audit logs contain
                            important security and compliance information. Are you sure you want to
                            proceed without them?
                        </div>
                        <div className={styles.checkboxRow}>
                            <input
                                type="checkbox"
                                id="confirmExclude"
                                checked={excludeAudit}
                                onChange={e => setExcludeAudit(e.target.checked)}
                            />
                            <label htmlFor="confirmExclude">Yes, exclude audit logs</label>
                        </div>
                        <div className={styles.dialogActions}>
                            <button
                                className={`${styles.dialogButton} ${styles.secondary}`}
                                onClick={() => setShowExportDialog(false)}
                            >
                                Cancel
                            </button>
                            <button
                                className={`${styles.dialogButton} ${styles.danger}`}
                                onClick={() => performExport(false)}
                            >
                                Export Without Audit
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}
</file>

<file path="src/app/more/diagnostics/page.module.css">
.container {
    padding: 16px;
    padding-bottom: 80px;
    background: var(--background);
    min-height: 100vh;
}

.header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.backButton {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    cursor: pointer;
    color: var(--foreground);
}

.title {
    font-size: 20px;
    font-weight: 700;
    color: var(--foreground);
}

.filterBar {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.filterRow {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
}

.filterRow:last-child {
    margin-bottom: 0;
}

.levelChip {
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--background);
    color: var(--text-secondary);
    transition: all 0.2s;
}

.levelChip.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.levelChip.debug {
    border-color: #9CA3AF;
}

.levelChip.debug.active {
    background: #9CA3AF;
    border-color: #9CA3AF;
}

.levelChip.info {
    border-color: #3B82F6;
}

.levelChip.info.active {
    background: #3B82F6;
    border-color: #3B82F6;
}

.levelChip.warn {
    border-color: #F59E0B;
}

.levelChip.warn.active {
    background: #F59E0B;
    border-color: #F59E0B;
}

.levelChip.error {
    border-color: #EF4444;
}

.levelChip.error.active {
    background: #EF4444;
    border-color: #EF4444;
}

.levelChip.audit {
    border-color: #8B5CF6;
}

.levelChip.audit.active {
    background: #8B5CF6;
    border-color: #8B5CF6;
}

.searchInput {
    flex: 1;
    min-width: 150px;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--background);
    color: var(--foreground);
    font-size: 14px;
}

.searchInput::placeholder {
    color: var(--text-muted);
}

.dateInput {
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--background);
    color: var(--foreground);
    font-size: 12px;
}

.actions {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.exportButton {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--card-bg);
    color: var(--foreground);
    transition: all 0.2s;
}

.exportButton:hover {
    background: var(--primary-light);
}

.exportButton.primary {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.stats {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 12px;
}

.logList {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.logCard {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 12px 16px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    cursor: pointer;
    transition: all 0.2s;
}

.logCard:active {
    background: #F9FAFB;
}

.logHeader {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
}

.levelBadge {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
}

.levelBadge.debug {
    background: #F3F4F6;
    color: #6B7280;
}

.levelBadge.info {
    background: #DBEAFE;
    color: #1D4ED8;
}

.levelBadge.warn {
    background: #FEF3C7;
    color: #D97706;
}

.levelBadge.error {
    background: #FEE2E2;
    color: #DC2626;
}

.levelBadge.audit {
    background: #EDE9FE;
    color: #7C3AED;
}

.timestamp {
    font-size: 11px;
    color: var(--text-muted);
    font-family: monospace;
}

.eventName {
    font-size: 14px;
    font-weight: 600;
    color: var(--foreground);
}

.sessionInfo {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 4px;
}

.contextWrapper {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
}

.contextToggle {
    font-size: 12px;
    color: var(--primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
}

.contextJson {
    margin-top: 8px;
    padding: 12px;
    background: var(--background);
    border-radius: 8px;
    font-family: monospace;
    font-size: 11px;
    color: var(--text-secondary);
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 200px;
    overflow-y: auto;
}

.loadMore {
    padding: 12px;
    text-align: center;
    color: var(--primary);
    font-weight: 600;
    cursor: pointer;
    background: var(--card-bg);
    border-radius: 12px;
    margin-top: 8px;
}

.empty {
    text-align: center;
    padding: 40px;
    color: var(--text-muted);
}

.error {
    background: #FEE2E2;
    color: #DC2626;
    padding: 12px 16px;
    border-radius: 10px;
    margin-bottom: 16px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: var(--text-muted);
}

/* Confirmation Dialog */
.overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 1000;
}

.dialog {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 24px;
    max-width: 400px;
    width: 100%;
}

.dialogTitle {
    font-size: 18px;
    font-weight: 700;
    color: var(--foreground);
    margin-bottom: 12px;
}

.dialogText {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 20px;
    line-height: 1.5;
}

.dialogActions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.dialogButton {
    padding: 10px 20px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: none;
}

.dialogButton.secondary {
    background: var(--background);
    color: var(--foreground);
    border: 1px solid var(--border);
}

.dialogButton.danger {
    background: #EF4444;
    color: white;
}

.checkboxRow {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
}

.checkboxRow input {
    width: 18px;
    height: 18px;
}

.checkboxRow label {
    font-size: 14px;
    color: var(--foreground);
}
</file>

<file path="src/app/more/label-templates/page.module.css">
.container {
    min-height: 100vh;
    background: #f8fafc;
    padding-bottom: 80px;
}

.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: white;
    border-bottom: 1px solid #e5e7eb;
}

.title {
    font-size: 18px;
    font-weight: 600;
    color: #111827;
    margin: 0;
}

.toggleContainer {
    display: flex;
    gap: 8px;
    padding: 16px;
    background: white;
}

.toggleBtn {
    flex: 1;
    padding: 10px 16px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.toggleBtn.active {
    background: #2563eb;
    color: white;
    border-color: #2563eb;
}

.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 16px;
    padding: 16px;
}

.card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    border: 2px solid transparent;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.card.selected {
    border-color: #2563eb;
}

.checkBadge {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    background: #2563eb;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.previewContainer {
    width: 100%;
    aspect-ratio: 4/3;
    background: #f9fafb;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 16px;
    overflow: hidden;
}

.previewImage {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

.previewPlaceholder {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.barcodePlaceholder {
    width: 80%;
    height: 32px;
    background: linear-gradient(90deg, #333 2px, transparent 2px) 0 0 / 4px 100%;
}

.textPlaceholder {
    width: 60%;
    height: 8px;
    background: #d1d5db;
    border-radius: 4px;
}

.weightBig {
    font-size: 24px;
    font-weight: 700;
    color: #111827;
    margin-top: 8px;
}

.cardContent {
    padding: 12px;
    border-top: 1px solid #f3f4f6;
}

.templateName {
    margin: 0 0 4px;
    font-size: 14px;
    font-weight: 600;
    color: #111827;
}

.templateDesc {
    margin: 0;
    font-size: 12px;
    color: #6b7280;
    line-height: 1.4;
}

.note {
    text-align: center;
    padding: 24px;
    color: #9ca3af;
    font-size: 13px;
    font-style: italic;
}

.savingIndicator {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: #111827;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
}
</file>

<file path="src/app/more/masters/page.js">
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';

export default function MastersPage() {
    const router = useRouter();

    useEffect(() => {
        router.replace('/more/masters/products');
    }, []);

    return null;
}
</file>

<file path="src/app/more/profile/page.module.css">
.container {
    padding: 16px;
    padding-bottom: 80px;
    background: #f3f4f6;
    min-height: 100vh;
}

.header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    font-size: 18px;
    font-weight: 600;
}

.sectionLabel {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 12px;
    color: #1f2937;
    margin-left: 4px;
}

.card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 24px;
}

.item {
    display: flex;
    align-items: center;
    padding: 16px;
    gap: 16px;
    border-bottom: 1px solid #f3f4f6;
    cursor: pointer;
}

.item:last-child {
    border-bottom: none;
}

.icon {
    color: #4b5563;
    font-size: 20px;
}

.content {
    flex: 1;
}

.label {
    font-size: 14px;
    color: #1f2937;
    margin-bottom: 2px;
}

.subLabel {
    font-size: 12px;
    color: #6b7280;
}

.arrow {
    color: var(--primary);
}

.dangerItem {
    display: flex;
    align-items: center;
    padding: 16px;
    gap: 16px;
    border-bottom: 1px solid #f3f4f6;
    cursor: pointer;
    color: #ef4444;
}

.dangerIcon {
    font-size: 20px;
}

.dangerLabel {
    flex: 1;
    font-size: 14px;
}

.footer {
    text-align: center;
    margin-top: 40px;
}

.supportButton {
    background: white;
    border: 1px solid #e5e7eb;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    color: #1f2937;
}
</file>

<file path="src/app/more/server-config/page.js">
'use client';

import { useRouter } from 'next/navigation';
import ServerSetup from '@/components/ServerConfig/ServerSetup';

export default function ServerConfigPage() {
    const router = useRouter();

    return (
        <ServerSetup onConfigured={() => {
            router.back();
            // Alternatively, trigger a refresh/reauth if key info changed
        }} />
    );
}
</file>

<file path="src/app/more/templates/lending/page.js">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useSettingsStore } from '@/lib/store/settingsStore';
import { templates } from '@/components/InvoiceTemplates';
import { FiArrowLeft, FiCheck } from 'react-icons/fi';

export default function LendingTemplatesPage() {
    const router = useRouter();
    const { lendingBillTemplateId, setLendingBillTemplateId, loadSettings } = useSettingsStore();
    const [selectedId, setSelectedId] = useState('modern');

    useEffect(() => {
        loadSettings();
    }, []);

    useEffect(() => {
        if (lendingBillTemplateId) {
            setSelectedId(lendingBillTemplateId);
        }
    }, [lendingBillTemplateId]);

    const handleSave = async () => {
        await setLendingBillTemplateId(selectedId);
        router.back();
    };

    const selectedTemplate = templates[selectedId] || templates.modern;

    return (
        <div style={{ background: '#f3f4f6', minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
            {/* Header */}
            <div style={{
                background: 'white',
                padding: '16px',
                display: 'flex',
                alignItems: 'center',
                gap: 12,
                borderBottom: '1px solid #e5e7eb',
                position: 'sticky', top: 0, zIndex: 10
            }}>
                <FiArrowLeft size={24} onClick={() => router.back()} style={{ cursor: 'pointer' }} />
                <div style={{ fontWeight: 700, fontSize: 18 }}>Lending Bill Template</div>
            </div>

            {/* Preview Area */}
            <div style={{ flex: 1, overflow: 'auto', padding: '20px', display: 'flex', justifyContent: 'center', background: '#f3f4f6' }}>
                <div style={{
                    width: '100%', maxWidth: '400px',
                    boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    borderRadius: '8px', overflow: 'hidden'
                }}>
                    <img
                        src={selectedTemplate.previewImage}
                        alt="Template Preview"
                        style={{ width: '100%', height: 'auto', display: 'block' }}
                    />
                </div>
            </div>

            {/* Template Selector */}
            <div style={{
                background: 'white',
                padding: '20px',
                borderTop: '1px solid #e5e7eb',
                zIndex: 10
            }}>
                <div style={{ marginBottom: '16px' }}>
                    <div style={{ fontWeight: 600 }}>Choose Lending Bill Template</div>
                    <div style={{ fontSize: '12px', color: '#6b7280', marginTop: '4px' }}>This template controls the layout and styling of your Lending Bill PDFs.</div>
                </div>
                <div style={{ display: 'flex', gap: '16px', overflowX: 'auto', paddingBottom: '8px' }}>
                    {Object.values(templates).map((template) => (
                        <div
                            key={template.id}
                            onClick={() => setSelectedId(template.id)}
                            style={{
                                minWidth: '100px',
                                cursor: 'pointer',
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                gap: '8px'
                            }}
                        >
                            <div style={{
                                width: '80px',
                                height: '100px',
                                border: selectedId === template.id ? '2px solid #2563eb' : '1px solid #e5e7eb',
                                borderRadius: '8px',
                                background: '#f9fafb',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                position: 'relative',
                                overflow: 'hidden'
                            }}>
                                <img
                                    src={template.thumbnail}
                                    alt={template.name}
                                    style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                                />
                                {selectedId === template.id && (
                                    <div style={{
                                        position: 'absolute', top: 4, right: 4,
                                        background: '#2563eb', borderRadius: '50%',
                                        width: 16, height: 16, display: 'flex', alignItems: 'center', justifyContent: 'center'
                                    }}>
                                        <FiCheck size={10} color="white" />
                                    </div>
                                )}
                            </div>
                            <div style={{ fontSize: '12px', fontWeight: selectedId === template.id ? 600 : 400 }}>
                                {template.name}
                            </div>
                        </div>
                    ))}
                </div>

                <button
                    onClick={handleSave}
                    style={{
                        width: '100%',
                        background: '#2563eb',
                        color: 'white',
                        border: 'none',
                        padding: '14px',
                        borderRadius: '8px',
                        fontWeight: 600,
                        marginTop: '16px'
                    }}
                >
                    Save & Update
                </button>
            </div>
        </div>
    );
}
</file>

<file path="src/app/parties/payment/create/page.module.css">
.container {
    background-color: #f9fafb;
    min-height: 100vh;
    padding-bottom: 100px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

.header {
    background-color: white;
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #e5e7eb;
    position: sticky;
    top: 0;
    z-index: 10;
}

.headerTitle {
    font-size: 18px;
    font-weight: 600;
    color: #111827;
}

.headerSubtitle {
    font-size: 12px;
    color: #6b7280;
}

.content {
    padding: 16px;
}

.sectionTitle {
    font-size: 14px;
    color: #374151;
    margin-bottom: 4px;
}

.sectionTitleBold {
    font-size: 16px;
    font-weight: 700;
    color: #111827;
    margin-bottom: 16px;
}

.inputGroup {
    margin-bottom: 20px;
}

.label {
    font-size: 14px;
    color: #4b5563;
    margin-bottom: 8px;
    display: block;
}

.resetLink {
    font-size: 12px;
    color: #ef4444;
    cursor: pointer;
    font-weight: 500;
}

.amountInputContainer {
    position: relative;
    background: white;
    border: 1px solid #16a34a;
    border-radius: 8px;
    padding: 12px;
    display: flex;
    align-items: center;
}

.currencySymbol {
    font-size: 20px;
    font-weight: 600;
    color: #111827;
    margin-right: 4px;
}

.amountInput {
    border: none;
    outline: none;
    font-size: 20px;
    font-weight: 600;
    width: 100%;
    color: #111827;
}

.pendingText {
    font-size: 12px;
    color: #9ca3af;
    margin-top: 4px;
}

.dateInputContainer {
    position: relative;
}

.dateInput {
    width: 100%;
    padding: 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    font-size: 14px;
    color: #111827;
    outline: none;
}

.calendarIcon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    pointer-events: none;
}

.chipContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.chip {
    padding: 8px 16px;
    background: #f3f4f6;
    border-radius: 20px;
    font-size: 14px;
    color: #374151;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: 500;
}

.activeChip {
    background: #dcfce7;
    color: #166534;
}

.checkIcon {
    font-size: 12px;
}

.addNewButton {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #e5e7eb;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    cursor: pointer;
}

.textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
    min-height: 80px;
    resize: vertical;
}

.divider {
    height: 1px;
    background: #e5e7eb;
    margin: 24px 0;
}

.attachmentButtons {
    display: flex;
    gap: 12px;
}

.attachmentButton {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background: white;
    border: 1px solid #e5e7eb;
    padding: 12px;
    border-radius: 8px;
    color: #2563eb;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
}

.toggleGroup {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #f3f4f6;
}

.toggleLabel {
    font-size: 14px;
    font-weight: 600;
    color: #374151;
}

.toggleSubLabel {
    font-size: 12px;
    color: #6b7280;
}

/* Switch Styles */
.switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 24px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked+.slider {
    background-color: #16a34a;
}

input:checked+.slider:before {
    transform: translateX(20px);
}

.footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    padding: 16px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
}

.footerAmount {
    flex: 1;
}

.footerLabel {
    font-size: 12px;
    color: #6b7280;
}

.footerValue {
    font-size: 20px;
    font-weight: 700;
    color: #111827;
}

.recordButton {
    background: #16a34a;
    color: white;
    border: none;
    padding: 12px 32px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
}

.bankButton {
    padding: 8px 16px;
    border-radius: 20px;
    display: inline-flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
}

.cancelButton {
    font-size: 16px;
    font-weight: 600;
    color: #111827;
    cursor: pointer;
    padding: 12px;
    text-decoration: underline;
}
</file>

<file path="src/app/parties/vendor/edit/page.js">
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { usePartyStore } from '@/lib/store/partyStore';
import { FiArrowLeft, FiMoreHorizontal, FiPlayCircle, FiPlusCircle, FiCopy, FiChevronDown } from 'react-icons/fi';
import { AddressBottomSheet } from '@/components/AddressBottomSheet';
import AnimatedButton from '@/components/AnimatedButton';
import styles from './page.module.css';

function VendorEditContent() {
    const router = useRouter();
    const searchParams = useSearchParams();
    const id = searchParams.get('id');
    const { getVendor, updateVendor } = usePartyStore();

    const [formData, setFormData] = useState({
        name: '',
        phone: '',
        email: '',
        gstin: '',
        companyName: '',
        billingAddress: null,
        shippingAddress: null,
        sameAsBilling: false
    });

    const [isBillingSheetOpen, setIsBillingSheetOpen] = useState(false);
    const [isShippingSheetOpen, setIsShippingSheetOpen] = useState(false);

    useEffect(() => {
        if (id) {
            const vendor = getVendor(id);
            if (vendor) {
                setFormData(prev => ({ ...prev, ...vendor }));
            }
        }
    }, [id]);

    const handleChange = (e) => {
        const { name, value } = e.target;
        if (name === 'phone') {
            const numericValue = value.replace(/\D/g, '').slice(0, 10);
            setFormData(prev => ({ ...prev, [name]: numericValue }));
        } else {
            setFormData(prev => ({ ...prev, [name]: value }));
        }
    };

    const handleSave = async () => {
        if (!formData.name) {
            alert('Name is required');
            return;
        }
        if (formData.phone && formData.phone.length !== 10) {
            alert('Phone number must be 10 digits');
            return;
        }
        await updateVendor(parseInt(id), formData);
        router.back();
    };

    const handleAddressSave = (type, addressData) => {
        if (type === 'billing') {
            setFormData(prev => ({
                ...prev,
                billingAddress: addressData,
                shippingAddress: prev.sameAsBilling ? addressData : prev.shippingAddress
            }));
        } else {
            setFormData(prev => ({ ...prev, shippingAddress: addressData }));
        }
    };

    const toggleSameAsBilling = () => {
        setFormData(prev => {
            const newSame = !prev.sameAsBilling;
            return {
                ...prev,
                sameAsBilling: newSame,
                shippingAddress: newSame ? prev.billingAddress : prev.shippingAddress
            };
        });
    };

    return (
        <div className={styles.container}>
            {/* Header */}
            <div className={styles.header}>
                <div style={{ display: 'flex', alignItems: 'center' }}>
                    <FiArrowLeft size={24} onClick={() => router.back()} style={{ cursor: 'pointer' }} />
                    <span className={styles.headerTitle}>Update Vendor</span>
                </div>
                <div className={styles.headerActions}>
                    <div className={styles.importAction}>
                        Import <FiChevronDown />
                    </div>
                    <FiMoreHorizontal size={24} />
                </div>
            </div>

            <div className={styles.content}>
                {/* Basic Details */}
                <div className={styles.section}>
                    <div className={styles.sectionHeader}>
                        <div className={styles.sectionTitle}>Basic Details</div>
                        <FiPlayCircle size={20} color="#dc2626" />
                    </div>

                    <div className={styles.inputGroup}>
                        <input
                            className={styles.input}
                            name="name"
                            value={formData.name}
                            onChange={handleChange}
                            placeholder=" "
                        />
                        <label className={styles.label}>Name <span style={{ color: 'red' }}>*</span></label>
                    </div>

                    <div className={styles.phoneInputContainer} style={{ marginBottom: '16px' }}>
                        <img src="https://flagcdn.com/w40/in.png" alt="IN" className={styles.flag} />
                        <span className={styles.phonePrefix}>IN +91 <FiChevronDown size={12} /></span>
                        <input
                            className={styles.phoneInput}
                            name="phone"
                            value={formData.phone}
                            onChange={handleChange}
                            placeholder="Enter Phone Number"
                        />
                    </div>

                    <div className={styles.inputGroup} style={{ marginBottom: 0 }}>
                        <input
                            className={styles.input}
                            name="email"
                            value={formData.email}
                            onChange={handleChange}
                            placeholder=" "
                        />
                        <label className={styles.label}>Email</label>
                    </div>
                </div>

                {/* Company Details */}
                <div className={styles.section}>
                    <div className={styles.sectionTitle} style={{ marginBottom: '16px' }}>Company Details (Optional)</div>

                    <div style={{ marginBottom: '16px' }}>
                        <div className={styles.gstContainer}>
                            <div style={{ position: 'relative', flex: 1 }}>
                                <input
                                    className={styles.gstInput}
                                    name="gstin"
                                    value={formData.gstin || ''}
                                    onChange={handleChange}
                                    placeholder="GST Number"
                                    style={{ paddingTop: '20px', paddingBottom: '4px' }}
                                />
                                <label style={{ position: 'absolute', left: '12px', top: '4px', fontSize: '10px', color: '#6b7280' }}>GST Number</label>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div className={styles.inputGroup} style={{ marginBottom: '4px' }}>
                            <input
                                className={styles.input}
                                name="companyName"
                                value={formData.companyName || ''}
                                onChange={handleChange}
                                placeholder=" "
                            />
                            <label className={styles.label}>Company Name</label>
                        </div>
                        <div className={styles.helperText}>eg. Tata Motors Private Limited</div>
                    </div>
                </div>

                {/* Billing Address */}
                <div className={styles.section}>
                    <div className={styles.sectionTitle} style={{ marginBottom: '16px' }}>Billing Address (Optional)</div>
                    <button className={styles.addressButton} onClick={() => setIsBillingSheetOpen(true)}>
                        <FiPlusCircle size={18} /> {formData.billingAddress ? 'Edit Billing Address' : 'Billing Address'}
                    </button>
                </div>

                {/* Shipping Address */}
                <div className={styles.section}>
                    <div className={styles.sectionHeader}>
                        <div className={styles.sectionTitle}>Shipping Address (Optional)</div>
                    </div>

                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', background: '#f9fafb', border: '1px solid #e5e7eb', borderRadius: '8px', padding: '8px 12px' }}>
                        <div
                            style={{ display: 'flex', alignItems: 'center', gap: '8px', fontWeight: 600, color: '#6b7280', cursor: 'pointer', flex: 1 }}
                            onClick={() => setIsShippingSheetOpen(true)}
                        >
                            <FiPlusCircle size={18} /> {formData.shippingAddress ? 'Edit Shipping Address' : 'Shipping Address'}
                        </div>
                        <div className={styles.checkboxContainer} onClick={toggleSameAsBilling}>
                            <span>Same as Billing?</span>
                            <FiCopy size={16} color={formData.sameAsBilling ? '#2563eb' : '#9ca3af'} />
                        </div>
                    </div>
                </div>

                <AnimatedButton className={styles.updateButton} onClick={handleSave}>
                    Update Vendor
                </AnimatedButton>
            </div>

            <AddressBottomSheet
                isOpen={isBillingSheetOpen}
                onClose={() => setIsBillingSheetOpen(false)}
                onSave={(data) => handleAddressSave('billing', data)}
                initialData={formData.billingAddress}
                title="Enter Billing Address"
            />

            <AddressBottomSheet
                isOpen={isShippingSheetOpen}
                onClose={() => setIsShippingSheetOpen(false)}
                onSave={(data) => handleAddressSave('shipping', data)}
                initialData={formData.shippingAddress}
                title="Enter Shipping Address"
            />
        </div>
    );
}

export default function VendorEditPage() {
    return (
        <Suspense fallback={<div>Loading...</div>}>
            <VendorEditContent />
        </Suspense>
    );
}
</file>

<file path="src/app/parties/vendor/edit/page.module.css">
.container {
    background: #f3f4f6;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.header {
    background: white;
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #eee;
}

.headerTitle {
    font-size: 18px;
    font-weight: 700;
    color: #111827;
    margin-left: 12px;
}

.headerActions {
    display: flex;
    align-items: center;
    gap: 16px;
}

.importAction {
    color: #2563eb;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
    cursor: pointer;
}

.content {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    flex: 1;
}

.section {
    background: white;
    padding: 16px;
    border-radius: 12px;
}

.sectionHeader {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.sectionTitle {
    font-weight: 700;
    font-size: 14px;
    color: #111827;
}

.inputGroup {
    margin-bottom: 16px;
    position: relative;
}

.input {
    width: 100%;
    padding: 16px 12px 4px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    font-size: 16px;
    outline: none;
    transition: border-color 0.2s;
}

.input:focus {
    border-color: #2563eb;
}

.label {
    position: absolute;
    left: 12px;
    top: 12px;
    font-size: 14px;
    color: #6b7280;
    pointer-events: none;
    transition: all 0.2s;
}

.input:focus+.label,
.input:not(:placeholder-shown)+.label {
    top: 4px;
    font-size: 10px;
    color: #2563eb;
}

.phoneInputContainer {
    display: flex;
    align-items: center;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 8px 12px;
    background: white;
}

.flag {
    width: 24px;
    height: 16px;
    margin-right: 8px;
    border-radius: 2px;
    object-fit: cover;
}

.phonePrefix {
    font-weight: 500;
    margin-right: 8px;
    color: #111827;
    display: flex;
    align-items: center;
    gap: 4px;
}

.phoneInput {
    border: none;
    outline: none;
    font-size: 16px;
    width: 100%;
}

.gstContainer {
    display: flex;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
}

.gstInput {
    flex: 1;
    padding: 12px;
    border: none;
    outline: none;
    font-size: 16px;
}

.helperText {
    font-size: 12px;
    color: #9ca3af;
    margin-top: 4px;
}

.addressButton {
    width: 100%;
    padding: 16px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    text-align: left;
    color: #6b7280;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.checkboxContainer {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #6b7280;
    cursor: pointer;
}

.updateButton {
    width: 100%;
    background: #2563eb;
    color: white;
    padding: 16px;
    border-radius: 12px;
    border: none;
    font-size: 16px;
    font-weight: 700;
    margin-top: auto;
    cursor: pointer;
}
</file>

<file path="src/app/products/bulk-upload/page.js">
'use client';

import { useState, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { FiArrowLeft, FiDownload, FiUploadCloud, FiFileText, FiAlertCircle, FiCheckCircle, FiLoader } from 'react-icons/fi';
import { BulkUploadService } from '@/lib/services/bulkUploadService';
import styles from './page.module.css';
import Link from 'next/link';

export default function BulkUploadPage() {
    const router = useRouter();
    const fileInputRef = useRef(null);
    const [file, setFile] = useState(null);
    const [validationState, setValidationState] = useState({
        status: 'idle', // idle, validating, valid, invalid 
        errors: [],
        data: [],
        totalReceived: 0
    });
    const [processingState, setProcessingState] = useState({
        status: 'idle', // idle, processing, complete, error
        successCount: 0,
        failureCount: 0,
        failedRows: []
    });

    const handleFileSelect = (e) => {
        const selectedFile = e.target.files[0];
        if (selectedFile) {
            if (selectedFile.type !== 'text/csv' && !selectedFile.name.endsWith('.csv')) {
                alert('Please upload a CSV file.');
                return;
            }
            setFile(selectedFile);
            setValidationState({ status: 'idle', errors: [], data: [], totalReceived: 0 });
            setProcessingState({ status: 'idle', successCount: 0, failureCount: 0, failedRows: [] });
        }
    };

    const handleDownloadTemplate = () => {
        BulkUploadService.downloadTemplate();
    };

    const handleValidate = async () => {
        if (!file) return;

        setValidationState(prev => ({ ...prev, status: 'validating' }));
        try {
            const result = await BulkUploadService.validateFile(file);
            setValidationState({
                status: result.valid ? 'valid' : 'invalid',
                errors: result.errors,
                data: result.data,
                totalReceived: result.totalReceived
            });
        } catch (error) {
            console.error(error);
            setValidationState({
                status: 'invalid',
                errors: ['Failed to validate file. Please check format.'],
                data: [],
                totalReceived: 0
            });
        }
    };

    const handleProcess = async () => {
        if (validationState.status !== 'valid') return;

        setProcessingState({ status: 'processing', successCount: 0, failureCount: 0, failedRows: [] });
        try {
            const result = await BulkUploadService.processFile(validationState.data);
            setProcessingState({
                status: 'complete',
                successCount: result.successCount,
                failureCount: result.failureCount,
                failedRows: result.failedRows
            });
            // Optional: reset file after success? 
            // setFile(null); 
        } catch (error) {
            console.error(error);
            setProcessingState({ status: 'error', successCount: 0, failureCount: 0, failedRows: [] });
        }
    };

    return (
        <div className={styles.container}>
            {/* Header */}
            <div className={styles.header}>
                <Link href="/products">
                    <FiArrowLeft size={24} color="#111827" style={{ cursor: 'pointer' }} />
                </Link>
                <h1 className={styles.title}>Bulk Product Upload</h1>
            </div>

            {/* Step 1: Download Template */}
            <div className={styles.card}>
                <h2 className={styles.sectionTitle}>1. Download Template</h2>
                <p className={styles.sectionDesc}>
                    Use this standardized CSV template to enter your product details.
                    Do not change the column headers.
                </p>
                <button
                    onClick={handleDownloadTemplate}
                    className={`${styles.button} ${styles.outlineButton}`}
                >
                    <FiDownload size={18} />
                    Download CSV Template
                </button>
            </div>

            {/* Step 2: Upload CSV */}
            <div className={styles.card}>
                <h2 className={styles.sectionTitle}>2. Upload CSV File</h2>
                <p className={styles.sectionDesc}>
                    Upload your filled CSV file here. Ensure all mandatory fields are present.
                </p>

                <input
                    type="file"
                    accept=".csv"
                    ref={fileInputRef}
                    style={{ display: 'none' }}
                    onChange={handleFileSelect}
                />

                <div
                    className={styles.dropZone}
                    onClick={() => fileInputRef.current?.click()}
                >
                    <FiUploadCloud size={48} color="#9ca3af" />
                    <p style={{ marginTop: 12, color: '#4b5563', fontWeight: 500 }}>
                        Click to upload CSV
                    </p>
                    <p style={{ fontSize: 12, color: '#9ca3af' }}>
                        Supported format: .csv
                    </p>
                </div>

                {file && (
                    <div className={styles.fileInfo}>
                        <FiFileText size={20} color="#4b5563" />
                        <span style={{ fontSize: 14, fontWeight: 500, flex: 1 }}>{file.name}</span>
                        <button
                            onClick={(e) => { e.stopPropagation(); setFile(null); setValidationState({ status: 'idle', errors: [], data: [], totalReceived: 0 }); }}
                            style={{ border: 'none', background: 'none', color: '#ef4444', cursor: 'pointer' }}
                        >
                            Remove
                        </button>
                    </div>
                )}
            </div>

            {/* Step 3: Validation & Processing */}
            {file && (
                <div className={styles.card}>
                    <h2 className={styles.sectionTitle}>3. Validate & Process</h2>

                    <div style={{ display: 'flex', gap: 12, marginTop: 16 }}>
                        <button
                            onClick={handleValidate}
                            className={`${styles.button} ${styles.outlineButton}`}
                            disabled={validationState.status === 'validating' || processingState.status === 'processing' || processingState.status === 'complete'}
                            style={{ opacity: (validationState.status === 'validating' || processingState.status === 'processing') ? 0.7 : 1 }}
                        >
                            {validationState.status === 'validating' ? <FiLoader className="spin" /> : 'Validate File'}
                        </button>

                        <button
                            onClick={handleProcess}
                            className={`${styles.button} ${styles.primaryButton}`}
                            disabled={validationState.status !== 'valid'}
                            style={{ opacity: validationState.status !== 'valid' ? 0.5 : 1, cursor: validationState.status !== 'valid' ? 'not-allowed' : 'pointer' }}
                        >
                            {processingState.status === 'processing' ? (
                                <>
                                    <FiLoader className="spin" /> Processing...
                                </>
                            ) : 'Upload & Process'}
                        </button>
                    </div>

                    {/* Validation Errors */}
                    {validationState.status === 'invalid' && validationState.errors.length > 0 && (
                        <div className={styles.validationResults}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12, color: '#dc2626' }}>
                                <FiAlertCircle />
                                <span style={{ fontWeight: 600 }}>Validation Failed</span>
                            </div>
                            <div className={styles.errorList}>
                                {validationState.errors.map((err, idx) => (
                                    <div key={idx} className={styles.errorItem}>• {err}</div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Validation Success */}
                    {validationState.status === 'valid' && processingState.status === 'idle' && (
                        <div className={styles.validationResults}>
                            <div className={styles.successSummary}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                    <FiCheckCircle size={20} />
                                    <span style={{ fontWeight: 600 }}>Validation Successful!</span>
                                </div>
                                <p style={{ marginTop: 4, fontSize: 14 }}>
                                    Found {validationState.data.length} valid records out of {validationState.totalReceived}. Ready to process.
                                </p>
                            </div>
                        </div>
                    )}

                    {/* Processing Complete */}
                    {processingState.status === 'complete' && (
                        <div className={styles.validationResults}>
                            <div className={styles.successSummary} style={{ background: processingState.failureCount > 0 ? '#fff7ed' : '#f0fdf4', borderColor: processingState.failureCount > 0 ? '#fdba74' : '#bbf7d0', color: processingState.failureCount > 0 ? '#9a3412' : '#166534' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                    <FiCheckCircle size={20} />
                                    <span style={{ fontWeight: 600 }}>Processing Complete</span>
                                </div>
                                <p style={{ marginTop: 4, fontSize: 14 }}>
                                    Successfully processed: <strong>{processingState.successCount}</strong>
                                </p>
                                {processingState.failureCount > 0 && (
                                    <p style={{ marginTop: 4, fontSize: 14, color: '#dc2626' }}>
                                        Failed: <strong>{processingState.failureCount}</strong>
                                    </p>
                                )}
                            </div>

                            {processingState.failedRows.length > 0 && (
                                <div className={styles.errorList} style={{ marginTop: 16 }}>
                                    <p style={{ fontWeight: 600, marginBottom: 8, color: '#dc2626' }}>Failed Rows Details:</p>
                                    {processingState.failedRows.map((item, idx) => (
                                        <div key={idx} className={styles.errorItem}>
                                            • Row {item.row.product_name || 'Generic'}: {item.error}
                                        </div>
                                    ))}
                                </div>
                            )}

                            <div style={{ marginTop: 16 }}>
                                <Link href="/products">
                                    <button className={`${styles.button} ${styles.outlineButton}`}>
                                        Go back to Products
                                    </button>
                                </Link>
                            </div>
                        </div>
                    )}
                </div>
            )}
        </div>
    );
}
</file>

<file path="src/app/products/bulk-upload/page.module.css">
.container {
    padding: 24px;
    max-width: 1200px;
    margin: 0 auto;
    padding-bottom: 100px;
    /* Space for bottom nav */
}

.header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
}

.title {
    font-size: 24px;
    font-weight: 600;
    color: #111827;
}

.card {
    background: #fff;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
}

.sectionTitle {
    font-size: 18px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
}

.sectionDesc {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 16px;
}

.button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
}

.primaryButton {
    background: #2563eb;
    color: #fff;
}

/* Removed hover for mobile touch primarily */

.outlineButton {
    background: #fff;
    border: 1px solid #d1d5db;
    color: #374151;
}

.dropZone {
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s;
    background: #f9fafb;
}

.dropZoneActive {
    border-color: #2563eb;
    background: #eff6ff;
}

.fileInfo {
    margin-top: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    background: #f3f4f6;
    padding: 12px;
    border-radius: 8px;
}

.validationResults {
    margin-top: 20px;
    border-top: 1px solid #e5e7eb;
    padding-top: 20px;
}

.errorList {
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    max-height: 200px;
    overflow-y: auto;
}

.errorItem {
    color: #991b1b;
    font-size: 14px;
    margin-bottom: 4px;
}

.successSummary {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 8px;
    padding: 16px;
    color: #166534;
}
</file>

<file path="src/app/products/components/__tests__/ProductCard.test.js">
import React from 'react';
import { render, screen, fireEvent } from '@testing-library/react';
import ProductCard from '../ProductCard';

// Mock next/navigation
jest.mock('next/navigation', () => ({
    useRouter: () => ({
        push: jest.fn(),
    }),
}));

// Mock next/link
jest.mock('next/link', () => {
    return ({ children, href }) => <a href={href}>{children}</a>;
});

describe('ProductCard', () => {
    const mockProduct = {
        id: 1,
        name: 'Gold Ring',
        category: 'Ring',
        purity: '22K',
        grossWeight: 10.5,
        stoneType: 'Diamond',
        tags: '',
    };

    const mockOnAddToTray = jest.fn();
    const mockOnShare = jest.fn();

    beforeEach(() => {
        jest.clearAllMocks();
    });

    describe('rendering', () => {
        it('should render product title with category and purity', () => {
            render(
                <ProductCard
                    product={mockProduct}
                    onAddToTray={mockOnAddToTray}
                    onShare={mockOnShare}
                />
            );

            expect(screen.getByText('Ring – 22K')).toBeInTheDocument();
        });

        it('should display weight correctly formatted', () => {
            render(
                <ProductCard
                    product={mockProduct}
                    onAddToTray={mockOnAddToTray}
                    onShare={mockOnShare}
                />
            );

            expect(screen.getByText(/Weight: 10.50g/)).toBeInTheDocument();
        });

        it('should display stone type', () => {
            render(
                <ProductCard
                    product={mockProduct}
                    onAddToTray={mockOnAddToTray}
                    onShare={mockOnShare}
                />
            );

            expect(screen.getByText(/Stone: Diamond/)).toBeInTheDocument();
        });

        it('should show purity badge', () => {
            render(
                <ProductCard
                    product={mockProduct}
                    onAddToTray={mockOnAddToTray}
                    onShare={mockOnShare}
                />
            );

            expect(screen.getByText('22K')).toBeInTheDocument();
        });

        it('should show Bestseller badge when product has bestseller tag', () => {
            const bestsellerProduct = {
                ...mockProduct,
                tags: 'bestseller, popular',
            };

            render(
                <ProductCard
                    product={bestsellerProduct}
                    onAddToTray={mockOnAddToTray}
                    onShare={mockOnShare}
                />
            );

            expect(screen.getByText('Bestseller')).toBeInTheDocument();
        });

        it('should not show Bestseller badge when tag is absent', () => {
            render(
                <ProductCard
                    product={mockProduct}
                    onAddToTray={mockOnAddToTray}
                    onShare={mockOnShare}
                />
            );

            expect(screen.queryByText('Bestseller')).not.toBeInTheDocument();
        });
    });

    describe('default values', () => {
        it('should show default purity when not provided', () => {
            const productWithoutPurity = { ...mockProduct, purity: '' };

            render(
                <ProductCard
                    product={productWithoutPurity}
                    onAddToTray={mockOnAddToTray}
                    onShare={mockOnShare}
                />
            );

            // Default is 22K
            expect(screen.getAllByText('22K').length).toBeGreaterThan(0);
        });

        it('should show 0.00g when grossWeight is not provided', () => {
            const productWithoutWeight = { ...mockProduct, grossWeight: null };

            render(
                <ProductCard
                    product={productWithoutWeight}
                    onAddToTray={mockOnAddToTray}
                    onShare={mockOnShare}
                />
            );

            expect(screen.getByText(/Weight: 0.00g/)).toBeInTheDocument();
        });

        it('should show Plain Gold when stoneType is not provided', () => {
            const productWithoutStone = { ...mockProduct, stoneType: '' };

            render(
                <ProductCard
                    product={productWithoutStone}
                    onAddToTray={mockOnAddToTray}
                    onShare={mockOnShare}
                />
            );

            expect(screen.getByText(/Stone: Plain Gold/)).toBeInTheDocument();
        });
    });

    describe('interactions', () => {
        it('should call onAddToTray when Add to Tray button is clicked', () => {
            render(
                <ProductCard
                    product={mockProduct}
                    onAddToTray={mockOnAddToTray}
                    onShare={mockOnShare}
                />
            );

            const addButton = screen.getByText('Add to Tray');
            fireEvent.click(addButton);

            expect(mockOnAddToTray).toHaveBeenCalledWith(mockProduct);
            expect(mockOnAddToTray).toHaveBeenCalledTimes(1);
        });

        it('should call onShare when share button is clicked', () => {
            render(
                <ProductCard
                    product={mockProduct}
                    onAddToTray={mockOnAddToTray}
                    onShare={mockOnShare}
                />
            );

            // Find the WhatsApp button (it's an icon button)
            const buttons = screen.getAllByRole('button');
            const shareButton = buttons.find(btn => btn.querySelector('svg'));

            if (shareButton) {
                fireEvent.click(shareButton);
                expect(mockOnShare).toHaveBeenCalledWith(mockProduct);
            }
        });

        it('should stop propagation when action buttons are clicked', () => {
            const mockCardClick = jest.fn();

            render(
                <ProductCard
                    product={mockProduct}
                    onAddToTray={mockOnAddToTray}
                    onShare={mockOnShare}
                />
            );

            const addButton = screen.getByText('Add to Tray');
            fireEvent.click(addButton);

            // onAddToTray should be called, but not navigate (we can't test navigation directly)
            expect(mockOnAddToTray).toHaveBeenCalled();
        });
    });

    describe('image handling', () => {
        it('should show placeholder when no images', () => {
            render(
                <ProductCard
                    product={mockProduct}
                    onAddToTray={mockOnAddToTray}
                    onShare={mockOnShare}
                />
            );

            // Placeholder contains FiShoppingBag icon
            expect(screen.queryByRole('img')).not.toBeInTheDocument();
        });

        it('should render image when images array has data', () => {
            const productWithImage = {
                ...mockProduct,
                images: [{ data: 'data:image/png;base64,abc123' }],
            };

            render(
                <ProductCard
                    product={productWithImage}
                    onAddToTray={mockOnAddToTray}
                    onShare={mockOnShare}
                />
            );

            const img = screen.getByRole('img');
            expect(img).toHaveAttribute('src', 'data:image/png;base64,abc123');
        });
    });
});
</file>

<file path="src/app/products/components/FilterBar.js">
import styles from './FilterBar.module.css';
import { FiX } from 'react-icons/fi';

const FILTERS = {
    purity: ['22K', '18K'],
    weight: ['0-5g', '5-10g'],
    gender: ['Ladies', 'Gents', 'Kids'],
};

export default function FilterBar({ filters, onFilterChange, categories = [] }) {

    const handleFilterToggle = (type, value) => {
        const current = filters[type] || [];
        const updated = current.includes(value)
            ? current.filter(item => item !== value)
            : [...current, value];
        onFilterChange({ ...filters, [type]: updated });
    };

    const removeFilter = (type, value) => {
        const current = filters[type] || [];
        const updated = current.filter(item => item !== value);
        onFilterChange({ ...filters, [type]: updated });
    };

    // Flatten selected filters for the chip view
    const selectedChips = [];
    Object.keys(filters).forEach(key => {
        filters[key].forEach(val => {
            selectedChips.push({ type: key, value: val });
        });
    });

    return (
        <div className={styles.container}>
            {/* Scrollable Filter Pills */}
            <div className={styles.scrollContainer}>
                {/* Purity Group */}
                <div className={styles.filterGroup}>
                    <span className={styles.groupLabel}>Purity:</span>
                    {FILTERS.purity.map(val => (
                        <button
                            key={val}
                            className={`${styles.pill} ${filters.purity.includes(val) ? styles.active : ''}`}
                            onClick={() => handleFilterToggle('purity', val)}
                        >
                            {val}
                        </button>
                    ))}
                </div>

                {/* Weight Group */}
                <div className={styles.filterGroup}>
                    <span className={styles.groupLabel}>Weight:</span>
                    {FILTERS.weight.map(val => (
                        <button
                            key={val}
                            className={`${styles.pill} ${filters.weight.includes(val) ? styles.active : ''}`}
                            onClick={() => handleFilterToggle('weight', val)}
                        >
                            {val}
                        </button>
                    ))}
                </div>

                {/* Gender Group */}
                <div className={styles.filterGroup}>
                    <span className={styles.groupLabel}>Gender:</span>
                    {FILTERS.gender.map(val => (
                        <button
                            key={val}
                            className={`${styles.pill} ${filters.gender.includes(val) ? styles.active : ''}`}
                            onClick={() => handleFilterToggle('gender', val)}
                        >
                            {val}
                        </button>
                    ))}
                </div>

                {/* Category Group - if categories provided */}
                {categories.length > 0 && (
                    <div className={styles.filterGroup}>
                        <span className={styles.groupLabel}>Category:</span>
                        {categories.map(cat => (
                            <button
                                key={cat.name}
                                className={`${styles.pill} ${filters.category && filters.category.includes(cat.name) ? styles.active : ''}`}
                                onClick={() => handleFilterToggle('category', cat.name)}
                            >
                                {cat.name}
                            </button>
                        ))}
                    </div>
                )}
            </div>

            {/* Selected Chips */}
            {selectedChips.length > 0 && (
                <div className={styles.chipContainer}>
                    {selectedChips.map((chip, idx) => (
                        <div key={`${chip.type}-${chip.value}-${idx}`} className={styles.chip}>
                            {chip.value}
                            <button
                                className={styles.chipClose}
                                onClick={() => removeFilter(chip.type, chip.value)}
                            >
                                <FiX size={14} />
                            </button>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}
</file>

<file path="src/app/products/components/FilterBar.module.css">
.container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 12px 16px;
    background: #fff;
    border-bottom: 1px solid #e5e7eb;
}

.scrollContainer {
    display: flex;
    overflow-x: auto;
    gap: 16px;
    white-space: nowrap;
    scrollbar-width: none;
    /* Firefox */
    -ms-overflow-style: none;
    /* IE 10+ */
    padding-bottom: 4px;
    /* Space for scrollbar if visible on some OS */
}

.scrollContainer::-webkit-scrollbar {
    display: none;
    /* Chrome/Safari */
}

.filterGroup {
    display: flex;
    align-items: center;
    gap: 8px;
    padding-right: 8px;
    border-right: 1px solid #f3f4f6;
}

.filterGroup:last-child {
    border-right: none;
}

.groupLabel {
    font-size: 13px;
    font-weight: 600;
    color: #374151;
}

.pill {
    background: #f3f4f6;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 13px;
    color: #4b5563;
    cursor: pointer;
    transition: all 0.2s;
}

.pill:hover {
    background: #e5e7eb;
}

.pill.active {
    background: #ca8a04;
    /* Gold */
    color: white;
}

.chipContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.chip {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #e5e7eb;
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 12px;
    color: #1f2937;
}

.chipClose {
    background: none;
    border: none;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #6b7280;
}

.chipClose:hover {
    color: #1f2937;
}
</file>

<file path="src/app/products/components/Pagination.js">
import styles from './Pagination.module.css';
import { FiChevronLeft, FiChevronRight, FiClock } from 'react-icons/fi';
import { useState } from 'react';

export default function Pagination({ currentPage, totalPages, onPageChange, onRecentlyViewed }) {
    const [jumpPage, setJumpPage] = useState('');

    const handleJump = (e) => {
        if (e.key === 'Enter') {
            const page = parseInt(jumpPage);
            if (!isNaN(page) && page >= 1 && page <= totalPages) {
                onPageChange(page);
                setJumpPage('');
            }
        }
    };

    return (
        <div className={styles.container}>
            <div className={styles.controls}>
                <button
                    className={styles.navButton}
                    disabled={currentPage === 1}
                    onClick={() => onPageChange(currentPage - 1)}
                >
                    <FiChevronLeft />
                </button>

                <span className={styles.pageInfo}>
                    Page {currentPage} of {totalPages}
                </span>

                <button
                    className={styles.navButton}
                    disabled={currentPage === totalPages}
                    onClick={() => onPageChange(currentPage + 1)}
                >
                    <FiChevronRight />
                </button>
            </div>

            <div className={styles.jumpContainer}>
                <span className={styles.jumpLabel}>Jump to:</span>
                <input
                    className={styles.jumpInput}
                    value={jumpPage}
                    onChange={(e) => setJumpPage(e.target.value)}
                    onKeyDown={handleJump}
                    placeholder="#"
                />
            </div>

            <button className={styles.recentButton} onClick={onRecentlyViewed}>
                <FiClock size={16} />
                Recently Viewed
            </button>
        </div>
    );
}
</file>

<file path="src/app/products/components/Pagination.module.css">
.container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: #fff;
    border-top: 1px solid #e5e7eb;
    flex-wrap: wrap;
    gap: 12px;
}

.controls {
    display: flex;
    align-items: center;
    gap: 12px;
}

.navButton {
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #4b5563;
}

.navButton:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #f3f4f6;
}

.navButton:hover:not(:disabled) {
    background: #f9fafb;
    border-color: #9ca3af;
}

.pageInfo {
    font-size: 14px;
    font-weight: 500;
    color: #374151;
}

.jumpContainer {
    display: flex;
    align-items: center;
    gap: 8px;
}

.jumpLabel {
    font-size: 13px;
    color: #6b7280;
}

.jumpInput {
    width: 50px;
    padding: 6px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    text-align: center;
    font-size: 13px;
    background: #fff;
    color: #000;
}

.jumpInput:focus {
    outline: none;
    border-color: #ca8a04;
}

.recentButton {
    display: flex;
    align-items: center;
    gap: 8px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 13px;
    font-weight: 500;
    color: #4b5563;
    cursor: pointer;
    margin-left: auto;
    /* Push to right */
}

.recentButton:hover {
    background: #f9fafb;
    color: #111827;
}

@media (max-width: 600px) {
    .container {
        justify-content: center;
    }

    .recentButton {
        margin-left: 0;
        width: 100%;
        justify-content: center;
    }
}
</file>

<file path="src/app/purchase/create/select-vendor/page.js">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { usePartyStore } from '@/lib/store/partyStore';
import { usePurchaseStore } from '@/lib/store/purchaseStore';
import { FiArrowLeft, FiSearch, FiPlus, FiX } from 'react-icons/fi';
import { formatCurrency } from '@/lib/utils/tax';

export default function SelectVendorPage() {
    const router = useRouter();
    const { vendors, loadParties } = usePartyStore();
    const { setVendor } = usePurchaseStore();
    const [searchQuery, setSearchQuery] = useState('');

    useEffect(() => {
        loadParties();
    }, [loadParties]);

    const filteredVendors = vendors.filter(v =>
        v.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        (v.phone && v.phone.includes(searchQuery))
    );

    const handleSelect = (vendor) => {
        setVendor(vendor);
        router.back();
    };

    return (
        <div style={{ background: '#f3f4f6', minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
            {/* Header */}
            <div style={{
                background: 'white',
                padding: '16px',
                display: 'flex',
                alignItems: 'center',
                gap: '12px',
                borderBottom: '1px solid #e5e7eb'
            }}>
                <button onClick={() => router.back()} style={{ border: 'none', background: 'none', cursor: 'pointer' }}>
                    <FiArrowLeft size={24} />
                </button>
                <div style={{ flex: 1, position: 'relative' }}>
                    <input
                        placeholder="Search Vendor"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        style={{
                            width: '100%',
                            padding: '8px 0',
                            fontSize: '16px',
                            border: 'none',
                            outline: 'none'
                        }}
                        autoFocus
                    />
                </div>
                {searchQuery && (
                    <button onClick={() => setSearchQuery('')} style={{ border: 'none', background: 'none', cursor: 'pointer' }}>
                        <FiX size={20} color="#6b7280" />
                    </button>
                )}
            </div>

            {/* Add New Vendor Button */}
            <Link href="/parties/vendor/add?returnUrl=/purchase/create" style={{ textDecoration: 'none' }}>
                <div style={{
                    background: '#fef3c7',
                    padding: '12px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px',
                    color: '#92400e',
                    fontWeight: 500,
                    cursor: 'pointer'
                }}>
                    <FiPlus size={18} /> Add new vendor
                </div>
            </Link>

            {/* Vendor List */}
            <div style={{ flex: 1, overflowY: 'auto', padding: '16px', display: 'flex', flexDirection: 'column', gap: '12px' }}>
                {filteredVendors.length === 0 ? (
                    <div style={{ textAlign: 'center', padding: '40px', color: '#9ca3af' }}>
                        {vendors.length === 0 ? 'No vendors found. Add a vendor first.' : 'No vendors match your search.'}
                    </div>
                ) : (
                    filteredVendors.map(vendor => (
                        <div
                            key={vendor.id}
                            onClick={() => handleSelect(vendor)}
                            style={{
                                background: 'white',
                                padding: '16px',
                                borderRadius: '12px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                cursor: 'pointer',
                                boxShadow: '0 1px 2px rgba(0,0,0,0.05)'
                            }}
                        >
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                <div style={{
                                    width: '40px',
                                    height: '40px',
                                    borderRadius: '50%',
                                    background: '#fef3c7',
                                    color: '#92400e',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontWeight: 600,
                                    fontSize: '16px'
                                }}>
                                    {vendor.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div style={{ fontWeight: 500, color: '#111827' }}>{vendor.name}</div>
                                    {vendor.phone && (
                                        <div style={{ fontSize: '13px', color: '#6b7280' }}>{vendor.phone}</div>
                                    )}
                                </div>
                            </div>
                            <div style={{ textAlign: 'right' }}>
                                {vendor.balance ? (
                                    <div style={{
                                        color: vendor.balance > 0 ? '#dc2626' : '#10b981',
                                        fontWeight: 500
                                    }}>
                                        {vendor.balance > 0 ? '↑' : ''} {formatCurrency(Math.abs(vendor.balance))}
                                        <div style={{ fontSize: '10px', color: '#6b7280' }}>
                                            {vendor.balance > 0 ? 'You owe' : 'They owe'}
                                        </div>
                                    </div>
                                ) : (
                                    <div style={{ fontSize: '13px', color: '#6b7280', fontWeight: 500 }}>No dues</div>
                                )}
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>
    );
}
</file>

<file path="src/app/purchase/create/page.js">
'use client';

import PurchaseForm from '@/components/PurchaseForm';
import { FiArrowLeft } from 'react-icons/fi';
import Link from 'next/link';
import { useEffect } from 'react';
import { usePurchaseStore } from '@/lib/store/purchaseStore';

export default function CreatePurchasePage() {
    const { resetPurchase } = usePurchaseStore();

    useEffect(() => {
        // Reset the store when entering create mode
        resetPurchase();
    }, []);

    return (
        <div>
            <div style={{
                padding: '16px',
                background: 'white',
                display: 'flex',
                alignItems: 'center',
                gap: '16px',
                borderBottom: '1px solid #eee'
            }}>
                <Link href="/">
                    <FiArrowLeft size={24} />
                </Link>
                <h1 style={{ fontSize: '18px', fontWeight: 600 }}>Create Purchase</h1>
                <span style={{
                    fontSize: '12px',
                    background: '#fef3c7',
                    color: '#92400e',
                    padding: '2px 8px',
                    borderRadius: '4px',
                    fontWeight: 600
                }}>
                    Purchase Order
                </span>
            </div>
            <PurchaseForm />
        </div>
    );
}
</file>

<file path="src/app/reports/page.js">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { FiChevronLeft, FiChevronDown } from 'react-icons/fi';
import styles from './page.module.css';

const reportSections = [
    {
        title: 'Taxes',
        items: [
            'GSTR – 1',
            'GSTR – 2B',
            'GSTR – 3B',
            'GSTR – 7',
            'Sale Summary by HSN',
            'IUS Receivable',
            'TDS Payable',
            'TCS Receivable',
            'ICS Payable',
        ],
    },
    {
        title: 'Transaction Reports',
        items: [
            'Sales',
            'Purchases',
            'Sale Returns / Credit Notes',
            'Purchase Returns / Debit Notes',
            'Quotations',
            'Sales Orders (NEW)',
            'Delivery Challans',
            'Pro Forma Invoices',
            'Purchase Orders',
            'Payments',
            'Indirect Income',
            'Category-Wise Expenses',
            'Category-Wise Indirect Income',
        ],
    },
    {
        title: 'Bill-wise Item Reports',
        items: [
            'Sales',
            'Purchases',
            'Sale Returns / Credit Notes',
            'Purchase Returns / Debit Notes',
            'Quotations',
            'Sales Orders (NEW)',
            'Delivery Challans',
            'Pro Forma Invoices',
            'Purchase Orders',
        ],
    },
    {
        title: 'Item Reports',
        items: [
            'Stock Summary',
            'Item-wise Discount',
            'Stock Value',
            'Inventory Timeline',
            'Low Stock (NEW)',
        ],
    },
    {
        title: 'Party Reports',
        items: [
            'All Customers',
            'All Vendors',
            'Customer Statement',
            'Vendor Statement',
            'Customer-wise Items',
            'Vendor-wise Items',
        ],
    },
    {
        title: 'Profit & Loss (P/L) Reports',
        items: [
            'P/L Statement',
            'Seller P/L Report',
            'Sale Items P/L Report',
            'Item-wise P/L (Purchases)',
            'Item-wise P/L Report (Purchase Price)',
            'Category-wise P/L Report (Purchase Price)',
            'Customer-wise P/L Statement',
        ],
    },
    {
        title: 'Payments Reports',
        items: [
            'Payment Timeline',
            'Payouts',
        ],
    },
    {
        title: 'Other Reports',
        items: [
            'Day Book',
            'Document Conversion',
        ],
    },
];

export default function ReportsPage() {
    const router = useRouter();
    // Initialize with all sections collapsed or expanded as per preference. 
    // The screenshot shows them collapsed, so we'll start with empty or specific ones if needed.
    // Let's keep them all collapsed initially to match the clean look, or maybe just the first one?
    // The screenshot shows all collapsed.
    const [expandedSections, setExpandedSections] = useState({});

    const toggleSection = (index) => {
        setExpandedSections((prev) => ({
            ...prev,
            [index]: !prev[index],
        }));
    };

    return (
        <div className={styles.container}>
            <header className={styles.header}>
                <button onClick={() => router.back()} className={styles.backButton}>
                    <FiChevronLeft />
                </button>
                <h1 className={styles.title}>Reports</h1>
            </header>

            <div className={styles.content}>
                {reportSections.map((section, index) => (
                    <div key={index} className={styles.section}>
                        <div
                            className={styles.sectionHeader}
                            onClick={() => toggleSection(index)}
                        >
                            <span className={styles.sectionTitle}>{section.title}</span>
                            <FiChevronDown
                                className={`${styles.chevron} ${expandedSections[index] ? styles.expanded : ''}`}
                            />
                        </div>
                        {expandedSections[index] && (
                            <div className={styles.reportList}>
                                {section.items.map((item, itemIndex) => (
                                    <div key={itemIndex} className={styles.reportItem}>
                                        {item}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                ))}
            </div>
        </div>
    );
}
</file>

<file path="src/app/reports/page.module.css">
.container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background-color: #f8f9fa;
}

.header {
    display: flex;
    align-items: center;
    padding: 16px;
    background-color: #fff;
    border-bottom: 1px solid #eee;
    position: sticky;
    top: 0;
    z-index: 10;
}

.backButton {
    background: none;
    border: none;
    font-size: 24px;
    margin-right: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
}

.title {
    font-size: 18px;
    font-weight: 600;
    color: #000;
}

.content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.section {
    background-color: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.sectionHeader {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    cursor: pointer;
    user-select: none;
}

.sectionTitle {
    font-size: 15px;
    font-weight: 500;
    color: #333;
}

.chevron {
    font-size: 20px;
    color: #666;
    transition: transform 0.2s ease;
}

.chevron.expanded {
    transform: rotate(180deg);
}

.reportList {
    border-top: 1px solid #f0f0f0;
}

.reportItem {
    padding: 14px 16px;
    font-size: 14px;
    color: #555;
    border-bottom: 1px solid #f5f5f5;
    cursor: pointer;
    display: block;
    text-decoration: none;
}

.reportItem:last-child {
    border-bottom: none;
}

.reportItem:hover {
    background-color: #f9f9f9;
}
</file>

<file path="src/app/template.js">
'use client';

import { motion } from 'framer-motion';
import { ANIMATIONS } from '@/lib/animations';

export default function Template({ children }) {
    return (
        <motion.div
            initial={ANIMATIONS.variants.slideUp.initial}
            animate={ANIMATIONS.variants.slideUp.animate}
            transition={{
                duration: ANIMATIONS.duration.medium,
                ease: ANIMATIONS.ease.out,
            }}
            className="page-transition-container"
        >
            {children}
        </motion.div>
    );
}
</file>

<file path="src/components/__tests__/BottomNav.test.js">
import React from 'react';
import { render, screen } from '@testing-library/react';
import BottomNav from '../BottomNav';

// Mock next/navigation
jest.mock('next/navigation', () => ({
    usePathname: jest.fn(),
}));

// Mock next/link to render as regular anchor
jest.mock('next/link', () => {
    return ({ children, href }) => {
        return <a href={href}>{children}</a>;
    };
});

// Import the mocked usePathname
import { usePathname } from 'next/navigation';

describe('BottomNav', () => {
    beforeEach(() => {
        // Default to home route
        usePathname.mockReturnValue('/');
    });

    describe('rendering', () => {
        it('should render all navigation items on home page', () => {
            usePathname.mockReturnValue('/');
            render(<BottomNav />);

            expect(screen.getByText('Home')).toBeInTheDocument();
            expect(screen.getByText('Bills')).toBeInTheDocument();
            expect(screen.getByText('Products')).toBeInTheDocument();
            expect(screen.getByText('Parties')).toBeInTheDocument();
            expect(screen.getByText('More')).toBeInTheDocument();
        });

        it('should render correct navigation links', () => {
            usePathname.mockReturnValue('/');
            render(<BottomNav />);

            const homeLink = screen.getByText('Home').closest('a');
            expect(homeLink).toHaveAttribute('href', '/');

            const billsLink = screen.getByText('Bills').closest('a');
            expect(billsLink).toHaveAttribute('href', '/bills');

            const productsLink = screen.getByText('Products').closest('a');
            expect(productsLink).toHaveAttribute('href', '/products');

            const partiesLink = screen.getByText('Parties').closest('a');
            expect(partiesLink).toHaveAttribute('href', '/parties');

            const moreLink = screen.getByText('More').closest('a');
            expect(moreLink).toHaveAttribute('href', '/more');
        });
    });

    describe('route-based visibility', () => {
        it('should hide on /add routes', () => {
            usePathname.mockReturnValue('/products/add');
            const { container } = render(<BottomNav />);

            expect(container.firstChild).toBeNull();
        });

        it('should hide on /create routes', () => {
            usePathname.mockReturnValue('/invoice/create');
            const { container } = render(<BottomNav />);

            expect(container.firstChild).toBeNull();
        });

        it('should hide on /view routes', () => {
            usePathname.mockReturnValue('/invoice/view');
            const { container } = render(<BottomNav />);

            expect(container.firstChild).toBeNull();
        });

        it('should hide on /edit routes', () => {
            usePathname.mockReturnValue('/products/edit');
            const { container } = render(<BottomNav />);

            expect(container.firstChild).toBeNull();
        });

        it('should show on main listing pages', () => {
            usePathname.mockReturnValue('/products');
            render(<BottomNav />);

            expect(screen.getByText('Products')).toBeInTheDocument();
        });

        it('should show on parties page', () => {
            usePathname.mockReturnValue('/parties');
            render(<BottomNav />);

            expect(screen.getByText('Home')).toBeInTheDocument();
        });
    });

    describe('active state', () => {
        it('should apply active class to current route', () => {
            usePathname.mockReturnValue('/products');
            render(<BottomNav />);

            // The Products link should be in the document
            const productsLink = screen.getByText('Products').closest('a');
            expect(productsLink).toBeInTheDocument();
        });

        it('should not apply active class to non-current routes', () => {
            usePathname.mockReturnValue('/');
            render(<BottomNav />);

            // Home should be active, all others should not be
            const homeLink = screen.getByText('Home').closest('a');
            const billsLink = screen.getByText('Bills').closest('a');

            expect(homeLink).toBeInTheDocument();
            expect(billsLink).toBeInTheDocument();
        });
    });
});
</file>

<file path="src/components/AppBootstrap/AppBootstrap.js">
'use client';

import { useState, useEffect, useCallback } from 'react';
import { usePathname } from 'next/navigation';
import { api } from '@/api/backendClient';
import ServerSetup from '@/components/ServerConfig/ServerSetup';
import AuthWrapper from '@/components/Auth/AuthWrapper';
import styles from './AppBootstrap.module.css';

/**
 * AppBootstrap - Top-level connectivity gate
 * 
 * Ensures backend is configured and reachable BEFORE rendering AuthWrapper.
 * Flow: Check Config → Health Check → Auth
 * 
 * States:
 * - loading: Checking configuration/connectivity
 * - needsConfig: No URL configured, show ServerSetup
 * - healthCheckFailed: URL configured but unreachable, show ServerSetup with error
 * - ready: Connected, render AuthWrapper
 */
export default function AppBootstrap({ children }) {
    const pathname = usePathname();
    const isAdminRoute = pathname?.startsWith('/admin');

    const [state, setState] = useState('loading'); // loading | needsConfig | healthCheckFailed | ready
    const [lastUrl, setLastUrl] = useState('');
    const [connectionLost, setConnectionLost] = useState(false);

    const checkConnectivity = useCallback(async () => {
        setState('loading');

        try {
            // Get configured URL
            const url = await api.init();

            if (!url) {
                // No URL configured -> show setup
                setState('needsConfig');
                return;
            }

            setLastUrl(url);

            // URL exists, perform health check
            try {
                const isHealthy = await api.health();
                if (isHealthy) {
                    setState('ready');
                    setConnectionLost(false);
                } else {
                    setState('healthCheckFailed');
                }
            } catch (healthError) {
                console.error('Health check failed:', healthError);
                setState('healthCheckFailed');
            }
        } catch (error) {
            console.error('Bootstrap init failed:', error);
            setState('needsConfig');
        }
    }, []);

    useEffect(() => {
        checkConnectivity();

        // Listen for mid-session connection drops
        // This only affects the 'ready' state - shows a non-blocking banner
        const unsubscribe = api.onConnectionError(() => {
            // Only set connection lost if we're in ready state
            // Do NOT change state from ready - that would unmount AuthWrapper
            setConnectionLost(true);
        });

        return unsubscribe;
    }, [checkConnectivity]);

    const handleRetryConnection = async () => {
        setConnectionLost(false);
        try {
            const isHealthy = await api.health();
            if (!isHealthy) {
                setConnectionLost(true);
            }
        } catch (e) {
            setConnectionLost(true);
        }
    };

    const handleChangeServer = () => {
        setState('needsConfig');
        setConnectionLost(false);
    };

    const handleConfigured = () => {
        // After ServerSetup saves, re-check connectivity
        checkConnectivity();
    };

    // Loading state - neutral spinner to avoid UI flicker
    if (state === 'loading') {
        return (
            <div className={styles.loadingContainer}>
                <div className={styles.spinner} />
                <p className={styles.loadingText}>Connecting...</p>
            </div>
        );
    }

    // No URL configured - show ServerSetup (blocking)
    if (state === 'needsConfig') {
        return (
            <ServerSetup
                onConfigured={handleConfigured}
                initialUrl={lastUrl}
            />
        );
    }

    // URL configured but health check failed - show ServerSetup with error
    if (state === 'healthCheckFailed') {
        return (
            <ServerSetup
                onConfigured={handleConfigured}
                initialUrl={lastUrl}
                initialError="Unable to connect to server. Please check the URL or try again."
            />
        );
    }

    // Ready state - render content
    // Admin routes skip AuthWrapper (for shop/user setup before login)
    // Other routes go through AuthWrapper
    return (
        <>
            {/* Mid-session connection lost banner - non-blocking */}
            {connectionLost && (
                <div className={styles.connectionBanner}>
                    <span>Connection Lost</span>
                    <div className={styles.bannerActions}>
                        <button onClick={handleRetryConnection}>Retry</button>
                        <button onClick={handleChangeServer}>Change Server</button>
                    </div>
                </div>
            )}
            {isAdminRoute ? children : <AuthWrapper>{children}</AuthWrapper>}
        </>
    );
}
</file>

<file path="src/components/AppBootstrap/AppBootstrap.module.css">
.loadingContainer {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: #f8fafc;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e2e8f0;
    border-top-color: #2563eb;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.loadingText {
    margin-top: 16px;
    color: #64748b;
    font-size: 14px;
}

.connectionBanner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #ef4444;
    color: white;
    padding: 12px 16px;
    z-index: 9999;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.bannerActions {
    display: flex;
    gap: 10px;
}

.connectionBanner button {
    background: white;
    color: #ef4444;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
}

.connectionBanner button:hover {
    background: #fee2e2;
}
</file>

<file path="src/components/Auth/AuthWrapper.module.css">
.banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #ff4444;
    color: white;
    padding: 12px 16px;
    z-index: 9999;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.actions {
    display: flex;
    gap: 10px;
}

.banner button {
    background: white;
    color: #ff4444;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
}
</file>

<file path="src/components/Auth/LoginFlow.module.css">
.container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 24px;
    background: var(--background);
}

.logo {
    font-size: 48px;
    font-weight: 800;
    color: var(--foreground);
    margin-bottom: 16px;
}

.title {
    font-size: 24px;
    font-weight: 700;
    color: var(--foreground);
    margin-bottom: 8px;
    text-align: center;
}

.subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 48px;
    text-align: center;
}

.card {
    background: var(--card-bg);
    padding: 32px 24px;
    border-radius: 20px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.input {
    width: 100%;
    padding: 16px;
    border: 1px solid var(--border);
    border-radius: 12px;
    font-size: 16px;
    margin-bottom: 16px;
    outline: none;
    background: #F9FAFB;
}

.input:focus {
    border-color: var(--primary);
    background: white;
}

.button {
    width: 100%;
    padding: 16px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    margin-bottom: 12px;
}

.button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.backButton {
    width: 100%;
    padding: 16px;
    background: transparent;
    color: var(--primary);
    border: 1px solid var(--primary);
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}

.otpContainer {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-bottom: 24px;
}

.otpInput {
    width: 48px;
    height: 56px;
    text-align: center;
    font-size: 24px;
    font-weight: 700;
    border: 2px solid var(--border);
    border-radius: 12px;
    outline: none;
}

.otpInput:focus {
    border-color: var(--primary);
}

.error {
    color: #EF4444;
    font-size: 14px;
    margin-bottom: 16px;
    text-align: center;
}
</file>

<file path="src/components/Expenses/AddCategoryModal.js">
import { useState, useEffect } from 'react';
import { FiX } from 'react-icons/fi';
import { useExpenseStore } from '@/lib/store/expenseStore';
import styles from '@/app/more/bills/expenses/create/page.module.css';

export default function AddCategoryModal({ onClose, categoryToEdit }) {
    const { addCategory, updateCategory, deleteCategory } = useExpenseStore();
    const [categoryName, setCategoryName] = useState('');

    useEffect(() => {
        if (categoryToEdit) {
            setCategoryName(categoryToEdit);
        } else {
            setCategoryName('');
        }
    }, [categoryToEdit]);

    const handleSave = () => {
        if (!categoryName.trim()) return;

        if (categoryToEdit) {
            updateCategory(categoryToEdit, categoryName);
        } else {
            addCategory(categoryName);
        }
        onClose();
    };

    const handleDelete = () => {
        if (categoryToEdit) {
            deleteCategory(categoryToEdit);
            onClose();
        }
    };

    return (
        <div className={styles.modalOverlay} onClick={onClose}>
            <div className={styles.modalContent} onClick={(e) => e.stopPropagation()}>
                <div className={styles.modalHeader}>
                    <h2 className={styles.modalTitle}>
                        {categoryToEdit ? 'Edit Category' : 'Add Category'}
                    </h2>
                    <button onClick={onClose} className={styles.closeButton}>
                        <FiX />
                    </button>
                </div>
                <div className={styles.modalBody}>
                    <div className={styles.formGroup}>
                        <label className={styles.label}>Category Name</label>
                        <input
                            type="text"
                            value={categoryName}
                            onChange={(e) => setCategoryName(e.target.value)}
                            className={styles.input}
                            placeholder="Enter category name"
                            autoFocus
                        />
                    </div>
                </div>
                <div className={styles.modalFooter}>
                    <div className={styles.modalActions}>
                        {categoryToEdit && (
                            <button className={styles.deleteButton} onClick={handleDelete}>
                                Delete
                            </button>
                        )}
                        <button className={styles.saveButton} onClick={handleSave}>
                            Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/components/Expenses/CategoryModal.js">
import { useState } from 'react';
import { FiX, FiSearch, FiEdit2 } from 'react-icons/fi';
import { useExpenseStore } from '@/lib/store/expenseStore';
import styles from '@/app/more/bills/expenses/create/page.module.css'; // Reusing styles

export default function CategoryModal({ onClose, onSelect, onEdit }) {
    const { categories } = useExpenseStore();
    const [searchQuery, setSearchQuery] = useState('');

    const filteredCategories = categories.filter((cat) =>
        cat.toLowerCase().includes(searchQuery.toLowerCase())
    );

    return (
        <div className={styles.modalOverlay} onClick={onClose}>
            <div className={styles.modalContent} onClick={(e) => e.stopPropagation()}>
                <div className={styles.modalHeader}>
                    <h2 className={styles.modalTitle}>Select Category</h2>
                    <button onClick={onClose} className={styles.closeButton}>
                        <FiX />
                    </button>
                </div>
                <div className={styles.modalBody}>
                    <div className={styles.modalSearch}>
                        <FiSearch color="#888" />
                        <input
                            type="text"
                            placeholder="Search Expense Category"
                            className={styles.modalSearchInput}
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                    </div>
                    <div className={styles.categoryList}>
                        {filteredCategories.map((category) => (
                            <div
                                key={category}
                                className={styles.categoryItem}
                                onClick={() => onSelect(category)}
                            >
                                <span className={styles.categoryName}>{category}</span>
                                <FiEdit2
                                    className={styles.editIcon}
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        onEdit(category);
                                    }}
                                />
                            </div>
                        ))}
                    </div>
                </div>
                <div className={styles.modalFooter}>
                    <button
                        className={styles.addCategoryButton}
                        onClick={() => onEdit(null)} // null means adding new
                    >
                        Add Category
                    </button>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/components/icons/index.js">
// Custom SVG Icons with Gray Outlines and Gold Accents
// Design specs: 30x30 canvas, 2.25px stroke, rounded caps/joins
// Primary: #666666 | Accent: #D4AF37

// Invoice - Document with header line accent
export const InvoiceIcon = ({ size = 30, className }) => (
    <svg
        width={size}
        height={size}
        viewBox="0 0 30 30"
        fill="none"
        className={className}
    >
        {/* Document outline */}
        <rect x="5" y="4" width="20" height="22" rx="2.5" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        {/* Gold header line */}
        <line x1="9" y1="9" x2="21" y2="9" stroke="#D4AF37" strokeWidth="2.25" strokeLinecap="round" />
        {/* Content lines */}
        <line x1="9" y1="14" x2="21" y2="14" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
        <line x1="9" y1="19" x2="16" y2="19" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
    </svg>
);

// Purchase - Shopping Bag with plus accent
export const PurchaseIcon = ({ size = 30, className }) => (
    <svg
        width={size}
        height={size}
        viewBox="0 0 30 30"
        fill="none"
        className={className}
    >
        {/* Bag handles */}
        <path d="M11 10V7a4 4 0 018 0v3" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        {/* Bag body */}
        <rect x="6" y="10" width="18" height="16" rx="2.5" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        {/* Gold plus sign */}
        <line x1="15" y1="15" x2="15" y2="21" stroke="#D4AF37" strokeWidth="2.25" strokeLinecap="round" />
        <line x1="12" y1="18" x2="18" y2="18" stroke="#D4AF37" strokeWidth="2.25" strokeLinecap="round" />
    </svg>
);

// Quotation - Clipboard with header accent
export const QuotationIcon = ({ size = 30, className }) => (
    <svg
        width={size}
        height={size}
        viewBox="0 0 30 30"
        fill="none"
        className={className}
    >
        {/* Clipboard body */}
        <rect x="5" y="5" width="20" height="21" rx="2.5" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        {/* Clipboard clip */}
        <path d="M11 3h8v4a1 1 0 01-1 1h-6a1 1 0 01-1-1V3z" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        {/* Gold header bar */}
        <line x1="9" y1="12" x2="21" y2="12" stroke="#D4AF37" strokeWidth="2.25" strokeLinecap="round" />
        {/* Content lines */}
        <line x1="9" y1="17" x2="21" y2="17" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
        <line x1="9" y1="22" x2="15" y2="22" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
    </svg>
);

// DailyLogin - Calendar with checkmark accent
export const DailyLoginIcon = ({ size = 30, className }) => (
    <svg
        width={size}
        height={size}
        viewBox="0 0 30 30"
        fill="none"
        className={className}
    >
        {/* Calendar body */}
        <rect x="4" y="5" width="22" height="21" rx="2.5" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        {/* Calendar hooks */}
        <line x1="10" y1="3" x2="10" y2="8" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
        <line x1="20" y1="3" x2="20" y2="8" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
        {/* Horizontal divider */}
        <line x1="4" y1="11" x2="26" y2="11" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
        {/* Gold checkmark */}
        <path d="M10 18l3 3L20 15" stroke="#D4AF37" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
    </svg>
);

// LendingBill - Archive box with stroked arrow (fixed weight consistency)
export const LendingBillIcon = ({ size = 30, className }) => (
    <svg
        width={size}
        height={size}
        viewBox="0 0 30 30"
        fill="none"
        className={className}
    >
        {/* Archive box top */}
        <path d="M4 6.5a2.5 2.5 0 012.5-2.5h17a2.5 2.5 0 012.5 2.5v2.5H4V6.5z" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        {/* Archive box body */}
        <path d="M4 9h22v15a2.5 2.5 0 01-2.5 2.5h-17A2.5 2.5 0 014 24V9z" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        {/* Gold arrow pointing down - Simple stroke */}
        <line x1="15" y1="13" x2="15" y2="21" stroke="#D4AF37" strokeWidth="2.25" strokeLinecap="round" />
        <line x1="11" y1="17" x2="15" y2="21" stroke="#D4AF37" strokeWidth="2.25" strokeLinecap="round" />
        <line x1="19" y1="17" x2="15" y2="21" stroke="#D4AF37" strokeWidth="2.25" strokeLinecap="round" />
    </svg>
);

// Expenses - Wallet with coin accent (centered)
export const ExpensesIcon = ({ size = 30, className }) => (
    <svg
        width={size}
        height={size}
        viewBox="0 0 30 30"
        fill="none"
        className={className}
    >
        {/* Wallet body - optically centered */}
        <rect x="3" y="6" width="24" height="18" rx="2.5" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        {/* Wallet flap */}
        <path d="M3 11h24" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
        {/* Gold coin circle */}
        <circle cx="21" cy="16.5" r="2.5" stroke="#D4AF37" strokeWidth="2.25" />
    </svg>
);

// ProFormaInvoice - Simplified density (replaced buttons with lines)
export const ProFormaInvoiceIcon = ({ size = 30, className }) => (
    <svg
        width={size}
        height={size}
        viewBox="0 0 30 30"
        fill="none"
        className={className}
    >
        {/* Calculator body */}
        <rect x="5" y="3" width="20" height="24" rx="2.5" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        {/* Gold display screen */}
        <rect x="8" y="7" width="14" height="4" rx="1" stroke="#D4AF37" strokeWidth="2.25" />
        {/* Simple keypad lines - Less noise */}
        <line x1="8" y1="16" x2="13" y2="16" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
        <line x1="17" y1="16" x2="22" y2="16" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
        <line x1="8" y1="21" x2="13" y2="21" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
        <line x1="17" y1="21" x2="22" y2="21" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
    </svg>
);

// PaymentsTimeline - Document/card with checkmark
export const PaymentsTimelineIcon = ({ size = 30, className }) => (
    <svg
        width={size}
        height={size}
        viewBox="0 0 30 30"
        fill="none"
        className={className}
    >
        {/* Card/document outline */}
        <rect x="4" y="5" width="22" height="20" rx="2.5" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        {/* Horizontal lines */}
        <line x1="8" y1="11" x2="13" y2="11" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
        <line x1="8" y1="16" x2="15" y2="16" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
        {/* Gold checkmark */}
        <path d="M17 14l2.5 2.5 5-5" stroke="#D4AF37" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
    </svg>
);

// Reports - Clock with gold hands
export const ReportsIcon = ({ size = 30, className }) => (
    <svg
        width={size}
        height={size}
        viewBox="0 0 30 30"
        fill="none"
        className={className}
    >
        {/* Clock circle */}
        <circle cx="15" cy="15" r="11" stroke="#666666" strokeWidth="2.25" />
        {/* Tick marks */}
        <line x1="15" y1="4.5" x2="15" y2="6.5" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
        <line x1="15" y1="23.5" x2="15" y2="25.5" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
        <line x1="4.5" y1="15" x2="6.5" y2="15" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
        <line x1="23.5" y1="15" x2="25.5" y2="15" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
        {/* Gold clock hands */}
        <line x1="15" y1="15" x2="15" y2="9" stroke="#D4AF37" strokeWidth="2.25" strokeLinecap="round" />
        <line x1="15" y1="15" x2="20" y2="15" stroke="#D4AF37" strokeWidth="2.25" strokeLinecap="round" />
    </svg>
);

// Insights - Optically balanced
export const InsightsIcon = ({ size = 30, className }) => (
    <svg
        width={size}
        height={size}
        viewBox="0 0 30 30"
        fill="none"
        className={className}
    >
        {/* X and Y axis - shifted down slightly to ground it */}
        <path d="M4 5v21h22" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        {/* Gold rising trend line with nodes */}
        <path d="M9 20l5-5 5 2.5 6-7.5" stroke="#D4AF37" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        <circle cx="9" cy="20" r="2" fill="#D4AF37" />
        <circle cx="14" cy="15" r="2" fill="#D4AF37" />
        <circle cx="19" cy="17.5" r="2" fill="#D4AF37" />
        <circle cx="25" cy="10" r="2" fill="#D4AF37" />
    </svg>
);

// InvoiceTemplates - Simplified visual density
export const InvoiceTemplatesIcon = ({ size = 30, className }) => (
    <svg
        width={size}
        height={size}
        viewBox="0 0 30 30"
        fill="none"
        className={className}
    >
        {/* Document outline */}
        <path d="M17.5 3H8a2.5 2.5 0 00-2.5 2.5v19A2.5 2.5 0 008 27h14a2.5 2.5 0 002.5-2.5V10l-7-7z" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        {/* Folded corner */}
        <path d="M17.5 3v7.5H25" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        {/* Gold title line */}
        <line x1="10" y1="15" x2="20" y2="15" stroke="#D4AF37" strokeWidth="2.25" strokeLinecap="round" />
        {/* Content lines - Removed extra lines for density */}
        <line x1="10" y1="21" x2="20" y2="21" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" />
    </svg>
);

// DocumentSettings - Consistency fix
export const DocumentSettingsIcon = ({ size = 30, className }) => (
    <svg
        width={size}
        height={size}
        viewBox="0 0 30 30"
        fill="none"
        className={className}
    >
        {/* Gear outer shape */}
        <path d="M15 18.75a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5z" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        <path d="M24.25 18.75a2.06 2.06 0 00.41 2.28l.08.08a2.5 2.5 0 11-3.54 3.54l-.08-.08a2.06 2.06 0 00-2.28-.41 2.06 2.06 0 00-1.25 1.89v.2a2.5 2.5 0 01-5 0v-.11a2.06 2.06 0 00-1.35-1.89 2.06 2.06 0 00-2.28.41l-.08.08a2.5 2.5 0 11-3.54-3.54l.08-.08a2.06 2.06 0 00.41-2.28 2.06 2.06 0 00-1.89-1.25h-.2a2.5 2.5 0 010-5h.11a2.06 2.06 0 001.89-1.35 2.06 2.06 0 00-.41-2.28l-.08-.08a2.5 2.5 0 113.54-3.54l.08.08a2.06 2.06 0 002.28.41h.09a2.06 2.06 0 001.25-1.89v-.2a2.5 2.5 0 015 0v.11a2.06 2.06 0 001.25 1.89 2.06 2.06 0 002.28-.41l.08-.08a2.5 2.5 0 113.54 3.54l-.08.08a2.06 2.06 0 00-.41 2.28v.09a2.06 2.06 0 001.89 1.25h.2a2.5 2.5 0 010 5h-.11a2.06 2.06 0 00-1.89 1.25z" stroke="#666666" strokeWidth="2.25" strokeLinecap="round" strokeLinejoin="round" />
        {/* Gold center hub */}
        <circle cx="15" cy="15" r="2" fill="#D4AF37" />
    </svg>
);
</file>

<file path="src/components/InvoiceTemplates/index.js">
import { Template1 } from './Template1';
import { Template2 } from './Template2';
import { Template3 } from './Template3';

export const templates = {
    modern: {
        id: 'modern',
        name: 'Modern',
        component: Template1,
        thumbnail: '/templates/modern.svg',
        previewImage: '/templates/modern-preview.svg'
    },
    classic: {
        id: 'classic',
        name: 'Classic',
        component: Template2,
        thumbnail: '/templates/classic.svg',
        previewImage: '/templates/classic-preview.svg'
    },
    elegant: {
        id: 'elegant',
        name: 'Elegant',
        component: Template3,
        thumbnail: '/templates/elegant.svg',
        previewImage: '/templates/modern-preview.svg' // Placeholder
    }
};

export const getTemplate = (id) => {
    return templates[id] || templates.modern;
};
</file>

<file path="src/components/LandingPage/LandingPage.js">
'use client';

import { motion } from 'framer-motion';
import {
    RiRocketLine, RiPieChartLine, RiSecurePaymentLine, RiSmartphoneLine,
    RiInstagramLine, RiYoutubeFill, RiLinkedinFill, RiTwitterXFill, RiFacebookCircleFill,
    RiArrowUpLine
} from 'react-icons/ri';
import styles from './LandingPage.module.css';

export default function LandingPage({ onGetStarted }) {
    return (
        <div className={styles.container}>
            <nav className={styles.nav}>
                <div className={styles.logo}>swipe 🇮🇳</div>
                <button className={styles.secondaryButton} onClick={onGetStarted} style={{ padding: '0.5rem 1.5rem', fontSize: '0.9rem' }}>
                    Login
                </button>
            </nav>

            <main className={styles.hero}>
                <motion.div
                    className={styles.heroContent}
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.8 }}
                >
                    <span className={styles.badge}>New: GST E-Invoicing Support</span>
                    <h1 className={styles.title}>
                        Invoicing for the <br />
                        <span style={{ color: '#60a5fa' }}>Modern Business</span>
                    </h1>
                    <p className={styles.subtitle}>
                        Create professional invoices, track payments, and manage your inventory with the #1 billing app for Indian MSMEs.
                    </p>

                    <div className={styles.ctaGroup}>
                        <button className={styles.primaryButton} onClick={onGetStarted}>
                            Get Started Free
                        </button>
                        <button className={styles.secondaryButton}>
                            Watch Demo
                        </button>
                    </div>
                </motion.div>

                <motion.div
                    className={styles.heroImageContainer}
                    initial={{ opacity: 0, y: 40, rotateX: 10 }}
                    animate={{ opacity: 1, y: 0, rotateX: 0 }}
                    transition={{ duration: 1, delay: 0.2 }}
                >
                    <img
                        src="/hero-dashboard.png"
                        alt="Swipe Dashboard"
                        className={styles.heroImage}
                    />
                </motion.div>
            </main>

            <section className={styles.features}>
                <h2 className={styles.sectionTitle}>Everything you need to grow</h2>
                <div className={styles.grid}>
                    <FeatureCard
                        icon={RiRocketLine}
                        title="Lightning Fast"
                        text="Create invoices in less than 10 seconds. Share via WhatsApp or Email instantly."
                        delay={0}
                    />
                    <FeatureCard
                        icon={RiPieChartLine}
                        title="Smart Analytics"
                        text="Track your sales, expenses, and profits with beautiful, easy-to-understand charts."
                        delay={0.1}
                    />
                    <FeatureCard
                        icon={RiSecurePaymentLine}
                        title="Secure & Safe"
                        text="Your data is encrypted and backed up automatically. Access it from anywhere."
                        delay={0.2}
                    />
                    <FeatureCard
                        icon={RiSmartphoneLine}
                        title="Mobile First"
                        text="Designed for your phone. Manage your entire business from your pocket."
                        delay={0.3}
                    />
                </div>
            </section>
            <footer className={styles.footer}>
                <div className={styles.footerGrid}>
                    <div className={styles.footerColumn}>
                        <div className={styles.footerLogo}>
                            <div className={styles.logo}>swipe 🇮🇳</div>
                        </div>
                        <div className={styles.socialIcons}>
                            <RiInstagramLine className={styles.socialIcon} />
                            <RiYoutubeFill className={styles.socialIcon} />
                            <RiLinkedinFill className={styles.socialIcon} />
                            <RiTwitterXFill className={styles.socialIcon} />
                            <RiFacebookCircleFill className={styles.socialIcon} />
                        </div>
                    </div>

                    <div className={styles.footerColumn}>
                        <h4 className={styles.footerHeading}>Quick Links</h4>
                        <a href="#" className={styles.footerLink}>Home</a>
                        <a href="#" className={styles.footerLink}>Features</a>
                        <a href="#" className={styles.footerLink}>Pricing</a>
                        <a href="#" className={styles.footerLink}>Invoice Formats</a>
                        <a href="#" className={styles.footerLink}>Tutorials</a>
                    </div>

                    <div className={styles.footerColumn}>
                        <h4 className={styles.footerHeading}>Features</h4>
                        <a href="#" className={styles.footerLink}>Einvoices</a>
                        <a href="#" className={styles.footerLink}>Ewaybills</a>
                        <a href="#" className={styles.footerLink}>Swipe AI</a>
                        <a href="#" className={styles.footerLink}>Online Store</a>
                        <a href="#" className={styles.footerLink}>Integrations</a>
                    </div>

                    <div className={styles.footerColumn}>
                        <h4 className={styles.footerHeading}>Register</h4>
                        <a href="#" className={styles.footerLink}>Get Started</a>
                        <a href="#" className={styles.footerLink}>Login</a>
                        <a href="#" className={styles.footerLink}>Contact Us</a>
                    </div>

                    <div className={styles.footerColumn}>
                        <h4 className={styles.footerHeading}>Legal</h4>
                        <a href="#" className={styles.footerLink}>Privacy Policy</a>
                        <a href="#" className={styles.footerLink}>Refund Policy</a>
                        <a href="#" className={styles.footerLink}>Terms of Service</a>
                        <a href="#" className={styles.footerLink}>Refer your friends</a>
                    </div>

                    <div className={styles.footerColumn}>
                        <h4 className={styles.footerHeading}>Explore</h4>
                        <a href="#" className={styles.footerLink}>Blog</a>
                        <a href="#" className={styles.footerLink}>Join Community 🤝</a>
                        <a href="#" className={styles.footerLink}>Product Updates</a>
                        <a href="#" className={styles.footerLink}>Developers 👷</a>
                        <a href="#" className={styles.footerLink}>Swipe for Startups 🤝</a>
                        <a href="#" className={styles.footerLink}>Swipe for Accountants 💼</a>
                        <a href="#" className={styles.footerLink}>Tools</a>
                        <a href="#" className={styles.footerLink}>We're hiring 🚀</a>
                    </div>
                </div>
            </footer>

            <button
                className={styles.scrollTopButton}
                onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
            >
                <RiArrowUpLine size={24} />
            </button>
        </div>
    );
}

function FeatureCard({ icon: Icon, title, text, delay }) {
    return (
        <motion.div
            className={styles.card}
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.5, delay }}
        >
            <Icon className={styles.cardIcon} />
            <h3 className={styles.cardTitle}>{title}</h3>
            <p className={styles.cardText}>{text}</p>
        </motion.div>
    );
}
</file>

<file path="src/components/ServerConfig/ServerSetup.module.css">
.container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
    background-color: #f5f5f5;
}

.card {
    background: white;
    padding: 30px;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    width: 100%;
    max-width: 400px;
    text-align: center;
}

.title {
    margin: 0 0 10px 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: #1a1a1a;
}

.subtitle {
    margin: 0 0 24px 0;
    color: #666;
    font-size: 0.95rem;
    line-height: 1.5;
}

.inputGroup {
    margin-bottom: 20px;
}

.input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #eee;
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.2s;
    outline: none;
}

.input:focus {
    border-color: #0070f3;
}

.button {
    width: 100%;
    padding: 14px;
    background: #0070f3;
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
}

.button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.message {
    margin-bottom: 20px;
    padding: 10px;
    border-radius: 8px;
    font-size: 0.9rem;
}

.error {
    background: #fff0f0;
    color: #d32f2f;
}

.success {
    background: #f0fff4;
    color: #2e7d32;
}

.testing {
    background: #e3f2fd;
    color: #0288d1;
}
</file>

<file path="src/components/AddressBottomSheet.js">
import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { FiX } from 'react-icons/fi';
import styles from './BottomSheet.module.css'; // Reusing existing BottomSheet styles

export const AddressBottomSheet = ({ isOpen, onClose, onSave, initialData, title, showAutofill }) => {
    const [formData, setFormData] = useState({
        addressLine1: '',
        addressLine2: '',
        pincode: '',
        city: '',
        state: ''
    });

    useEffect(() => {
        if (isOpen && initialData) {
            setFormData(initialData);
        }
    }, [isOpen, initialData]);

    if (!isOpen) return null;

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleSave = () => {
        if (!formData.addressLine1 || !formData.state) {
            alert('Please fill required fields (*)');
            return;
        }
        onSave(formData);
        onClose();
    };

    // Mock fetch details
    const fetchDetails = () => {
        if (formData.pincode === '500032') {
            setFormData(prev => ({ ...prev, city: 'Hyderabad', state: 'Telangana' }));
        } else {
            alert('Details not found for this pincode (Try 500032)');
        }
    };

    return createPortal(
        <div className={styles.overlay} onClick={onClose}>
            <div className={styles.sheet} onClick={e => e.stopPropagation()}>
                <div className={styles.handleBar} />

                <div style={{ padding: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', borderBottom: '1px solid #eee' }}>
                    <h3 style={{ margin: 0, fontSize: '18px' }}>{title}</h3>
                    <FiX size={24} onClick={onClose} style={{ cursor: 'pointer' }} />
                </div>

                <div style={{ padding: '20px', display: 'flex', flexDirection: 'column', gap: '16px', maxHeight: '70vh', overflowY: 'auto' }}>
                    {showAutofill && (
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#2563eb', fontSize: '14px', fontWeight: 500 }}>
                            <input type="checkbox" /> Autofill Company Name
                        </div>
                    )}

                    <div>
                        <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px' }}>Address Line 1 <span style={{ color: 'red' }}>*</span></label>
                        <input
                            name="addressLine1"
                            value={formData.addressLine1}
                            onChange={handleChange}
                            style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #e5e7eb', fontSize: '16px' }}
                        />
                    </div>

                    <div>
                        <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px' }}>Address Line 2</label>
                        <input
                            name="addressLine2"
                            value={formData.addressLine2}
                            onChange={handleChange}
                            style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #e5e7eb', fontSize: '16px' }}
                        />
                    </div>

                    <div style={{ display: 'flex', gap: '12px' }}>
                        <div style={{ flex: 1 }}>
                            <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px' }}>Pincode</label>
                            <div style={{ position: 'relative' }}>
                                <input
                                    name="pincode"
                                    value={formData.pincode}
                                    onChange={handleChange}
                                    style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #e5e7eb', fontSize: '16px' }}
                                />
                                <button
                                    onClick={fetchDetails}
                                    style={{ position: 'absolute', right: '4px', top: '4px', bottom: '4px', background: '#2563eb', color: 'white', border: 'none', borderRadius: '6px', padding: '0 12px', fontSize: '12px', cursor: 'pointer' }}
                                >
                                    Fetch Details
                                </button>
                            </div>
                        </div>
                    </div>

                    <div style={{ display: 'flex', gap: '12px' }}>
                        <div style={{ flex: 1 }}>
                            <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px' }}>City</label>
                            <input
                                name="city"
                                value={formData.city}
                                onChange={handleChange}
                                style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #e5e7eb', fontSize: '16px' }}
                            />
                        </div>
                        <div style={{ flex: 1 }}>
                            <label style={{ display: 'block', fontSize: '12px', color: '#666', marginBottom: '4px' }}>State <span style={{ color: 'red' }}>*</span></label>
                            <input
                                name="state"
                                value={formData.state}
                                onChange={handleChange}
                                style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #e5e7eb', fontSize: '16px' }}
                            />
                        </div>
                    </div>

                    <button
                        onClick={handleSave}
                        style={{ width: '100%', background: '#2563eb', color: 'white', padding: '16px', borderRadius: '8px', border: 'none', fontSize: '16px', fontWeight: 'bold', marginTop: '16px' }}
                    >
                        Save & Update
                    </button>
                </div>
            </div>
        </div>,
        document.body
    );
};
</file>

<file path="src/components/AnimatedButton.js">
'use client';

import { motion } from 'framer-motion';
import { ANIMATIONS } from '@/lib/animations';

export default function AnimatedButton({ children, className, onClick, ...props }) {
    return (
        <motion.button
            whileHover={{ scale: 1.02 }}
            whileTap={{ scale: 0.95 }}
            transition={{
                duration: ANIMATIONS.duration.fast,
                ease: ANIMATIONS.ease.out,
            }}
            className={className}
            onClick={onClick}
            {...props}
        >
            {children}
        </motion.button>
    );
}
</file>

<file path="src/components/BackButtonHandler.js">
'use client';

import { useBackButton } from '@/lib/hooks/useBackButton';

export default function BackButtonHandler() {
    useBackButton();
    return null;
}
</file>

<file path="src/components/BottomSheet.module.css">
.overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    animation: fadeIn 0.2s ease-out;
}

.sheet {
    background-color: white;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
    padding-bottom: env(safe-area-inset-bottom);
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
}

.handleBar {
    width: 100%;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.handle {
    width: 40px;
    height: 4px;
    background-color: #e5e7eb;
    border-radius: 2px;
}

.content {
    padding: 0 16px 16px 16px;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }

    to {
        opacity: 1;
    }
}

@keyframes slideUp {
    from {
        transform: translateY(100%);
    }

    to {
        transform: translateY(0);
    }
}
</file>

<file path="src/components/CancelInvoiceModal.js">
'use client';

import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { ANIMATIONS } from '@/lib/animations';

export default function CancelInvoiceModal({ isOpen, onClose, onConfirm }) {
    const [mounted, setMounted] = useState(false);
    const [reason, setReason] = useState('');

    useEffect(() => {
        setMounted(true);
    }, []);

    if (!mounted) return null;

    return createPortal(
        <AnimatePresence>
            {isOpen && (
                <div style={{
                    position: 'fixed', inset: 0, zIndex: 50,
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    padding: '16px'
                }}>
                    {/* Backdrop */}
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        onClick={onClose}
                        style={{
                            position: 'absolute', inset: 0,
                            background: 'rgba(0, 0, 0, 0.5)',
                            backdropFilter: 'blur(2px)'
                        }}
                    />

                    {/* Modal Content */}
                    <motion.div
                        initial={{ opacity: 0, scale: 0.95, y: 10 }}
                        animate={{ opacity: 1, scale: 1, y: 0 }}
                        exit={{ opacity: 0, scale: 0.95, y: 10 }}
                        transition={{ duration: ANIMATIONS.duration.fast, ease: ANIMATIONS.ease.out }}
                        style={{
                            position: 'relative',
                            background: 'white',
                            borderRadius: '16px',
                            padding: '24px',
                            width: '100%',
                            maxWidth: '340px',
                            boxShadow: '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)'
                        }}
                    >
                        <h3 style={{
                            fontSize: '18px', fontWeight: 700, color: '#111827',
                            marginBottom: '16px', textAlign: 'center', lineHeight: 1.3
                        }}>
                            Do you want to cancel this invoice?
                        </h3>

                        <div style={{ position: 'relative', marginBottom: '16px' }}>
                            <input
                                type="text"
                                value={reason}
                                onChange={(e) => setReason(e.target.value)}
                                placeholder=" "
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    border: '1px solid #2563eb',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    outline: 'none',
                                    color: '#111827'
                                }}
                            />
                            <label style={{
                                position: 'absolute',
                                left: '12px',
                                top: '-8px',
                                background: 'white',
                                padding: '0 4px',
                                fontSize: '12px',
                                color: '#2563eb'
                            }}>
                                Enter reason
                            </label>
                            <div style={{
                                position: 'absolute',
                                left: '14px',
                                top: '14px',
                                width: '1px',
                                height: '20px',
                                background: '#111827',
                                animation: 'blink 1s step-end infinite'
                            }} />
                            <style jsx>{`
                                @keyframes blink {
                                    0%, 100% { opacity: 1; }
                                    50% { opacity: 0; }
                                }
                            `}</style>
                        </div>

                        <p style={{
                            color: '#ef4444',
                            fontSize: '13px',
                            marginBottom: '24px',
                            textAlign: 'left'
                        }}>
                            This action cannot be reversed
                        </p>

                        <div style={{ display: 'flex', gap: '12px' }}>
                            <button
                                onClick={onClose}
                                style={{
                                    flex: 1,
                                    padding: '10px',
                                    borderRadius: '8px',
                                    background: '#e5e7eb',
                                    color: '#4b5563',
                                    fontWeight: 600,
                                    fontSize: '14px'
                                }}
                            >
                                No
                            </button>
                            <button
                                onClick={() => onConfirm(reason)}
                                style={{
                                    flex: 1,
                                    padding: '10px',
                                    borderRadius: '8px',
                                    background: '#ef4444',
                                    color: 'white',
                                    fontWeight: 600,
                                    fontSize: '14px'
                                }}
                            >
                                Yes
                            </button>
                        </div>
                    </motion.div>
                </div>
            )}
        </AnimatePresence>,
        document.body
    );
}
</file>

<file path="src/components/ComingSoon.js">
'use client';

import { useRouter } from 'next/navigation';
import { RiRocketLine, RiArrowLeftLine } from 'react-icons/ri';
import styles from './ComingSoon.module.css';

export default function ComingSoon({ showBackButton = true }) {
    const router = useRouter();

    return (
        <div className={styles.container}>
            <div className={styles.iconWrapper}>
                <RiRocketLine size={64} color="#2563eb" />
            </div>
            <h1 className={styles.title}>Coming Soon!</h1>
            <p className={styles.subtitle}>
                We are working hard to bring this feature to you. Stay tuned for updates!
            </p>
            {showBackButton && (
                <button className={styles.button} onClick={() => router.back()}>
                    <RiArrowLeftLine size={20} />
                    Go Back
                </button>
            )}
        </div>
    );
}
</file>

<file path="src/components/ComingSoon.module.css">
.container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 24px;
    background-color: #F5F7FA;
    text-align: center;
}

.iconWrapper {
    width: 120px;
    height: 120px;
    background: #EFF6FF;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 32px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
}

.title {
    font-size: 28px;
    font-weight: 800;
    color: #111111;
    margin-bottom: 12px;
}

.subtitle {
    font-size: 16px;
    color: #6B7280;
    margin-bottom: 48px;
    line-height: 1.5;
    max-width: 300px;
}

.button {
    background: #2563eb;
    color: white;
    padding: 16px 32px;
    border-radius: 16px;
    font-weight: 600;
    font-size: 16px;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.button:active {
    transform: scale(0.98);
}
</file>

<file path="src/components/ImagePicker.js">
import React, { useRef } from 'react';
import { FiCamera } from 'react-icons/fi';

export const ImagePicker = ({ image, onImageSelect }) => {
    const fileInputRef = useRef(null);

    const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onloadend = () => {
                onImageSelect(reader.result);
            };
            reader.readAsDataURL(file);
        }
    };

    return (
        <div
            onClick={() => fileInputRef.current.click()}
            style={{
                width: '100px',
                height: '100px',
                borderRadius: '16px',
                background: image ? `url(${image}) center/cover no-repeat` : '#f3f4f6',
                border: '1px solid #e5e7eb',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                cursor: 'pointer',
                position: 'relative',
                boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)'
            }}
        >
            <input
                type="file"
                ref={fileInputRef}
                onChange={handleFileChange}
                accept="image/*"
                style={{ display: 'none' }}
            />
            {!image && <FiCamera size={32} color="#9ca3af" />}

            {/* Edit Icon Overlay */}
            <div style={{
                position: 'absolute',
                top: -8,
                right: -8,
                background: 'white',
                borderRadius: '50%',
                padding: '4px',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }}>
                <div style={{ width: '20px', height: '20px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#2563eb', fontSize: '16px' }}>+</div>
            </div>
        </div>
    );
};
</file>

<file path="src/components/InvoiceTemplate.js">
import React from 'react';
import { formatCurrency } from '@/lib/utils/tax';

export const InvoiceTemplate = ({ data }) => {
    const { invoiceNumber, date, items, totals } = data;

    return (
        <div style={{ padding: '40px', background: 'white', width: '800px', fontFamily: 'Arial, sans-serif' }} id="invoice-template">
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '40px' }}>
                <div>
                    <h1 style={{ fontSize: '32px', color: '#2563eb', margin: 0 }}>INVOICE</h1>
                    <p style={{ color: '#666', marginTop: '8px' }}>#{invoiceNumber}</p>
                </div>
                <div style={{ textAlign: 'right' }}>
                    <p style={{ fontWeight: 'bold' }}>Date: {date}</p>
                </div>
            </div>

            <table style={{ width: '100%', borderCollapse: 'collapse', marginBottom: '40px' }}>
                <thead>
                    <tr style={{ background: '#f8f9fa', textAlign: 'left' }}>
                        <th style={{ padding: '12px', borderBottom: '2px solid #eee' }}>Item</th>
                        <th style={{ padding: '12px', borderBottom: '2px solid #eee', textAlign: 'right' }}>Qty</th>
                        <th style={{ padding: '12px', borderBottom: '2px solid #eee', textAlign: 'right' }}>Rate</th>
                        <th style={{ padding: '12px', borderBottom: '2px solid #eee', textAlign: 'right' }}>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {items.map((item, index) => (
                        <tr key={index} style={{ borderBottom: '1px solid #eee' }}>
                            <td style={{ padding: '12px' }}>{item.name}</td>
                            <td style={{ padding: '12px', textAlign: 'right' }}>{item.quantity}</td>
                            <td style={{ padding: '12px', textAlign: 'right' }}>{formatCurrency(item.rate)}</td>
                            <td style={{ padding: '12px', textAlign: 'right' }}>{formatCurrency(item.quantity * item.rate)}</td>
                        </tr>
                    ))}
                </tbody>
            </table>

            <div style={{ display: 'flex', justifyContent: 'flex-end' }}>
                <div style={{ width: '300px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0' }}>
                        <span>Subtotal:</span>
                        <span>{formatCurrency(totals.subtotal)}</span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0' }}>
                        <span>Tax:</span>
                        <span>{formatCurrency(totals.totalTax)}</span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px 0', borderTop: '2px solid #eee', fontWeight: 'bold', fontSize: '18px' }}>
                        <span>Total:</span>
                        <span>{formatCurrency(totals.total)}</span>
                    </div>
                </div>
            </div>
        </div>
    );
};
</file>

<file path="src/components/PartyListItem.js">
import React from 'react';
import { FiArrowDown } from 'react-icons/fi';

export const PartyListItem = ({ party, onClick }) => {
    const balance = party.balance || 0;
    const isDue = balance > 0;
    const isAdvance = balance < 0;

    return (
        <div
            onClick={onClick}
            style={{
                display: 'flex',
                alignItems: 'center',
                padding: '16px',
                background: 'white',
                borderBottom: '1px solid #f3f4f6',
                cursor: 'pointer'
            }}
        >
            <div style={{
                width: '40px',
                height: '40px',
                borderRadius: '50%',
                background: '#e0e7ff',
                color: '#3730a3',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontWeight: 'bold',
                marginRight: '12px'
            }}>
                {party.name[0].toUpperCase()}
            </div>

            <div style={{ flex: 1 }}>
                <div style={{ fontWeight: 600, color: '#111827' }}>{party.name}</div>
                <div style={{ fontSize: '12px', color: '#6b7280' }}>
                    {party.phone || 'No phone'}
                </div>
            </div>

            <div style={{ textAlign: 'right' }}>
                {balance === 0 ? (
                    <div style={{ fontSize: '14px', color: '#6b7280' }}>No dues</div>
                ) : (
                    <div style={{
                        fontSize: '14px',
                        fontWeight: 600,
                        color: isDue ? '#dc2626' : '#16a34a',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'flex-end',
                        gap: '4px'
                    }}>
                        {isDue && <FiArrowDown />}
                        ₹ {Math.abs(balance).toFixed(2)}
                    </div>
                )}
                {balance !== 0 && (
                    <div style={{ fontSize: '10px', color: isDue ? '#dc2626' : '#16a34a' }}>
                        {isDue ? 'You get' : 'You pay'}
                    </div>
                )}
            </div>
        </div>
    );
};
</file>

<file path="src/components/PurchaseForm.module.css">
.container {
    padding: 16px;
    padding-bottom: 120px;
    /* Space for fixed footer */
}

.card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.label {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 4px;
}

.value {
    font-size: 14px;
    font-weight: 500;
    color: #111827;
}

.sectionTitle {
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.addButton {
    width: 100%;
    padding: 12px;
    background: #eff6ff;
    border: 1px dashed #3b82f6;
    border-radius: 8px;
    color: #2563eb;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
}

.itemRow {
    border-bottom: 1px solid #f3f4f6;
    padding-bottom: 12px;
    margin-bottom: 12px;
}

.itemHeader {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.itemInputs {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    align-items: center;
}

.input {
    width: 100%;
    padding: 8px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 14px;
}

/* Optional Fields */
.optionalRow {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid #f3f4f6;
}

.optionalLabel {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #4b5563;
}

.optionalInput {
    border: none;
    text-align: right;
    font-size: 14px;
    outline: none;
    width: 120px;
}

/* Toggles */
.toggleRow {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.toggleRow:last-child {
    margin-bottom: 0;
}

.toggleLabel {
    font-size: 14px;
    font-weight: 600;
    color: #111827;
}

.toggleSwitch {
    width: 44px;
    height: 24px;
    background: #e5e7eb;
    border-radius: 12px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
}

.toggleSwitch.active {
    background: #2563eb;
}

.toggleKnob {
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    position: absolute;
    top: 2px;
    left: 2px;
    transition: transform 0.2s;
}

.toggleSwitch.active .toggleKnob {
    transform: translateX(20px);
}

/* Payments */
.checkboxRow {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
}

.paymentGrid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.inputWrapper {
    display: flex;
    align-items: center;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 0 8px;
}

.paymentInput {
    width: 100%;
    padding: 8px;
    border: none;
    outline: none;
}

.select {
    width: 100%;
    padding: 8px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: white;
}

/* Footer */
.footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fef3c7;
    padding: 16px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 10;
}

.footerLeft {
    flex: 1;
}

.footerRow {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 4px;
}

.totalAmount {
    font-size: 16px;
    font-weight: 700;
    color: #111827;
    margin-top: 4px;
}

.createButton {
    background: #f59e0b;
    color: white;
    border: none;
    padding: 10px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

/* Vendor Selection Styles */
.selectedVendor {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.vendorInfo {
    flex: 1;
}

.vendorName {
    font-weight: 600;
    font-size: 16px;
    color: #111827;
}

.vendorPhone {
    font-size: 13px;
    color: #6b7280;
}

.vendorActions {
    display: flex;
    gap: 12px;
}

.actionButton {
    background: none;
    border: none;
    color: #f59e0b;
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    padding: 4px 8px;
}

/* Item Actions */
.itemActions {
    display: flex;
    gap: 8px;
}

.itemActionBtn {
    border: none;
    background: none;
    padding: 4px;
    cursor: pointer;
    color: #6b7280;
}

.itemActionBtn:hover {
    color: #111827;
}

.itemActionBtn.delete {
    color: #ef4444;
}
</file>

<file path="src/components/ScanResultModal.js">
'use client';

import { FiShoppingBag, FiX, FiRefreshCw, FiPlus } from 'react-icons/fi';
import styles from './ScanResultModal.module.css';

export default function ScanResultModal({
    isOpen,
    product,
    barcode,
    onAddToTray,
    onScanAgain,
    onAddManually,
    onClose
}) {
    if (!isOpen) return null;

    const hasProduct = !!product;

    return (
        <div className={styles.overlay} onClick={onClose}>
            <div className={styles.modal} onClick={(e) => e.stopPropagation()}>
                <button className={styles.closeBtn} onClick={onClose}>
                    <FiX size={24} />
                </button>

                {hasProduct ? (
                    <>
                        {/* Product Found */}
                        <div className={styles.productCard}>
                            <div className={styles.imageContainer}>
                                {product.images && product.images.length > 0 ? (
                                    <img src={product.images[0].data} alt={product.name} className={styles.image} />
                                ) : (
                                    <div className={styles.placeholderImage}>
                                        <FiShoppingBag size={40} color="#9ca3af" />
                                    </div>
                                )}
                            </div>
                            <div className={styles.productDetails}>
                                <div className={styles.purity}>{product.purity || '22K'}</div>
                                <h3 className={styles.productName}>{product.name || product.subCategory}</h3>
                                <div className={styles.productMeta}>
                                    Weight: {product.grossWeight || 0}g | {product.stoneType || 'Plain Gold'}
                                </div>
                            </div>
                        </div>

                        <button className={styles.primaryBtn} onClick={() => onAddToTray(product)}>
                            <FiPlus size={18} />
                            Add to Tray
                        </button>
                    </>
                ) : (
                    <>
                        {/* Product Not Found */}
                        <div className={styles.notFoundIcon}>
                            <FiShoppingBag size={48} color="#9ca3af" />
                        </div>
                        <h3 className={styles.title}>No Product Found</h3>
                        <p className={styles.message}>
                            No product matches barcode: <strong>{barcode}</strong>
                        </p>

                        <div className={styles.actions}>
                            <button className={styles.secondaryBtn} onClick={onScanAgain}>
                                <FiRefreshCw size={18} />
                                Scan Again
                            </button>
                            <button className={styles.primaryBtn} onClick={() => onAddManually(barcode)}>
                                <FiPlus size={18} />
                                Add Manually
                            </button>
                        </div>
                    </>
                )}
            </div>
        </div>
    );
}
</file>

<file path="src/components/ScanResultModal.module.css">
.overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
}

.modal {
    background: white;
    border-radius: 16px;
    width: 100%;
    max-width: 360px;
    padding: 24px;
    position: relative;
}

.closeBtn {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
}

.productCard {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
}

.imageContainer {
    width: 80px;
    height: 80px;
    border-radius: 12px;
    overflow: hidden;
    flex-shrink: 0;
}

.image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.placeholderImage {
    width: 100%;
    height: 100%;
    background: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
}

.productDetails {
    flex: 1;
}

.purity {
    background: rgba(234, 179, 8, 0.9);
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    display: inline-block;
    margin-bottom: 8px;
}

.productName {
    margin: 0 0 4px;
    font-size: 16px;
    font-weight: 600;
    color: #111827;
}

.productMeta {
    font-size: 13px;
    color: #6b7280;
}

.notFoundIcon {
    width: 80px;
    height: 80px;
    background: #f3f4f6;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
}

.title {
    text-align: center;
    margin: 0 0 8px;
    font-size: 18px;
    font-weight: 600;
    color: #111827;
}

.message {
    text-align: center;
    margin: 0 0 24px;
    font-size: 14px;
    color: #6b7280;
}

.actions {
    display: flex;
    gap: 12px;
}

.primaryBtn {
    flex: 1;
    background: #ca8a04;
    color: white;
    border: none;
    padding: 12px 16px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.primaryBtn:hover {
    background: #a16207;
}

.secondaryBtn {
    flex: 1;
    background: #f3f4f6;
    color: #374151;
    border: none;
    padding: 12px 16px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.secondaryBtn:hover {
    background: #e5e7eb;
}
</file>

<file path="src/components/Toast.js">
'use client';

import { useState, useEffect, createContext, useContext, useCallback } from 'react';
import { createPortal } from 'react-dom';
import { registerToastCallback } from '@/lib/utils/invoiceActions';

// Toast Context
const ToastContext = createContext(null);

export const useToast = () => {
    const context = useContext(ToastContext);
    if (!context) {
        console.warn('useToast must be used within ToastProvider');
        return { showToast: () => { } };
    }
    return context;
};

// Toast styles
const toastStyles = {
    container: {
        position: 'fixed',
        bottom: '100px',
        left: '50%',
        transform: 'translateX(-50%)',
        zIndex: 9999,
        pointerEvents: 'none'
    },
    toast: {
        padding: '12px 20px',
        borderRadius: '8px',
        fontSize: '14px',
        fontWeight: 500,
        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
        display: 'flex',
        alignItems: 'center',
        gap: '8px',
        animation: 'slideUp 0.3s ease-out',
        maxWidth: '90vw',
        textAlign: 'center'
    },
    success: {
        background: '#10b981',
        color: 'white'
    },
    error: {
        background: '#ef4444',
        color: 'white'
    },
    info: {
        background: '#3b82f6',
        color: 'white'
    }
};

// Toast Component
const Toast = ({ message, type, onClose }) => {
    useEffect(() => {
        const timer = setTimeout(onClose, 3000);
        return () => clearTimeout(timer);
    }, [onClose]);

    const icons = {
        success: '✓',
        error: '✕',
        info: 'ℹ'
    };

    return (
        <div style={{ ...toastStyles.toast, ...toastStyles[type] }}>
            <span>{icons[type]}</span>
            <span>{message}</span>
        </div>
    );
};

// Toast Provider Component
export const ToastProvider = ({ children }) => {
    const [toasts, setToasts] = useState([]);
    const [mounted, setMounted] = useState(false);

    const showToast = useCallback((message, type = 'info') => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type }]);
    }, []);

    const removeToast = useCallback((id) => {
        setToasts(prev => prev.filter(t => t.id !== id));
    }, []);

    // Register callback with invoiceActions utility
    useEffect(() => {
        setMounted(true);
        registerToastCallback(showToast);
        return () => registerToastCallback(null);
    }, [showToast]);

    // Inject keyframes for animation
    useEffect(() => {
        if (typeof document !== 'undefined') {
            const styleId = 'toast-animations';
            if (!document.getElementById(styleId)) {
                const style = document.createElement('style');
                style.id = styleId;
                style.textContent = `
                    @keyframes slideUp {
                        from { opacity: 0; transform: translateY(20px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                `;
                document.head.appendChild(style);
            }
        }
    }, []);

    return (
        <ToastContext.Provider value={{ showToast }}>
            {children}
            {mounted && typeof document !== 'undefined' && createPortal(
                <div style={toastStyles.container}>
                    {toasts.map(toast => (
                        <Toast
                            key={toast.id}
                            message={toast.message}
                            type={toast.type}
                            onClose={() => removeToast(toast.id)}
                        />
                    ))}
                </div>,
                document.body
            )}
        </ToastContext.Provider>
    );
};

export default ToastProvider;
</file>

<file path="src/lib/data/tagTemplates.js">
// Tag Template Definitions
// These are static template configurations used for barcode label printing

export const TAG_TEMPLATES = [
    {
        template_id: 'MINIMAL',
        name: 'Minimal Tag',
        description: 'Fast printing, least clutter',
        preview_front: '/images/templates/minimal_front.png',
        preview_back: '/images/templates/minimal_back.png',
        fields_front: ['barcode', 'sku', 'category'],
        fields_back: ['netWeight', 'purity'],
        version: 1
    },
    {
        template_id: 'WEIGHT',
        name: 'Weight-Focused Tag',
        description: 'Highlights product weight prominently',
        preview_front: '/images/templates/weight_front.png',
        preview_back: '/images/templates/weight_back.png',
        fields_front: ['barcode', 'netWeight', 'purity'],
        fields_back: ['sku', 'grossWeight', 'price'],
        version: 1
    },
    {
        template_id: 'DETAILED',
        name: 'Detailed Tag',
        description: 'High-detail for premium jewellery',
        preview_front: '/images/templates/detailed_front.png',
        preview_back: '/images/templates/detailed_back.png',
        fields_front: ['barcode', 'sku', 'category', 'netWeight', 'purity'],
        fields_back: ['stoneDetails', 'makingCharges', 'finalPrice'],
        version: 1
    }
];

// Helper to get template by ID
export const getTemplateById = (templateId) => {
    return TAG_TEMPLATES.find(t => t.template_id === templateId);
};

// Default template
export const DEFAULT_TEMPLATE_ID = 'MINIMAL';
</file>

<file path="src/lib/hooks/useBackButton.js">
import { useEffect } from 'react';
import { App } from '@capacitor/app';
import { useRouter, usePathname } from 'next/navigation';

export const useBackButton = () => {
    const router = useRouter();
    const pathname = usePathname();

    useEffect(() => {
        const handleBackButton = async () => {
            App.addListener('backButton', ({ canGoBack }) => {
                if (pathname === '/') {
                    App.exitApp();
                } else {
                    router.back();
                }
            });
        };

        handleBackButton();

        return () => {
            App.removeAllListeners();
        };
    }, [router, pathname]);
};
</file>

<file path="src/lib/logger/__tests__/logger.test.js">
import { logger } from '../logger';
import { LOG_EVENTS } from '../events';
import { exportLogs } from '../export';

// Mock storage to prevent actual DB/FS writes during tests
jest.mock('../storage', () => ({
    initStorage: jest.fn().mockResolvedValue({
        write: jest.fn().mockResolvedValue(true),
        readAll: jest.fn().mockResolvedValue([]),
        clear: jest.fn().mockResolvedValue(true),
        getSize: jest.fn().mockResolvedValue(0)
    })
}));

describe('Logger System', () => {

    test('should expose all log levels', () => {
        expect(typeof logger.debug).toBe('function');
        expect(typeof logger.info).toBe('function');
        expect(typeof logger.warn).toBe('function');
        expect(typeof logger.error).toBe('function');
        expect(typeof logger.audit).toBe('function');
    });

    test('should have defined LOG_EVENTS', () => {
        expect(LOG_EVENTS).toBeDefined();
        expect(LOG_EVENTS.APP_INIT).toBe('APP_INIT');
        expect(LOG_EVENTS.AUTH_LOGIN_SUCCESS).toBe('AUTH_LOGIN_SUCCESS');
    });

    test('should allow logging without error', async () => {
        // This primarily tests that the facade doesn't crash
        // Deep verification would require spying on the internal storage which is mocked
        expect(() => logger.info(LOG_EVENTS.APP_INIT, { test: true })).not.toThrow();
    });

    test('exportLogs should be a function', () => {
        expect(typeof exportLogs).toBe('function');
    });

});
</file>

<file path="src/lib/logger/config.ts">
// Log levels with numeric priority for filtering
export const LOG_LEVELS: Record<string, number> = {
    debug: 0,
    info: 1,
    warn: 2,
    error: 3,
    audit: 4, // Audit always has highest priority
};

// Determine current environment
const isDev = process.env.NODE_ENV !== 'production';

// Minimum level to persist
export const MIN_LOG_LEVEL = isDev ? 'debug' : 'info';

// Storage configuration
export const STORAGE_CONFIG = {
    DB_NAME: 'swipe_logs_db',
    STORE_LOGS: 'logs',
    STORE_AUDIT: 'audit_logs',
    MAX_SIZE_BYTES_LOGS: 5 * 1024 * 1024, // 5 MB
    MAX_SIZE_BYTES_AUDIT: 10 * 1024 * 1024, // 10 MB
    // For file system (native)
    DIR_LOGS: 'logs',
    FILE_LOGS: 'app_logs.json',
    FILE_AUDIT: 'audit_logs.json',
};
</file>

<file path="src/lib/logger/context.ts">
import { v4 as uuidv4 } from 'uuid';
import { Device } from './types';

// Simple session ID that persists for the lifetime of the module (app session)
export const SESSION_ID = uuidv4();

/**
 * Get the application version
 */
export const getAppVersion = () => {
    // TODO: Inject this via environment variable in next.config.mjs
    // process.env.NEXT_PUBLIC_APP_VERSION
    return '0.1.0';
};

export const getDevice = (): Device => {
    if (typeof window !== 'undefined' && (window as any).Capacitor && (window as any).Capacitor.isNative) {
        if ((window as any).Capacitor.getPlatform() === 'ios') return 'ios';
        return 'android';
    }
    return 'web';
};

export const getContext = () => ({
    sessionId: SESSION_ID,
    appVersion: getAppVersion(),
    device: getDevice(),
});
</file>

<file path="src/lib/logger/events.ts">
export const LOG_EVENTS = {
    // System
    APP_INIT: 'APP_INIT',
    APP_ERROR: 'APP_ERROR',
    UNHANDLED_REJECTION: 'UNHANDLED_REJECTION',
    PERMISSION_CHECK: 'PERMISSION_CHECK',
    PERMISSION_GRANTED: 'PERMISSION_GRANTED',
    PERMISSION_DENIED: 'PERMISSION_DENIED',

    // Auth
    AUTH_CHECK: 'AUTH_CHECK',
    AUTH_LOGIN_START: 'AUTH_LOGIN_START',
    AUTH_LOGIN_SUCCESS: 'AUTH_LOGIN_SUCCESS',
    AUTH_LOGIN_FAILED: 'AUTH_LOGIN_FAILED',
    AUTH_LOGOUT: 'AUTH_LOGOUT',
    AUTH_OTP_REQUEST: 'AUTH_OTP_REQUEST',
    AUTH_OTP_VERIFY: 'AUTH_OTP_VERIFY',

    // Invoice
    INVOICE_CREATED: 'INVOICE_CREATED',
    INVOICE_UPDATED: 'INVOICE_UPDATED',
    INVOICE_DELETED: 'INVOICE_DELETED',
    INVOICE_PDF_GENERATING: 'INVOICE_PDF_GENERATING',
    INVOICE_PDF_GENERATED: 'INVOICE_PDF_GENERATED',
    INVOICE_SHARED: 'INVOICE_SHARED',
    INVOICE_SHARE_FAILED: 'INVOICE_SHARE_FAILED',
    INVOICE_DOWNLOADED: 'INVOICE_DOWNLOADED',
    INVOICE_DOWNLOAD_FAILED: 'INVOICE_DOWNLOAD_FAILED',
    INVOICE_LOAD_FAILED: 'INVOICE_LOAD_FAILED',
    INVOICE_SAVE_FAILED: 'INVOICE_SAVE_FAILED',

    // PDF / Share
    PDF_GENERATION_FAILED: 'PDF_GENERATION_FAILED',
    SHARE_PLATFORM_NATIVE: 'SHARE_PLATFORM_NATIVE',
    SHARE_PLATFORM_WEB: 'SHARE_PLATFORM_WEB',
    SHARE_SUCCESS: 'SHARE_SUCCESS',
    SHARE_FAILED: 'SHARE_FAILED',
    DOWNLOAD_PLATFORM_NATIVE: 'DOWNLOAD_PLATFORM_NATIVE',
    DOWNLOAD_PLATFORM_WEB: 'DOWNLOAD_PLATFORM_WEB',

    // Products
    PRODUCT_SCAN: 'PRODUCT_SCAN',
    PRODUCT_SCAN_ERROR: 'PRODUCT_SCAN_ERROR',
    PRODUCT_ADD: 'PRODUCT_ADD',
    PRODUCT_UPDATE: 'PRODUCT_UPDATE',
    PRODUCT_DELETE: 'PRODUCT_DELETE',
    PRODUCT_LOAD_FAILED: 'PRODUCT_LOAD_FAILED',
    PRODUCT_SEARCH: 'PRODUCT_SEARCH',

    // Stores
    STORE_LOAD_ERROR: 'STORE_LOAD_ERROR',
    STORE_SAVE_ERROR: 'STORE_SAVE_ERROR',
    STORE_DELETE_ERROR: 'STORE_DELETE_ERROR',
    STORE_UPDATE_ERROR: 'STORE_UPDATE_ERROR',
    STORE_ACTION_ERROR: 'STORE_ACTION_ERROR',

    // Bulk Upload
    BULK_UPLOAD_START: 'BULK_UPLOAD_START',
    BULK_UPLOAD_SUCCESS: 'BULK_UPLOAD_SUCCESS',
    BULK_UPLOAD_FAILED: 'BULK_UPLOAD_FAILED',
    BULK_UPLOAD_ROW_ERROR: 'BULK_UPLOAD_ROW_ERROR',

    // Audit
    AUDIT_LOG_CREATED: 'AUDIT_LOG_CREATED',
    AUDIT_LOG_FAILED: 'AUDIT_LOG_FAILED',

    // UI
    TOAST_SHOWN: 'TOAST_SHOWN',
};
</file>

<file path="src/lib/logger/logger.ts">
import { Logger, LogEvent, LogLevel, LogEntry, Device } from './types';
import { LOG_LEVELS, MIN_LOG_LEVEL } from './config';
import { getContext } from './context';
import { LogStorage } from './storage';

// Storage implementation will be injected
let storage: LogStorage | null = null;

// Initialize storage automatically
const initStorage = async () => {
    if (typeof window === 'undefined') return;

    const { getDevice } = await import('./context');
    const device = getDevice();

    if (device !== 'web') {
        // Native (Android/iOS)
        const { CapacitorStorage } = await import('./storage/capacitorFs');
        storage = new CapacitorStorage();
    } else {
        // Web
        const { IndexedDbStorage } = await import('./storage/indexedDb');
        storage = new IndexedDbStorage();
    }

    if (storage) {
        storage.init().catch(err => console.error('Failed to init log storage:', err));
    }
};

// Start init
if (typeof window !== 'undefined') {
    initStorage();
}

const createLogEntry = (
    level: LogLevel,
    event: LogEvent,
    context: Record<string, unknown> = {}
): LogEntry => {
    const meta = getContext();
    return {
        timestamp: new Date().toISOString(),
        level,
        event,
        context,
        ...meta
    };
};

const shouldLog = (level: LogLevel): boolean => {
    return LOG_LEVELS[level] >= LOG_LEVELS[MIN_LOG_LEVEL];
};

const log = (level: LogLevel, event: LogEvent, context: Record<string, unknown> = {}) => {
    // Always allow audit, otherwise check level
    if (level !== 'audit' && !shouldLog(level)) {
        return;
    }

    const entry = createLogEntry(level, event, context);

    // Console output (dev only or formatted)
    if (process.env.NODE_ENV !== 'production') {
        const style = level === 'error' ? 'color: red' :
            level === 'warn' ? 'color: orange' :
                level === 'debug' ? 'color: gray' : 'color: blue';
        // Use raw console methods to avoid circular dependency if we patch console later
        // eslint-disable-next-line
        console.log(`%c[${level.toUpperCase()}] ${event}`, style, context);
    }

    // Persist to storage
    if (storage) {
        storage.write(entry).catch(err => {
            // Fallback to console if storage fails, but prevent infinite loop
            if (process.env.NODE_ENV !== 'production') {
                // eslint-disable-next-line
                console.error('Logger storage failed:', err);
            }
        });
    }
};

export const logger: Logger = {
    debug: (event, context) => log('debug', event, context),
    info: (event, context) => log('info', event, context),
    warn: (event, context) => log('warn', event, context),
    error: (event, context) => log('error', event, context),
    audit: (event, context) => log('audit', event, context),
};
</file>

<file path="src/lib/logger/redact.ts">
/**
 * PII Redaction Utility for Log Export
 * 
 * Provides pattern-based redaction for sensitive data:
 * - Key-based patterns: password, token, secret, auth, apikey, credential
 * - Value-based patterns: JWT tokens, emails, phone numbers
 */

import { LogEntry } from './types';

// Key patterns that indicate sensitive data
const SENSITIVE_KEY_PATTERNS = [
    /password/i,
    /secret/i,
    /token/i,
    /auth/i,
    /apikey/i,
    /api_key/i,
    /credential/i,
    /bearer/i,
    /authorization/i,
    /session/i,
    /cookie/i,
    /private/i,
];

// Value patterns for detecting sensitive data
const JWT_PATTERN = /^eyJ[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;
const EMAIL_PATTERN = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
const PHONE_PATTERN = /^[\+]?[(]?[0-9]{1,3}[)]?[-\s\.]?[0-9]{3,4}[-\s\.]?[0-9]{4,6}$/;
const CREDIT_CARD_PATTERN = /^\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}$/;

const REDACTED = '[REDACTED]';

/**
 * Check if a key matches sensitive patterns
 */
function isSensitiveKey(key: string): boolean {
    return SENSITIVE_KEY_PATTERNS.some(pattern => pattern.test(key));
}

/**
 * Check if a value matches sensitive patterns
 */
function isSensitiveValue(value: unknown): boolean {
    if (typeof value !== 'string') return false;

    return (
        JWT_PATTERN.test(value) ||
        EMAIL_PATTERN.test(value) ||
        PHONE_PATTERN.test(value) ||
        CREDIT_CARD_PATTERN.test(value)
    );
}

/**
 * Deep clone and redact sensitive data from an object
 */
function redactObject(obj: Record<string, unknown>, depth = 0): Record<string, unknown> {
    // Prevent infinite recursion
    if (depth > 10) return { _truncated: true };

    const result: Record<string, unknown> = {};

    for (const [key, value] of Object.entries(obj)) {
        if (isSensitiveKey(key)) {
            result[key] = REDACTED;
        } else if (value === null || value === undefined) {
            result[key] = value;
        } else if (typeof value === 'string' && isSensitiveValue(value)) {
            result[key] = REDACTED;
        } else if (Array.isArray(value)) {
            result[key] = value.map(item => {
                if (typeof item === 'object' && item !== null) {
                    return redactObject(item as Record<string, unknown>, depth + 1);
                }
                if (typeof item === 'string' && isSensitiveValue(item)) {
                    return REDACTED;
                }
                return item;
            });
        } else if (typeof value === 'object') {
            result[key] = redactObject(value as Record<string, unknown>, depth + 1);
        } else {
            result[key] = value;
        }
    }

    return result;
}

/**
 * Redact sensitive data from a log entry
 */
export function redactLogEntry(entry: LogEntry): LogEntry {
    return {
        ...entry,
        context: redactObject(entry.context as Record<string, unknown>),
    };
}

/**
 * Redact sensitive data from an array of log entries
 */
export function redactLogs(entries: LogEntry[]): LogEntry[] {
    return entries.map(redactLogEntry);
}

/**
 * Configuration for custom redaction patterns
 */
export interface RedactionConfig {
    additionalKeyPatterns?: RegExp[];
    additionalValuePatterns?: RegExp[];
}

/**
 * Create a custom redactor with additional patterns
 */
export function createRedactor(config: RedactionConfig) {
    const keyPatterns = [...SENSITIVE_KEY_PATTERNS, ...(config.additionalKeyPatterns || [])];
    const valuePatterns = [JWT_PATTERN, EMAIL_PATTERN, PHONE_PATTERN, CREDIT_CARD_PATTERN, ...(config.additionalValuePatterns || [])];

    const customIsSensitiveKey = (key: string): boolean => {
        return keyPatterns.some(pattern => pattern.test(key));
    };

    const customIsSensitiveValue = (value: unknown): boolean => {
        if (typeof value !== 'string') return false;
        return valuePatterns.some(pattern => pattern.test(value));
    };

    const customRedactObject = (obj: Record<string, unknown>, depth = 0): Record<string, unknown> => {
        if (depth > 10) return { _truncated: true };

        const result: Record<string, unknown> = {};

        for (const [key, value] of Object.entries(obj)) {
            if (customIsSensitiveKey(key)) {
                result[key] = REDACTED;
            } else if (value === null || value === undefined) {
                result[key] = value;
            } else if (typeof value === 'string' && customIsSensitiveValue(value)) {
                result[key] = REDACTED;
            } else if (Array.isArray(value)) {
                result[key] = value.map(item => {
                    if (typeof item === 'object' && item !== null) {
                        return customRedactObject(item as Record<string, unknown>, depth + 1);
                    }
                    if (typeof item === 'string' && customIsSensitiveValue(item)) {
                        return REDACTED;
                    }
                    return item;
                });
            } else if (typeof value === 'object') {
                result[key] = customRedactObject(value as Record<string, unknown>, depth + 1);
            } else {
                result[key] = value;
            }
        }

        return result;
    };

    return {
        redactEntry: (entry: LogEntry): LogEntry => ({
            ...entry,
            context: customRedactObject(entry.context as Record<string, unknown>),
        }),
        redactLogs: (entries: LogEntry[]): LogEntry[] => entries.map(entry => ({
            ...entry,
            context: customRedactObject(entry.context as Record<string, unknown>),
        })),
    };
}
</file>

<file path="src/lib/logger/types.ts">
export type LogLevel = 'debug' | 'info' | 'warn' | 'error' | 'audit';
export type LogEvent = string;
export type Device = 'web' | 'android' | 'ios';

export interface LogEntry {
    timestamp: string;      // ISO 8601
    level: LogLevel;
    event: LogEvent;
    context: Record<string, unknown>;
    sessionId: string;
    appVersion: string;
    device: Device;
}

export interface Logger {
    debug: (event: LogEvent, context?: Record<string, unknown>) => void;
    info: (event: LogEvent, context?: Record<string, unknown>) => void;
    warn: (event: LogEvent, context?: Record<string, unknown>) => void;
    error: (event: LogEvent, context?: Record<string, unknown>) => void;
    audit: (event: LogEvent, context: Record<string, unknown>) => void;
}
</file>

<file path="src/lib/store/__tests__/homeStore.test.js">
/**
 * @jest-environment jsdom
 */

// Mock the API client
jest.mock('@/api/backendClient', () => ({
    api: {
        home: {
            snapshot: jest.fn(),
        },
    },
}));

// Mock the logger
jest.mock('@/lib/logger', () => ({
    logger: {
        info: jest.fn(),
        error: jest.fn(),
    },
    LOG_EVENTS: {
        DATA_LOAD: 'DATA_LOAD',
    },
}));

import { useHomeStore } from '../homeStore';
import { api } from '@/api/backendClient';

describe('homeStore', () => {
    beforeEach(() => {
        // Reset to initial state
        useHomeStore.getState().reset();
        jest.clearAllMocks();
    });

    describe('initial state', () => {
        it('should have correct default values', () => {
            const state = useHomeStore.getState();
            expect(state.snapshot).toBeNull();
            expect(state.loading).toBe(false);
            expect(state.error).toBeNull();
        });
    });

    describe('fetchSnapshot', () => {
        it('should set loading to true immediately', async () => {
            api.home.snapshot.mockImplementation(() => new Promise(() => { })); // Never resolves

            const promise = useHomeStore.getState().fetchSnapshot();

            // Check loading state immediately
            expect(useHomeStore.getState().loading).toBe(true);
            expect(useHomeStore.getState().error).toBeNull();
        });

        it('should load snapshot successfully', async () => {
            const mockSnapshot = {
                snapshotVersion: 1,
                businessPulse: {
                    amountReceivedThisWeek: 50000,
                    percentChangeWoW: 25.5,
                    paymentsCompleted: 3
                },
                primaryAction: {
                    mostUsed: 'INVOICE'
                },
                recentActivity: [],
                riskSummary: {
                    unpaidInvoicesCount: 5,
                    unpaidAmount: 125000
                },
                momentum: {
                    invoiceStreakDays: 7,
                    totalSentThisWeek: 12
                },
                generatedAt: '2026-01-03T13:52:00.000Z'
            };

            api.home.snapshot.mockResolvedValue(mockSnapshot);

            await useHomeStore.getState().fetchSnapshot();

            const state = useHomeStore.getState();
            expect(state.snapshot).toEqual(mockSnapshot);
            expect(state.loading).toBe(false);
            expect(state.error).toBeNull();
            expect(api.home.snapshot).toHaveBeenCalledTimes(1);
        });

        it('should handle network errors with human-readable message', async () => {
            const networkError = {
                message: 'Network error',
                status: 0,
            };

            api.home.snapshot.mockRejectedValue(networkError);

            await useHomeStore.getState().fetchSnapshot();

            const state = useHomeStore.getState();
            expect(state.snapshot).toBeNull();
            expect(state.loading).toBe(false);
            expect(state.error).toBe('Unable to reach server. Please check your connection.');
        });

        it('should handle 401 unauthorized with human-readable message', async () => {
            const authError = {
                message: 'Unauthorized',
                status: 401,
            };

            api.home.snapshot.mockRejectedValue(authError);

            await useHomeStore.getState().fetchSnapshot();

            const state = useHomeStore.getState();
            expect(state.error).toBe('Session expired. Please log in again.');
            expect(state.loading).toBe(false);
        });

        it('should handle 500 server errors with human-readable message', async () => {
            const serverError = {
                message: 'Internal Server Error',
                status: 500,
            };

            api.home.snapshot.mockRejectedValue(serverError);

            await useHomeStore.getState().fetchSnapshot();

            const state = useHomeStore.getState();
            expect(state.error).toBe('Server error. Please try again later.');
            expect(state.loading).toBe(false);
        });

        it('should handle generic errors with default message', async () => {
            const genericError = {
                message: 'Something went wrong',
                status: 400,
            };

            api.home.snapshot.mockRejectedValue(genericError);

            await useHomeStore.getState().fetchSnapshot();

            const state = useHomeStore.getState();
            expect(state.error).toBe('Unable to load business summary');
            expect(state.loading).toBe(false);
        });

        it('should NOT overwrite existing snapshot on fetch failure', async () => {
            const mockSnapshot = {
                snapshotVersion: 1,
                businessPulse: { amountReceivedThisWeek: 50000 },
                generatedAt: '2026-01-03T13:52:00.000Z'
            };

            // First successful fetch
            api.home.snapshot.mockResolvedValueOnce(mockSnapshot);
            await useHomeStore.getState().fetchSnapshot();

            expect(useHomeStore.getState().snapshot).toEqual(mockSnapshot);

            // Second fetch fails
            api.home.snapshot.mockRejectedValueOnce({ status: 500 });
            await useHomeStore.getState().fetchSnapshot();

            // Snapshot should remain unchanged
            const state = useHomeStore.getState();
            expect(state.snapshot).toEqual(mockSnapshot);
            expect(state.error).toBe('Server error. Please try again later.');
        });

        it('should clear previous error before new fetch', async () => {
            // First fetch fails
            api.home.snapshot.mockRejectedValueOnce({ status: 500 });
            await useHomeStore.getState().fetchSnapshot();
            expect(useHomeStore.getState().error).toBeTruthy();

            // Second fetch succeeds
            const mockSnapshot = { snapshotVersion: 1 };
            api.home.snapshot.mockResolvedValueOnce(mockSnapshot);
            await useHomeStore.getState().fetchSnapshot();

            const state = useHomeStore.getState();
            expect(state.error).toBeNull();
            expect(state.snapshot).toEqual(mockSnapshot);
        });

        it('should never throw errors', async () => {
            api.home.snapshot.mockRejectedValue(new Error('Catastrophic failure'));

            // Should not throw
            await expect(
                useHomeStore.getState().fetchSnapshot()
            ).resolves.toBeUndefined();

            expect(useHomeStore.getState().loading).toBe(false);
            expect(useHomeStore.getState().error).toBeTruthy();
        });
    });

    describe('reset', () => {
        it('should reset all fields to initial state', async () => {
            const mockSnapshot = { snapshotVersion: 1 };
            api.home.snapshot.mockResolvedValue(mockSnapshot);

            await useHomeStore.getState().fetchSnapshot();

            // Verify state has data
            expect(useHomeStore.getState().snapshot).toEqual(mockSnapshot);

            // Reset
            useHomeStore.getState().reset();

            // Verify back to initial state
            const state = useHomeStore.getState();
            expect(state.snapshot).toBeNull();
            expect(state.loading).toBe(false);
            expect(state.error).toBeNull();
        });
    });
});
</file>

<file path="src/lib/store/attendanceStore.js">
import { create } from 'zustand';
import { api } from '@/api/backendClient';
import { logger, LOG_EVENTS } from '@/lib/logger';

export const useAttendanceStore = create((set, get) => ({
    currentLogId: null,
    isLoggedIn: false,
    todayAttendance: null,
    history: [],
    isLoading: false,
    error: null,

    // Record login
    login: async (userId) => {
        set({ isLoading: true, error: null });
        try {
            const result = await api.attendance.login(userId);
            set({
                currentLogId: result.id,
                isLoggedIn: true,
                todayAttendance: result,
                isLoading: false
            });
            return result;
        } catch (error) {
            logger.error(LOG_EVENTS.AUTH_LOGIN_FAILED, { error: error.message, userId });
            set({ error: error.message, isLoading: false });
            throw error;
        }
    },

    // Record logout
    logout: async () => {
        const logId = get().currentLogId;
        if (!logId) {
            logger.warn(LOG_EVENTS.AUTH_LOGOUT_FAILED, { reason: 'no_active_session' });
            return;
        }

        set({ isLoading: true, error: null });
        try {
            await api.attendance.logout(logId);
            set({
                currentLogId: null,
                isLoggedIn: false,
                isLoading: false
            });
        } catch (error) {
            logger.error(LOG_EVENTS.AUTH_LOGOUT_FAILED, { error: error.message, logId });
            set({ error: error.message, isLoading: false });
            throw error;
        }
    },

    // Get attendance history for a user
    loadHistory: async (userId, limit = 30) => {
        set({ isLoading: true, error: null });
        try {
            const history = await api.attendance.getHistory(userId, limit);
            set({ history, isLoading: false });
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_LOAD_ERROR, { store: 'attendance_history', userId, error: error.message });
            set({ error: error.message, isLoading: false });
        }
    },

    // Get attendance for a specific date
    getByDate: async (userId, date) => {
        try {
            return await api.attendance.getByDate(userId, date);
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_LOAD_ERROR, { store: 'attendance_by_date', userId, date, error: error.message });
            return null;
        }
    },

    // Check today's attendance status
    checkTodayStatus: async (userId) => {
        set({ isLoading: true });
        try {
            const today = new Date().toISOString().split('T')[0];
            const attendance = await api.attendance.getByDate(userId, today);

            if (attendance) {
                set({
                    todayAttendance: attendance,
                    currentLogId: attendance.id,
                    isLoggedIn: !attendance.logoutAt, // Logged in if no logout recorded
                    isLoading: false
                });
            } else {
                set({
                    todayAttendance: null,
                    currentLogId: null,
                    isLoggedIn: false,
                    isLoading: false
                });
            }
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_LOAD_ERROR, { store: 'attendance_today_status', userId, error: error.message });
            set({ isLoading: false });
        }
    },

    clearError: () => set({ error: null }),
}));
</file>

<file path="src/lib/store/homeStore.js">
import { create } from 'zustand';
import { api } from '@/api/backendClient';
import { logger, LOG_EVENTS } from '@/lib/logger';

/**
 * Home Snapshot Store
 * 
 * Manages the home screen snapshot data from /api/home/snapshot.
 * All business logic is backend-owned; this store only manages state.
 * 
 * CRITICAL RULES:
 * - Never crash the home screen (all errors caught)
 * - Never auto-retry (backend caching handles freshness)
 * - Never compute metrics client-side
 */
export const useHomeStore = create((set, get) => ({
    // State
    snapshot: null,
    loading: false,
    error: null,

    /**
     * Fetch home snapshot from backend
     * 
     * Sets loading immediately, clears error before fetch.
     * On success: sets snapshot and loading = false
     * On failure: sets human-readable error and loading = false
     * Never throws - home screen must never crash
     */
    fetchSnapshot: async () => {
        set({ loading: true, error: null });

        try {
            const snapshot = await api.home.snapshot();

            set({
                snapshot,
                loading: false,
                error: null
            });

            logger.info(LOG_EVENTS.DATA_LOAD, 'Home snapshot loaded successfully', {
                snapshotVersion: snapshot.snapshotVersion,
                generatedAt: snapshot.generatedAt
            });
        } catch (error) {
            // Convert technical errors to human-readable messages
            let errorMessage = 'Unable to load business summary';

            if (error.status === 0) {
                // Network error or timeout
                errorMessage = 'Unable to reach server. Please check your connection.';
            } else if (error.status === 401 || error.status === 403) {
                errorMessage = 'Session expired. Please log in again.';
            } else if (error.status >= 500) {
                errorMessage = 'Server error. Please try again later.';
            }

            set({
                error: errorMessage,
                loading: false
            });

            logger.error(LOG_EVENTS.DATA_LOAD, 'Failed to load home snapshot', {
                error: error.message,
                status: error.status
            });

            // Do NOT throw - home screen must render even if snapshot fails
        }
    },

    /**
     * Reset store to initial state
     */
    reset: () => {
        set({
            snapshot: null,
            loading: false,
            error: null
        });
    },
}));
</file>

<file path="src/lib/utils/__tests__/exportUtils.test.js">
/**
 * @jest-environment jsdom
 */

// Mock jsPDF
jest.mock('jspdf', () => {
    return jest.fn().mockImplementation(() => ({
        setFontSize: jest.fn(),
        text: jest.fn(),
        line: jest.fn(),
        setTextColor: jest.fn(),
        addPage: jest.fn(),
        save: jest.fn(),
    }));
});

import { exportToCSV, exportToPDF } from '../exportUtils';

describe('exportUtils', () => {
    describe('exportToCSV', () => {
        let mockCreateElement;
        let mockLink;

        beforeEach(() => {
            mockLink = {
                setAttribute: jest.fn(),
                click: jest.fn(),
                style: {},
                download: '',
            };
            mockCreateElement = jest.spyOn(document, 'createElement').mockReturnValue(mockLink);
            jest.spyOn(document.body, 'appendChild').mockImplementation(() => { });
            jest.spyOn(document.body, 'removeChild').mockImplementation(() => { });
            global.URL.createObjectURL = jest.fn(() => 'blob:test-url');
        });

        afterEach(() => {
            jest.restoreAllMocks();
        });

        it('should return early for empty data', () => {
            exportToCSV([], 'test.csv');
            expect(mockCreateElement).not.toHaveBeenCalled();
        });

        it('should return early for null data', () => {
            exportToCSV(null, 'test.csv');
            expect(mockCreateElement).not.toHaveBeenCalled();
        });

        it('should create CSV with correct headers', () => {
            const data = [
                { name: 'Product 1', price: 100, category: 'Gold' },
                { name: 'Product 2', price: 200, category: 'Silver' },
            ];

            exportToCSV(data, 'products.csv');

            expect(mockLink.setAttribute).toHaveBeenCalledWith('download', 'products.csv');
            expect(mockLink.click).toHaveBeenCalled();
        });

        it('should handle strings with commas by wrapping in quotes', () => {
            const data = [
                { name: 'Gold, 22K Ring', price: 5000 },
            ];

            exportToCSV(data, 'test.csv');

            // The blob should contain the wrapped value
            expect(mockLink.click).toHaveBeenCalled();
        });

        it('should create downloadable link', () => {
            const data = [{ id: 1, name: 'Test' }];

            exportToCSV(data, 'export.csv');

            expect(mockCreateElement).toHaveBeenCalledWith('a');
            expect(mockLink.setAttribute).toHaveBeenCalledWith('href', 'blob:test-url');
            expect(mockLink.setAttribute).toHaveBeenCalledWith('download', 'export.csv');
            expect(document.body.appendChild).toHaveBeenCalledWith(mockLink);
            expect(mockLink.click).toHaveBeenCalled();
            expect(document.body.removeChild).toHaveBeenCalledWith(mockLink);
        });
    });

    describe('exportToPDF', () => {
        it('should create PDF with customer information', () => {
            const customer = {
                name: 'John Doe',
                phone: '9876543210',
                balance: 15000.50,
            };

            const transactions = [
                { date: new Date(), type: 'invoice', number: 'INV-001', amount: 10000, balance: 10000 },
                { date: new Date(), type: 'payment_in', number: 'PAY-001', amount: 5000, balance: 5000 },
            ];

            exportToPDF(customer, transactions, 'ledger.pdf');

            // Verify jsPDF was instantiated and methods were called
            const jsPDF = require('jspdf');
            expect(jsPDF).toHaveBeenCalled();
        });

        it('should handle customer without phone', () => {
            const customer = {
                name: 'Jane Doe',
                balance: 5000,
            };

            const transactions = [];

            // Should not throw
            expect(() => {
                exportToPDF(customer, transactions, 'ledger.pdf');
            }).not.toThrow();
        });

        it('should format transaction types correctly', () => {
            const customer = { name: 'Test', balance: 0 };
            const transactions = [
                { date: new Date(), type: 'payment_in', number: 'P1', amount: 100, balance: 100 },
                { date: new Date(), type: 'payment_out', number: 'P2', amount: 50, balance: 50 },
                { date: new Date(), type: 'invoice', number: 'I1', amount: 200, balance: 250 },
            ];

            exportToPDF(customer, transactions, 'test.pdf');

            const jsPDF = require('jspdf');
            expect(jsPDF).toHaveBeenCalled();
        });

        it('should handle transactions without balance', () => {
            const customer = { name: 'Test', balance: 1000 };
            const transactions = [
                { date: new Date(), type: 'invoice', number: 'INV-1', amount: 1000 },
            ];

            expect(() => {
                exportToPDF(customer, transactions, 'test.pdf');
            }).not.toThrow();
        });
    });
});
</file>

<file path="src/lib/utils/__tests__/numberToWords.test.js">
import { numberToWords } from '../numberToWords';

describe('numberToWords', () => {
    describe('basic numbers (1-19)', () => {
        it('should convert single digit numbers', () => {
            expect(numberToWords(1)).toBe('One only ');
            expect(numberToWords(5)).toBe('Five only ');
            expect(numberToWords(9)).toBe('Nine only ');
        });

        it('should convert teen numbers', () => {
            expect(numberToWords(11)).toBe('Eleven only ');
            expect(numberToWords(15)).toBe('Fifteen only ');
            expect(numberToWords(19)).toBe('Nineteen only ');
        });
    });

    describe('tens (20-99)', () => {
        it('should convert round tens', () => {
            expect(numberToWords(20)).toBe('Twenty only ');
            expect(numberToWords(50)).toBe('Fifty only ');
            expect(numberToWords(90)).toBe('Ninety only ');
        });

        it('should convert compound numbers', () => {
            expect(numberToWords(21)).toBe('Twenty One only ');
            expect(numberToWords(45)).toBe('Forty Five only ');
            expect(numberToWords(99)).toBe('Ninety Nine only ');
        });
    });

    describe('hundreds', () => {
        it('should convert round hundreds', () => {
            // Note: Function doesn't append 'only' for round hundreds without units
            expect(numberToWords(100)).toBe('One Hundred ');
            expect(numberToWords(500)).toBe('Five Hundred ');
        });

        it('should convert compound hundreds', () => {
            expect(numberToWords(101)).toBe('One Hundred and One only ');
            expect(numberToWords(250)).toBe('Two Hundred and Fifty only ');
            expect(numberToWords(999)).toBe('Nine Hundred and Ninety Nine only ');
        });
    });

    describe('thousands', () => {
        it('should convert round thousands', () => {
            // Note: Function doesn't append 'only' for round thousands without units
            expect(numberToWords(1000)).toBe('One Thousand ');
            expect(numberToWords(5000)).toBe('Five Thousand ');
        });

        it('should convert compound thousands', () => {
            expect(numberToWords(1234)).toBe('One Thousand Two Hundred and Thirty Four only ');
            expect(numberToWords(10000)).toBe('Ten Thousand ');
            expect(numberToWords(99999)).toBe('Ninety Nine Thousand Nine Hundred and Ninety Nine only ');
        });
    });

    describe('lakhs (Indian number system)', () => {
        it('should convert round lakhs', () => {
            // Note: Function doesn't append 'only' for round lakhs without units
            expect(numberToWords(100000)).toBe('One Lakh ');
            expect(numberToWords(500000)).toBe('Five Lakh ');
        });

        it('should convert compound lakhs', () => {
            expect(numberToWords(123456)).toBe('One Lakh Twenty Three Thousand Four Hundred and Fifty Six only ');
            expect(numberToWords(999999)).toBe('Nine Lakh Ninety Nine Thousand Nine Hundred and Ninety Nine only ');
        });
    });

    describe('crores (Indian number system)', () => {
        it('should convert round crores', () => {
            // Note: Function doesn't append 'only' for round crores without units
            expect(numberToWords(10000000)).toBe('One Crore ');
            expect(numberToWords(50000000)).toBe('Five Crore ');
        });

        it('should convert compound crores', () => {
            expect(numberToWords(12345678)).toBe('One Crore Twenty Three Lakh Forty Five Thousand Six Hundred and Seventy Eight only ');
        });
    });

    describe('edge cases', () => {
        it('should return empty string for zero', () => {
            expect(numberToWords(0)).toBe('');
        });

        it('should handle typical invoice amounts', () => {
            // Round amounts don't get 'only' suffix
            expect(numberToWords(1500)).toBe('One Thousand Five Hundred ');
            expect(numberToWords(25000)).toBe('Twenty Five Thousand ');
            expect(numberToWords(150000)).toBe('One Lakh Fifty Thousand ');
        });
    });
});
</file>

<file path="src/lib/utils/__tests__/tax.test.js">
import { calculateGST, formatCurrency } from '../tax';

describe('calculateGST', () => {
    describe('intra-state transactions (same state)', () => {
        it('should split GST equally between CGST and SGST', () => {
            const result = calculateGST(1000, 18, false);

            expect(result.cgst).toBe(90);
            expect(result.sgst).toBe(90);
            expect(result.igst).toBe(0);
            expect(result.totalTax).toBe(180);
        });

        it('should handle 5% GST rate', () => {
            const result = calculateGST(2000, 5, false);

            expect(result.cgst).toBe(50);
            expect(result.sgst).toBe(50);
            expect(result.igst).toBe(0);
            expect(result.totalTax).toBe(100);
        });

        it('should handle 3% GST rate (for jewellery)', () => {
            const result = calculateGST(10000, 3, false);

            expect(result.cgst).toBe(150);
            expect(result.sgst).toBe(150);
            expect(result.igst).toBe(0);
            expect(result.totalTax).toBe(300);
        });

        it('should handle zero amount', () => {
            const result = calculateGST(0, 18, false);

            expect(result.cgst).toBe(0);
            expect(result.sgst).toBe(0);
            expect(result.igst).toBe(0);
            expect(result.totalTax).toBe(0);
        });
    });

    describe('inter-state transactions (different states)', () => {
        it('should apply full GST as IGST', () => {
            const result = calculateGST(1000, 18, true);

            expect(result.cgst).toBe(0);
            expect(result.sgst).toBe(0);
            expect(result.igst).toBe(180);
            expect(result.totalTax).toBe(180);
        });

        it('should handle 12% GST rate', () => {
            const result = calculateGST(5000, 12, true);

            expect(result.cgst).toBe(0);
            expect(result.sgst).toBe(0);
            expect(result.igst).toBe(600);
            expect(result.totalTax).toBe(600);
        });
    });

    describe('edge cases', () => {
        it('should handle decimal amounts', () => {
            const result = calculateGST(999.99, 18, false);

            expect(result.totalTax).toBeCloseTo(179.9982, 2);
        });

        it('should handle zero GST rate', () => {
            const result = calculateGST(1000, 0, false);

            expect(result.cgst).toBe(0);
            expect(result.sgst).toBe(0);
            expect(result.igst).toBe(0);
            expect(result.totalTax).toBe(0);
        });
    });
});

describe('formatCurrency', () => {
    it('should format whole numbers in INR', () => {
        const formatted = formatCurrency(1000);

        expect(formatted).toContain('1,000');
        expect(formatted).toMatch(/₹|INR/);
    });

    it('should format decimal amounts', () => {
        const formatted = formatCurrency(1234.56);

        expect(formatted).toContain('1,234.56');
    });

    it('should format large amounts with Indian number system', () => {
        const formatted = formatCurrency(1234567);

        // Indian format: 12,34,567
        expect(formatted).toContain('12,34,567');
    });

    it('should handle zero', () => {
        const formatted = formatCurrency(0);

        expect(formatted).toContain('0');
    });

    it('should handle negative amounts', () => {
        const formatted = formatCurrency(-500);

        expect(formatted).toContain('500');
        expect(formatted).toContain('-');
    });
});
</file>

<file path="src/lib/utils/exportUtils.js">
import jsPDF from 'jspdf';

export const exportToCSV = (data, filename) => {
    if (!data || !data.length) return;

    // Get headers from first object
    const headers = Object.keys(data[0]);
    const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(fieldName => {
            const value = row[fieldName];
            // Handle strings with commas by wrapping in quotes
            return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
        }).join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
};

export const exportToPDF = (customer, transactions, filename) => {
    const doc = new jsPDF();

    // Header
    doc.setFontSize(20);
    doc.text(customer.name, 14, 22);
    doc.setFontSize(12);
    doc.text(`Phone: ${customer.phone || 'N/A'}`, 14, 30);
    doc.text(`Balance: ${customer.balance?.toFixed(2)}`, 14, 38);

    // Table Header
    let y = 50;
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text('Date', 14, y);
    doc.text('Type', 60, y);
    doc.text('Number', 100, y);
    doc.text('Amount', 150, y);
    doc.text('Balance', 180, y);

    doc.line(14, y + 2, 200, y + 2); // Header line
    y += 10;
    doc.setTextColor(0);

    // Table Rows
    transactions.forEach(tx => {
        if (y > 280) { // New page
            doc.addPage();
            y = 20;
        }

        const date = new Date(tx.date).toLocaleDateString();
        const type = tx.type === 'payment_in' ? 'Payment In' :
            tx.type === 'payment_out' ? 'Payment Out' : 'Invoice';
        const number = tx.number;
        const amount = tx.amount.toFixed(2);
        const balance = tx.balance !== undefined ? tx.balance.toFixed(2) : '-';

        doc.text(date, 14, y);
        doc.text(type, 60, y);
        doc.text(number, 100, y);
        doc.text(amount, 150, y);
        doc.text(balance, 180, y);

        y += 8;
    });

    doc.save(filename);
};
</file>

<file path="src/lib/utils/isDiagnosticsEnabled.js">
/**
 * Build-time flag for Diagnostics feature
 * 
 * This constant is evaluated at build time by Next.js.
 * When false/undefined, all code paths using this flag are eliminated
 * via dead code elimination (tree-shaking).
 * 
 * To enable: Set NEXT_PUBLIC_ENABLE_DIAGNOSTICS=true in your environment
 */
export const DIAGNOSTICS_ENABLED = process.env.NEXT_PUBLIC_ENABLE_DIAGNOSTICS === 'true';

/**
 * Check if diagnostics feature should be available
 * Use this for conditional rendering of UI elements
 */
export const isDiagnosticsEnabled = () => DIAGNOSTICS_ENABLED;
</file>

<file path="src/lib/utils/numberToWords.js">
export function numberToWords(num) {
    const a = [
        '', 'One ', 'Two ', 'Three ', 'Four ', 'Five ', 'Six ', 'Seven ', 'Eight ', 'Nine ', 'Ten ',
        'Eleven ', 'Twelve ', 'Thirteen ', 'Fourteen ', 'Fifteen ', 'Sixteen ', 'Seventeen ', 'Eighteen ', 'Nineteen '
    ];
    const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

    const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
    if (!n) return '';

    let str = '';
    str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'Crore ' : '';
    str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'Lakh ' : '';
    str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'Thousand ' : '';
    str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'Hundred ' : '';
    str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) + 'only ' : '';

    return str;
}
</file>

<file path="src/lib/utils/tax.js">
export const calculateGST = (amount, rate, isInterState) => {
    const gstAmount = (amount * rate) / 100;
    if (isInterState) {
        return {
            cgst: 0,
            sgst: 0,
            igst: gstAmount,
            totalTax: gstAmount
        };
    } else {
        return {
            cgst: gstAmount / 2,
            sgst: gstAmount / 2,
            igst: 0,
            totalTax: gstAmount
        };
    }
};

export const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        maximumFractionDigits: 2
    }).format(amount);
};
</file>

<file path="src/lib/animations.js">
export const ANIMATIONS = {
    // Durations
    duration: {
        fast: 0.2,
        medium: 0.3,
        slow: 0.5,
    },
    // Easings
    ease: {
        // Smooth, modern ease-out
        out: [0.25, 0.1, 0.25, 1.0],
        // Bouncy for playful elements
        elastic: [0.5, 1.5, 0.5, 0.8],
    },
    // Variants
    variants: {
        fadeIn: {
            initial: { opacity: 0 },
            animate: { opacity: 1 },
            exit: { opacity: 0 },
        },
        slideUp: {
            initial: { opacity: 0, y: 10 },
            animate: { opacity: 1, y: 0 },
            exit: { opacity: 0, y: -10 },
        },
        scaleIn: {
            initial: { opacity: 0, scale: 0.95 },
            animate: { opacity: 1, scale: 1 },
            exit: { opacity: 0, scale: 0.95 },
        },
        staggerContainer: {
            animate: {
                transition: {
                    staggerChildren: 0.05,
                },
            },
        },
        listItem: {
            initial: { opacity: 0, y: 10 },
            animate: { opacity: 1, y: 0 },
        },
    },
};
</file>

<file path=".eslintrc.json">
{
    "extends": [
        "next/core-web-vitals"
    ],
    "rules": {
        "no-console": [
            "error",
            {
                "allow": [
                    "warn",
                    "error"
                ]
            }
        ]
    },
    "overrides": [
        {
            "files": [
                "src/lib/logger/**/*.ts"
            ],
            "rules": {
                "no-console": "off"
            }
        }
    ]
}
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="back_int.md">
Integrate the existing Swipe frontend with a new local-first backend API, fully replacing IndexedDB/Dexie. **Do not retain any client-side persistence layer**. The frontend must become a thin client over the backend.

**Key Requirements & Steps**

1. **Disable IndexedDB Completely**

   * Remove Dexie initialization and all IndexedDB read/write code.
   * Delete or bypass any feature flags related to local storage.
   * Ensure no data is persisted client-side beyond UI state.

2. **Introduce a Single Backend API Client**

   * Create a centralized API layer (e.g., `src/api/backendClient.ts`).
   * All data operations (customers, products, invoices, payments, photos) must go through this layer.
   * UI components must never call `fetch` directly.

3. **Backend as Source of Truth**

   * Stop generating IDs, invoice numbers, or authoritative totals in the frontend.
   * Send minimal payloads for create/update.
   * Always replace local UI state with the backend response (aggregate object).

4. **Authentication**

   * Integrate JWT-based auth (`/auth/login`, `/auth/me`).
   * Attach JWT to every API request.
   * Handle unauthorized responses gracefully.

5. **Environment Configuration**

   * Add `VITE_API_BASE_URL` for local development (e.g., `http://localhost:3000`).
   * Ensure CORS-compatible requests.

6. **Error & Loading States**

   * Show backend errors clearly.
   * Handle offline/backend-down scenarios explicitly.

7. **Verification**

   * Test full flows: create → refresh → fetch → update → delete.
   * Verify photos load after refresh.
   * Confirm no data loss on page reload.

**Constraints**

* No IndexedDB fallback.
* No client-side syncing logic.
* Follow backend aggregate contracts exactly.

---
</file>

<file path="cypress.config.js">
const { defineConfig } = require('cypress');

module.exports = defineConfig({
    e2e: {
        // Base URL for cy.visit() commands
        baseUrl: 'http://localhost:3000',

        // Spec file pattern
        specPattern: 'cypress/e2e/**/*.cy.{js,jsx,ts,tsx}',

        // Support file location
        supportFile: 'cypress/support/e2e.js',

        // Viewport size (mobile-first for this app)
        viewportWidth: 390,
        viewportHeight: 844,

        // Video recording settings
        video: false,

        // Screenshot settings
        screenshotOnRunFailure: true,

        // Timeouts
        defaultCommandTimeout: 10000,
        pageLoadTimeout: 30000,

        // Retry failed tests
        retries: {
            runMode: 2,
            openMode: 0,
        },

        setupNodeEvents(on, config) {
            // Implement node event listeners here if needed
        },
    },
});
</file>

<file path="jest.config.js">
const nextJest = require('next/jest');

const createJestConfig = nextJest({
    // Provide the path to your Next.js app to load next.config.js and .env files
    dir: './',
});

/** @type {import('jest').Config} */
const customJestConfig = {
    // Setup files to run after Jest is installed
    setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],

    // Test environment for React components
    testEnvironment: 'jsdom',

    // Module path aliases matching jsconfig.json
    moduleNameMapper: {
        '^@/(.*)$': '<rootDir>/src/$1',
    },

    // Test file patterns
    testMatch: [
        '**/__tests__/**/*.test.[jt]s?(x)',
        '**/?(*.)+(spec|test).[jt]s?(x)',
    ],

    // Files to ignore
    testPathIgnorePatterns: [
        '<rootDir>/node_modules/',
        '<rootDir>/.next/',
        '<rootDir>/cypress/',
    ],

    // Coverage configuration
    collectCoverageFrom: [
        'src/**/*.{js,jsx}',
        '!src/**/*.d.ts',
        '!src/**/__tests__/**',
    ],

    // Coverage thresholds (start with lower thresholds, increase over time)
    coverageThreshold: {
        global: {
            branches: 50,
            functions: 50,
            lines: 50,
            statements: 50,
        },
    },
};

module.exports = createJestConfig(customJestConfig);
</file>

<file path="jest.setup.js">
// Jest setup file
// This file runs after Jest is installed but before tests run

// Import custom jest-dom matchers for DOM assertions
// e.g., toBeInTheDocument(), toHaveTextContent(), etc.
import '@testing-library/jest-dom';

// Clean up after each test
afterEach(() => {
    // Clear all mocks between tests
    jest.clearAllMocks();
});

// Mock window.matchMedia for components that use media queries
Object.defineProperty(window, 'matchMedia', {
    writable: true,
    value: jest.fn().mockImplementation(query => ({
        matches: false,
        media: query,
        onchange: null,
        addListener: jest.fn(),
        removeListener: jest.fn(),
        addEventListener: jest.fn(),
        removeEventListener: jest.fn(),
        dispatchEvent: jest.fn(),
    })),
});

// Mock IntersectionObserver for components that use it
global.IntersectionObserver = class IntersectionObserver {
    constructor() { }
    observe() { return null; }
    unobserve() { return null; }
    disconnect() { return null; }
};

// Mock ResizeObserver for components that use it
global.ResizeObserver = class ResizeObserver {
    constructor() { }
    observe() { return null; }
    unobserve() { return null; }
    disconnect() { return null; }
};
</file>

<file path="jsconfig.json">
{
  "compilerOptions": {
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}
</file>

<file path="parse.js">
import fs from "fs";
import path from "path";
import { parse } from "@babel/parser";
import traverseModule from "@babel/traverse";

const traverse = traverseModule.default;

const root = process.argv[2];

function parseFile(file) {
    const code = fs.readFileSync(file, "utf8");

    const ast = parse(code, {
        sourceType: "module",
        plugins: ["jsx", "typescript"]
    });

    traverse(ast, {
        Function(path) {
            const name =
                path.node.id?.name ||
                path.parent?.id?.name ||
                "anonymous";

            const calls = [];
            path.traverse({
                CallExpression(p) {
                    if (p.node.callee.type === "Identifier") {
                        calls.push(p.node.callee.name);
                    }
                }
            });

            console.log({
                file,
                function: name,
                calls
            });
        }
    });
}

function walk(dir) {
    fs.readdirSync(dir).forEach(f => {
        const full = path.join(dir, f);
        if (fs.statSync(full).isDirectory()) walk(full);
        else if (full.match(/\.(js|ts|tsx)$/)) parseFile(full);
    });
}

walk(root);
</file>

<file path="schema.md">
# IndexedDB Database Schema

**Database Name:** `SwipeInvoiceDB`  
**Current Version:** `11`  
**Database Type:** Dexie.js (IndexedDB wrapper)

---

## Tables Overview

This document describes all tables in the Swipe Invoice application's IndexedDB database, including their indexed columns and data types.

---

## 1. invoices

**Purpose:** Stores invoice and billing records (including regular invoices, proforma invoices, and lending bills)

**Indexes:** `++id, invoiceNumber, date, customerId, status, balanceDue, type`

| Column Name | Type | Description |
|------------|------|-------------|
| `id` | Number (Auto-increment) | Primary key, auto-generated |
| `invoiceNumber` | String | Unique invoice identifier (e.g., "INV-1234") |
| `date` | String (ISO Date) | Invoice date |
| `dueDate` | String (ISO Date) | Payment due date |
| `placeOfSupply` | String | Location where goods/services are supplied |
| `invoiceCopyType` | String | Type of copy (e.g., "Original for Recipient") |
| `customerId` | Number | Foreign key to customers table |
| `customer` | Object | Embedded customer snapshot {name, id, phone} |
| `items` | Array | Array of line items with product details |
| `details` | Object | {reference, notes, terms, extraDiscount, shippingCharges, packagingCharges} |
| `weightSummary` | Object | {grossWeight, netWeight} for jewelry items |
| `toggles` | Object | {tds, tcs, rcm} - tax toggles |
| `totals` | Object | Calculated totals {subtotal, totalTax, total, roundOffAmount, cgst, sgst, igst} |
| `status` | String | Payment status: "Paid", "Partial", "Unpaid", "Pending" |
| `balanceDue` | Number | Outstanding amount |
| `type` | String | Invoice type: "INVOICE", "PROFORMA", or "LENDING" |
| `cgstAmount` | Number | CGST calculated amount |
| `sgstAmount` | Number | SGST calculated amount |
| `totalBeforeTax` | Number | Subtotal before taxes |
| `totalAfterTax` | Number | Final total amount |
| `createdAt` | String (ISO DateTime) | Record creation timestamp |
| `updatedAt` | String (ISO DateTime) | Last update timestamp |

---

## 2. purchases

**Purpose:** Stores purchase orders and vendor invoices

**Indexes:** `++id, purchaseNumber, date, vendorId, status, balanceDue`

| Column Name | Type | Description |
|------------|------|-------------|
| `id` | Number (Auto-increment) | Primary key, auto-generated |
| `purchaseNumber` | String | Unique purchase identifier (e.g., "PUR-1234") |
| `date` | String (ISO Date) | Purchase date |
| `dueDate` | String (ISO Date) | Payment due date |
| `vendorId` | Number | Foreign key to vendors table |
| `vendor` | Object | Embedded vendor snapshot {name, id, phone} |
| `items` | Array | Array of purchased items |
| `details` | Object | {reference, notes, terms, extraDiscount, shippingCharges, packagingCharges} |
| `weightSummary` | Object | {grossWeight, netWeight} |
| `gstEnabled` | Boolean | Whether GST is enabled for this purchase |
| `totals` | Object | Calculated totals {subtotal, totalTax, total, roundOffAmount, cgst, sgst, igst} |
| `status` | String | Payment status: "Paid", "Partial", "Unpaid" |
| `balanceDue` | Number | Outstanding amount |
| `cgstAmount` | Number | CGST calculated amount |
| `sgstAmount` | Number | SGST calculated amount |
| `totalBeforeTax` | Number | Subtotal before taxes |
| `totalAfterTax` | Number | Final total amount |
| `createdAt` | String (ISO DateTime) | Record creation timestamp |
| `updatedAt` | String (ISO DateTime) | Last update timestamp |

---

## 3. customers

**Purpose:** Stores customer/party information

**Indexes:** `++id, name, gstin, phone, email, isDeleted`

| Column Name | Type | Description |
|------------|------|-------------|
| `id` | Number (Auto-increment) | Primary key, auto-generated |
| `name` | String | Customer name |
| `gstin` | String | GST identification number |
| `phone` | String | Contact phone number |
| `email` | String | Email address |
| `balance` | Number | Current account balance (receivable) |
| `isDeleted` | Boolean | Soft delete flag |
| `address` | Object (Optional) | Address details |
| `createdAt` | String (ISO DateTime) | Record creation timestamp |

---

## 4. vendors

**Purpose:** Stores vendor/supplier information

**Indexes:** `++id, name, gstin, phone, email, isDeleted`

| Column Name | Type | Description |
|------------|------|-------------|
| `id` | Number (Auto-increment) | Primary key, auto-generated |
| `name` | String | Vendor name |
| `gstin` | String | GST identification number |
| `phone` | String | Contact phone number |
| `email` | String | Email address |
| `balance` | Number | Current account balance (payable) |
| `isDeleted` | Boolean | Soft delete flag |
| `address` | Object (Optional) | Address details |
| `createdAt` | String (ISO DateTime) | Record creation timestamp |

---

## 5. products

**Purpose:** Stores product catalog (primarily jewelry items)

**Indexes:** `++id, name, type, sku, hsn, category, sellingPrice, purchasePrice, taxRate, unit, barcode`

| Column Name | Type | Description |
|------------|------|-------------|
| `id` | Number (Auto-increment) | Primary key, auto-generated |
| `type` | String | "product" or "service" |
| `name` | String | Product name/title |
| `sku` | String | Stock Keeping Unit code (format: CAT-SUB-000001) |
| `barcode` | String | Barcode identifier |
| `hsn` | String | HSN/SAC code for taxation |
| `category` | String | Product category name |
| `subCategory` | String | Product sub-category name |
| `description` | String | Product description |
| `sellingPrice` | Number | Selling price |
| `purchasePrice` | Number | Purchase/cost price |
| `taxRate` | Number | Applicable tax rate percentage |
| `unit` | String | Unit of measurement (e.g., "gms") |
| **Metal Attributes** | | |
| `metalType` | String | "Gold", "Silver", "Platinum" |
| `metalColor` | String | "Yellow", "White", "Rose", "Two-tone" |
| `purity` | String | "24K", "22K", "18K", "14K" |
| `grossWeight` | Number | Gross weight in grams |
| `netWeight` | Number | Net metal weight in grams |
| `wastagePercentage` | Number | Wastage percentage |
| `wastageWeight` | Number | Wastage weight |
| `makingCharges` | Number | Making charges amount |
| `makingChargesType` | String | "per_gram" or "fixed" |
| `metalRateRef` | String | Reference to metal rate |
| **Gemstone Attributes** | | |
| `hasStones` | Boolean | Whether product has gemstones |
| `stoneType` | String | Type of stone (e.g., "Diamond", "Ruby") |
| `stoneCount` | Number | Number of stones |
| `stoneWeight` | Number | Weight in carats |
| `stoneShape` | String | Shape of stone |
| `stoneClarity` | String | Clarity grade (SI, VS, VVS) |
| `stoneColor` | String | Color grade |
| `stoneCut` | String | Cut quality |
| `stoneCertification` | String | Certification body (GIA, IGI) |
| `stonePrice` | Number | Stone charges/price |
| `stoneSetting` | String | Setting type |
| **Design & Dimensions** | | |
| `size` | String | Product size |
| `pattern` | String | Design pattern details |
| `customizable` | Boolean | Can be customized |
| `engravingText` | String | Engraving details |
| **Other** | | |
| `vendorRef` | String | Vendor reference |
| `procurementDate` | String (ISO Date) | Date of procurement |
| `hallmarkCert` | String | BIS Hallmark certification number |
| `launchDate` | String (ISO Date) | Product launch date |
| `images` | Array | Product images array |
| `showOnline` | Boolean | Show in online store |
| `notForSale` | Boolean | Not available for sale |
| `createdAt` | Date | Record creation timestamp |

---

## 6. payments

**Purpose:** Stores payment transactions

**Indexes:** `++id, transactionNumber, date, type, partyType, partyId`

| Column Name | Type | Description |
|------------|------|-------------|
| `id` | Number (Auto-increment) | Primary key, auto-generated |
| `transactionNumber` | String | Unique transaction identifier |
| `date` | String (ISO Date) | Payment date |
| `type` | String | "IN" (received) or "OUT" (paid) |
| `partyType` | String | "CUSTOMER" or "VENDOR" |
| `partyId` | Number | Foreign key to customer/vendor |
| `amount` | Number | Payment amount |
| `mode` | String | Payment mode: "Cash", "UPI", "CASH", etc. |
| `notes` | String | Payment notes |
| `createdAt` | String (ISO DateTime) | Record creation timestamp |

---

## 7. payment_allocations

**Purpose:** Links payments to specific invoices

**Indexes:** `++id, paymentId, invoiceId`

| Column Name | Type | Description |
|------------|------|-------------|
| `id` | Number (Auto-increment) | Primary key, auto-generated |
| `paymentId` | Number | Foreign key to payments table |
| `invoiceId` | Number | Foreign key to invoices table |
| `amount` | Number | Allocated amount |

---

## 8. audit_logs

**Purpose:** Tracks audit trail for important actions

**Indexes:** `++id, entityType, entityId, action, timestamp`

| Column Name | Type | Description |
|------------|------|-------------|
| `id` | Number (Auto-increment) | Primary key, auto-generated |
| `entityType` | String | Type of entity (e.g., "product") |
| `entityId` | Number | ID of the affected entity |
| `action` | String | Action performed (e.g., "MANUAL_SKU_OVERRIDE") |
| `details` | String | Detailed description of action |
| `timestamp` | Date | When the action occurred |

---

## 9. attendance_log

**Purpose:** Tracks user login/logout sessions

**Indexes:** `++id, userId, loginDate, loginTimestamp, logoutTimestamp, created_at`

| Column Name | Type | Description |
|------------|------|-------------|
| `id` | Number (Auto-increment) | Primary key, auto-generated |
| `userId` | Number/String | User identifier |
| `loginDate` | String (ISO Date) | Login date |
| `loginTimestamp` | String (ISO DateTime) | Login timestamp |
| `logoutTimestamp` | String (ISO DateTime) | Logout timestamp |
| `created_at` | String (ISO DateTime) | Record creation timestamp |

---

## 10. bulk_upload_logs

**Purpose:** Tracks bulk data upload operations

**Indexes:** `++id, userId, fileName, totalRecords, successCount, failureCount, timestamp`

| Column Name | Type | Description |
|------------|------|-------------|
| `id` | Number (Auto-increment) | Primary key, auto-generated |
| `userId` | Number/String | User who performed the upload |
| `fileName` | String | Name of uploaded file |
| `totalRecords` | Number | Total records in upload |
| `successCount` | Number | Successfully imported records |
| `failureCount` | Number | Failed records |
| `timestamp` | String (ISO DateTime) | Upload timestamp |

---

## 11. categories

**Purpose:** Stores product categories

**Indexes:** `++id, name, type`

| Column Name | Type | Description |
|------------|------|-------------|
| `id` | Number (Auto-increment) | Primary key, auto-generated |
| `name` | String | Category name |
| `type` | String | Category type (e.g., "product_category") |

---

## 12. subCategories

**Purpose:** Stores product sub-categories

**Indexes:** `++id, name, categoryId`

| Column Name | Type | Description |
|------------|------|-------------|
| `id` | Number (Auto-increment) | Primary key, auto-generated |
| `name` | String | Sub-category name |
| `categoryId` | Number | Foreign key to categories table |

---

## 13. sequences

**Purpose:** Stores auto-increment sequences for various entities

**Indexes:** `key` (Primary key)

| Column Name | Type | Description |
|------------|------|-------------|
| `key` | String | Sequence identifier (e.g., "product_sku") |
| `value` | Number | Current sequence value |

---

## 14. settings

**Purpose:** Stores application settings and configuration

**Indexes:** `key` (Primary key)

| Column Name | Type | Description |
|------------|------|-------------|
| `key` | String | Setting identifier |
| `value` | Any | Setting value (can be object, string, etc.) |

**Common Settings:**
- `companyDetails`: Company information object
- `userProfile`: User profile object
- `templateId`: Invoice template ID (default: "modern")
- `lendingBillTemplateId`: Lending bill template ID (default: "modern")

---

## 15. tag_templates

**Purpose:** Stores barcode tag/label templates for products

**Indexes:** `template_id, name, version`

| Column Name | Type | Description |
|------------|------|-------------|
| `template_id` | String | Primary key, template identifier |
| `name` | String | Template name |
| `version` | String | Template version |
| `frontFields` | Array (Optional) | Fields to show on front of tag |
| `backFields` | Array (Optional) | Fields to show on back of tag |
| `previewImage` | String (Optional) | Preview image path |

---

## 16. product_tag_config

**Purpose:** Links products to their selected tag templates

**Indexes:** `++id, product_id, template_id`

| Column Name | Type | Description |
|------------|------|-------------|
| `id` | Number (Auto-increment) | Primary key, auto-generated |
| `product_id` | Number | Foreign key to products table |
| `template_id` | String | Foreign key to tag_templates table |

---

## Database Schema Diagram

```
┌─────────────┐         ┌──────────────┐
│  customers  │◄───────┤   invoices   │
└─────────────┘         └──────────────┘
                               │
                               ▼
                        ┌──────────────────────┐
                        │ payment_allocations  │
                        └──────────────────────┘
                               ▲
                               │
┌─────────────┐         ┌──────────────┐
│   vendors   │◄───────┤  purchases   │
└─────────────┘         └──────────────┘
       ▲                       
       │                       
       │                ┌──────────────┐
       └───────────────┤   payments   │
                        └──────────────┘

┌──────────────┐        ┌──────────────────┐        ┌──────────────────────┐
│  categories  │◄──────┤  subCategories   │◄──────┤     products         │
└──────────────┘        └──────────────────┘        └──────────────────────┘
                                                              │
                                                              ▼
                                                     ┌──────────────────────┐
                                                     │ product_tag_config   │
                                                     └──────────────────────┘
                                                              │
                                                              ▼
                                                     ┌──────────────────────┐
                                                     │   tag_templates      │
                                                     └──────────────────────┘
```

---

## Notes

1. **Auto-increment IDs**: All tables use `++id` for auto-incrementing primary keys except `sequences` and `settings` which use `key` as primary key
2. **Soft Deletes**: `customers` and `vendors` use `isDeleted` flag for soft deletion
3. **Embedded Data**: Invoice and purchase records embed customer/vendor snapshots for historical accuracy
4. **Timestamps**: Most tables include `createdAt` and `updatedAt` timestamps in ISO DateTime format
5. **Balance Tracking**: Customer and vendor balances are updated atomically within transactions
6. **Jewelry-Specific**: The schema is optimized for jewelry business with metal, gemstone, and weight-related fields
</file>

<file path="style_guide.md">
Here is a comprehensive yet crisp **UI Design Guideline** tailored for your development team. This document standardizes the visual language of the "First Screenshot" (the ideal state) to ensure consistency across all future screens.

***

# 🎨 Swipe App – UI Design System & Guidelines
**Version 1.0** | **Goal:** Clean, Modern, High-Contrast Consistency

---

## 1. Color Palette
**Rule:** Avoid pastel/washed-out colors. Use high-contrast neutrals for structure and the specific Blue Accent for actions/highlights.

### **Primary Colors (Neutrals)**
*   **`#FFFFFF` (Surface White):** Main cards, bottom navigation, input fields.
*   **`#F5F7FA` (Background Grey):** The global background behind the white cards. *Crucial for depth.*
*   **`#111827` (Ink Black):** Primary Headings (e.g., "Create"), Icon Strokes.
*   **`#6B7280` (Slate Grey):** Secondary text, sub-labels (e.g., "Invoice," "Purchase").

### **Accent Colors (Brand)**
*   **`#0F6CBD` (Brand Blue):** Primary buttons, links, active tab icons.
*   **`#E0F2FE` (Soft Blue Wash):** Backgrounds for informational banners (e.g., the "Add Logo" banner).

---

## 2. Typography
**Font Family:** Use a modern Geometric Sans-Serif (e.g., **Inter**, **Roboto**, or System Default).
**Rule:** Text must never be lighter than Medium (500) weight for labels. Avoid "Regular (400)" weight for small text to prevent a "washed out" look.

| Element | Weight | Size (px/sp) | Color | Usage |
| :--- | :--- | :--- | :--- | :--- |
| **Section Header** | **Bold (700)** | 18px | Ink Black | "Create", "Quick Access" |
| **Icon Label** | **Medium (500)** | 12px | Slate Grey | "Invoice", "Purchase Order" |
| **Banner Title** | **SemiBold (600)** | 14px | Brand Blue | "Add company logo..." |
| **Banner Body** | **Regular (400)** | 12px | Brand Blue | "Get Swipe PRO & grow..." |

---

## 3. Iconography (Strict Rules)
**Rule:** Icons must be uniform. Do not mix filled and outlined styles. Do not use multiple colors for icons.

*   **Style:** **Linear / Outline** (Stroke-based).
*   **Stroke Width:** **1.5px** constant width.
*   **Color:** **`#111827` (Ink Black)**.
*   **Container:** Every icon must reside inside a **Squircle** (rounded square) container.
    *   *Container Border:* 1px solid `#E5E7EB` (Light Grey).
    *   *Container Radius:* `12px`.
    *   *Container Size:* `48x48px` (approx).
    *   *Container Background:* Transparent or `#FFFFFF`.

---

## 4. Layout & Spacing (The "Card" Look)
**Rule:** The app is not a flat white sheet. It is a collection of **White Cards** floating on a **Grey Background**.

### **Grid System**
*   **Columns:** 4-column grid for icons.
*   **Alignment:** Center-aligned text relative to the icon container.

### **Spacing (Padding & Margins)**
*   **Global Page Background:** `#F5F7FA`.
*   **Card Padding:** `16px` internal padding.
*   **Card Radius:** `16px` (Rounded corners for the white sections).
*   **Section Gap:** `24px` vertical space between "Create" and "Quick Access" sections.
*   **Element Gap:** `8px` vertical space between an Icon and its Label.

---

## 5. UI Components

### **A. The Feature Card (White Area)**
*   **Usage:** Wrapper for all icon grids.
*   **CSS/Style:**
    ```css
    background-color: #FFFFFF;
    border-radius: 16px;
    margin-bottom: 16px;
    /* Optional: Very subtle shadow for lift */
    box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.05);
    ```

### **B. The Action Banner (Blue Box)**
*   **Usage:** Upsells, Tips, or "Add Logo" prompts.
*   **Style:**
    *   **Background:** `#E0F2FE` (Light Blue).
    *   **Icon:** Brand Blue color, left-aligned.
    *   **Text:** Brand Blue color (`#0F6CBD`).
    *   **Border Radius:** `8px` or `12px`.

### **C. Bottom Navigation**
*   **Background:** White (`#FFFFFF`).
*   **Border Top:** 1px solid `#F3F4F6`.
*   **Active State:** Icon turns Filled + Brand Blue. Text turns Brand Blue.
*   **Inactive State:** Icon is Outline + Grey. Text is Grey.

---

## 6. Developer Checklist (Do's & Don'ts)

*   ✅ **DO** ensure the background behind the icons is pure white, but the screen background is light grey.
*   ✅ **DO** use `text-transform: capitalize` for labels.
*   ❌ **DON'T** use shadows on the text.
*   ❌ **DON'T** use the "Trusted by" footer inside the main dashboard; it creates clutter.
*   ❌ **DON'T** color the icons; keep them black/dark grey. Color is reserved for interactive buttons only.
</file>

<file path=".github/workflows/build-apk.yml">
name: Build Android APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: Build Next.js App
        run: npm run build

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Sync Capacitor
        run: npx cap sync

      - name: Build APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: android/app/build/outputs/apk/debug/app-debug.apk
</file>

<file path="android/app/src/main/res/xml/file_paths.xml">
<?xml version="1.0" encoding="utf-8"?>
<paths xmlns:android="http://schemas.android.com/apk/res/android">
    <external-path name="my_images" path="." />
    <cache-path name="my_cache_images" path="." />
    <files-path name="my_documents" path="." />
</paths>
</file>

<file path="src/app/attendance/history/page.js">
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useAttendanceStore } from '@/lib/store/attendanceStore';
import { FiArrowLeft, FiCalendar } from 'react-icons/fi';
import styles from '../page.module.css'; // Reusing styles

export default function AttendanceHistoryPage() {
    const router = useRouter();
    const { history, isLoading, loadHistory } = useAttendanceStore();

    const userId = '1'; // Default user ID

    useEffect(() => {
        loadHistory(userId, 100); // Load more history for this page
    }, [loadHistory]);

    const formatFullDate = (dateStr) => {
        return new Date(dateStr).toLocaleDateString('en-IN', {
            weekday: 'short', day: 'numeric', month: 'short', year: 'numeric'
        });
    };

    const formatTime = (isoString) => {
        if (!isoString) return '';
        return new Date(isoString).toLocaleTimeString('en-IN', {
            hour: '2-digit', minute: '2-digit', hour12: true
        });
    };

    return (
        <div className={styles.container}>
            <div className={styles.header}>
                <button className={styles.backButton} onClick={() => router.back()}>
                    <FiArrowLeft />
                </button>
                <div>
                    <div className={styles.title}>Attendance History</div>
                    <div className={styles.subtext}>All your login records</div>
                </div>
            </div>

            <div className={styles.content}>
                <div className={styles.historySection}>
                    <div className={styles.historyList}>
                        {isLoading ? (
                            <div className={styles.emptyState}>Loading...</div>
                        ) : history.length === 0 ? (
                            <div className={styles.emptyState}>No history available</div>
                        ) : (
                            history.map(log => (
                                <div key={log.id} className={styles.historyItem}>
                                    <div>
                                        <div className={styles.historyDate}>
                                            {formatFullDate(log.loginDate)}
                                        </div>
                                        <div className={styles.historyTime}>
                                            Login at {formatTime(log.loginAt || log.loginTimestamp)}
                                        </div>
                                    </div>
                                    <div className={styles.statusTag}>Present</div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/attendance/page.js">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useAttendanceStore } from '@/lib/store/attendanceStore';
import { FiArrowLeft, FiCheckCircle, FiClock, FiCalendar } from 'react-icons/fi';
import styles from './page.module.css';
import Link from 'next/link';

export default function AttendancePage() {
    const router = useRouter();
    const {
        todayAttendance,
        history,
        isLoggedIn,
        isLoading,
        login,
        checkTodayStatus,
        loadHistory
    } = useAttendanceStore();

    const userId = '1'; // Default user ID

    useEffect(() => {
        checkTodayStatus(userId);
        loadHistory(userId, 5);
    }, [checkTodayStatus, loadHistory]);

    const handleLogin = async () => {
        try {
            await login(userId);
        } catch (error) {
            console.error('Login failed:', error);
            alert('Failed to record login. Please try again.');
        }
    };

    const formatDate = (dateStr) => {
        return new Date(dateStr).toLocaleDateString('en-IN', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });
    };

    const formatTime = (isoString) => {
        if (!isoString) return '';
        return new Date(isoString).toLocaleTimeString('en-IN', {
            hour: '2-digit', minute: '2-digit', hour12: true
        });
    };

    if (isLoading) return <div className={styles.container}><div className={styles.content}>Loading...</div></div>;

    return (
        <div className={styles.container}>
            <div className={styles.header}>
                <button className={styles.backButton} onClick={() => router.back()}>
                    <FiArrowLeft />
                </button>
                <div>
                    <div className={styles.title}>Daily Attendance</div>
                    <div className={styles.subtext}>Record your login for today</div>
                </div>
            </div>

            <div className={styles.content}>

                {/* Status Card */}
                <div className={styles.statusCard}>
                    <div className={styles.dateDisplay}>
                        {formatDate(new Date())}
                    </div>

                    {todayAttendance ? (
                        <div className={styles.successBadge}>
                            <FiCheckCircle className={styles.successIcon} />
                            <div className={styles.timeDisplay}>
                                {formatTime(todayAttendance.loginAt || todayAttendance.loginTimestamp)}
                            </div>
                            <div className={styles.statusLabel}>
                                Present Today
                            </div>
                        </div>
                    ) : (
                        <button className={styles.loginButton} onClick={handleLogin}>
                            <FiClock /> Log In Now
                        </button>
                    )}
                </div>

                {/* History Preview */}
                <div className={styles.historySection}>
                    <div className={styles.sectionHeader}>
                        <div className={styles.sectionTitle}>Recent Activity</div>
                        <Link href="/attendance/history" className={styles.viewAllLink}>
                            View Full History
                        </Link>
                    </div>

                    <div className={styles.historyList}>
                        {history.length === 0 ? (
                            <div className={styles.emptyState}>No attendance records found</div>
                        ) : (
                            history.map(log => (
                                <div key={log.id} className={styles.historyItem}>
                                    <div>
                                        <div className={styles.historyDate}>
                                            {new Date(log.loginDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })}
                                        </div>
                                        <div className={styles.historyTime}>
                                            {formatTime(log.loginAt || log.loginTimestamp)}
                                        </div>
                                    </div>
                                    <div className={styles.statusTag}>Present</div>
                                </div>
                            ))
                        )}
                    </div>
                </div>

            </div>
        </div>
    );
}
</file>

<file path="src/app/invoice/create/select-customer/page.js">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { usePartyStore } from '@/lib/store/partyStore';
import { useInvoiceStore } from '@/lib/store/invoiceStore';
import { FiArrowLeft, FiSearch, FiPlus, FiX } from 'react-icons/fi';
import { formatCurrency } from '@/lib/utils/tax';

export default function SelectCustomerPage() {
    const router = useRouter();
    const { customers, loadParties } = usePartyStore();
    const { setCustomer } = useInvoiceStore();
    const [searchQuery, setSearchQuery] = useState('');

    useEffect(() => {
        loadParties();
    }, [loadParties]);

    const filteredCustomers = customers.filter(c =>
        c.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        (c.phone && c.phone.includes(searchQuery))
    );

    const handleSelect = (customer) => {
        setCustomer(customer);
        router.back();
    };

    return (
        <div style={{ background: '#f3f4f6', minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
            {/* Header */}
            <div style={{
                background: 'white',
                padding: '16px',
                display: 'flex',
                alignItems: 'center',
                gap: '12px',
                borderBottom: '1px solid #e5e7eb'
            }}>
                <button onClick={() => router.back()} style={{ border: 'none', background: 'none', cursor: 'pointer' }}>
                    <FiArrowLeft size={24} />
                </button>
                <div style={{ flex: 1, position: 'relative' }}>
                    <input
                        placeholder="Search Customer"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        style={{
                            width: '100%',
                            padding: '8px 0',
                            fontSize: '16px',
                            border: 'none',
                            outline: 'none'
                        }}
                        autoFocus
                    />
                </div>
                {searchQuery && (
                    <button onClick={() => setSearchQuery('')} style={{ border: 'none', background: 'none', cursor: 'pointer' }}>
                        <FiX size={20} color="#6b7280" />
                    </button>
                )}
            </div>

            {/* Add New Customer Button */}
            <Link href="/parties/customer/add?returnUrl=/invoice/create" style={{ textDecoration: 'none' }}>
                <div style={{
                    background: '#e0e7ff',
                    padding: '12px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px',
                    color: '#3730a3',
                    fontWeight: 500,
                    cursor: 'pointer'
                }}>
                    <FiPlus size={18} /> Add new customer
                </div>
            </Link>

            {/* Customer List */}
            <div style={{ flex: 1, overflowY: 'auto', padding: '16px', display: 'flex', flexDirection: 'column', gap: '12px' }}>
                {filteredCustomers.map(customer => (
                    <div
                        key={customer.id}
                        onClick={() => handleSelect(customer)}
                        style={{
                            background: 'white',
                            padding: '16px',
                            borderRadius: '12px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            cursor: 'pointer',
                            boxShadow: '0 1px 2px rgba(0,0,0,0.05)'
                        }}
                    >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                            <div style={{
                                width: '40px',
                                height: '40px',
                                borderRadius: '50%',
                                background: '#fce7f3',
                                color: '#be185d',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontWeight: 600,
                                fontSize: '16px'
                            }}>
                                {customer.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style={{ fontWeight: 500, color: '#111827' }}>{customer.name}</div>
                                {customer.phone && (
                                    <div style={{ fontSize: '13px', color: '#6b7280' }}>{customer.phone}</div>
                                )}
                            </div>
                        </div>
                        <div style={{ textAlign: 'right' }}>
                            {customer.balance ? (
                                <div style={{
                                    color: customer.balance > 0 ? '#ef4444' : '#10b981',
                                    fontWeight: 500
                                }}>
                                    {customer.balance > 0 ? '↓' : ''} {formatCurrency(Math.abs(customer.balance))}
                                </div>
                            ) : (
                                <div style={{ fontSize: '13px', color: '#6b7280', fontWeight: 500 }}>No dues</div>
                            )}
                        </div>
                    </div>
                ))}

                {/* Export/SEZ Banner (Static for now as per screenshot design) */}

            </div>
        </div>
    );
}
</file>

<file path="src/app/invoice/create/select-product/page.js">
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';

// Redirect to products page with select mode
export default function SelectProductPage() {
    const router = useRouter();

    useEffect(() => {
        // Redirect to the unified products page with select mode enabled
        router.replace('/products?mode=select&returnUrl=/invoice/create');
    }, [router]);

    return (
        <div style={{ padding: 40, textAlign: 'center', color: '#6b7280' }}>
            Loading products...
        </div>
    );
}
</file>

<file path="src/app/invoice/create/page.js">
'use client';

import InvoiceForm from '@/components/InvoiceForm';
import { FiArrowLeft } from 'react-icons/fi';
import Link from 'next/link';
import { useSearchParams } from 'next/navigation';
import { useEffect } from 'react';
import { useInvoiceStore } from '@/lib/store/invoiceStore';

export default function CreateInvoicePage() {
    const searchParams = useSearchParams();
    const type = searchParams.get('type');
    const { setInvoiceType } = useInvoiceStore();

    // Set the invoice type based on query param when component mounts
    // We assume resetInvoice has already been called or we call it here to be safe?
    // Usually a layout or a parent "create" wrapper would handle reset.
    // For now we just ensure type is set.

    // We need to allow effect to run.
    useEffect(() => {
        if (type === 'proforma') {
            setInvoiceType('PROFORMA');
        } else if (type === 'lending') {
            setInvoiceType('LENDING');
        } else {
            setInvoiceType('INVOICE');
        }
    }, [type, setInvoiceType]);

    return (
        <div>
            <div style={{
                padding: '16px',
                background: 'white',
                display: 'flex',
                alignItems: 'center',
                gap: '16px',
                borderBottom: '1px solid #eee'
            }}>
                <Link href="/">
                    <FiArrowLeft size={24} />
                </Link>
                <h1 style={{ fontSize: '18px', fontWeight: 600 }}>
                    {type === 'proforma' ? 'Create Pro Forma Invoice' : type === 'LENDING' ? 'Create Lending Bill' : 'Create Invoice'}
                </h1>
                {(type === 'proforma' || type === 'LENDING') && (
                    <span style={{ fontSize: '12px', background: type === 'LENDING' ? '#f3f4f6' : '#e0e7ff', color: type === 'LENDING' ? '#374151' : '#4338ca', padding: '2px 8px', borderRadius: '4px', fontWeight: 600 }}>
                        {type === 'LENDING' ? 'Lending Bill' : 'Pro Forma'}
                    </span>
                )}
            </div>
            <InvoiceForm />
        </div>
    );
}
</file>

<file path="src/app/invoice/edit/page.js">
'use client';

import { useEffect, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useInvoiceStore } from '@/lib/store/invoiceStore';
import InvoiceForm from '@/components/InvoiceForm';
import { FiArrowLeft } from 'react-icons/fi';

function InvoiceEditContent() {
    const router = useRouter();
    const searchParams = useSearchParams();
    const id = searchParams.get('id');
    const { setInvoice, resetInvoice, getInvoice } = useInvoiceStore();

    useEffect(() => {
        const loadInvoice = async () => {
            if (id) {
                try {
                    const inv = await getInvoice(id);
                    if (inv) {
                        setInvoice(inv);
                    } else {
                        alert('Invoice not found');
                        router.push('/');
                    }
                } catch (error) {
                    console.error('Failed to load invoice:', error);
                    alert('Failed to load invoice');
                    router.push('/');
                }
            }
        };
        loadInvoice();

        // Cleanup on unmount is tricky because we might want to keep state if navigating to select-product
        // But if we navigate away to home, we should reset.
        // For now, we rely on explicit reset in handleSave or component mount of create page if we were to add one.
        // Actually, Create page should probably reset on mount.

        return () => {
            // Optional: reset if leaving the edit flow completely? 
            // Let's not reset here to allow navigation to sub-pages (select-customer/product)
        };
    }, [id, setInvoice, router]);

    return (
        <div>
            <div style={{ padding: '16px', background: 'white', borderBottom: '1px solid #e5e7eb', display: 'flex', alignItems: 'center', gap: 12 }}>
                <FiArrowLeft size={24} onClick={() => router.back()} style={{ cursor: 'pointer' }} />
                <h1 style={{ fontSize: 18, fontWeight: 600 }}>Update Invoice</h1>
            </div>
            <InvoiceForm isEditMode={true} />
        </div>
    );
}

export default function InvoiceEditPage() {
    return (
        <Suspense fallback={<div>Loading...</div>}>
            <InvoiceEditContent />
        </Suspense>
    );
}
</file>

<file path="src/app/more/company/page.module.css">
.container {
    min-height: 100vh;
    background-color: #f3f4f6;
    display: flex;
    flex-direction: column;
}

.header {
    background: white;
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #e5e7eb;
    position: sticky;
    top: 0;
    z-index: 10;
}

.headerTitle {
    font-weight: 700;
    font-size: 18px;
    color: #111827;
}

.editButton {
    background: #fef3c7;
    color: #d97706;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
}

.content {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding-bottom: 100px; /* Space for footer if needed */
}

.card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    position: relative;
    margin-top: 40px; /* Space for floating logo */
}

.logoContainer {
    position: absolute;
    top: -50px;
    left: 50%;
    transform: translateX(-50%);
}

.formGroup {
    margin-bottom: 16px;
}

.label {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 4px;
    display: block;
}

.value {
    font-size: 16px;
    font-weight: 600;
    color: #111827;
}

.input {
    width: 100%;
    padding: 10px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 16px;
    outline: none;
}

.input:focus {
    border-color: #3b82f6;
}

.addressButton {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    font-weight: 600;
    color: #111827;
}

.iconCircle {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #6b7280;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.accordionHeader {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0;
    cursor: pointer;
    font-weight: 600;
    color: #111827;
}

.accordionContent {
    padding-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}
</file>

<file path="src/app/more/label-templates/page.js">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { FiArrowLeft, FiCheck } from 'react-icons/fi';
import { TAG_TEMPLATES, DEFAULT_TEMPLATE_ID } from '@/lib/data/tagTemplates';
import { api } from '@/api/backendClient';
import styles from './page.module.css';

export default function LabelTemplatesPage() {
    const router = useRouter();
    const [selectedTemplate, setSelectedTemplate] = useState(DEFAULT_TEMPLATE_ID);
    const [showBack, setShowBack] = useState(false);
    const [saving, setSaving] = useState(false);

    // Load saved template preference
    useEffect(() => {
        const loadSavedTemplate = async () => {
            try {
                const settings = await api.settings.get();
                if (settings.selectedLabelTemplate) {
                    setSelectedTemplate(settings.selectedLabelTemplate);
                }
            } catch (err) {
                console.error('Failed to load template setting:', err);
            }
        };
        loadSavedTemplate();
    }, []);

    const handleSelectTemplate = async (templateId) => {
        setSelectedTemplate(templateId);
        setSaving(true);
        try {
            await api.settings.update('selectedLabelTemplate', templateId);
        } catch (err) {
            console.error('Failed to save template setting:', err);
        }
        setSaving(false);
    };

    return (
        <div className={styles.container}>
            {/* Header */}
            <div className={styles.header}>
                <FiArrowLeft size={24} onClick={() => router.back()} style={{ cursor: 'pointer' }} />
                <h1 className={styles.title}>Label Templates</h1>
                <div style={{ width: 24 }}></div>
            </div>

            {/* Toggle Front/Back */}
            <div className={styles.toggleContainer}>
                <button
                    className={`${styles.toggleBtn} ${!showBack ? styles.active : ''}`}
                    onClick={() => setShowBack(false)}
                >
                    Front View
                </button>
                <button
                    className={`${styles.toggleBtn} ${showBack ? styles.active : ''}`}
                    onClick={() => setShowBack(true)}
                >
                    Back View
                </button>
            </div>

            {/* Template Grid */}
            <div className={styles.grid}>
                {TAG_TEMPLATES.map((template) => (
                    <div
                        key={template.template_id}
                        className={`${styles.card} ${selectedTemplate === template.template_id ? styles.selected : ''}`}
                        onClick={() => handleSelectTemplate(template.template_id)}
                    >
                        {selectedTemplate === template.template_id && (
                            <div className={styles.checkBadge}>
                                <FiCheck size={16} />
                            </div>
                        )}

                        <div className={styles.previewContainer}>
                            <img
                                key={`${template.template_id}-${showBack ? 'back' : 'front'}`}
                                src={showBack ? template.preview_back : template.preview_front}
                                alt={`${template.name} preview`}
                                className={styles.previewImage}
                                onError={(e) => {
                                    // Fallback to placeholder if image not found
                                    e.target.style.display = 'none';
                                    e.target.nextSibling.style.display = 'flex';
                                }}
                            />
                            <div className={styles.previewPlaceholder} style={{ display: 'none' }}>
                                <div className={styles.barcodePlaceholder}></div>
                                <div className={styles.textPlaceholder}></div>
                                {template.template_id === 'WEIGHT' && (
                                    <div className={styles.weightBig}>9.97g</div>
                                )}
                            </div>
                        </div>

                        <div className={styles.cardContent}>
                            <h3 className={styles.templateName}>{template.name}</h3>
                            <p className={styles.templateDesc}>{template.description}</p>
                        </div>
                    </div>
                ))}
            </div>

            {/* Coming Soon Note */}
            <div className={styles.note}>
                More templates coming soon
            </div>

            {saving && (
                <div className={styles.savingIndicator}>Saving...</div>
            )}
        </div>
    );
}
</file>

<file path="src/app/more/masters/products/page.js">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useMasterStore } from '@/lib/store/masterStore';
import { FiArrowLeft, FiPlus, FiSearch, FiEdit2, FiX, FiCheck } from 'react-icons/fi';
import styles from './page.module.css';
import clsx from 'clsx';

export default function ProductMastersPage() {
    const router = useRouter();
    const {
        categories, loadCategories,
        subCategories, loadSubCategories,
        addCategory, updateCategory, deleteCategory,
        addSubCategory, updateSubCategory, deleteSubCategory
    } = useMasterStore();

    const [activeTab, setActiveTab] = useState('categories'); // 'categories' | 'subcategories'
    const [search, setSearch] = useState('');
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingItem, setEditingItem] = useState(null); // If set, we are editing

    useEffect(() => {
        loadCategories();
        loadSubCategories();
    }, []);

    const filteredItems = activeTab === 'categories'
        ? categories.filter(c => c.name.toLowerCase().includes(search.toLowerCase()))
        : subCategories.filter(sc =>
            sc.name.toLowerCase().includes(search.toLowerCase()) ||
            categories.find(c => c.id === sc.categoryId)?.name.toLowerCase().includes(search.toLowerCase())
        );

    const handleEdit = (item) => {
        setEditingItem(item);
        setIsModalOpen(true);
    };

    const handleAdd = () => {
        setEditingItem(null);
        setIsModalOpen(true);
    };

    return (
        <div className={styles.container}>
            {/* Header */}
            <div className={styles.header}>
                <div className={styles.headerLeft}>
                    <button className={styles.backButton} onClick={() => router.back()}>
                        <FiArrowLeft />
                    </button>
                    <div className={styles.title}>Product Masters</div>
                </div>
            </div>

            {/* Tabs */}
            <div className={styles.tabContainer}>
                <div
                    className={clsx(styles.tab, activeTab === 'categories' && styles.active)}
                    onClick={() => setActiveTab('categories')}
                >
                    Categories
                </div>
                <div
                    className={clsx(styles.tab, activeTab === 'subcategories' && styles.active)}
                    onClick={() => setActiveTab('subcategories')}
                >
                    Sub-Categories
                </div>
            </div>

            {/* Search */}
            <div style={{ padding: '16px 16px 0 16px' }}>
                <div className={styles.searchBar}>
                    <FiSearch color="#9ca3af" size={20} />
                    <input
                        className={styles.searchInput}
                        placeholder={`Search ${activeTab === 'categories' ? 'categories...' : 'sub-categories...'}`}
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                    />
                </div>
            </div>

            {/* List */}
            <div className={styles.content}>
                {filteredItems.map(item => (
                    <div key={item.id} className={styles.itemCard} onClick={() => handleEdit(item)}>
                        <div className={styles.itemInfo}>
                            <div className={styles.itemName}>{item.name}</div>
                            {activeTab === 'subcategories' && (
                                <div className={styles.itemSub}>
                                    {categories.find(c => c.id === item.categoryId)?.name || 'Unknown Category'}
                                </div>
                            )}
                        </div>
                        <FiEdit2 color="#6b7280" />
                    </div>
                ))}
                {filteredItems.length === 0 && (
                    <div style={{ textAlign: 'center', color: '#9ca3af', marginTop: 32 }}>
                        No {activeTab} found
                    </div>
                )}
            </div>

            {/* FAB */}
            <div className={styles.fab} onClick={handleAdd}>
                <FiPlus size={24} />
                <span>NEW {activeTab === 'categories' ? 'CATEGORY' : 'SUB-CATEGORY'}</span>
            </div>

            {/* Modal */}
            {isModalOpen && (
                <MasterModal
                    isOpen={isModalOpen}
                    onClose={() => setIsModalOpen(false)}
                    mode={activeTab}
                    item={editingItem}
                    categories={categories}
                    actions={{
                        addCategory, updateCategory, deleteCategory,
                        addSubCategory, updateSubCategory, deleteSubCategory
                    }}
                />
            )}
        </div>
    );
}

function MasterModal({ isOpen, onClose, mode, item, categories, actions }) {
    // Shared State
    const [name, setName] = useState(item ? item.name : '');
    const [categoryId, setCategoryId] = useState(item ? item.categoryId : '');

    // Reset when modal opens/changes
    useEffect(() => {
        if (isOpen) {
            setName(item ? item.name : '');
            setCategoryId(item ? item.categoryId : '');
        }
    }, [isOpen, item]);

    const handleSave = async () => {
        if (!name.trim()) return alert('Name is required');

        if (mode === 'categories') {
            if (item) {
                await actions.updateCategory(item.id, { name });
            } else {
                await actions.addCategory(name);
            }
        } else {
            // Subcategory
            if (!categoryId) return alert('Category is required for Sub-Category');
            if (item) {
                await actions.updateSubCategory(item.id, { name, categoryId });
            } else {
                await actions.addSubCategory(name, categoryId);
            }
        }
        onClose();
    };

    const handleDelete = async () => {
        if (!item) return;
        if (confirm('Are you sure you want to delete this item?')) {
            if (mode === 'categories') {
                await actions.deleteCategory(item.id);
            } else {
                await actions.deleteSubCategory(item.id);
            }
            onClose();
        }
    };

    if (!isOpen) return null;

    return (
        <div className={styles.modalOverlay} onClick={onClose}>
            <div className={styles.modalContent} onClick={e => e.stopPropagation()}>
                <div className={styles.modalHeader}>
                    <div className={styles.modalTitle}>
                        {item ? 'Edit' : 'Add'} {mode === 'categories' ? 'Category' : 'Sub-Category'}
                    </div>
                    <button className={styles.closeButton} onClick={onClose}>
                        <FiX />
                    </button>
                </div>

                <div className={styles.modalBody}>
                    <div className={styles.formGroup}>
                        <label className={styles.label}>Name</label>
                        <input
                            className={styles.input}
                            placeholder="Enter Name"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            autoFocus
                        />
                    </div>

                    {mode === 'subcategories' && (
                        <div className={styles.formGroup}>
                            <label className={styles.label}>Parent Category</label>
                            <select
                                className={styles.select}
                                value={categoryId}
                                onChange={(e) => setCategoryId(e.target.value)}
                            >
                                <option value="">Select Category</option>
                                {categories.map(c => (
                                    <option key={c.id} value={c.id}>{c.name}</option>
                                ))}
                            </select>
                        </div>
                    )}
                </div>

                <div className={styles.modalFooter}>
                    <div className={styles.modalActions}>
                        {item && (
                            <button className={styles.deleteButton} onClick={handleDelete}>Delete</button>
                        )}
                        <button className={styles.saveButton} onClick={handleSave}>Save</button>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/more/masters/products/page.module.css">
.container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background-color: #f8f9fa;
}

.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background-color: #fff;
    border-bottom: 1px solid #eee;
}

.headerLeft {
    display: flex;
    align-items: center;
    gap: 12px;
}

.backButton {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
}

.title {
    font-size: 18px;
    font-weight: 600;
    color: #000;
}

.tabContainer {
    display: flex;
    background-color: #fff;
    border-bottom: 1px solid #eee;
}

.tab {
    flex: 1;
    padding: 16px;
    text-align: center;
    cursor: pointer;
    font-weight: 500;
    color: #666;
    border-bottom: 2px solid transparent;
}

.tab.active {
    color: #2962ff;
    border-bottom-color: #2962ff;
}

.content {
    flex: 1;
    overflow-y: auto;
    padding: 16px 16px 120px 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.searchBar {
    display: flex;
    align-items: center;
    background-color: #fff;
    padding: 12px 16px;
    border-radius: 8px;
    border: 1px solid #eee;
}

.searchInput {
    border: none;
    background: none;
    outline: none;
    flex: 1;
    margin-left: 8px;
    font-size: 16px;
}

.itemCard {
    background-color: #fff;
    padding: 16px;
    border-radius: 8px;
    border: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.itemInfo {
    display: flex;
    flex-direction: column;
}

.itemName {
    font-size: 16px;
    color: #333;
    font-weight: 500;
}

.itemSub {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
}

.fab {
    position: fixed;
    bottom: 100px;
    right: 24px;
    background-color: #2962ff;
    color: #fff;
    padding: 16px 24px;
    border-radius: 32px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(41, 98, 255, 0.3);
    cursor: pointer;
    z-index: 100;
}

/* Modal Styles */
.modalOverlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: flex-end;
    /* Bottom sheet style */
    z-index: 1000;
}

.modalContent {
    background-color: #fff;
    width: 100%;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        transform: translateY(100%);
    }

    to {
        transform: translateY(0);
    }
}

.modalHeader {
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
}

.modalTitle {
    font-size: 18px;
    font-weight: 600;
}

.closeButton {
    background: none;
    border: none;
    font-size: 24px;
    color: #666;
    cursor: pointer;
}

.modalBody {
    padding: 16px;
    overflow-y: auto;
    flex: 1;
}

.formGroup {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
}

.label {
    font-size: 14px;
    color: #666;
    font-weight: 500;
}

.input {
    padding: 12px 16px;
    border: 1px solid #eee;
    border-radius: 8px;
    font-size: 16px;
    background-color: #f9f9f9;
    outline: none;
}

.input:focus {
    background-color: #fff;
    border-color: #2962ff;
}

.select {
    padding: 12px 16px;
    border: 1px solid #eee;
    border-radius: 8px;
    font-size: 16px;
    background-color: #f9f9f9;
    outline: none;
    appearance: none;
    /* simple styling */
}

.modalFooter {
    padding: 16px;
    border-top: 1px solid #eee;
}

.modalActions {
    display: flex;
    gap: 16px;
}

.deleteButton {
    flex: 1;
    padding: 14px;
    background-color: #ffebee;
    color: #d32f2f;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}

.saveButton {
    flex: 1;
    padding: 14px;
    background-color: #2962ff;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}
</file>

<file path="src/app/more/profile/page.js">
'use client';

import { useEffect } from 'react';
import Link from 'next/link';
import { useSettingsStore } from '@/lib/store/settingsStore';
import { useAuthStore } from '@/lib/store/authStore';
import { FiArrowLeft, FiUser, FiMail, FiPhone, FiTrash2, FiLogOut, FiChevronRight } from 'react-icons/fi';
import styles from './page.module.css';

export default function UserProfilePage() {
    const { userProfile, loadSettings, resetData } = useSettingsStore();
    const { logout } = useAuthStore();

    useEffect(() => {
        loadSettings();
    }, []);

    const handleReset = async () => {
        if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
            await resetData();
        }
    };

    return (
        <div className={styles.container}>
            <div className={styles.header}>
                <Link href="/more"><FiArrowLeft size={24} /></Link>
                User Profile
            </div>

            <div className={styles.sectionLabel}>User Details</div>
            <div className={styles.card}>
                <div className={styles.item}>
                    <FiUser className={styles.icon} />
                    <div className={styles.content}>
                        <div className={styles.label}>User Name</div>
                        <div className={styles.subLabel}>{userProfile.name || 'Add User Name'}</div>
                    </div>
                    <FiChevronRight className={styles.arrow} />
                </div>
                <div className={styles.item}>
                    <FiMail className={styles.icon} />
                    <div className={styles.content}>
                        <div className={styles.label}>Email Address</div>
                        <div className={styles.subLabel}>{userProfile.email || 'Add Email Address'}</div>
                    </div>
                    <FiChevronRight className={styles.arrow} />
                </div>
                <div className={styles.item}>
                    <FiPhone className={styles.icon} />
                    <div className={styles.content}>
                        <div className={styles.label}>Phone Number</div>
                        <div className={styles.subLabel}>{userProfile.phone || '8454881721'}</div>
                    </div>
                    <FiChevronRight className={styles.arrow} />
                </div>
            </div>

            <div className={styles.sectionLabel}>Privacy Settings</div>
            <div className={styles.card}>
                <div className={styles.item} onClick={handleReset}>
                    <FiTrash2 className={styles.icon} />
                    <div className={styles.content}>
                        <div className={styles.label}>Reset Data</div>
                    </div>
                    <FiChevronRight className={styles.arrow} />
                </div>
                <div className={styles.dangerItem}>
                    <FiUser className={styles.dangerIcon} />
                    <div className={styles.dangerLabel}>Delete Account</div>
                    <FiChevronRight className={styles.arrow} />
                </div>
                <div className={styles.item} onClick={() => {
                    if (confirm('Are you sure you want to logout?')) {
                        logout();
                    }
                }}>
                    <FiLogOut className={styles.icon} />
                    <div className={styles.content}>
                        <div className={styles.label}>Logout</div>
                    </div>
                    <FiChevronRight className={styles.arrow} />
                </div>
                <div className={styles.item} onClick={() => alert('This feature is coming soon')}>
                    <FiLogOut className={styles.icon} />
                    <div className={styles.content}>
                        <div className={styles.label}>Logout from all devices</div>
                    </div>
                    <FiChevronRight className={styles.arrow} />
                </div>
            </div>

            <div className={styles.footer}>
                <button className={styles.supportButton}>
                    Support Code <span style={{ color: 'var(--primary)' }}>***</span>
                </button>
            </div>
        </div>
    );
}
</file>

<file path="src/app/parties/customer/edit/page.module.css">
.container {
    background: #f3f4f6;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.header {
    background: white;
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #eee;
}

.headerTitle {
    font-size: 18px;
    font-weight: 700;
    color: #111827;
    margin-left: 12px;
}

.headerActions {
    display: flex;
    align-items: center;
    gap: 16px;
}

.importAction {
    color: #2563eb;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
    cursor: pointer;
}

.content {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    flex: 1;
}

.banner {
    background: #e0e7ff;
    padding: 16px;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.bannerTitle {
    font-weight: 700;
    color: #111827;
    font-size: 14px;
    margin-bottom: 4px;
}

.bannerText {
    font-size: 12px;
    color: #4b5563;
}

.section {
    background: white;
    padding: 16px;
    border-radius: 12px;
}

.sectionHeader {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.sectionTitle {
    font-weight: 700;
    font-size: 14px;
    color: #111827;
}

.inputGroup {
    margin-bottom: 16px;
    position: relative;
}

.input {
    width: 100%;
    padding: 16px 12px 4px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    font-size: 16px;
    outline: none;
    transition: border-color 0.2s;
}

.input:focus {
    border-color: #2563eb;
}

.label {
    position: absolute;
    left: 12px;
    top: 12px;
    font-size: 14px;
    color: #6b7280;
    pointer-events: none;
    transition: all 0.2s;
}

.input:focus+.label,
.input:not(:placeholder-shown)+.label {
    top: 4px;
    font-size: 10px;
    color: #2563eb;
}

.phoneInputContainer {
    display: flex;
    align-items: center;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 8px 12px;
    background: white;
}

.flag {
    width: 24px;
    height: 16px;
    margin-right: 8px;
    border-radius: 2px;
    object-fit: cover;
}

.phonePrefix {
    font-weight: 500;
    margin-right: 8px;
    color: #111827;
    display: flex;
    align-items: center;
    gap: 4px;
}

.phoneInput {
    border: none;
    outline: none;
    font-size: 16px;
    width: 100%;
}

.gstContainer {
    display: flex;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
}

.gstInput {
    flex: 1;
    padding: 12px;
    border: none;
    outline: none;
    font-size: 16px;
}

.fetchButton {
    background: #2563eb;
    color: white;
    border: none;
    padding: 0 16px;
    font-weight: 600;
    font-size: 12px;
    cursor: pointer;
}

.helperText {
    font-size: 12px;
    color: #9ca3af;
    margin-top: 4px;
}

.addressButton {
    width: 100%;
    padding: 16px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    text-align: left;
    color: #6b7280;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.checkboxContainer {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #6b7280;
    cursor: pointer;
}

.updateButton {
    width: 100%;
    background: #2563eb;
    color: white;
    padding: 16px;
    border-radius: 12px;
    border: none;
    font-size: 16px;
    font-weight: 700;
    margin-top: auto;
    cursor: pointer;
}
</file>

<file path="src/app/parties/vendor/add/page.js">
'use client';

import { useState } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import Link from 'next/link';
import { usePartyStore } from '@/lib/store/partyStore';
import { FiArrowLeft, FiPlusCircle, FiUpload, FiX } from 'react-icons/fi';
import styles from '../../form.module.css';

export default function AddVendorPage() {
    const router = useRouter();
    const { addVendor } = usePartyStore();
    const [formData, setFormData] = useState({
        name: '',
        phone: '',
        email: '',
        address: '',
        gstin: '',
        companyName: '',
        documents: []
    });
    const [showBillingAddress, setShowBillingAddress] = useState(false);

    const handleFileChange = (e) => {
        const files = Array.from(e.target.files);

        files.forEach(file => {
            const reader = new FileReader();
            reader.onloadend = () => {
                setFormData(prev => ({
                    ...prev,
                    documents: [...prev.documents, {
                        name: file.name,
                        type: file.type,
                        data: reader.result
                    }]
                }));
            };
            reader.readAsDataURL(file);
        });
    };

    const removeDocument = (index) => {
        setFormData(prev => ({
            ...prev,
            documents: prev.documents.filter((_, i) => i !== index)
        }));
    };

    const searchParams = useSearchParams();
    const returnUrl = searchParams.get('returnUrl');

    const handleSave = async () => {
        if (!formData.name) return alert('Name is required');
        if (formData.phone && formData.phone.length !== 10) return alert('Phone number must be 10 digits');
        const id = await addVendor({ ...formData, balance: 0 });

        if (returnUrl) {
            router.push(returnUrl);
        } else {
            router.push('/parties');
        }
    };

    return (
        <div className={styles.container}>
            <div className={styles.header}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                    <Link href="/parties"><FiArrowLeft size={24} /></Link>
                    Add Vendor
                </div>
            </div>

            <div className={styles.sectionLabel}>Basic Details</div>
            <div className={styles.card}>
                <input
                    className={styles.input}
                    placeholder="Name *"
                    value={formData.name}
                    onChange={e => setFormData({ ...formData, name: e.target.value })}
                    style={{ marginBottom: 12 }}
                />
                <div className={styles.row} style={{ marginBottom: 12 }}>
                    <div style={{ padding: 12, background: '#f9fafb', border: '1px solid #e5e7eb', borderRadius: 8 }}>🇮🇳 +91</div>
                    <input
                        className={styles.input}
                        placeholder="Enter Phone Number"
                        value={formData.phone}
                        onChange={e => {
                            const value = e.target.value.replace(/\D/g, '').slice(0, 10);
                            setFormData({ ...formData, phone: value });
                        }}
                    />
                </div>
                <input
                    className={styles.input}
                    placeholder="Email"
                    value={formData.email}
                    onChange={e => setFormData({ ...formData, email: e.target.value })}
                />
            </div>

            <div className={styles.sectionLabel}>Company Details (Optional)</div>
            <div className={styles.card}>
                <input
                    className={styles.input}
                    placeholder="GST Number"
                    value={formData.gstin}
                    onChange={e => setFormData({ ...formData, gstin: e.target.value })}
                    style={{ marginBottom: 12 }}
                />
                <input
                    className={styles.input}
                    placeholder="Company Name"
                    value={formData.companyName}
                    onChange={e => setFormData({ ...formData, companyName: e.target.value })}
                />
            </div>

            <div className={styles.sectionLabel}>Billing Address (Optional)</div>
            <div className={styles.card}>
                {!showBillingAddress ? (
                    <div className={styles.actionRow} onClick={() => setShowBillingAddress(true)}>
                        <FiPlusCircle size={20} color="#6b7280" />
                        <span>Billing Address</span>
                    </div>
                ) : (
                    <textarea
                        className={styles.textarea}
                        placeholder="Enter Billing Address"
                        value={formData.address}
                        onChange={e => setFormData({ ...formData, address: e.target.value })}
                        autoFocus
                    />
                )}
            </div>

            <div className={styles.sectionLabel}>Documents (Optional)</div>
            <div className={styles.card}>
                <label className={styles.uploadBox}>
                    <input
                        type="file"
                        multiple
                        accept="image/*,application/pdf"
                        style={{ display: 'none' }}
                        onChange={handleFileChange}
                    />
                    <FiUpload className={styles.uploadIcon} />
                    <span className={styles.uploadText}>Upload Identity Documents (Image/PDF)</span>
                </label>

                {formData.documents.length > 0 && (
                    <div className={styles.fileList}>
                        {formData.documents.map((doc, index) => (
                            <div key={index} className={styles.fileItem}>
                                <span>{doc.name}</span>
                                <FiX
                                    style={{ cursor: 'pointer', color: '#ef4444' }}
                                    onClick={() => removeDocument(index)}
                                />
                            </div>
                        ))}
                    </div>
                )}
            </div>

            <div className={styles.footer}>
                <button className={styles.saveButton} onClick={handleSave}>Add Vendor</button>
            </div>
        </div>
    );
}
</file>

<file path="src/app/parties/form.module.css">
.container {
    padding: 16px;
    padding-bottom: 80px;
    background: #f3f4f6;
    min-height: 100vh;
}

.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    font-size: 18px;
    font-weight: 600;
}

.sectionLabel {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 12px;
    color: #1f2937;
    margin-left: 4px;
}

.card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 24px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.inputGroup {
    margin-bottom: 16px;
}

.input {
    width: 100%;
    padding: 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
}

.input:focus {
    border-color: var(--primary);
}

.textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
}

.textarea:focus {
    border-color: var(--primary);
}

.row {
    display: flex;
    gap: 12px;
}

.fetchButton {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0 16px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
}

.actionRow {
    display: flex;
    align-items: center;
    gap: 12px;
    color: #4b5563;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
}

.uploadBox {
    border: 2px dashed #e5e7eb;
    border-radius: 12px;
    padding: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
    transition: border-color 0.2s;
    text-align: center;
}

.uploadBox:hover {
    border-color: var(--primary);
}

.uploadIcon {
    font-size: 24px;
    color: #9ca3af;
}

.uploadText {
    font-size: 14px;
    color: #6b7280;
}

.fileList {
    margin-top: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.fileItem {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: #f9fafb;
    border-radius: 8px;
    font-size: 12px;
    color: #374151;
}

.footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    padding: 16px;
    border-top: 1px solid #eee;
    z-index: 50;
}

.saveButton {
    width: 100%;
    background: var(--primary);
    color: white;
    padding: 14px;
    border-radius: 12px;
    font-weight: 600;
}
</file>

<file path="src/app/parties/page.module.css">
.container {
    padding: 16px;
    padding-bottom: 80px;
    background: var(--background);
    min-height: 100vh;
}

.tabs {
    display: flex;
    background: var(--card-bg);
    padding: 0 16px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 10;
}

.tab {
    padding: 16px;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    font-size: 14px;
}

.activeTab {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

.summaryRow {
    display: flex;
    gap: 12px;
    margin: 16px 0;
}

.summaryCard {
    flex: 1;
    padding: 16px;
    border-radius: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.collectCard {
    background: #ECFDF5;
    color: #065F46;
    border: 1px solid #D1FAE5;
}

.payCard {
    background: #FEF2F2;
    color: #991B1B;
    border: 1px solid #FEE2E2;
}

.summaryLabel {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.summaryAmount {
    font-size: 16px;
    font-weight: 700;
}

.emptyState {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    text-align: center;
    background: var(--card-bg);
    border-radius: 16px;
    min-height: 300px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.emptyIcon {
    font-size: 48px;
    color: #CBD5E1;
    margin-bottom: 16px;
}

.emptyText {
    color: var(--text-secondary);
    margin-bottom: 24px;
    font-weight: 500;
}

.addButton {
    background: var(--primary);
    color: white;
    padding: 14px 24px;
    border-radius: 12px;
    font-weight: 600;
    width: 100%;
    margin-bottom: 12px;
    font-size: 14px;
}

.secondaryButton {
    background: white;
    color: var(--primary);
    border: 1px solid var(--primary);
    padding: 14px 24px;
    border-radius: 12px;
    font-weight: 600;
    width: 100%;
    font-size: 14px;
}

.list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.listItem {
    background: var(--card-bg);
    padding: 16px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.avatar {
    width: 48px;
    height: 48px;
    border-radius: 16px;
    /* Squircle */
    background: var(--primary-light);
    color: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
}

.info {
    flex: 1;
}

.name {
    font-weight: 600;
    color: var(--foreground);
    font-size: 14px;
    margin-bottom: 2px;
}

.subtext {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
}
</file>

<file path="src/app/products/components/ProductCard.module.css">
.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    border: 1px solid #f3f4f6;
    transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.imageContainer {
    position: relative;
    width: 100%;
    padding-top: 75%;
    /* 4:3 Aspect Ratio */
    background: #f9fafb;
    overflow: hidden;
}

.image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.placeholderImage {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f3f4f6;
}

.purityBadge {
    position: absolute;
    top: 8px;
    left: 8px;
    background: rgba(234, 179, 8, 0.9);
    /* Goldish */
    color: #fff;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    z-index: 10;
}

.statusBadge {
    position: absolute;
    top: 8px;
    right: 8px;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    z-index: 10;
    color: white;
}

.new {
    background: #3b82f6;
    /* Blue */
}

.bestseller {
    background: #d97706;
    /* Darker Gold/Orange */
}

.details {
    padding: 12px;
    flex: 1;
    /* Pushes footer down */
}

.title {
    margin: 0 0 4px 0;
    font-size: 14px;
    font-weight: 600;
    color: #111827;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.infoRow {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 8px;
}

.price {
    font-size: 15px;
    font-weight: 700;
    color: #111827;
}

.actions {
    padding: 12px;
    border-top: 1px solid #f3f4f6;
    display: flex;
    gap: 8px;
    background: #ffffff;
}

.primaryBtn {
    flex: 1;
    background: #ca8a04;
    /* Gold */
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
}

.primaryBtn:hover {
    background: #a16207;
}

.iconBtn {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #4b5563;
    cursor: pointer;
    padding: 0;
    transition: background 0.2s;
}

.iconBtn:hover {
    background: #f9fafb;
    color: #111827;
}

/* Quantity Badge for Select Mode */
.quantityBadge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #2563eb;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    font-size: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

/* Added Button State */
.addedBtn {
    background: #16a34a;
    display: flex;
    align-items: center;
    justify-content: center;
}

.addedBtn:hover {
    background: #15803d;
}
</file>

<file path="src/components/LandingPage/LandingPage.module.css">
.container {
    min-height: 100vh;
    background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
    color: white;
    overflow-x: hidden;
    font-family: 'Inter', sans-serif;
}

.nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 2rem;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10;
}

.logo {
    font-size: 1.5rem;
    font-weight: 800;
    background: linear-gradient(to right, #60a5fa, #a78bfa);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.hero {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 6rem 2rem 2rem;
    position: relative;
}

.heroContent {
    max-width: 800px;
    z-index: 2;
}

.badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 9999px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
    color: #93c5fd;
}

.title {
    font-size: 3.5rem;
    font-weight: 800;
    line-height: 1.1;
    margin-bottom: 1.5rem;
    background: linear-gradient(to right, #ffffff, #94a3b8);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.subtitle {
    font-size: 1.25rem;
    color: #94a3b8;
    margin-bottom: 2.5rem;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
}

.ctaGroup {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 4rem;
}

.primaryButton {
    padding: 1rem 2rem;
    background: linear-gradient(to right, #2563eb, #4f46e5);
    color: white;
    border: none;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 1.125rem;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5);
}

.primaryButton:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.6);
}

.secondaryButton {
    padding: 1rem 2rem;
    background: rgba(255, 255, 255, 0.05);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 9999px;
    font-weight: 600;
    font-size: 1.125rem;
    cursor: pointer;
    backdrop-filter: blur(10px);
    transition: background 0.2s;
}

.secondaryButton:hover {
    background: rgba(255, 255, 255, 0.1);
}

.heroImageContainer {
    position: relative;
    width: 100%;
    max-width: 1000px;
    margin: 0 auto;
    perspective: 1000px;
}

.heroImage {
    width: 100%;
    height: auto;
    border-radius: 1rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.features {
    padding: 6rem 2rem;
    background: rgba(0, 0, 0, 0.2);
}

.sectionTitle {
    text-align: center;
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 4rem;
}

.grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    padding: 2rem;
    border-radius: 1rem;
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-5px);
    background: rgba(255, 255, 255, 0.05);
}

.cardIcon {
    font-size: 2rem;
    color: #60a5fa;
    margin-bottom: 1.5rem;
}

.cardTitle {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

.cardText {
    color: #94a3b8;
    line-height: 1.6;
}

/* Footer Styles */
.footer {
    padding: 4rem 2rem 2rem;
    background: #0f172a;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.footerGrid {
    display: grid;
    grid-template-columns: 1.5fr 1fr 1fr 1fr 1fr 1fr;
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.footerColumn {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.footerLogo {
    font-size: 1.5rem;
    font-weight: 800;
    color: white;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
}

.socialIcons {
    display: flex;
    gap: 1rem;
}

.socialIcon {
    font-size: 1.5rem;
    color: #94a3b8;
    cursor: pointer;
    transition: color 0.2s;
}

.socialIcon:hover {
    color: white;
}

.footerHeading {
    font-size: 0.875rem;
    font-weight: 600;
    color: #94a3b8;
    margin-bottom: 0.5rem;
}

.footerLink {
    color: #cbd5e1;
    text-decoration: none;
    font-size: 0.9rem;
    transition: color 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.footerLink:hover {
    color: #60a5fa;
}

.scrollTopButton {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 3rem;
    height: 3rem;
    background: white;
    color: #0f172a;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
    z-index: 50;
}

.scrollTopButton:hover {
    transform: translateY(-2px);
}

@media (max-width: 1024px) {
    .footerGrid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 768px) {
    .title {
        font-size: 2.5rem;
    }

    .hero {
        padding-top: 8rem;
    }

    .ctaGroup {
        flex-direction: column;
    }

    .ctaGroup .primaryButton,
    .ctaGroup .secondaryButton {
        width: 100%;
    }

    .footerGrid {
        grid-template-columns: 1fr;
        gap: 3rem;
    }
}
</file>

<file path="src/components/ServerConfig/ServerSetup.js">
'use client';

import { useState, useEffect } from 'react';
import { api } from '@/api/backendClient';
import styles from './ServerSetup.module.css';

export default function ServerSetup({ onConfigured, initialUrl = '', initialError = '' }) {
    const [url, setUrl] = useState(initialUrl);
    const [status, setStatus] = useState(initialError ? 'error' : 'idle'); // idle, testing, success, error
    const [message, setMessage] = useState(initialError);

    // Update state if props change
    useEffect(() => {
        if (initialUrl) setUrl(initialUrl);
        if (initialError) {
            setStatus('error');
            setMessage(initialError);
        }
    }, [initialUrl, initialError]);

    const handleTestAndSave = async () => {
        if (!url) {
            setMessage('Please enter a URL');
            setStatus('error');
            return;
        }

        // Normalization
        let cleanUrl = url.trim().replace(/\/$/, '');
        if (!/^https?:\/\//i.test(cleanUrl)) {
            setMessage('URL must start with http:// or https://');
            setStatus('error');
            return;
        }

        setStatus('testing');
        setMessage('Testing connection...');

        try {
            // Test the connection directly
            // We append /health or just check the root/api health
            // Assuming the user enters the BASE URL e.g. http://192.168.1.5:3000/api
            // Or just the host? The user request said "http://192.168.1.25:3000" and existing code adds /api often.
            // Existing backendClient says: API_BASE = .../api
            // So if user enters http://host:port, we might need to append /api depending on convention.
            // Let's assume user enters the full base or host.
            // Best UX: User enters "http://192.168.1.5:3000", we auto-append /api if missing?
            // Let's try raw fetch to /health endpoint which seems to be at host/health based on backendClient

            // BackendClient: health: () => fetch(`${API_BASE.replace('/api', '')}/health`)
            // So if API_BASE is http://localhost:3000/api, it fetches http://localhost:3000/health

            // let's try to construct the probable health URL
            let testUrl = cleanUrl;
            if (!testUrl.endsWith('/api')) {
                // If user didn't add /api, maybe they shouldn't?
                // But the app needs /api to be part of the base usually? 
                // Let's stick to the convention in backendClient.
                // If the user inputs http://x.x.x.x:3000, we likely want to save http://x.x.x.x:3000/api
                // So let's test http://x.x.x.x:3000/health
            }

            // Heuristic: If url ends with /api, remove it for health check
            const healthUrl = cleanUrl.endsWith('/api')
                ? `${cleanUrl.replace(/\/api$/, '')}/health`
                : `${cleanUrl}/health`;

            const res = await fetch(healthUrl);

            if (res.ok) {
                setStatus('success');
                setMessage('Connected! Saving...');

                // Determine what to save. 
                // If user entered http://.../api, save it. 
                // If user entered http://..., append /api?
                // Let's ask the user in the generic case, or just standardization.
                // Default API_BASE was http://localhost:3000/api
                // So we want the stored URL to end in /api

                let finalBaseUrl = cleanUrl;
                if (!finalBaseUrl.endsWith('/api')) {
                    finalBaseUrl = `${finalBaseUrl}/api`;
                }

                await api.setApiBase(finalBaseUrl);

                setTimeout(() => {
                    if (onConfigured) onConfigured();
                }, 1000);
            } else {
                throw new Error('Health check returned ' + res.status);
            }
        } catch (err) {
            console.error(err);
            setStatus('error');
            setMessage(`Connection failed: ${err.message}`);
        }
    };

    return (
        <div className={styles.container}>
            <div className={styles.card}>
                <h2 className={styles.title}>Connect to Backend</h2>
                <p className={styles.subtitle}>
                    Enter the URL of your local server.<br />
                    Example: http://192.168.1.15:3000
                </p>

                <div className={styles.inputGroup}>
                    <input
                        type="text"
                        className={styles.input}
                        placeholder="http://192.168.x.x:3000"
                        value={url}
                        onChange={(e) => setUrl(e.target.value)}
                        disabled={status === 'testing' || status === 'success'}
                    />
                </div>

                {message && (
                    <div className={`${styles.message} ${styles[status]}`}>
                        {message}
                    </div>
                )}

                <button
                    className={styles.button}
                    onClick={handleTestAndSave}
                    disabled={status === 'testing' || status === 'success'}
                >
                    {status === 'testing' ? 'Testing...' : 'Connect'}
                </button>
            </div>
        </div>
    );
}
</file>

<file path="src/components/BarcodeScanner.module.css">
.overlay {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 1000;
    display: flex;
    flex-direction: column;
}

.header {
    display: flex;
    justify-content: space-between;
    padding: 16px 24px;
    padding-top: env(safe-area-inset-top, 16px);
}

.headerBtn {
    background: none;
    border: none;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    cursor: pointer;
}

.scannerContainer {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

.reader {
    width: 100%;
    height: 100%;
}

.reader video {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
}

.scanFrame {
    position: absolute;
    width: 260px;
    height: 260px;
    pointer-events: none;
}

.corner {
    position: absolute;
    width: 40px;
    height: 40px;
    border: 3px solid #4ade80;
}

.topLeft {
    top: 0;
    left: 0;
    border-right: none;
    border-bottom: none;
    border-radius: 12px 0 0 0;
}

.topRight {
    top: 0;
    right: 0;
    border-left: none;
    border-bottom: none;
    border-radius: 0 12px 0 0;
}

.bottomLeft {
    bottom: 0;
    left: 0;
    border-right: none;
    border-top: none;
    border-radius: 0 0 0 12px;
}

.bottomRight {
    bottom: 0;
    right: 0;
    border-left: none;
    border-top: none;
    border-radius: 0 0 12px 0;
}

.errorMessage {
    color: white;
    text-align: center;
    padding: 20px;
    font-size: 14px;
}

.errorContainer {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    padding: 32px;
}

.loadingMessage {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    color: white;
    font-size: 16px;
}

.retryBtn {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #3b82f6;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    margin-top: 8px;
}

.retryBtn:active {
    background: #2563eb;
}

.instructions {
    text-align: center;
    color: white;
    padding: 24px;
    font-size: 16px;
}

.manualEntryBtn {
    background: none;
    border: none;
    color: white;
    text-decoration: underline;
    font-size: 16px;
    padding: 24px;
    padding-bottom: env(safe-area-inset-bottom, 24px);
    cursor: pointer;
    text-align: center;
}

.manualInputContainer {
    display: flex;
    gap: 12px;
    padding: 16px 24px;
    padding-bottom: env(safe-area-inset-bottom, 24px);
}

.manualInput {
    flex: 1;
    padding: 12px 16px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    background: white;
}

.submitBtn {
    background: #2563eb;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
}
</file>

<file path="src/components/BottomNav.module.css">
.nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  border-top: 1px solid #eee;
  display: flex;
  justify-content: space-around;
  padding: 8px 0;
  z-index: 100;
  padding-bottom: env(safe-area-inset-bottom);
}

.item {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-decoration: none;
  color: #666;
  font-size: 12px;
  gap: 4px;
}

.active {
  color: #D4AF37;
  font-weight: 600;
}

.label {
  margin-top: 2px;
}
</file>

<file path="src/components/BottomSheet.js">
'use client';

import { useEffect, useState } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { ANIMATIONS } from '@/lib/animations';
import styles from './BottomSheet.module.css';

export default function BottomSheet({ isOpen, onClose, children }) {
    const [mounted, setMounted] = useState(false);

    useEffect(() => {
        setMounted(true);
    }, []);

    useEffect(() => {
        if (isOpen) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = 'unset';
        }
        return () => {
            document.body.style.overflow = 'unset';
        };
    }, [isOpen]);

    if (!mounted) return null;

    return createPortal(
        <AnimatePresence>
            {isOpen && (
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    transition={{ duration: ANIMATIONS.duration.fast }}
                    className={styles.overlay}
                    onClick={onClose}
                >
                    <motion.div
                        initial={{ y: '100%' }}
                        animate={{ y: 0 }}
                        exit={{ y: '100%' }}
                        transition={{
                            type: 'spring',
                            damping: 25,
                            stiffness: 300,
                        }}
                        className={styles.sheet}
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className={styles.handleBar}>
                            <div className={styles.handle} />
                        </div>
                        <div className={styles.content}>
                            {children}
                        </div>
                    </motion.div>
                </motion.div>
            )}
        </AnimatePresence>,
        document.body
    );
}
</file>

<file path="src/components/InvoiceBottomSheet.js">
import React from 'react';
import { createPortal } from 'react-dom';
import { FiX, FiShare2, FiDollarSign } from 'react-icons/fi';
import { shareInvoicePDF } from '@/lib/utils/invoiceActions';
import styles from './BottomSheet.module.css'; // Reusing existing styles

export const InvoiceBottomSheet = ({ isOpen, onClose, invoice, onRecordPayment, onShare }) => {
    if (!isOpen || !invoice) return null;

    const handleShare = async () => {
        // Use the passed onShare callback if provided (for backwards compatibility)
        // Otherwise use the centralized shareInvoicePDF utility
        if (onShare && typeof onShare === 'function') {
            // Check if it's a placeholder (like the alert callback)
            const result = onShare(invoice);
            // If onShare returns void/undefined or the invoice, also try our utility
            if (result === undefined) {
                // It was likely a placeholder - use our utility instead
                await shareInvoicePDF(invoice);
            }
        } else {
            await shareInvoicePDF(invoice);
        }
        onClose();
    };

    return createPortal(
        <div className={styles.overlay} onClick={onClose}>
            <div className={styles.sheet} onClick={e => e.stopPropagation()}>
                <div className={styles.handleBar} />

                <div style={{ padding: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', borderBottom: '1px solid #eee' }}>
                    <div>
                        <h3 style={{ margin: 0, fontSize: '18px' }}>Invoice #{invoice.invoiceNumber}</h3>
                        <div style={{ fontSize: '12px', color: '#666' }}>
                            {new Date(invoice.date).toLocaleDateString()} • <span style={{ color: '#dc2626' }}>{invoice.status || 'Pending'}</span>
                        </div>
                    </div>
                    <FiX size={24} onClick={onClose} style={{ cursor: 'pointer' }} />
                </div>

                <div style={{ padding: '20px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '24px' }}>
                        <div style={{ fontSize: '14px', color: '#666' }}>Amount Due</div>
                        <div style={{ fontSize: '20px', fontWeight: 'bold', color: '#dc2626' }}>
                            ₹ {(invoice.totals?.total || invoice.total || 0).toFixed(2)}
                        </div>
                    </div>

                    <div style={{ display: 'flex', gap: '16px' }}>
                        <button
                            onClick={() => onRecordPayment(invoice)}
                            style={{
                                flex: 1,
                                padding: '12px',
                                borderRadius: '8px',
                                background: '#2563eb',
                                color: 'white',
                                border: 'none',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '8px',
                                fontWeight: 600
                            }}
                        >
                            <FiDollarSign /> Record Payment
                        </button>
                        <button
                            onClick={handleShare}
                            style={{
                                flex: 1,
                                padding: '12px',
                                borderRadius: '8px',
                                background: 'white',
                                color: '#2563eb',
                                border: '1px solid #2563eb',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '8px',
                                fontWeight: 600
                            }}
                        >
                            <FiShare2 /> Share Invoice
                        </button>
                    </div>
                </div>
            </div>
        </div>,
        document.body
    );
};
</file>

<file path="src/components/InvoiceForm.module.css">
.container {
    padding: 16px;
    padding-bottom: 120px;
    /* Space for fixed footer */
}

.card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.label {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 4px;
}

.value {
    font-size: 14px;
    font-weight: 500;
    color: #111827;
}

.sectionTitle {
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.addButton {
    width: 100%;
    padding: 12px;
    background: #eff6ff;
    border: 1px dashed #3b82f6;
    border-radius: 8px;
    color: #2563eb;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
}

.itemRow {
    border-bottom: 1px solid #f3f4f6;
    padding-bottom: 12px;
    margin-bottom: 12px;
}

.itemHeader {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.itemInputs {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    align-items: center;
}

.input {
    width: 100%;
    padding: 8px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 14px;
}

/* Optional Fields */
.optionalRow {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid #f3f4f6;
}

.optionalLabel {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #4b5563;
}

.optionalInput {
    border: none;
    text-align: right;
    font-size: 14px;
    outline: none;
    width: 120px;
}

/* Toggles */
.toggleRow {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.toggleRow:last-child {
    margin-bottom: 0;
}

.toggleLabel {
    font-size: 14px;
    font-weight: 600;
    color: #111827;
}

.toggleSwitch {
    width: 44px;
    height: 24px;
    background: #e5e7eb;
    border-radius: 12px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
}

.toggleSwitch.active {
    background: #2563eb;
}

.toggleKnob {
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    position: absolute;
    top: 2px;
    left: 2px;
    transition: transform 0.2s;
}

.toggleSwitch.active .toggleKnob {
    transform: translateX(20px);
}

/* Payments */
.checkboxRow {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
}

.paymentGrid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.inputWrapper {
    display: flex;
    align-items: center;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 0 8px;
}

.paymentInput {
    width: 100%;
    padding: 8px;
    border: none;
    outline: none;
}

.select {
    width: 100%;
    padding: 8px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: white;
}

/* Footer */
.footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #eff6ff;
    padding: 16px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 10;
}

.footerLeft {
    flex: 1;
}

.footerRow {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 4px;
}

.totalAmount {
    font-size: 16px;
    font-weight: 700;
    color: #111827;
    margin-top: 4px;
}

.createButton {
    background: #2563eb;
    color: white;
    border: none;
    padding: 10px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

/* Customer Selection Styles */
.selectedCustomer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.customerInfo {
    flex: 1;
}

.customerName {
    font-weight: 600;
    font-size: 16px;
    color: #111827;
}

.customerPhone {
    font-size: 13px;
    color: #6b7280;
}

.customerActions {
    display: flex;
    gap: 12px;
}

.actionButton {
    background: none;
    border: none;
    color: #2563eb;
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    padding: 4px 8px;
}
</file>

<file path="src/components/TransactionCard.js">
import React from 'react';
import { motion } from 'framer-motion';
import { ANIMATIONS } from '@/lib/animations';

export const TransactionCard = ({ transaction, onClick }) => {
    const isCredit = transaction.type === 'credit' || transaction.type === 'payment';
    const amount = parseFloat(transaction.amount || 0);

    return (
        <motion.div
            layout
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            whileTap={{ scale: 0.98 }}
            transition={{ duration: ANIMATIONS.duration.fast }}
            onClick={onClick}
            style={{
                background: 'white',
                padding: '16px',
                borderBottom: '1px solid #f3f4f6',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                cursor: 'pointer'
            }}
        >
            <div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                    <span style={{
                        fontSize: '12px',
                        color: '#6b7280',
                        background: '#f3f4f6',
                        padding: '2px 6px',
                        borderRadius: '4px'
                    }}>
                        {transaction.type?.toUpperCase() || 'TRANSACTION'}
                    </span>
                    {transaction.status === 'pending' && (
                        <span style={{ fontSize: '12px', color: '#dc2626' }}>• Pending</span>
                    )}
                </div>
                <div style={{ fontWeight: 600, fontSize: '14px' }}>
                    {transaction.number || 'REF-NA'}
                </div>
                <div style={{ fontSize: '12px', color: '#9ca3af' }}>
                    {new Date(transaction.date).toLocaleDateString()}
                </div>
            </div>

            <div style={{ textAlign: 'right' }}>
                <div style={{
                    fontSize: '14px',
                    color: isCredit ? '#16a34a' : '#dc2626',
                    fontWeight: 500
                }}>
                    {isCredit ? '+' : '-'} ₹ {amount.toFixed(2)}
                </div>
                <div style={{ fontSize: '12px', color: '#111827', fontWeight: 600, marginTop: '4px' }}>
                    ₹ {transaction.balance?.toFixed(2) || '0.00'}
                </div>
            </div>
        </motion.div>
    );
};
</file>

<file path="src/lib/logger/storage/capacitorFs.ts">
import { LogEntry } from '../types';
import { LogStorage, LogQueryOptions, LogQueryResult } from './index';
import { STORAGE_CONFIG } from '../config';

/**
 * JSONL Chunked Storage for Capacitor (Android/iOS)
 * 
 * Uses JSONL (newline-delimited JSON) format for efficient append-only writes.
 * Logs are stored in chunks (logs_0001.jsonl, logs_0002.jsonl, etc.)
 * Each chunk targets ~500KB, with a 5MB total cap (10 chunks max).
 * FIFO eviction removes oldest chunks when limit is reached.
 */

const CHUNK_SIZE_BYTES = 500 * 1024; // 500KB per chunk
const MAX_CHUNKS = 10; // 5MB total

export class CapacitorStorage implements LogStorage {
    private isReady = false;
    private queuedWrites: LogEntry[] = [];
    private isWriting = false;
    private currentLogChunk = 0;
    private currentAuditChunk = 0;

    async init(): Promise<void> {
        try {
            const { Filesystem, Directory } = await import('@capacitor/filesystem');

            // Ensure logs directory exists
            try {
                await Filesystem.mkdir({
                    path: STORAGE_CONFIG.DIR_LOGS,
                    directory: Directory.Documents,
                    recursive: true
                });
            } catch {
                // Directory may already exist
            }

            // Find current chunk numbers
            this.currentLogChunk = await this.findLatestChunk('logs');
            this.currentAuditChunk = await this.findLatestChunk('audit');

            this.isReady = true;
            this.processQueue();
        } catch (e) {
            console.error('Failed to init Capacitor Storage', e);
        }
    }

    private async findLatestChunk(type: 'logs' | 'audit'): Promise<number> {
        const { Filesystem, Directory } = await import('@capacitor/filesystem');
        const prefix = type === 'audit' ? 'audit' : 'logs';

        try {
            const result = await Filesystem.readdir({
                path: STORAGE_CONFIG.DIR_LOGS,
                directory: Directory.Documents
            });

            const chunkNums = result.files
                .filter(f => f.name.startsWith(prefix) && f.name.endsWith('.jsonl'))
                .map(f => {
                    const match = f.name.match(/_(\d+)\.jsonl$/);
                    return match ? parseInt(match[1], 10) : 0;
                })
                .filter(n => !isNaN(n));

            return chunkNums.length > 0 ? Math.max(...chunkNums) : 1;
        } catch {
            return 1;
        }
    }

    private getChunkPath(type: 'logs' | 'audit', chunkNum: number): string {
        const prefix = type === 'audit' ? 'audit' : 'logs';
        return `${STORAGE_CONFIG.DIR_LOGS}/${prefix}_${String(chunkNum).padStart(4, '0')}.jsonl`;
    }

    async write(entry: LogEntry): Promise<void> {
        this.queuedWrites.push(entry);
        if (!this.isWriting && this.isReady) {
            this.processQueue();
        }
    }

    private async processQueue() {
        if (this.queuedWrites.length === 0) {
            this.isWriting = false;
            return;
        }

        this.isWriting = true;
        const { Filesystem, Directory, Encoding } = await import('@capacitor/filesystem');

        try {
            const batch = [...this.queuedWrites];
            this.queuedWrites = [];

            const logs = batch.filter(e => e.level !== 'audit');
            const audits = batch.filter(e => e.level === 'audit');

            if (logs.length > 0) {
                await this.appendToChunk('logs', logs);
            }
            if (audits.length > 0) {
                await this.appendToChunk('audit', audits);
            }

        } catch (e) {
            console.error('Failed to write logs to FS', e);
        }

        this.isWriting = false;
        if (this.queuedWrites.length > 0) {
            this.processQueue();
        }
    }

    private async appendToChunk(type: 'logs' | 'audit', entries: LogEntry[]) {
        const { Filesystem, Directory, Encoding } = await import('@capacitor/filesystem');

        const currentChunk = type === 'audit' ? this.currentAuditChunk : this.currentLogChunk;
        const chunkPath = this.getChunkPath(type, currentChunk);

        // Convert entries to JSONL format
        const jsonlLines = entries.map(e => JSON.stringify(e)).join('\n') + '\n';

        try {
            // Check if current chunk exists and its size
            let currentSize = 0;
            try {
                const stat = await Filesystem.stat({
                    path: chunkPath,
                    directory: Directory.Documents
                });
                currentSize = stat.size || 0;
            } catch {
                // File doesn't exist yet
            }

            // If adding would exceed chunk size, rotate
            if (currentSize + jsonlLines.length > CHUNK_SIZE_BYTES) {
                const newChunkNum = currentChunk + 1;

                if (type === 'audit') {
                    this.currentAuditChunk = newChunkNum;
                } else {
                    this.currentLogChunk = newChunkNum;
                }

                // Write to new chunk
                const newPath = this.getChunkPath(type, newChunkNum);
                await Filesystem.writeFile({
                    path: newPath,
                    data: jsonlLines,
                    directory: Directory.Documents,
                    encoding: Encoding.UTF8
                });

                // Enforce max chunks (FIFO eviction)
                await this.enforceChunkLimit(type, newChunkNum);
            } else {
                // Append to current chunk
                await Filesystem.appendFile({
                    path: chunkPath,
                    data: jsonlLines,
                    directory: Directory.Documents,
                    encoding: Encoding.UTF8
                });
            }
        } catch (e) {
            console.error(`Error appending to ${chunkPath}`, e);
        }
    }

    private async enforceChunkLimit(type: 'logs' | 'audit', latestChunk: number) {
        const { Filesystem, Directory } = await import('@capacitor/filesystem');
        const oldestToKeep = latestChunk - MAX_CHUNKS + 1;

        if (oldestToKeep <= 0) return;

        // Delete chunks older than the limit
        for (let i = 1; i < oldestToKeep; i++) {
            try {
                await Filesystem.deleteFile({
                    path: this.getChunkPath(type, i),
                    directory: Directory.Documents
                });
            } catch {
                // Chunk may not exist
            }
        }
    }

    async readAll(type: 'logs' | 'audit'): Promise<LogEntry[]> {
        const { Filesystem, Directory, Encoding } = await import('@capacitor/filesystem');

        try {
            const entries: LogEntry[] = [];
            const latestChunk = type === 'audit' ? this.currentAuditChunk : this.currentLogChunk;
            const oldestChunk = Math.max(1, latestChunk - MAX_CHUNKS + 1);

            for (let i = oldestChunk; i <= latestChunk; i++) {
                try {
                    const contents = await Filesystem.readFile({
                        path: this.getChunkPath(type, i),
                        directory: Directory.Documents,
                        encoding: Encoding.UTF8
                    });

                    if (typeof contents.data === 'string') {
                        const lines = contents.data.split('\n').filter(line => line.trim());
                        for (const line of lines) {
                            try {
                                entries.push(JSON.parse(line));
                            } catch {
                                // Skip malformed lines
                            }
                        }
                    }
                } catch {
                    // Chunk may not exist
                }
            }

            return entries;
        } catch {
            return [];
        }
    }

    async query(options: LogQueryOptions): Promise<LogQueryResult> {
        const { levels, event, startTime, endTime, sessionId, correlationId, limit = 50, offset = 0 } = options;

        try {
            // Read all entries from both logs and audit
            const [logs, audits] = await Promise.all([
                this.readAll('logs'),
                this.readAll('audit')
            ]);

            // Merge and filter
            const allEntries = [...logs, ...audits].filter(entry => {
                if (levels && levels.length > 0 && !levels.includes(entry.level)) {
                    return false;
                }
                if (event && !entry.event.toLowerCase().includes(event.toLowerCase())) {
                    return false;
                }
                if (startTime && entry.timestamp < startTime) {
                    return false;
                }
                if (endTime && entry.timestamp > endTime) {
                    return false;
                }
                if (sessionId && entry.sessionId !== sessionId) {
                    return false;
                }
                if (correlationId && (entry.context as Record<string, unknown>)?.correlationId !== correlationId) {
                    return false;
                }
                return true;
            });

            // Sort by timestamp descending (reverse-chronological)
            allEntries.sort((a, b) => b.timestamp.localeCompare(a.timestamp));

            const total = allEntries.length;
            const paginatedEntries = allEntries.slice(offset, offset + limit);
            const hasMore = offset + limit < total;

            return { entries: paginatedEntries, total, hasMore };
        } catch (error) {
            console.error('Query failed:', error);
            return { entries: [], total: 0, hasMore: false };
        }
    }

    async clear(type: 'logs' | 'audit'): Promise<void> {
        const { Filesystem, Directory } = await import('@capacitor/filesystem');
        const latestChunk = type === 'audit' ? this.currentAuditChunk : this.currentLogChunk;

        for (let i = 1; i <= latestChunk; i++) {
            try {
                await Filesystem.deleteFile({
                    path: this.getChunkPath(type, i),
                    directory: Directory.Documents
                });
            } catch {
                // Chunk may not exist
            }
        }

        // Reset chunk counter
        if (type === 'audit') {
            this.currentAuditChunk = 1;
        } else {
            this.currentLogChunk = 1;
        }
    }

    async getSize(): Promise<number> {
        const { Filesystem, Directory } = await import('@capacitor/filesystem');
        let totalSize = 0;

        try {
            const result = await Filesystem.readdir({
                path: STORAGE_CONFIG.DIR_LOGS,
                directory: Directory.Documents
            });

            for (const file of result.files) {
                if (file.name.endsWith('.jsonl')) {
                    totalSize += file.size || 0;
                }
            }
        } catch {
            // Directory may not exist
        }

        return totalSize;
    }
}
</file>

<file path="src/lib/logger/storage/index.ts">
import { LogEntry, LogLevel } from '../types';

/**
 * Query options for filtering logs
 */
export interface LogQueryOptions {
    levels?: LogLevel[];
    event?: string;
    startTime?: string; // ISO 8601
    endTime?: string;   // ISO 8601
    sessionId?: string;
    correlationId?: string;
    limit?: number;
    offset?: number;
}

/**
 * Query result with pagination info
 */
export interface LogQueryResult {
    entries: LogEntry[];
    total: number;
    hasMore: boolean;
}

export interface LogStorage {
    /**
     * Initialize the storage
     */
    init(): Promise<void>;

    /**
     * Write a log entry
     */
    write(entry: LogEntry): Promise<void>;

    /**
     * Read all logs
     */
    readAll(type: 'logs' | 'audit'): Promise<LogEntry[]>;

    /**
     * Query logs with filtering and pagination
     */
    query(options: LogQueryOptions): Promise<LogQueryResult>;

    /**
     * Clear logs
     */
    clear(type: 'logs' | 'audit'): Promise<void>;

    /**
     * Get total size in bytes
     */
    getSize(): Promise<number>;
}
</file>

<file path="src/lib/logger/storage/indexedDb.ts">
import { LogEntry, LogLevel } from '../types';
import { LogStorage, LogQueryOptions, LogQueryResult } from './index';
import { STORAGE_CONFIG } from '../config';

const DB_VERSION = 1;

export class IndexedDbStorage implements LogStorage {
    private db: IDBDatabase | null = null;
    private isReady = false;

    async init(): Promise<void> {
        if (typeof window === 'undefined' || !window.indexedDB) {
            console.warn('IndexedDB not supported');
            return;
        }

        return new Promise((resolve, reject) => {
            const request = window.indexedDB.open(STORAGE_CONFIG.DB_NAME, DB_VERSION);

            request.onerror = () => {
                console.error('Failed to open log DB');
                reject(request.error);
            };

            request.onsuccess = () => {
                this.db = request.result;
                this.isReady = true;
                resolve();
            };

            request.onupgradeneeded = (event) => {
                const db = (event.target as IDBOpenDBRequest).result;

                // General logs store
                if (!db.objectStoreNames.contains(STORAGE_CONFIG.STORE_LOGS)) {
                    const store = db.createObjectStore(STORAGE_CONFIG.STORE_LOGS, { keyPath: 'timestamp' });
                    store.createIndex('level', 'level', { unique: false });
                }

                // Audit logs store
                if (!db.objectStoreNames.contains(STORAGE_CONFIG.STORE_AUDIT)) {
                    db.createObjectStore(STORAGE_CONFIG.STORE_AUDIT, { keyPath: 'timestamp' });
                }
            };
        });
    }

    async write(entry: LogEntry): Promise<void> {
        if (!this.isReady || !this.db) return;

        const storeName = entry.level === 'audit'
            ? STORAGE_CONFIG.STORE_AUDIT
            : STORAGE_CONFIG.STORE_LOGS;

        return new Promise((resolve, reject) => {
            const transaction = this.db!.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.add(entry);

            request.onsuccess = () => {
                // Trigger cleanup asynchronously
                this.enforceLimits(storeName);
                resolve();
            };

            request.onerror = () => reject(request.error);
        });
    }

    async readAll(type: 'logs' | 'audit'): Promise<LogEntry[]> {
        if (!this.isReady || !this.db) return [];

        const storeName = type === 'audit'
            ? STORAGE_CONFIG.STORE_AUDIT
            : STORAGE_CONFIG.STORE_LOGS;

        return new Promise((resolve, reject) => {
            const transaction = this.db!.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.getAll();

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async clear(type: 'logs' | 'audit'): Promise<void> {
        if (!this.isReady || !this.db) return;

        const storeName = type === 'audit'
            ? STORAGE_CONFIG.STORE_AUDIT
            : STORAGE_CONFIG.STORE_LOGS;

        return new Promise((resolve, reject) => {
            const transaction = this.db!.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.clear();

            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }

    async getSize(): Promise<number> {
        // Estimating size is expensive in IDB, implemented as approximation
        // For now, we rely on record count or assume strict count limit if needed
        // But since req is bytes, we'd need to iterate cursor and sum up stringified JSON
        if (!this.isReady || !this.db) return 0;

        // Quick approximation: assuming roughly 500 bytes per log
        // Better implementation would be to track size in metadata
        return 0;
    }

    async query(options: LogQueryOptions): Promise<LogQueryResult> {
        if (!this.isReady || !this.db) {
            return { entries: [], total: 0, hasMore: false };
        }

        const { levels, event, startTime, endTime, sessionId, correlationId, limit = 50, offset = 0 } = options;

        // Read from both stores and merge
        const allEntries: LogEntry[] = [];

        const readStore = (storeName: string): Promise<LogEntry[]> => {
            return new Promise((resolve, reject) => {
                const transaction = this.db!.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const entries: LogEntry[] = [];

                // Use cursor with 'prev' direction for reverse-chronological order
                const cursorRequest = store.openCursor(null, 'prev');

                cursorRequest.onsuccess = (e) => {
                    const cursor = (e.target as IDBRequest<IDBCursorWithValue | null>).result;
                    if (cursor) {
                        const entry = cursor.value as LogEntry;

                        // Apply filters
                        let include = true;

                        if (levels && levels.length > 0 && !levels.includes(entry.level)) {
                            include = false;
                        }
                        if (event && !entry.event.toLowerCase().includes(event.toLowerCase())) {
                            include = false;
                        }
                        if (startTime && entry.timestamp < startTime) {
                            include = false;
                        }
                        if (endTime && entry.timestamp > endTime) {
                            include = false;
                        }
                        if (sessionId && entry.sessionId !== sessionId) {
                            include = false;
                        }
                        if (correlationId && (entry.context as Record<string, unknown>)?.correlationId !== correlationId) {
                            include = false;
                        }

                        if (include) {
                            entries.push(entry);
                        }

                        cursor.continue();
                    } else {
                        resolve(entries);
                    }
                };

                cursorRequest.onerror = () => reject(cursorRequest.error);
            });
        };

        try {
            const [logs, audits] = await Promise.all([
                readStore(STORAGE_CONFIG.STORE_LOGS),
                readStore(STORAGE_CONFIG.STORE_AUDIT)
            ]);

            // Merge and sort by timestamp (descending)
            allEntries.push(...logs, ...audits);
            allEntries.sort((a, b) => b.timestamp.localeCompare(a.timestamp));

            const total = allEntries.length;
            const paginatedEntries = allEntries.slice(offset, offset + limit);
            const hasMore = offset + limit < total;

            return { entries: paginatedEntries, total, hasMore };
        } catch (error) {
            console.error('Query failed:', error);
            return { entries: [], total: 0, hasMore: false };
        }
    }

    // FIFO Eviction
    private async enforceLimits(storeName: string): Promise<void> {
        // Lightweight size check - simplified for performance
        // Instead of bytes, we'll limit by count for now as proxy (e.g., 5000 logs)
        // Real byte checking requires reading everything which kills perf on write

        const MAX_COUNT = storeName === STORAGE_CONFIG.STORE_AUDIT ? 10000 : 5000;

        return new Promise((resolve) => {
            const transaction = this.db!.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const countRequest = store.count();

            countRequest.onsuccess = () => {
                if (countRequest.result > MAX_COUNT) {
                    // Delete oldest
                    // Cursor default direction is 'next' (ascending keys/timestamps), so first is oldest
                    const deleteCount = countRequest.result - MAX_COUNT;
                    let deleted = 0;

                    const cursorRequest = store.openCursor();

                    cursorRequest.onsuccess = (e) => {
                        const cursor = (e.target as IDBRequest).result;
                        if (cursor && deleted < deleteCount) {
                            cursor.delete();
                            deleted++;
                            cursor.continue();
                        }
                    };
                }
                resolve();
            };
        });
    }
}
</file>

<file path="src/lib/logger/export.ts">
import { logger } from './logger';
import { getDevice, getAppVersion, SESSION_ID } from './context';
import { redactLogs } from './redact';
import { LogEntry } from './types';

/**
 * Export options for log data
 */
export interface ExportOptions {
    /** Include audit logs (default: true, requires explicit false to exclude) */
    includeAudit?: boolean;
    /** Apply PII redaction (default: true) */
    applyRedaction?: boolean;
    /** Format: 'json' for pretty JSON, 'jsonl' for newline-delimited */
    format?: 'json' | 'jsonl';
}

/**
 * Export metadata included with logs
 */
export interface ExportMetadata {
    exportTimestamp: string;
    appVersion: string;
    buildType: string;
    device: string;
    sessionId: string;
    logCount: number;
    auditLogCount: number;
}

// Dynamic import strategy for storage reading
const getStorageReader = async () => {
    const device = getDevice();
    let storage;

    if (device !== 'web') {
        const { CapacitorStorage } = await import('./storage/capacitorFs');
        storage = new CapacitorStorage();
    } else {
        const { IndexedDbStorage } = await import('./storage/indexedDb');
        storage = new IndexedDbStorage();
    }

    // We need to init to ensure DB/Files are accessible
    await storage.init();
    return storage;
};

/**
 * Export logs with metadata and optional redaction
 */
export const exportLogs = async (options: ExportOptions = {}): Promise<Blob> => {
    const { includeAudit = true, applyRedaction = true, format = 'json' } = options;

    try {
        const storage = await getStorageReader();
        let logs = await storage.readAll('logs');
        let audits: LogEntry[] = [];

        if (includeAudit) {
            audits = await storage.readAll('audit');
        }

        // Apply redaction if enabled
        if (applyRedaction) {
            logs = redactLogs(logs);
            audits = redactLogs(audits);
        }

        const metadata: ExportMetadata = {
            exportTimestamp: new Date().toISOString(),
            appVersion: getAppVersion(),
            buildType: process.env.NODE_ENV || 'unknown',
            device: getDevice(),
            sessionId: SESSION_ID,
            logCount: logs.length,
            auditLogCount: audits.length,
        };

        if (format === 'jsonl') {
            // JSONL format: metadata on first line, then logs
            const lines = [
                JSON.stringify({ _metadata: metadata }),
                ...logs.map(log => JSON.stringify(log)),
                ...audits.map(audit => JSON.stringify(audit)),
            ];
            return new Blob([lines.join('\n')], { type: 'application/x-ndjson' });
        }

        // Standard JSON format
        const exportData = {
            metadata,
            logs,
            auditLogs: audits,
        };

        const jsonString = JSON.stringify(exportData, null, 2);
        return new Blob([jsonString], { type: 'application/json' });

    } catch (error) {
        logger.error('LOG_EXPORT_FAILED', { error: (error as Error).message });
        throw error;
    }
};

/**
 * Trigger download in browser
 */
export const triggerLogDownload = async (options: ExportOptions = {}): Promise<boolean> => {
    try {
        const blob = await exportLogs(options);
        const ext = options.format === 'jsonl' ? 'jsonl' : 'json';
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `swipe-diagnostics-${new Date().toISOString()}.${ext}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        return true;
    } catch (e) {
        console.error('Failed to export logs', e);
        return false;
    }
};

/**
 * Share logs via native share sheet (Android/iOS)
 */
export const shareLogsNative = async (options: ExportOptions = {}): Promise<boolean> => {
    try {
        const blob = await exportLogs(options);
        const ext = options.format === 'jsonl' ? 'jsonl' : 'json';
        const filename = `swipe-diagnostics-${new Date().toISOString()}.${ext}`;

        // Convert blob to base64 for Capacitor
        const reader = new FileReader();
        const base64Data = await new Promise<string>((resolve, reject) => {
            reader.onloadend = () => {
                const result = reader.result as string;
                resolve(result.split(',')[1]);
            };
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });

        const { Filesystem, Directory, Encoding } = await import('@capacitor/filesystem');

        // Write file to cache
        const result = await Filesystem.writeFile({
            path: filename,
            data: base64Data,
            directory: Directory.Cache,
        });

        // Share the file
        const { Share } = await import('@capacitor/share');
        await Share.share({
            title: 'Swipe Diagnostics',
            text: 'Diagnostic logs from Swipe app',
            files: [result.uri],
            dialogTitle: 'Share Diagnostics',
        });

        return true;
    } catch (e) {
        console.error('Failed to share logs', e);
        return false;
    }
};

/**
 * Platform-aware export: download on web, share on native
 */
export const exportOrShareLogs = async (options: ExportOptions = {}): Promise<boolean> => {
    const device = getDevice();

    if (device === 'web') {
        return triggerLogDownload(options);
    } else {
        return shareLogsNative(options);
    }
};
</file>

<file path="src/lib/logger/index.ts">
export * from './types';
export * from './events';
export * from './logger';
export * from './export';
export * from './redact';
export { LogQueryOptions, LogQueryResult } from './storage';
</file>

<file path="src/lib/services/bulkUploadService.js">
import Papa from 'papaparse';
import { api } from '@/api/backendClient';
import { useProductStore } from '@/lib/store/productStore';
import { useMasterStore } from '@/lib/store/masterStore';
import { logger, LOG_EVENTS } from '@/lib/logger';

export const BulkUploadService = {
    // 1. Download Template
    downloadTemplate: () => {
        const headers = [
            'product_name', 'product_code', 'category', 'sub_category',
            'gross_weight', 'net_weight', 'purity', 'metal_type',
            'making_charge_per_gram', 'rate_per_gram', 'description',
            'stock_qty', 'stone_weight', 'size', 'hsn_code', 'selling_price', 'purchase_price'
        ];

        const csvContent = headers.join(',');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'product_bulk_upload_template.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    },

    // 2. Download All Products
    downloadAllProducts: async () => {
        try {
            // Fetch products from backend API
            const products = await api.products.list();
            if (products.length === 0) {
                alert("No products to download.");
                return;
            }

            const headers = [
                'sku', 'name', 'category', 'subCategory', 'grossWeight', 'netWeight',
                'purity', 'metalType', 'makingCharge', 'sellingPrice', 'description',
                'stock', 'stoneWeight', 'size', 'hsn', 'purchasePrice'
            ];

            const csvData = products.map(p => ({
                sku: p.sku || '',
                name: p.name || '',
                category: p.category || '',
                subCategory: p.subCategory || '',
                grossWeight: p.grossWeight || 0,
                netWeight: p.netWeight || 0,
                purity: p.purity || '',
                metalType: p.type || '',
                makingCharge: p.makingCharges || 0,
                sellingPrice: p.sellingPrice || 0,
                description: p.description || '',
                stock: p.stock || 0,
                stoneWeight: p.stoneWeight || 0,
                size: p.size || '',
                hsn: p.hsn || '',
                purchasePrice: p.purchasePrice || 0
            }));

            const csvContent = [
                headers.join(','),
                ...csvData.map(row => headers.map(fieldName => {
                    const value = row[fieldName];
                    return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                }).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'all_products.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            logger.info(LOG_EVENTS.INVOICE_DOWNLOADED, { type: 'all_products_csv' });
        } catch (error) {
            logger.error(LOG_EVENTS.INVOICE_DOWNLOAD_FAILED, { type: 'all_products_csv', error: error.message });
            throw error;
        }
    },

    // 3. Validate File
    validateFile: (file) => {
        return new Promise((resolve) => {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: async (results) => {
                    const rows = results.data;
                    const errors = [];
                    const validRows = [];

                    // Fetch existing categories/subcategories via API
                    let categories = [];
                    let subCategories = [];
                    try {
                        categories = await api.categories.list();
                        // Extract subcategories from nested response
                        categories.forEach(cat => {
                            if (cat.subcategories) {
                                subCategories.push(...cat.subcategories);
                            }
                        });
                    } catch (err) {
                        logger.error(LOG_EVENTS.STORE_LOAD_ERROR, { type: 'categories', error: err.message });
                    }

                    const categoryNames = new Set(categories.map(c => c.name.toLowerCase()));
                    const subCategoryNames = new Set(subCategories.map(s => s.name.toLowerCase()));

                    rows.forEach((row, index) => {
                        const rowNum = index + 2; // +1 for 0-index, +1 for header
                        const rowErrors = [];

                        // Mandatory Fields
                        if (!row.product_name) rowErrors.push(`Row ${rowNum}: product_name is required.`);
                        if (!row.category) rowErrors.push(`Row ${rowNum}: category is required.`);

                        // Category Validation
                        if (row.category && !categoryNames.has(row.category.toLowerCase().trim())) {
                            rowErrors.push(`Row ${rowNum}: Category '${row.category}' not found.`);
                        }

                        // SubCategory Validation
                        if (row.sub_category && !subCategoryNames.has(row.sub_category.toLowerCase().trim())) {
                            rowErrors.push(`Row ${rowNum}: SubCategory '${row.sub_category}' not found.`);
                        }

                        // Numeric Validations
                        if (row.gross_weight && isNaN(parseFloat(row.gross_weight))) {
                            rowErrors.push(`Row ${rowNum}: gross_weight must be numeric.`);
                        }
                        if (row.net_weight && isNaN(parseFloat(row.net_weight))) {
                            rowErrors.push(`Row ${rowNum}: net_weight must be numeric.`);
                        }
                        if (row.selling_price && isNaN(parseFloat(row.selling_price))) {
                            rowErrors.push(`Row ${rowNum}: selling_price must be numeric.`);
                        }

                        if (rowErrors.length > 0) {
                            errors.push(...rowErrors);
                        } else {
                            validRows.push(row);
                        }
                    });

                    resolve({
                        valid: errors.length === 0,
                        errors,
                        data: validRows,
                        totalReceived: rows.length
                    });
                },
                error: (err) => {
                    resolve({ valid: false, errors: [`CSV Parse Error: ${err.message}`], data: [] });
                }
            });
        });
    },

    // 4. Process File - Sequential POSTs with progress
    processFile: async (rows, userId = 'user', onProgress = null) => {
        let successCount = 0;
        let failureCount = 0;
        const failedRows = [];

        logger.info(LOG_EVENTS.BULK_UPLOAD_START, { count: rows.length });

        try {
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];

                // Report progress
                if (onProgress) {
                    onProgress({
                        current: i + 1,
                        total: rows.length,
                        percent: Math.round(((i + 1) / rows.length) * 100)
                    });
                }

                try {
                    // SKU is now generated by backend
                    const productData = {
                        name: row.product_name,
                        sku: row.product_code || undefined, // Let backend generate if not provided
                        category: row.category,
                        subCategory: row.sub_category,
                        grossWeight: parseFloat(row.gross_weight) || 0,
                        netWeight: parseFloat(row.net_weight) || 0,
                        purity: row.purity,
                        type: row.metal_type,
                        makingCharges: parseFloat(row.making_charge_per_gram) || 0,
                        ratePerGram: parseFloat(row.rate_per_gram) || 0,
                        description: row.description,
                        stock: parseFloat(row.stock_qty) || 1,
                        stoneWeight: parseFloat(row.stone_weight) || 0,
                        size: row.size,
                        hsn: row.hsn_code,
                        sellingPrice: parseFloat(row.selling_price) || 0,
                        purchasePrice: parseFloat(row.purchase_price) || 0,
                        images: []
                    };

                    // Check if product exists by SKU to update
                    if (row.product_code) {
                        const existingProducts = await api.products.list({ sku: row.product_code });
                        if (existingProducts.length > 0) {
                            await api.products.update(existingProducts[0].id, productData);
                            successCount++;
                            continue;
                        }
                    }

                    // Create new product
                    await api.products.create(productData);
                    successCount++;
                } catch (err) {
                    logger.error(LOG_EVENTS.BULK_UPLOAD_ROW_ERROR, { row: i + 1, error: err.message });
                    failureCount++;
                    failedRows.push({ row, error: err.message });
                }
            }

            // Audit
            logger.audit(LOG_EVENTS.BULK_UPLOAD_SUCCESS, {
                total: rows.length,
                success: successCount,
                failed: failureCount
            });

            // Log entry via API (if audit logs endpoint exists)
            try {
                await api.auditLogs.create({
                    entityType: 'bulk_upload',
                    action: 'PRODUCTS_UPLOAD',
                    details: `Total: ${rows.length}, Success: ${successCount}, Failed: ${failureCount}`
                });
            } catch (e) {
                logger.warn(LOG_EVENTS.AUDIT_LOG_FAILED, { error: e.message });
            }

            return { success: true, successCount, failureCount, failedRows };

        } catch (error) {
            logger.error(LOG_EVENTS.BULK_UPLOAD_FAILED, { error: error.message });
            return { success: false, error: error.message };
        }
    }
};
</file>

<file path="src/lib/store/__tests__/invoiceStore.test.js">
/**
 * @jest-environment jsdom
 */

// Mock the API client
jest.mock('@/api/backendClient', () => ({
    api: {
        invoices: {
            list: jest.fn(),
            create: jest.fn(),
            update: jest.fn(),
            delete: jest.fn(),
            get: jest.fn(),
        },
    },
}));

import { useInvoiceStore } from '../invoiceStore';
import { api } from '@/api/backendClient';

describe('invoiceStore', () => {
    beforeEach(() => {
        // Reset to default state
        useInvoiceStore.getState().resetInvoice();
        jest.clearAllMocks();
    });

    describe('calculateTotals', () => {
        describe('with jewellery items', () => {
            it('should calculate item total from weight and rate', () => {
                useInvoiceStore.setState({
                    items: [{
                        id: 1,
                        productId: 100,
                        netWeight: 10, // 10 grams
                        ratePerGram: 5000, // ₹5000 per gram
                        makingChargePerGram: 500, // ₹500 per gram
                        quantity: 1,
                    }],
                    type: 'INVOICE',
                    roundOff: false,
                    details: { extraDiscount: 0, shippingCharges: 0, packagingCharges: 0 },
                });

                const { calculateTotals } = useInvoiceStore.getState();
                const totals = calculateTotals();

                // Material Value = 10 * 5000 = 50000
                // Making Charge = 10 * 500 = 5000
                // Subtotal = 55000
                expect(totals.subtotal).toBe(55000);

                // Tax = 1.5% CGST + 1.5% SGST = 3% = 1650
                expect(totals.cgst).toBe(825);
                expect(totals.sgst).toBe(825);
                expect(totals.totalTax).toBe(1650);

                // Total = 55000 + 1650 = 56650
                expect(totals.total).toBe(56650);
            });

            it('should handle multiple items', () => {
                useInvoiceStore.setState({
                    items: [
                        {
                            id: 1,
                            productId: 100,
                            netWeight: 10,
                            ratePerGram: 5000,
                            makingChargePerGram: 500,
                            quantity: 1,
                        },
                        {
                            id: 2,
                            productId: 101,
                            netWeight: 5,
                            ratePerGram: 6000,
                            makingChargePerGram: 600,
                            quantity: 1,
                        },
                    ],
                    type: 'INVOICE',
                    roundOff: false,
                    details: { extraDiscount: 0, shippingCharges: 0, packagingCharges: 0 },
                });

                const totals = useInvoiceStore.getState().calculateTotals();

                // Item 1: 10 * (5000 + 500) = 55000
                // Item 2: 5 * (6000 + 600) = 33000
                // Subtotal = 88000
                expect(totals.subtotal).toBe(88000);
            });

            it('should multiply by quantity', () => {
                useInvoiceStore.setState({
                    items: [{
                        id: 1,
                        productId: 100,
                        netWeight: 10,
                        ratePerGram: 1000,
                        makingChargePerGram: 100,
                        quantity: 2,
                    }],
                    type: 'INVOICE',
                    roundOff: false,
                    details: { extraDiscount: 0, shippingCharges: 0, packagingCharges: 0 },
                });

                const totals = useInvoiceStore.getState().calculateTotals();

                // Per piece: 10 * (1000 + 100) = 11000
                // x2 quantity = 22000
                expect(totals.subtotal).toBe(22000);
            });
        });

        describe('with extra charges and discounts', () => {
            it('should add shipping and packaging charges', () => {
                useInvoiceStore.setState({
                    items: [{
                        id: 1,
                        productId: 100,
                        netWeight: 10,
                        ratePerGram: 1000,
                        makingChargePerGram: 0,
                        quantity: 1,
                    }],
                    type: 'INVOICE',
                    roundOff: false,
                    details: {
                        extraDiscount: 0,
                        shippingCharges: 500,
                        packagingCharges: 200,
                    },
                });

                const totals = useInvoiceStore.getState().calculateTotals();

                // Subtotal = 10000
                // Tax = 300
                // + Shipping 500 + Packaging 200 = 11000
                expect(totals.total).toBe(10000 + 300 + 500 + 200);
            });

            it('should subtract extra discount', () => {
                useInvoiceStore.setState({
                    items: [{
                        id: 1,
                        productId: 100,
                        netWeight: 10,
                        ratePerGram: 1000,
                        makingChargePerGram: 0,
                        quantity: 1,
                    }],
                    type: 'INVOICE',
                    roundOff: false,
                    details: {
                        extraDiscount: 1000,
                        shippingCharges: 0,
                        packagingCharges: 0,
                    },
                });

                const totals = useInvoiceStore.getState().calculateTotals();

                // Subtotal = 10000, Tax = 300, Discount = -1000
                expect(totals.total).toBe(10000 + 300 - 1000);
            });
        });

        describe('round off', () => {
            it('should round total when roundOff is enabled', () => {
                useInvoiceStore.setState({
                    items: [{
                        id: 1,
                        productId: 100,
                        netWeight: 1,
                        ratePerGram: 1000,
                        makingChargePerGram: 0,
                        quantity: 1,
                    }],
                    type: 'INVOICE',
                    roundOff: true,
                    details: { extraDiscount: 0, shippingCharges: 0, packagingCharges: 0 },
                });

                const totals = useInvoiceStore.getState().calculateTotals();

                // Subtotal = 1000, Tax = 30, Total = 1030 (already round)
                expect(totals.total).toBe(1030);
                expect(totals.roundOffAmount).toBe(0);
            });

            it('should calculate round off amount correctly', () => {
                useInvoiceStore.setState({
                    items: [{
                        id: 1,
                        productId: 100,
                        netWeight: 1,
                        ratePerGram: 1001,
                        makingChargePerGram: 0,
                        quantity: 1,
                    }],
                    type: 'INVOICE',
                    roundOff: true,
                    details: { extraDiscount: 0, shippingCharges: 0, packagingCharges: 0 },
                });

                const totals = useInvoiceStore.getState().calculateTotals();

                // Subtotal = 1001, Tax = 30.03, Raw Total = 1031.03
                // Rounded = 1031, roundOffAmount = -0.03
                expect(totals.total).toBe(1031);
                expect(totals.roundOffAmount).toBeCloseTo(-0.03, 2);
            });
        });

        describe('invoice types', () => {
            it('should return zero totals for LENDING type', () => {
                useInvoiceStore.setState({
                    items: [{
                        id: 1,
                        productId: 100,
                        netWeight: 10,
                        ratePerGram: 5000,
                        makingChargePerGram: 500,
                        quantity: 1,
                    }],
                    type: 'LENDING',
                    roundOff: false,
                    details: { extraDiscount: 0, shippingCharges: 0, packagingCharges: 0 },
                });

                const totals = useInvoiceStore.getState().calculateTotals();

                expect(totals.subtotal).toBe(0);
                expect(totals.totalTax).toBe(0);
                expect(totals.total).toBe(0);
                expect(totals.cgst).toBe(0);
                expect(totals.sgst).toBe(0);
            });

            it('should skip tax for PROFORMA type', () => {
                useInvoiceStore.setState({
                    items: [{
                        id: 1,
                        productId: 100,
                        netWeight: 10,
                        ratePerGram: 1000,
                        makingChargePerGram: 0,
                        quantity: 1,
                    }],
                    type: 'PROFORMA',
                    roundOff: false,
                    details: { extraDiscount: 0, shippingCharges: 0, packagingCharges: 0 },
                });

                const totals = useInvoiceStore.getState().calculateTotals();

                expect(totals.subtotal).toBe(10000);
                expect(totals.totalTax).toBe(0);
                expect(totals.cgst).toBe(0);
                expect(totals.sgst).toBe(0);
                expect(totals.total).toBe(10000);
            });
        });

        describe('legacy items (without productId)', () => {
            it('should use rate * quantity for legacy items', () => {
                useInvoiceStore.setState({
                    items: [{
                        id: 1,
                        name: 'Manual Item',
                        rate: 500,
                        quantity: 3,
                        // No productId or netWeight
                    }],
                    type: 'INVOICE',
                    roundOff: false,
                    details: { extraDiscount: 0, shippingCharges: 0, packagingCharges: 0 },
                });

                const totals = useInvoiceStore.getState().calculateTotals();

                // rate * quantity = 500 * 3 = 1500
                expect(totals.subtotal).toBe(1500);
            });
        });
    });

    describe('item management', () => {
        it('should add empty item with addItem', () => {
            const { addItem } = useInvoiceStore.getState();
            addItem();

            const items = useInvoiceStore.getState().items;
            expect(items.length).toBe(1);
            expect(items[0]).toEqual(expect.objectContaining({
                name: '',
                rate: 0,
                quantity: 1,
            }));
        });

        it('should update item field with updateItem', () => {
            useInvoiceStore.setState({
                items: [{ id: 1, name: 'Test', quantity: 1 }],
            });

            const { updateItem } = useInvoiceStore.getState();
            updateItem(1, 'quantity', 5);

            expect(useInvoiceStore.getState().items[0].quantity).toBe(5);
        });

        it('should remove item with removeItem', () => {
            useInvoiceStore.setState({
                items: [
                    { id: 1, name: 'Item 1' },
                    { id: 2, name: 'Item 2' },
                ],
            });

            const { removeItem } = useInvoiceStore.getState();
            removeItem(1);

            const items = useInvoiceStore.getState().items;
            expect(items.length).toBe(1);
            expect(items[0].name).toBe('Item 2');
        });
    });

    describe('addOrUpdateItem', () => {
        it('should add new product to items', () => {
            const product = {
                id: 100,
                name: 'Gold Ring',
                subCategory: 'Ring',
                sellingPrice: 5000,
                makingCharges: 500,
                grossWeight: 12,
                netWeight: 10,
                hsn: '7113',
                purity: '22K',
            };

            const { addOrUpdateItem } = useInvoiceStore.getState();
            addOrUpdateItem(product, 1);

            const items = useInvoiceStore.getState().items;
            expect(items.length).toBe(1);
            expect(items[0]).toEqual(expect.objectContaining({
                productId: 100,
                name: 'Ring', // Uses subCategory
                ratePerGram: 5000,
                makingChargePerGram: 500,
                grossWeight: 12,
                netWeight: 10,
                hsn: '7113',
                purity: '22K',
                quantity: 1,
            }));
        });

        it('should increment quantity for existing product', () => {
            useInvoiceStore.setState({
                items: [{
                    id: 1,
                    productId: 100,
                    name: 'Ring',
                    quantity: 2,
                }],
            });

            const { addOrUpdateItem } = useInvoiceStore.getState();
            addOrUpdateItem({ id: 100 }, 1);

            expect(useInvoiceStore.getState().items[0].quantity).toBe(3);
        });

        it('should remove item when quantity goes to zero', () => {
            useInvoiceStore.setState({
                items: [{
                    id: 1,
                    productId: 100,
                    name: 'Ring',
                    quantity: 1,
                }],
            });

            const { addOrUpdateItem } = useInvoiceStore.getState();
            addOrUpdateItem({ id: 100 }, -1);

            expect(useInvoiceStore.getState().items.length).toBe(0);
        });
    });

    describe('resetInvoice', () => {
        it('should reset all fields to defaults', () => {
            useInvoiceStore.setState({
                customer: { id: 1, name: 'Test' },
                items: [{ id: 1 }],
                type: 'PROFORMA',
            });

            const { resetInvoice } = useInvoiceStore.getState();
            resetInvoice();

            const state = useInvoiceStore.getState();
            expect(state.customer).toBeNull();
            expect(state.items).toEqual([]);
            expect(state.type).toBe('INVOICE');
        });
    });

    describe('API operations', () => {
        it('should load invoices from API', async () => {
            const mockInvoices = [
                { id: 1, invoiceNumber: 'INV-001' },
                { id: 2, invoiceNumber: 'INV-002' },
            ];
            api.invoices.list.mockResolvedValue(mockInvoices);

            const { loadInvoices } = useInvoiceStore.getState();
            await loadInvoices();

            expect(api.invoices.list).toHaveBeenCalled();
            expect(useInvoiceStore.getState().invoices).toEqual([
                { id: 2, invoiceNumber: 'INV-002' },
                { id: 1, invoiceNumber: 'INV-001' },
            ]);
        });

        it('should get single invoice from API', async () => {
            const mockInvoice = { id: 1, invoiceNumber: 'INV-001' };
            api.invoices.get.mockResolvedValue(mockInvoice);

            const { getInvoice } = useInvoiceStore.getState();
            const result = await getInvoice(1);

            expect(api.invoices.get).toHaveBeenCalledWith(1);
            expect(result).toEqual(mockInvoice);
        });
    });
});
</file>

<file path="src/lib/store/expenseStore.js">
import { create } from 'zustand';
import { api } from '@/api/backendClient';
import { logger, LOG_EVENTS } from '@/lib/logger';

export const useExpenseStore = create((set, get) => ({
    expenses: [],
    categories: [
        'Karigar',
        'Miscellaneous',
        'Transportation & Travel Expense',
        'Telephone & Internet Bills',
        'Repair & Maintenance',
        'Rent Expense',
        'Raw Material',
        'Printing and Stationery',
        'Employee Salaries & Advances',
        'Electricity Bill',
        'Bank Fee and Charges',
    ],
    isLoading: false,
    error: null,

    loadExpenses: async () => {
        set({ isLoading: true, error: null });
        try {
            const expenses = await api.expenses.list();
            set({ expenses: expenses.reverse(), isLoading: false });
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_LOAD_ERROR, { store: 'expenses', error: error.message });
            set({ error: error.message, isLoading: false });
        }
    },

    addExpense: async (expense) => {
        set({ isLoading: true, error: null });
        try {
            const newExpense = await api.expenses.create(expense);
            set((state) => ({
                expenses: [newExpense, ...state.expenses],
                isLoading: false
            }));
            return newExpense.id;
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_SAVE_ERROR, { store: 'expense', error: error.message });
            set({ error: error.message, isLoading: false });
            throw error;
        }
    },

    updateExpense: async (id, updatedExpense) => {
        set({ isLoading: true, error: null });
        try {
            const result = await api.expenses.update(id, updatedExpense);
            set((state) => ({
                expenses: state.expenses.map((exp) =>
                    exp.id === id ? { ...exp, ...result } : exp
                ),
                isLoading: false
            }));
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_UPDATE_ERROR, { store: 'expense', id, error: error.message });
            set({ error: error.message, isLoading: false });
            throw error;
        }
    },

    deleteExpense: async (id) => {
        set({ isLoading: true, error: null });
        try {
            await api.expenses.delete(id);
            set((state) => ({
                expenses: state.expenses.filter((exp) => exp.id !== id),
                isLoading: false
            }));
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_DELETE_ERROR, { store: 'expense', id, error: error.message });
            set({ error: error.message, isLoading: false });
            throw error;
        }
    },

    // Categories are currently hardcoded
    // If backend supports dynamic categories, these would become API calls
    addCategory: (category) =>
        set((state) => ({
            categories: [...state.categories, category],
        })),

    updateCategory: (oldCategory, newCategory) =>
        set((state) => ({
            categories: state.categories.map((cat) =>
                cat === oldCategory ? newCategory : cat
            ),
            expenses: state.expenses.map((exp) =>
                exp.category === oldCategory ? { ...exp, category: newCategory } : exp
            ),
        })),

    deleteCategory: (category) =>
        set((state) => ({
            categories: state.categories.filter((cat) => cat !== category),
        })),

    clearError: () => set({ error: null }),
}));
</file>

<file path="src/lib/store/masterStore.js">
import { create } from 'zustand';
import { api } from '@/api/backendClient';
import { logger, LOG_EVENTS } from '@/lib/logger';

export const useMasterStore = create((set, get) => ({
    categories: [],
    subCategories: [],
    isLoading: false,
    error: null,

    // Categories
    loadCategories: async () => {
        set({ isLoading: true, error: null });
        try {
            const categories = await api.categories.list();

            // Backend returns categories with embedded subcategories
            // Extract subcategories into flat list for compatibility
            const allSubCategories = [];
            categories.forEach(cat => {
                if (cat.subcategories) {
                    cat.subcategories.forEach(sub => {
                        allSubCategories.push({
                            ...sub,
                            categoryId: cat.id
                        });
                    });
                }
            });

            set({ categories, subCategories: allSubCategories, isLoading: false });
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_LOAD_ERROR, { store: 'categories', error: error.message });
            set({ error: error.message, isLoading: false });
        }
    },

    addCategory: async (name, type = 'product_category') => {
        try {
            const newCategory = await api.categories.create({ name, type });
            set(state => ({ categories: [...state.categories, newCategory] }));
            return newCategory.id;
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_SAVE_ERROR, { store: 'category', error: error.message });
            throw error;
        }
    },

    updateCategory: async (id, updates) => {
        try {
            const updatedCategory = await api.categories.update(id, updates);
            set(state => ({
                categories: state.categories.map(c =>
                    c.id === id ? { ...c, ...updatedCategory } : c
                )
            }));
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_UPDATE_ERROR, { store: 'category', id, error: error.message });
            throw error;
        }
    },

    deleteCategory: async (id) => {
        try {
            // Backend cascades delete to subcategories
            await api.categories.delete(id);
            set(state => ({
                categories: state.categories.filter(c => c.id !== id),
                subCategories: state.subCategories.filter(sc => sc.categoryId !== id)
            }));
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_DELETE_ERROR, { store: 'category', id, error: error.message });
            throw error;
        }
    },

    // SubCategories
    loadSubCategories: async () => {
        // Subcategories are loaded with categories
        // This is a no-op for API compatibility
        await get().loadCategories();
    },

    addSubCategory: async (name, categoryId) => {
        try {
            const newSubCategory = await api.categories.addSubcategory(categoryId, { name });
            set(state => ({
                subCategories: [...state.subCategories, { ...newSubCategory, categoryId }]
            }));
            return newSubCategory.id;
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_SAVE_ERROR, { store: 'subcategory', error: error.message });
            throw error;
        }
    },

    updateSubCategory: async (id, updates) => {
        try {
            // Find the category this subcategory belongs to
            const subCategory = get().subCategories.find(sc => sc.id === id);
            if (!subCategory) throw new Error('Subcategory not found');

            // Note: API may need PUT endpoint for subcategories
            // For now, update local state optimistically
            set(state => ({
                subCategories: state.subCategories.map(sc =>
                    sc.id === id ? { ...sc, ...updates } : sc
                )
            }));
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_UPDATE_ERROR, { store: 'subcategory', id, error: error.message });
            throw error;
        }
    },

    deleteSubCategory: async (id) => {
        try {
            // Find the category this subcategory belongs to
            const subCategory = get().subCategories.find(sc => sc.id === id);
            if (!subCategory) throw new Error('Subcategory not found');

            await api.categories.deleteSubcategory(subCategory.categoryId, id);
            set(state => ({
                subCategories: state.subCategories.filter(sc => sc.id !== id)
            }));
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_DELETE_ERROR, { store: 'subcategory', id, error: error.message });
            throw error;
        }
    },

    getSubCategoriesByCategory: (categoryId) => {
        const state = get();
        return state.subCategories.filter(sc =>
            sc.categoryId === categoryId || sc.categoryId === parseInt(categoryId)
        );
    },

    clearError: () => set({ error: null }),
}));
</file>

<file path="capacitor.config.json">
{
    "appId": "com.swipe.app",
    "appName": "Swipe",
    "webDir": "out",
    "server": {
        "androidScheme": "https",
        "cleartext": true
    }
}
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.js`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Testing

This project includes a comprehensive testing setup with unit tests, component tests, and end-to-end tests.

### Running Unit & Component Tests

```bash
# Run all tests
pnpm test

# Run tests in watch mode (re-runs on file changes)
pnpm test:watch

# Run tests with coverage report
pnpm test:coverage
```

### Running End-to-End Tests (Cypress)

First, make sure the development server is running:

```bash
pnpm dev
```

Then in another terminal:

```bash
# Open Cypress interactive UI
pnpm cypress:open

# Run Cypress tests headlessly (for CI)
pnpm cypress:run
```

### Test Structure

```
/src
  /components/__tests__/    # Component tests (React Testing Library)
  /lib/utils/__tests__/     # Unit tests for utilities
/cypress
  /e2e/                     # End-to-end tests
  /support/                 # Cypress support files
```

### Writing New Tests

- **Unit Tests**: Place in `__tests__` folder next to the module being tested
- **Component Tests**: Use React Testing Library (RTL)
- **E2E Tests**: Add `.cy.js` files in `cypress/e2e/`

Follow TDD: **Red → Green → Refactor**

## Deploy on Vercel


The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="android/app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml">
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@color/ic_launcher_background" />
    <foreground>
        <inset android:drawable="@mipmap/ic_launcher_foreground" android:inset="16.7%" />
    </foreground>
</adaptive-icon>
</file>

<file path="android/app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml">
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@color/ic_launcher_background" />
    <foreground>
        <inset android:drawable="@mipmap/ic_launcher_foreground" android:inset="16.7%" />
    </foreground>
</adaptive-icon>
</file>

<file path="src/app/more/company/page.js">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useSettingsStore } from '@/lib/store/settingsStore';
import { FiArrowLeft, FiEdit2, FiPlus, FiChevronDown, FiChevronUp } from 'react-icons/fi';
import { ImagePicker } from '@/components/ImagePicker';
import { AddressBottomSheet } from '@/components/AddressBottomSheet';
import styles from './page.module.css';

export default function CompanyDetailsPage() {
    const router = useRouter();
    const { companyDetails, updateCompanyDetails, loadSettings } = useSettingsStore();

    const [isBillingSheetOpen, setIsBillingSheetOpen] = useState(false);
    const [isShippingSheetOpen, setIsShippingSheetOpen] = useState(false);
    const [isOptionalExpanded, setIsOptionalExpanded] = useState(false);
    const [isGSTEnabled, setIsGSTEnabled] = useState(false);

    useEffect(() => {
        loadSettings();
    }, []);

    useEffect(() => {
        if (companyDetails.gstin) {
            setIsGSTEnabled(true);
        }
    }, [companyDetails.gstin]);

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        if (name === 'phone' || name === 'alternatePhone') {
            const numericValue = value.replace(/\D/g, '').slice(0, 10);
            updateCompanyDetails({ [name]: numericValue });
        } else {
            updateCompanyDetails({ [name]: value });
        }
    };

    const handleImageSelect = (imageData) => {
        updateCompanyDetails({ logo: imageData });
    };

    const handleAddressSave = (type, addressData) => {
        if (type === 'billing') {
            updateCompanyDetails({ billingAddress: addressData });
        } else {
            updateCompanyDetails({ shippingAddress: addressData });
        }
    };

    return (
        <div className={styles.container}>
            {/* Header */}
            <div className={styles.header}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                    <FiArrowLeft size={24} onClick={() => router.back()} style={{ cursor: 'pointer' }} />
                    <div className={styles.headerTitle}>Company Details</div>
                </div>
                <button className={styles.editButton}>
                    <FiEdit2 size={14} /> Edit
                </button>
            </div>

            <div className={styles.content}>
                {/* Main Card */}
                <div className={styles.card}>
                    <div className={styles.logoContainer}>
                        <ImagePicker image={companyDetails.logo} onImageSelect={handleImageSelect} />
                    </div>

                    <div style={{ marginTop: '40px' }}>
                        <div className={styles.formGroup}>
                            <label className={styles.label}>Business/Company Name</label>
                            <input
                                name="name"
                                value={companyDetails.name || ''}
                                onChange={handleInputChange}
                                className={styles.input}
                                placeholder="Enter Business Name"
                            />
                        </div>

                        <div className={styles.formGroup}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                                <input
                                    type="checkbox"
                                    checked={isGSTEnabled}
                                    onChange={(e) => setIsGSTEnabled(e.target.checked)}
                                    style={{ width: 16, height: 16 }}
                                />
                                <label className={styles.label} style={{ margin: 0 }}>GST Number (Optional)</label>
                            </div>
                            {isGSTEnabled && (
                                <input
                                    name="gstin"
                                    value={companyDetails.gstin || ''}
                                    onChange={handleInputChange}
                                    className={styles.input}
                                    placeholder="Enter GSTIN"
                                />
                            )}
                            {!isGSTEnabled && <div className={styles.value}>NA</div>}
                        </div>

                        <div className={styles.formGroup}>
                            <label className={styles.label}>Business Phone No.</label>
                            <input
                                name="phone"
                                value={companyDetails.phone || ''}
                                onChange={handleInputChange}
                                className={styles.input}
                                placeholder="Enter Phone Number"
                            />
                        </div>

                        <div className={styles.formGroup}>
                            <label className={styles.label}>Business Email</label>
                            <input
                                name="email"
                                value={companyDetails.email || ''}
                                onChange={handleInputChange}
                                className={styles.input}
                                placeholder="Enter Email"
                            />
                        </div>

                        <div className={styles.formGroup}>
                            <label className={styles.label}>Trade/Brand Name</label>
                            <input
                                name="tradeName"
                                value={companyDetails.tradeName || companyDetails.name || ''}
                                onChange={handleInputChange}
                                className={styles.input}
                                placeholder="Enter Trade Name"
                            />
                        </div>
                    </div>
                </div>

                {/* Address Section */}
                <div>
                    <div style={{ fontWeight: 600, marginBottom: '12px' }}>Billing Address</div>
                    <button className={styles.addressButton} onClick={() => setIsBillingSheetOpen(true)}>
                        <div className={styles.iconCircle}><FiPlus size={16} /></div>
                        {companyDetails.billingAddress?.addressLine1 ? 'Edit Billing Address' : 'Billing Address'}
                    </button>
                    {companyDetails.billingAddress?.addressLine1 && (
                        <div style={{ marginTop: '8px', fontSize: '14px', color: '#666', paddingLeft: '12px' }}>
                            {companyDetails.billingAddress.addressLine1}, {companyDetails.billingAddress.city}
                        </div>
                    )}
                </div>

                <div>
                    <div style={{ fontWeight: 600, marginBottom: '12px' }}>Shipping Address</div>
                    <button className={styles.addressButton} onClick={() => setIsShippingSheetOpen(true)}>
                        <div className={styles.iconCircle}><FiPlus size={16} /></div>
                        {companyDetails.shippingAddress?.addressLine1 ? 'Edit Shipping Address' : 'Shipping Address'}
                    </button>
                    {companyDetails.shippingAddress?.addressLine1 && (
                        <div style={{ marginTop: '8px', fontSize: '14px', color: '#666', paddingLeft: '12px' }}>
                            {companyDetails.shippingAddress.addressLine1}, {companyDetails.shippingAddress.city}
                        </div>
                    )}
                </div>

                {/* Optional Fields */}
                <div>
                    <div className={styles.accordionHeader} onClick={() => setIsOptionalExpanded(!isOptionalExpanded)}>
                        <div>
                            <div>Optional Fields</div>
                            <div style={{ fontSize: '12px', color: '#666', fontWeight: 400 }}>Pan Number, Alternate Contact Number, Website</div>
                        </div>
                        {isOptionalExpanded ? <FiChevronUp /> : <FiChevronDown />}
                    </div>

                    {isOptionalExpanded && (
                        <div className={styles.accordionContent}>
                            <div className={styles.formGroup}>
                                <label className={styles.label}>PAN Number</label>
                                <input
                                    name="panNumber"
                                    value={companyDetails.panNumber || ''}
                                    onChange={handleInputChange}
                                    className={styles.input}
                                    placeholder="Enter PAN"
                                />
                            </div>
                            <div className={styles.formGroup}>
                                <label className={styles.label}>Alternate Contact Number</label>
                                <input
                                    name="alternatePhone"
                                    value={companyDetails.alternatePhone || ''}
                                    onChange={handleInputChange}
                                    className={styles.input}
                                    placeholder="Enter Alternate Number"
                                />
                            </div>
                            <div className={styles.formGroup}>
                                <label className={styles.label}>Website</label>
                                <input
                                    name="website"
                                    value={companyDetails.website || ''}
                                    onChange={handleInputChange}
                                    className={styles.input}
                                    placeholder="Enter Website"
                                />
                            </div>
                        </div>
                    )}
                </div>
            </div>

            <AddressBottomSheet
                isOpen={isBillingSheetOpen}
                onClose={() => setIsBillingSheetOpen(false)}
                onSave={(data) => handleAddressSave('billing', data)}
                initialData={companyDetails.billingAddress}
                title="Enter Billing Address"
            />

            <AddressBottomSheet
                isOpen={isShippingSheetOpen}
                onClose={() => setIsShippingSheetOpen(false)}
                onSave={(data) => handleAddressSave('shipping', data)}
                initialData={companyDetails.shippingAddress}
                title="Enter Shipping Address"
                showAutofill={true}
            />
        </div>
    );
}
</file>

<file path="src/app/more/templates/page.js">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useSettingsStore } from '@/lib/store/settingsStore';
import { templates } from '@/components/InvoiceTemplates';
import { FiArrowLeft, FiCheck } from 'react-icons/fi';
import styles from '../page.module.css'; // Reuse existing styles or create new

// Dummy data for preview
const dummyData = {
    invoiceNumber: 'INV-001',
    date: '2023-11-21',
    customer: {
        name: 'John Doe',
        address: '123 Main St, City, Country'
    },
    items: [
        { name: 'Product A', quantity: 2, rate: 100 },
        { name: 'Service B', quantity: 1, rate: 500 }
    ],
    totals: {
        subtotal: 700,
        totalTax: 126,
        total: 826
    }
};

export default function TemplatesPage() {
    const router = useRouter();
    const { templateId, setTemplateId, loadSettings } = useSettingsStore();
    const [selectedId, setSelectedId] = useState('modern');

    useEffect(() => {
        loadSettings();
    }, []);

    useEffect(() => {
        if (templateId) {
            setSelectedId(templateId);
        }
    }, [templateId]);

    const handleSave = async () => {
        await setTemplateId(selectedId);
        router.back();
    };

    const selectedTemplate = templates[selectedId] || templates.modern;

    return (
        <div style={{ background: '#f3f4f6', minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
            {/* Header */}
            <div style={{
                background: 'white',
                padding: '16px',
                display: 'flex',
                alignItems: 'center',
                gap: 12,
                borderBottom: '1px solid #e5e7eb',
                position: 'sticky', top: 0, zIndex: 10
            }}>
                <FiArrowLeft size={24} onClick={() => router.back()} style={{ cursor: 'pointer' }} />
                <div style={{ fontWeight: 700, fontSize: 18 }}>Invoice Templates</div>
            </div>

            {/* Preview Area */}
            <div style={{ flex: 1, overflow: 'auto', padding: '20px', display: 'flex', justifyContent: 'center', background: '#f3f4f6' }}>
                <div style={{
                    width: '100%', maxWidth: '400px',
                    boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    borderRadius: '8px', overflow: 'hidden'
                }}>
                    <img
                        src={selectedTemplate.previewImage}
                        alt="Template Preview"
                        style={{ width: '100%', height: 'auto', display: 'block' }}
                    />
                </div>
            </div>

            {/* Template Selector */}
            {/* Invoice Template Selector */}
            <div style={{
                background: 'white',
                padding: '20px',
                borderTop: '1px solid #e5e7eb',
                zIndex: 10
            }}>
                <div style={{ marginBottom: '16px', fontWeight: 600 }}>Choose Invoice Template</div>
                <div style={{ display: 'flex', gap: '16px', overflowX: 'auto', paddingBottom: '8px', marginBottom: '24px' }}>
                    {Object.values(templates).map((template) => (
                        <div
                            key={template.id}
                            onClick={() => setSelectedId(template.id)}
                            style={{
                                minWidth: '100px',
                                cursor: 'pointer',
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                gap: '8px'
                            }}
                        >
                            <div style={{
                                width: '80px',
                                height: '100px',
                                border: selectedId === template.id ? '2px solid #2563eb' : '1px solid #e5e7eb',
                                borderRadius: '8px',
                                background: '#f9fafb',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                position: 'relative',
                                overflow: 'hidden'
                            }}>
                                <img
                                    src={template.thumbnail}
                                    alt={template.name}
                                    style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                                />
                                {selectedId === template.id && (
                                    <div style={{
                                        position: 'absolute', top: 4, right: 4,
                                        background: '#2563eb', borderRadius: '50%',
                                        width: 16, height: 16, display: 'flex', alignItems: 'center', justifyContent: 'center'
                                    }}>
                                        <FiCheck size={10} color="white" />
                                    </div>
                                )}
                            </div>
                            <div style={{ fontSize: '12px', fontWeight: selectedId === template.id ? 600 : 400 }}>
                                {template.name}
                            </div>
                        </div>
                    ))}
                </div>



                <button
                    onClick={handleSave}
                    style={{
                        width: '100%',
                        background: '#2563eb',
                        color: 'white',
                        border: 'none',
                        padding: '14px',
                        borderRadius: '8px',
                        fontWeight: 600,
                        marginTop: '16px'
                    }}
                >
                    Save & Update
                </button>
            </div>
        </div>
    );
}
</file>

<file path="src/app/more/page.module.css">
.container {
    padding: 16px;
    padding-bottom: 80px;
    background: var(--background);
    min-height: 100vh;
}

.profileCard {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.avatar {
    width: 56px;
    height: 56px;
    border-radius: 18px;
    /* Squircle */
    background: var(--primary-light);
    color: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 700;
    border: 1px solid #DBEAFE;
}

.profileInfo {
    flex: 1;
}

.profileName {
    font-size: 18px;
    font-weight: 700;
    color: var(--foreground);
    margin-bottom: 4px;
}

.profileSub {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 500;
}

.sectionTitle {
    font-size: 14px;
    font-weight: 700;
    color: var(--foreground);
    margin-bottom: 12px;
    margin-left: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.menuGroup {
    background: var(--card-bg);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.menuItem {
    display: flex;
    align-items: center;
    padding: 16px 20px;
    gap: 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.2s;
}

.menuItem:last-child {
    border-bottom: none;
}

.menuItem:active {
    background: #F9FAFB;
}

.menuIcon {
    color: var(--foreground);
    font-size: 20px;
    display: flex;
    align-items: center;
}

.menuLabel {
    flex: 1;
    font-size: 14px;
    color: var(--foreground);
    font-weight: 500;
}

.menuArrow {
    color: #9CA3AF;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }

    to {
        transform: rotate(360deg);
    }
}
</file>

<file path="src/app/parties/customer/edit/page.js">
'use client';

import { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { usePartyStore } from '@/lib/store/partyStore';
import { FiArrowLeft, FiMoreHorizontal, FiHeadphones, FiPlayCircle, FiPlusCircle, FiCopy, FiChevronDown } from 'react-icons/fi';
import { AddressBottomSheet } from '@/components/AddressBottomSheet';
import AnimatedButton from '@/components/AnimatedButton';
import styles from './page.module.css';

export default function CustomerEditPage() {
    const router = useRouter();
    const searchParams = useSearchParams();
    const id = searchParams.get('id');
    const { getCustomer, updateCustomer } = usePartyStore();

    const [formData, setFormData] = useState({
        name: '',
        phone: '',
        email: '',
        gstin: '',
        companyName: '',
        billingAddress: null,
        shippingAddress: null,
        sameAsBilling: false
    });

    const [isBillingSheetOpen, setIsBillingSheetOpen] = useState(false);
    const [isShippingSheetOpen, setIsShippingSheetOpen] = useState(false);

    useEffect(() => {
        if (id) {
            const customer = getCustomer(id);
            if (customer) {
                setFormData(prev => ({ ...prev, ...customer }));
            }
        }
    }, [id]);

    const handleChange = (e) => {
        const { name, value } = e.target;
        if (name === 'phone') {
            const numericValue = value.replace(/\D/g, '').slice(0, 10);
            setFormData(prev => ({ ...prev, [name]: numericValue }));
        } else {
            setFormData(prev => ({ ...prev, [name]: value }));
        }
    };

    const handleSave = async () => {
        if (!formData.name) {
            alert('Name is required');
            return;
        }
        if (formData.phone && formData.phone.length !== 10) {
            alert('Phone number must be 10 digits');
            return;
        }
        await updateCustomer(parseInt(id), formData);
        router.back();
    };

    const handleAddressSave = (type, addressData) => {
        if (type === 'billing') {
            setFormData(prev => ({
                ...prev,
                billingAddress: addressData,
                shippingAddress: prev.sameAsBilling ? addressData : prev.shippingAddress
            }));
        } else {
            setFormData(prev => ({ ...prev, shippingAddress: addressData }));
        }
    };

    const toggleSameAsBilling = () => {
        setFormData(prev => {
            const newSame = !prev.sameAsBilling;
            return {
                ...prev,
                sameAsBilling: newSame,
                shippingAddress: newSame ? prev.billingAddress : prev.shippingAddress
            };
        });
    };

    return (
        <div className={styles.container}>
            {/* Header */}
            <div className={styles.header}>
                <div style={{ display: 'flex', alignItems: 'center' }}>
                    <FiArrowLeft size={24} onClick={() => router.back()} style={{ cursor: 'pointer' }} />
                    <span className={styles.headerTitle}>Update Customer</span>
                </div>
                <div className={styles.headerActions}>
                    <div className={styles.importAction}>
                        Import <FiChevronDown />
                    </div>
                    <FiMoreHorizontal size={24} />
                </div>
            </div>

            <div className={styles.content}>
                {/* Banner */}


                {/* Basic Details */}
                <div className={styles.section}>
                    <div className={styles.sectionHeader}>
                        <div className={styles.sectionTitle}>Basic Details</div>
                        <FiPlayCircle size={20} color="#dc2626" />
                    </div>

                    <div className={styles.inputGroup}>
                        <input
                            className={styles.input}
                            name="name"
                            value={formData.name}
                            onChange={handleChange}
                            placeholder=" "
                        />
                        <label className={styles.label}>Name <span style={{ color: 'red' }}>*</span></label>
                    </div>

                    <div className={styles.phoneInputContainer} style={{ marginBottom: '16px' }}>
                        <img src="https://flagcdn.com/w40/in.png" alt="IN" className={styles.flag} />
                        <span className={styles.phonePrefix}>IN +91 <FiChevronDown size={12} /></span>
                        <input
                            className={styles.phoneInput}
                            name="phone"
                            value={formData.phone}
                            onChange={handleChange}
                            placeholder="Enter Phone Number"
                        />
                    </div>

                    <div className={styles.inputGroup} style={{ marginBottom: 0 }}>
                        <input
                            className={styles.input}
                            name="email"
                            value={formData.email}
                            onChange={handleChange}
                            placeholder=" "
                        />
                        <label className={styles.label}>Email</label>
                    </div>
                </div>

                {/* Company Details */}
                <div className={styles.section}>
                    <div className={styles.sectionTitle} style={{ marginBottom: '16px' }}>Company Details (Optional)</div>

                    <div style={{ marginBottom: '16px' }}>
                        <div className={styles.gstContainer}>
                            <div style={{ position: 'relative', flex: 1 }}>
                                <input
                                    className={styles.gstInput}
                                    name="gstin"
                                    value={formData.gstin || ''}
                                    onChange={handleChange}
                                    placeholder="GST Number"
                                    style={{ paddingTop: '20px', paddingBottom: '4px' }}
                                />
                                <label style={{ position: 'absolute', left: '12px', top: '4px', fontSize: '10px', color: '#6b7280' }}>GST Number</label>
                            </div>
                        </div>

                    </div>

                    <div>
                        <div className={styles.inputGroup} style={{ marginBottom: '4px' }}>
                            <input
                                className={styles.input}
                                name="companyName"
                                value={formData.companyName || ''}
                                onChange={handleChange}
                                placeholder=" "
                            />
                            <label className={styles.label}>Company Name</label>
                        </div>
                        <div className={styles.helperText}>eg. Tata Motors Private Limited</div>
                    </div>
                </div>

                {/* Billing Address */}
                <div className={styles.section}>
                    <div className={styles.sectionTitle} style={{ marginBottom: '16px' }}>Billing Address (Optional)</div>
                    <button className={styles.addressButton} onClick={() => setIsBillingSheetOpen(true)}>
                        <FiPlusCircle size={18} /> {formData.billingAddress ? 'Edit Billing Address' : 'Billing Address'}
                    </button>
                </div>

                {/* Shipping Address */}
                <div className={styles.section}>
                    <div className={styles.sectionHeader}>
                        <div className={styles.sectionTitle}>Shipping Address (Optional)</div>
                    </div>

                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', background: '#f9fafb', border: '1px solid #e5e7eb', borderRadius: '8px', padding: '8px 12px' }}>
                        <div
                            style={{ display: 'flex', alignItems: 'center', gap: '8px', fontWeight: 600, color: '#6b7280', cursor: 'pointer', flex: 1 }}
                            onClick={() => setIsShippingSheetOpen(true)}
                        >
                            <FiPlusCircle size={18} /> {formData.shippingAddress ? 'Edit Shipping Address' : 'Shipping Address'}
                        </div>
                        <div className={styles.checkboxContainer} onClick={toggleSameAsBilling}>
                            <span>Same as Billing?</span>
                            <FiCopy size={16} color={formData.sameAsBilling ? '#2563eb' : '#9ca3af'} />
                        </div>
                    </div>
                </div>

                <AnimatedButton className={styles.updateButton} onClick={handleSave}>
                    Update Customer
                </AnimatedButton>
            </div>

            <AddressBottomSheet
                isOpen={isBillingSheetOpen}
                onClose={() => setIsBillingSheetOpen(false)}
                onSave={(data) => handleAddressSave('billing', data)}
                initialData={formData.billingAddress}
                title="Enter Billing Address"
            />

            <AddressBottomSheet
                isOpen={isShippingSheetOpen}
                onClose={() => setIsShippingSheetOpen(false)}
                onSave={(data) => handleAddressSave('shipping', data)}
                initialData={formData.shippingAddress}
                title="Enter Shipping Address"
            />
        </div>
    );
}
</file>

<file path="src/app/parties/payment/create/page.js">
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { usePartyStore } from '@/lib/store/partyStore';
import { FiArrowLeft, FiPlayCircle, FiCalendar, FiPlus, FiCamera, FiUpload } from 'react-icons/fi';
import AnimatedButton from '@/components/AnimatedButton';
import styles from './page.module.css';

function RecordPaymentContent() {
    const router = useRouter();
    const searchParams = useSearchParams();
    const customerId = searchParams.get('customerId');
    const vendorId = searchParams.get('vendorId');
    const partyType = searchParams.get('partyType') || 'customer'; // 'customer' or 'vendor'
    const mode = searchParams.get('mode') || 'in'; // 'in' (You Got) or 'out' (You Gave)
    const { getCustomer, addPayment, getVendor, addVendorPayment } = usePartyStore();

    const isVendor = partyType === 'vendor';
    const partyId = isVendor ? vendorId : customerId;

    const [party, setParty] = useState(null);
    const [amount, setAmount] = useState('');
    const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
    const [paymentType, setPaymentType] = useState('Cash');
    const [notes, setNotes] = useState('');
    const [internalNotes, setInternalNotes] = useState('');
    const [sendSms, setSendSms] = useState(false);
    const [sendEmail, setSendEmail] = useState(false);

    useEffect(() => {
        if (partyId) {
            const p = isVendor ? getVendor(partyId) : getCustomer(partyId);
            if (p) setParty(p);
        }
    }, [partyId, isVendor]);

    const handleRecord = async () => {
        if (!amount) {
            alert('Please enter an amount');
            return;
        }

        if (isVendor) {
            const paymentData = {
                vendorId: vendorId,  // UUID from backend, don't parseInt
                amount: parseFloat(amount),
                date,
                type: paymentType,
                notes,
                internalNotes,
                sendSms,
                sendEmail,
                timestamp: Date.now(),
                mode: mode
            };
            await addVendorPayment(paymentData);
        } else {
            const paymentData = {
                customerId: customerId,  // UUID from backend, don't parseInt
                amount: parseFloat(amount),
                date,
                type: paymentType,
                notes,
                internalNotes,
                sendSms,
                sendEmail,
                timestamp: Date.now(),
                mode: mode
            };
            await addPayment(paymentData);
        }
        router.back();
    };

    const paymentTypes = ['UPI', 'Cash', 'Card', 'Net Banking', 'Cheque', 'EMI', 'TDS'];

    if (!party) return <div>Loading...</div>;

    const isIn = mode === 'in';
    const themeColor = isIn ? '#16a34a' : '#2563eb'; // Green : Blue
    const themeBg = isIn ? '#dcfce7' : '#dbeafe'; // Light Green : Light Blue
    const themeText = isIn ? '#166534' : '#1e40af'; // Dark Green : Dark Blue

    return (
        <div className={styles.container}>
            {/* Header */}
            <div className={styles.header}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <FiArrowLeft size={24} onClick={() => router.back()} style={{ cursor: 'pointer' }} />
                    <div>
                        <div className={styles.headerTitle}>Record Payment</div>
                        <div className={styles.headerSubtitle}>{isVendor ? 'Vendor' : 'Customer'}: {party.name}</div>
                    </div>
                </div>
                <FiPlayCircle size={24} color="#ef4444" />
            </div>

            <div className={styles.content}>
                <div className={styles.sectionTitle}>Payment</div>
                <div className={styles.sectionTitleBold}>Details</div>

                {/* Amount Input */}
                <div className={styles.inputGroup}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                        <label className={styles.label}>
                            {isIn ? 'Amount to be Recorded (₹)' : 'Amount to be paid (₹)'}
                        </label>
                        <span className={styles.resetLink} onClick={() => setAmount('')}>Reset</span>
                    </div>
                    <div className={styles.amountInputContainer} style={{ borderColor: themeColor }}>
                        <span className={styles.currencySymbol}>₹</span>
                        <input
                            type="number"
                            className={styles.amountInput}
                            value={amount}
                            onChange={(e) => setAmount(e.target.value)}
                            placeholder={isIn ? "0" : "Enter Amount"}
                        />
                    </div>
                    {isIn && <div className={styles.pendingText}>Pending ₹{party.balance?.toFixed(2) || '0.00'}</div>}
                </div>

                {/* Date Picker */}
                <div className={styles.inputGroup}>
                    <label className={styles.label}>Payment date</label>
                    <div className={styles.dateInputContainer}>
                        <input
                            type="date"
                            className={styles.dateInput}
                            value={date}
                            onChange={(e) => setDate(e.target.value)}
                        />
                        <FiCalendar className={styles.calendarIcon} />
                    </div>
                </div>

                {/* Payment Type */}
                <div className={styles.inputGroup}>
                    <label className={styles.label}>Payment type</label>
                    <div className={styles.chipContainer}>
                        {paymentTypes.map(type => (
                            <div
                                key={type}
                                className={styles.chip}
                                style={paymentType === type ? { background: themeBg, color: themeText } : {}}
                                onClick={() => setPaymentType(type)}
                            >
                                {paymentType === type && <span className={styles.checkIcon}>✓</span>}
                                {type}
                            </div>
                        ))}
                    </div>
                </div>

                {/* Bank */}
                <div className={styles.inputGroup}>
                    <label className={styles.label}>Bank</label>
                    {/* Mock Bank Selection for 'You Gave' as per screenshot */}
                    {!isIn && (
                        <button className={styles.bankButton} style={{ background: '#2563eb', color: 'white', border: 'none', marginRight: '8px' }}>
                            <span style={{ fontSize: '10px', display: 'block' }}>✓</span>
                            IDFC FIRST Bank
                            <span style={{ fontSize: '10px', display: 'block', opacity: 0.8 }}>xx6789</span>
                        </button>
                    )}
                    <button className={styles.addNewButton}>
                        <FiPlus /> Add New
                    </button>
                </div>

                {/* Notes */}
                <div className={styles.inputGroup}>
                    <label className={styles.label}>Notes</label>
                    <textarea
                        className={styles.textarea}
                        placeholder="Enter your notes..."
                        value={notes}
                        onChange={(e) => setNotes(e.target.value)}
                    />
                </div>

                <div className={styles.divider} />

                <div className={styles.sectionTitleBold}>Other Details</div>

                {/* Internal Notes */}
                <div className={styles.inputGroup}>
                    <label className={styles.label}>Internal notes</label>
                    <textarea
                        className={styles.textarea}
                        placeholder="Enter your notes..."
                        value={internalNotes}
                        onChange={(e) => setInternalNotes(e.target.value)}
                    />
                </div>

                {/* Attachments */}
                <div className={styles.inputGroup}>
                    <label className={styles.label}>Attachments (Max: 3)</label>
                    <div className={styles.attachmentButtons}>
                        <button className={styles.attachmentButton}>
                            <FiCamera size={18} /> Camera
                        </button>
                        <button className={styles.attachmentButton}>
                            <FiUpload size={18} /> Upload File
                        </button>
                    </div>
                </div>

                {/* Toggles */}
                {/* Note: Screenshot for 'You Gave' doesn't explicitly show toggles but 'You Got' did. Keeping them for consistency or hiding if needed. 
                    The 'You Gave' screenshot ends at attachments. Let's keep them but maybe they are below fold.
                    Actually, let's keep them as they are useful features.
                */}
                <div className={styles.toggleGroup}>
                    <div>
                        <div className={styles.toggleLabel}>SMS to {isVendor ? 'Vendor' : 'Customer'}</div>
                        <div className={styles.toggleSubLabel}>We'll send a confirmation to their mobile no.</div>
                    </div>
                    <label className={styles.switch}>
                        <input type="checkbox" checked={sendSms} onChange={(e) => setSendSms(e.target.checked)} />
                        <span className={styles.slider} style={sendSms ? { backgroundColor: themeColor } : {}}></span>
                    </label>
                </div>

                {/* Footer */}
                <div className={styles.footer}>
                    {isIn ? (
                        <div className={styles.footerAmount}>
                            <div className={styles.footerLabel}>Pay In Amount</div>
                            <div className={styles.footerValue}>₹{amount || '0'}</div>
                        </div>
                    ) : (
                        <div className={styles.cancelButton} onClick={() => router.back()}>
                            Cancel
                        </div>
                    )}

                    <AnimatedButton
                        className={styles.recordButton}
                        style={{ background: themeColor, flex: isIn ? 'initial' : 1 }} // Expand button in 'You Gave' mode
                        onClick={handleRecord}
                    >
                        Record
                    </AnimatedButton>
                </div>
            </div>
        </div>
    );
}

export default function RecordPaymentPage() {
    return (
        <Suspense fallback={<div>Loading...</div>}>
            <RecordPaymentContent />
        </Suspense>
    );
}
</file>

<file path="src/app/products/components/ProductCard.js">
import styles from './ProductCard.module.css';
import { FiShoppingBag, FiCheck } from 'react-icons/fi';
import { FaWhatsapp } from 'react-icons/fa';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import AuthenticatedImage from '@/components/AuthenticatedImage';

export default function ProductCard({ product, onAddToTray, onShare, quantity = 0, isSelectMode = false }) {
    const router = useRouter();

    const isBestseller = product.tags && product.tags.toLowerCase().includes('bestseller');
    const isInTray = quantity > 0;

    // Format fields
    const purity = product.purity || '22K';
    const category = product.category || 'Product';
    const title = `${category} – ${purity}`;
    const weight = product.grossWeight ? `${Number(product.grossWeight).toFixed(2)}g` : '0.00g';
    const stone = product.stoneType || 'Plain Gold';

    const handleCardClick = () => {
        if (!isSelectMode) {
            router.push(`/products/edit?id=${product.id}`);
        }
    };

    const handleAction = (e, callback) => {
        e.stopPropagation();
        callback();
    };

    // Get image URL - prefer API URL, fallback to base64 data
    const imageUrl = product.images?.[0]?.url;
    const imageData = product.images?.[0]?.data;

    return (
        <div className={styles.card} onClick={handleCardClick} style={{ cursor: isSelectMode ? 'default' : 'pointer' }}>
            <div className={styles.imageContainer}>
                {/* Badges */}
                <div className={styles.purityBadge}>{purity}</div>
                {isBestseller && (
                    <div className={`${styles.statusBadge} ${styles.bestseller}`}>
                        Bestseller
                    </div>
                )}
                {/* Quantity Badge in Select Mode */}
                {isSelectMode && isInTray && (
                    <div className={styles.quantityBadge}>
                        {quantity}
                    </div>
                )}

                {/* Image - use AuthenticatedImage for API URLs, regular img for base64 */}
                {imageUrl ? (
                    <AuthenticatedImage
                        src={imageUrl}
                        alt={product.name}
                        className={styles.image}
                        fallback={
                            <div className={styles.placeholderImage}>
                                <FiShoppingBag size={32} color="#ccc" />
                            </div>
                        }
                    />
                ) : imageData ? (
                    <img src={imageData} alt={product.name} className={styles.image} />
                ) : (
                    <div className={styles.placeholderImage}>
                        <FiShoppingBag size={32} color="#ccc" />
                    </div>
                )}
            </div>

            <div className={styles.details}>
                <h3 className={styles.title}>{title}</h3>
                <div className={styles.infoRow}>Weight: {weight} | Stone: {stone}</div>
            </div>

            <div className={styles.actions}>
                <button
                    className={`${styles.primaryBtn} ${isInTray ? styles.addedBtn : ''}`}
                    onClick={(e) => handleAction(e, () => onAddToTray(product))}
                >
                    {isInTray ? (
                        <>
                            <FiCheck size={14} style={{ marginRight: 4 }} />
                            Added ({quantity})
                        </>
                    ) : (
                        'Add to Tray'
                    )}
                </button>
                {!isSelectMode && (
                    <button
                        className={styles.iconBtn}
                        onClick={(e) => handleAction(e, () => onShare(product))}
                    >
                        <FaWhatsapp size={18} color="#25D366" />
                    </button>
                )}
            </div>
        </div>
    );
}
</file>

<file path="src/components/Auth/AuthWrapper.js">
'use client';

import { useEffect } from 'react';
import { useAuthStore } from '@/lib/store/authStore';
import LoginFlow from './LoginFlow';

/**
 * AuthWrapper - Handles authentication state only
 * 
 * Backend connectivity is now handled by AppBootstrap (parent).
 * This component only manages:
 * - Loading auth state from storage
 * - Rendering LoginFlow if not authenticated
 * - Rendering children if authenticated
 */
export default function AuthWrapper({ children }) {
    const { isAuthenticated, isLoading, loadAuth } = useAuthStore();

    useEffect(() => {
        // Load auth state - backend is already confirmed reachable by AppBootstrap
        loadAuth();
    }, [loadAuth]);

    // Show loading while checking auth state
    if (isLoading) {
        return (
            <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>
                Loading...
            </div>
        );
    }

    // Not authenticated - show login
    if (!isAuthenticated) {
        return <LoginFlow />;
    }

    // Authenticated - render app
    return <>{children}</>;
}
</file>

<file path="src/lib/store/__tests__/productStore.test.js">
/**
 * @jest-environment jsdom
 */

// Mock the API client
jest.mock('@/api/backendClient', () => ({
    api: {
        products: {
            list: jest.fn(),
            create: jest.fn(),
            update: jest.fn(),
            delete: jest.fn(),
            get: jest.fn(),
        },
        media: {
            upload: jest.fn(),
        },
    },
}));

import { useProductStore } from '../productStore';
import { api } from '@/api/backendClient';

describe('productStore', () => {
    beforeEach(() => {
        // Reset the store state before each test
        useProductStore.setState({
            products: [],
            isLoading: false,
            error: null,
        });
        jest.clearAllMocks();
    });

    describe('loadProducts', () => {
        it('should load products and reverse the order', async () => {
            const mockProducts = [
                { id: 1, name: 'Product 1' },
                { id: 2, name: 'Product 2' },
            ];
            api.products.list.mockResolvedValue(mockProducts);

            const { loadProducts } = useProductStore.getState();
            await loadProducts();

            const state = useProductStore.getState();
            expect(state.products).toEqual([
                { id: 2, name: 'Product 2' },
                { id: 1, name: 'Product 1' },
            ]);
            expect(state.isLoading).toBe(false);
        });

        it('should set isLoading to true while loading', async () => {
            api.products.list.mockImplementation(() => new Promise(() => { })); // Never resolves

            const { loadProducts } = useProductStore.getState();
            loadProducts(); // Don't await

            expect(useProductStore.getState().isLoading).toBe(true);
        });

        it('should handle errors and set error state', async () => {
            api.products.list.mockRejectedValue(new Error('API error'));

            const { loadProducts } = useProductStore.getState();
            await loadProducts();

            const state = useProductStore.getState();
            expect(state.isLoading).toBe(false);
            expect(state.error).toBe('API error');
        });
    });

    describe('addProduct', () => {
        it('should add product via API and update state', async () => {
            const newProduct = { name: 'Gold Ring', category: 'Gold' };
            const savedProduct = { id: 123, ...newProduct, sku: 'GOL-RIN-000001' };

            api.products.create.mockResolvedValue(savedProduct);
            api.products.list.mockResolvedValue([savedProduct]);

            const { addProduct } = useProductStore.getState();
            const result = await addProduct(newProduct);

            expect(api.products.create).toHaveBeenCalledWith(newProduct);
            // addProduct returns the product ID for use in subsequent operations (e.g., image uploads)
            expect(result).toEqual(savedProduct.id);

            const state = useProductStore.getState();
            expect(state.products[0]).toEqual(savedProduct);
        });

        it('should handle add errors', async () => {
            api.products.create.mockRejectedValue(new Error('Failed to create'));

            const { addProduct } = useProductStore.getState();

            await expect(addProduct({ name: 'Test' })).rejects.toThrow('Failed to create');
            expect(useProductStore.getState().error).toBe('Failed to create');
        });
    });

    describe('deleteProduct', () => {
        it('should delete product via API and update state', async () => {
            useProductStore.setState({
                products: [
                    { id: 1, name: 'Product 1' },
                    { id: 2, name: 'Product 2' },
                ],
            });

            api.products.delete.mockResolvedValue();
            api.products.list.mockResolvedValue([{ id: 2, name: 'Product 2' }]);

            const { deleteProduct } = useProductStore.getState();
            await deleteProduct(1);

            expect(api.products.delete).toHaveBeenCalledWith(1);
            expect(useProductStore.getState().products).toEqual([
                { id: 2, name: 'Product 2' },
            ]);
        });
    });

    describe('updateProduct', () => {
        it('should update product via API and update state', async () => {
            useProductStore.setState({
                products: [{ id: 1, name: 'Old Name', price: 100 }],
            });

            const updatedProduct = { id: 1, name: 'New Name', price: 100 };
            api.products.update.mockResolvedValue(updatedProduct);
            api.products.list.mockResolvedValue([updatedProduct]);

            const { updateProduct } = useProductStore.getState();
            await updateProduct(1, { name: 'New Name' });

            expect(api.products.update).toHaveBeenCalledWith(1, { name: 'New Name' });
            expect(useProductStore.getState().products[0]).toEqual(updatedProduct);
        });
    });

    describe('clearError', () => {
        it('should clear the error state', () => {
            useProductStore.setState({ error: 'Some error' });

            const { clearError } = useProductStore.getState();
            clearError();

            expect(useProductStore.getState().error).toBeNull();
        });
    });
});
</file>

<file path="src/lib/store/authStore.js">
import { create } from 'zustand';
import { api, setToken, clearToken, ApiError } from '@/api/backendClient';

export const useAuthStore = create((set, get) => ({
    isAuthenticated: false,
    isLoading: true,
    user: null,
    phoneNumber: '',
    currentStep: 'welcome', // welcome, phone, otp, notAssigned
    error: null,
    isNotAssignedToShop: false, // True when user exists but not assigned to any shop

    // Check if user is authenticated by validating token with backend
    loadAuth: async () => {
        set({ isLoading: true, error: null });
        try {
            const user = await api.auth.me();
            set({
                isAuthenticated: true,
                user,
                phoneNumber: user.phone || '',
                isLoading: false
            });
        } catch (error) {
            // Token invalid or expired
            clearToken();
            set({
                isAuthenticated: false,
                user: null,
                isLoading: false
            });
        }
    },

    setStep: (step) => set({ currentStep: step, isNotAssignedToShop: false, error: null }),

    setPhoneNumber: (phone) => set({ phoneNumber: phone }),

    // Request OTP from backend
    requestOTP: async (phone) => {
        console.log('[authStore] requestOTP called with:', phone);
        set({ isLoading: true, error: null });
        try {
            console.log('[authStore] calling api.auth.requestOTP');
            await api.auth.requestOTP(phone);
            console.log('[authStore] api.auth.requestOTP succeeded');
            set({ phoneNumber: phone, currentStep: 'otp', isLoading: false });
            return true;
        } catch (error) {
            console.log('[authStore] api.auth.requestOTP failed:', error.message);
            set({ error: error.message || 'Failed to send OTP', isLoading: false });
            return false;
        }
    },

    // Verify OTP and login
    verifyOTP: async (otp) => {
        set({ isLoading: true, error: null });
        try {
            const response = await api.auth.login({
                phone: get().phoneNumber,
                otp
            });

            // Store JWT token
            if (response.token) {
                setToken(response.token);
            }

            set({
                isAuthenticated: true,
                user: response.user || { phone: get().phoneNumber },
                currentStep: 'welcome',
                isLoading: false
            });
            return true;
        } catch (error) {
            // Check if this is a "user not registered" error (403)
            const isNotAssigned = error.status === 403 &&
                (error.message?.toLowerCase().includes('not registered') ||
                    error.message?.toLowerCase().includes('not assigned') ||
                    error.message?.toLowerCase().includes('contact your shop admin'));

            if (isNotAssigned) {
                set({
                    error: 'You are not added to any shop. Please contact your administrator.',
                    isNotAssignedToShop: true,
                    currentStep: 'notAssigned',
                    isLoading: false
                });
            } else {
                set({
                    error: error.message || 'Invalid OTP',
                    isNotAssignedToShop: false,
                    isLoading: false
                });
            }
            return false;
        }
    },

    logout: async () => {
        try {
            await api.auth.logout();
        } catch (error) {
            // Ignore logout errors, clear local state anyway
        }
        clearToken();
        set({
            isAuthenticated: false,
            user: null,
            phoneNumber: '',
            currentStep: 'welcome',
            error: null,
            isNotAssignedToShop: false
        });
    },

    clearError: () => set({ error: null }),
}));
</file>

<file path="src/lib/store/paymentStore.js">
import { create } from 'zustand';
import { api } from '@/api/backendClient';
import { logger, LOG_EVENTS } from '@/lib/logger';

export const usePaymentStore = create((set, get) => ({
    payments: [],
    isLoading: false,
    error: null,

    loadPayments: async () => {
        set({ isLoading: true, error: null });
        try {
            const payments = await api.payments.list();
            set({ payments: payments.reverse(), isLoading: false });
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_LOAD_ERROR, { store: 'payments', error: error.message });
            set({ error: error.message, isLoading: false });
        }
    },

    addPayment: async (payment) => {
        set({ isLoading: true, error: null });
        try {
            // Backend handles balance updates and invoice status changes
            const newPayment = await api.payments.create({
                ...payment,
                // Ensure allocations is included if provided
                allocations: payment.allocations || []
            });

            // Refresh payments list from backend
            const payments = await api.payments.list();
            set({ payments: payments.reverse(), isLoading: false });

            return newPayment.id;
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_SAVE_ERROR, { store: 'payment', error: error.message });
            set({ error: error.message, isLoading: false });
            throw error;
        }
    },

    deletePayment: async (id) => {
        set({ isLoading: true, error: null });
        try {
            await api.payments.delete(id);
            const payments = await api.payments.list();
            set({ payments: payments.reverse(), isLoading: false });
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_DELETE_ERROR, { store: 'payment', id, error: error.message });
            set({ error: error.message, isLoading: false });
            throw error;
        }
    },

    getPaymentsByParty: async (partyId) => {
        try {
            // Filter payments by party from loaded list
            const allPayments = get().payments;
            console.log('[paymentStore] getPaymentsByParty called with:', partyId);
            console.log('[paymentStore] All payments:', allPayments.length, allPayments.map(p => ({ id: p.id, partyId: p.partyId, party_id: p.party_id })));

            // Flexible comparison to handle both camelCase and snake_case
            const filtered = allPayments.filter(p => {
                const paymentPartyId = p.partyId || p.party_id;
                return String(paymentPartyId) === String(partyId);
            });

            console.log('[paymentStore] Filtered payments:', filtered.length);
            return filtered;
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_LOAD_ERROR, { store: 'payments_by_party', partyId, error: error.message });
            return [];
        }
    },

    clearError: () => set({ error: null }),
}));
</file>

<file path="src/lib/store/purchaseStore.js">
import { create } from 'zustand';
import { api } from '@/api/backendClient';

export const usePurchaseStore = create((set, get) => ({
    purchaseNumber: '', // Assigned by backend
    date: new Date().toISOString().split('T')[0],
    dueDate: new Date().toISOString().split('T')[0],
    vendor: null,
    items: [],
    purchases: [], // List of all purchases
    isLoading: false,
    error: null,

    // GST Toggle
    gstEnabled: true,

    // Details
    details: {
        reference: '',
        notes: '',
        terms: '',
        extraDiscount: 0,
        shippingCharges: 0,
        packagingCharges: 0,
    },

    // Weight Summary
    weightSummary: {
        grossWeight: '',
        netWeight: '',
    },

    // Payment tracking
    payment: {
        isFullyPaid: false,
        amountPaid: 0,
        mode: 'Cash',
        notes: '',
    },

    roundOff: false,
    id: null, // For editing

    // Setters
    setPurchaseNumber: (num) => set({ purchaseNumber: num }),
    setDate: (date) => set({ date }),
    setDueDate: (date) => set({ dueDate: date }),
    setVendor: (vendor) => set({ vendor }),
    toggleGst: () => set((state) => ({ gstEnabled: !state.gstEnabled })),
    toggleRoundOff: () => set((state) => ({ roundOff: !state.roundOff })),

    setWeightSummary: (field, value) => set((state) => ({
        weightSummary: { ...state.weightSummary, [field]: value }
    })),

    updateDetails: (field, value) => set((state) => ({
        details: { ...state.details, [field]: value }
    })),

    updatePayment: (field, value) => set((state) => ({
        payment: { ...state.payment, [field]: value }
    })),

    // Load purchases from backend
    loadPurchases: async () => {
        set({ isLoading: true, error: null });
        try {
            const purchases = await api.purchases.list();
            set({ purchases: purchases.reverse(), isLoading: false });
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_LOAD_ERROR, { store: 'purchases', error: error.message });
            set({ error: error.message, isLoading: false });
        }
    },

    // Get single purchase
    getPurchase: async (id) => {
        try {
            return await api.purchases.get(id);
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_LOAD_ERROR, { store: 'purchase_get', id, error: error.message });
            throw error;
        }
    },

    // Item management (local state)
    addItem: () => set((state) => ({
        items: [...state.items, {
            id: Date.now(),
            name: '',
            netWeight: 0,
            grossWeight: 0,
            wastage: 0,
            ratePerGram: 0,
            quantity: 1,
            purity: '',
            hsn: '',
        }]
    })),

    updateItem: (id, field, value) => set((state) => ({
        items: state.items.map(item =>
            item.id === id ? { ...item, [field]: value } : item
        )
    })),

    removeItem: (id) => set((state) => ({
        items: state.items.filter(item => item.id !== id)
    })),

    duplicateItem: (id) => set((state) => {
        const itemToDuplicate = state.items.find(item => item.id === id);
        if (itemToDuplicate) {
            return {
                items: [...state.items, { ...itemToDuplicate, id: Date.now() }]
            };
        }
        return state;
    }),

    // Calculate totals for UI preview - backend is authoritative
    calculateTotals: () => {
        const { items, details, roundOff, gstEnabled } = get();
        let subtotal = 0;

        items.forEach(item => {
            const netWeight = Number(item.netWeight) || 0;
            const wastage = Number(item.wastage) || 0;
            const effectiveWeight = netWeight + wastage;
            const ratePerGram = Number(item.ratePerGram) || 0;
            const itemTotal = effectiveWeight * ratePerGram * (item.quantity || 1);
            subtotal += itemTotal;
        });

        let cgstAmount = 0, sgstAmount = 0, totalTax = 0;
        if (gstEnabled) {
            cgstAmount = (subtotal * 1.5) / 100;
            sgstAmount = (subtotal * 1.5) / 100;
            totalTax = cgstAmount + sgstAmount;
        }

        let total = subtotal + totalTax;
        total += Number(details.shippingCharges || 0);
        total += Number(details.packagingCharges || 0);
        total -= Number(details.extraDiscount || 0);

        let finalTotal = total;
        let roundOffAmount = 0;
        if (roundOff) {
            finalTotal = Math.round(total);
            roundOffAmount = finalTotal - total;
        }

        return {
            subtotal, totalTax, total: finalTotal, roundOffAmount,
            rawTotal: total, cgst: cgstAmount, sgst: sgstAmount, igst: 0
        };
    },

    // Save purchase to backend
    savePurchase: async () => {
        const state = get();
        const { date, dueDate, vendor, items, details, weightSummary, payment, id, gstEnabled } = state;

        if (!vendor) throw new Error('Vendor is required');
        if (items.length === 0) throw new Error('At least one item is required');

        set({ isLoading: true, error: null });

        // Prepare items for backend
        const preparedItems = items.map(item => ({
            name: item.name,
            netWeight: Number(item.netWeight) || 0,
            grossWeight: Number(item.grossWeight) || 0,
            wastage: Number(item.wastage) || 0,
            ratePerGram: Number(item.ratePerGram) || 0,
            quantity: item.quantity || 1,
            purity: item.purity || '',
            hsn: item.hsn || ''
        }));

        const purchaseData = {
            vendorId: vendor.id,
            date,
            dueDate,
            vendor: {
                name: vendor.name,
                phone: vendor.phone,
                gstin: vendor.gstin
            },
            items: preparedItems,
            details,
            weightSummary,
            gstEnabled,
            roundOff: state.roundOff,
            payment: {
                amountPaid: Number(payment.amountPaid) || 0,
                mode: payment.mode,
                notes: payment.notes
            }
        };

        try {
            let savedPurchase;
            if (id) {
                savedPurchase = await api.purchases.update(id, purchaseData);
            } else {
                savedPurchase = await api.purchases.create(purchaseData);
            }

            // Reload purchases from backend
            const purchases = await api.purchases.list();
            set({ purchases: purchases.reverse(), isLoading: false });

            return savedPurchase.id;
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_SAVE_ERROR, { store: 'purchase', error: error.message });
            set({ error: error.message, isLoading: false });
            throw error;
        }
    },

    deletePurchase: async (id) => {
        set({ isLoading: true, error: null });
        try {
            await api.purchases.delete(id);
            const purchases = await api.purchases.list();
            set({ purchases: purchases.reverse(), isLoading: false });
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_DELETE_ERROR, { store: 'purchase', id, error: error.message });
            set({ error: error.message, isLoading: false });
            throw error;
        }
    },

    resetPurchase: () => set({
        id: null,
        purchaseNumber: '',
        date: new Date().toISOString().split('T')[0],
        dueDate: new Date().toISOString().split('T')[0],
        vendor: null,
        items: [],
        gstEnabled: true,
        details: { reference: '', notes: '', terms: '', extraDiscount: 0, shippingCharges: 0, packagingCharges: 0 },
        weightSummary: { grossWeight: '', netWeight: '' },
        payment: { isFullyPaid: false, amountPaid: 0, mode: 'Cash', notes: '' },
        roundOff: false
    }),

    setPurchase: (purchase) => set({
        id: purchase.id,
        purchaseNumber: purchase.purchaseNumber,
        date: purchase.date,
        dueDate: purchase.dueDate || purchase.date,
        vendor: purchase.vendor,
        items: purchase.items,
        gstEnabled: purchase.gstEnabled !== false,
        details: purchase.details || { reference: '', notes: '', terms: '', extraDiscount: 0, shippingCharges: 0, packagingCharges: 0 },
        weightSummary: purchase.weightSummary || { grossWeight: '', netWeight: '' },
        payment: purchase.payment || { isFullyPaid: false, amountPaid: 0, mode: 'Cash', notes: '' },
        roundOff: purchase.totals?.roundOffAmount !== 0
    }),

    clearError: () => set({ error: null }),
}));
</file>

<file path="src/lib/utils/invoiceActions.js">
'use client';

/**
 * Centralized Invoice Actions Utility
 * Handles share, download, and view operations with proper Capacitor/native support
 */

import { generatePDF } from './pdf';
import { api } from '@/api/backendClient';
import { logger, LOG_EVENTS } from '@/lib/logger';

// ============================================================================
// PLATFORM DETECTION
// ============================================================================

/**
 * Check if running in Capacitor native environment
 */
export const isNativePlatform = () => {
    return typeof window !== 'undefined' && window.Capacitor && window.Capacitor.isNative;
};

// ============================================================================
// TOAST NOTIFICATIONS
// ============================================================================

let toastCallback = null;

/**
 * Register a callback to show toast messages
 * Called by ToastProvider component on mount
 */
export const registerToastCallback = (callback) => {
    toastCallback = callback;
};

/**
 * Show a toast notification to the user
 * @param {string} message - Message to display
 * @param {'success' | 'error' | 'info'} type - Toast type
 */
export const showToast = (message, type = 'info') => {
    logger.info(LOG_EVENTS.TOAST_SHOWN, { message, type });
    if (toastCallback) {
        toastCallback(message, type);
    } else {
        // Fallback to alert if Toast component not mounted
        if (type === 'error') {
            alert(`Error: ${message}`);
        }
    }
};

// ============================================================================
// FILE SYSTEM UTILITIES (NATIVE)
// ============================================================================

/**
 * Convert Blob to base64 string
 */
const blobToBase64 = (blob) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
            const base64data = reader.result;
            const pureBase64 = base64data.split(',')[1];
            resolve(pureBase64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
};

/**
 * Write file to device storage (native only)
 * @returns {Promise<{uri: string, path: string}>} File result with URI
 */
const writeFileNative = async (fileName, blob, directory = 'Cache') => {
    try {
        const { Filesystem, Directory } = await import('@capacitor/filesystem');
        const base64 = await blobToBase64(blob);

        const directoryMap = {
            'Cache': Directory.Cache,
            'Documents': Directory.Documents,
            'Data': Directory.Data,
            'External': Directory.External,
            'ExternalStorage': Directory.ExternalStorage
        };

        const result = await Filesystem.writeFile({
            path: fileName,
            data: base64,
            directory: directoryMap[directory] || Directory.Cache
        });

        return result;
    } catch (error) {
        logger.error('NATIVE_WRITE_FAILED', { fileName, error: error.message });
        throw error;
    }
};

// ============================================================================
// SHARE UTILITIES
// ============================================================================

/**
 * Share invoice as PDF
 * @param {object} invoice - Invoice data object
 * @returns {Promise<boolean>} Success status
 */
export const shareInvoicePDF = async (invoice) => {
    if (!invoice) {
        showToast('No invoice to share', 'error');
        return false;
    }

    try {
        // Get settings from backend API
        const settings = await api.settings.get();

        const templateId = invoice.type === 'LENDING'
            ? (settings.lendingBillTemplateId || 'modern')
            : (settings.templateId || 'modern');
        const companyDetails = settings.companyDetails || {};

        logger.info(LOG_EVENTS.INVOICE_PDF_GENERATING, { invoiceNumber: invoice.invoiceNumber });
        const blob = await generatePDF({
            ...invoice,
            templateId,
            companyDetails,
            returnBlob: true
        });

        const fileName = `Invoice-${invoice.invoiceNumber}.pdf`;

        if (isNativePlatform()) {
            logger.info(LOG_EVENTS.SHARE_PLATFORM_NATIVE, { fileName });

            // Write to cache for sharing
            const result = await writeFileNative(fileName, blob, 'Cache');

            // Share the file
            const { Share } = await import('@capacitor/share');
            await Share.share({
                title: `Invoice ${invoice.invoiceNumber}`,
                text: `Please find attached invoice ${invoice.invoiceNumber}`,
                files: [result.uri],
                dialogTitle: 'Send Invoice'
            });

            logger.info(LOG_EVENTS.INVOICE_SHARED, { method: 'native', invoiceNumber: invoice.invoiceNumber });
            return true;
        } else {
            logger.info(LOG_EVENTS.SHARE_PLATFORM_WEB, { fileName });
            const file = new File([blob], fileName, { type: 'application/pdf' });

            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    title: `Invoice ${invoice.invoiceNumber}`,
                    text: `Please find attached invoice ${invoice.invoiceNumber}`,
                    files: [file]
                });
                logger.info(LOG_EVENTS.INVOICE_SHARED, { method: 'web_share', invoiceNumber: invoice.invoiceNumber });
                return true;
            } else {
                // Fallback: download the file
                logger.info(LOG_EVENTS.SHARE_PLATFORM_WEB, { method: 'fallback_download' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
                showToast('Sharing not supported - file downloaded instead', 'info');
                return true;
            }
        }
    } catch (error) {
        logger.error(LOG_EVENTS.INVOICE_SHARE_FAILED, { error: error.message, invoiceNumber: invoice?.invoiceNumber });
        if (error.name !== 'AbortError') {
            showToast('Failed to share invoice: ' + error.message, 'error');
        }
        return false;
    }
};

/**
 * Download invoice PDF to device
 * @param {object} invoice - Invoice data object
 * @returns {Promise<boolean>} Success status
 */
export const downloadInvoicePDF = async (invoice) => {
    if (!invoice) {
        showToast('No invoice to download', 'error');
        return false;
    }

    try {
        // Get settings from backend API
        const settings = await api.settings.get();

        const templateId = invoice.type === 'LENDING'
            ? (settings.lendingBillTemplateId || 'modern')
            : (settings.templateId || 'modern');
        const companyDetails = settings.companyDetails || {};

        const fileName = `Invoice-${invoice.invoiceNumber}.pdf`;

        if (isNativePlatform()) {
            logger.info(LOG_EVENTS.DOWNLOAD_PLATFORM_NATIVE, { fileName });
            const blob = await generatePDF({
                ...invoice,
                templateId,
                companyDetails,
                returnBlob: true
            });

            await writeFileNative(fileName, blob, 'Documents');
            showToast(`Invoice saved: ${fileName}`, 'success');
            logger.info(LOG_EVENTS.INVOICE_DOWNLOADED, { fileName, platform: 'native' });
            return true;
        } else {
            logger.info(LOG_EVENTS.DOWNLOAD_PLATFORM_WEB, { fileName });
            await generatePDF({ ...invoice, templateId, companyDetails });
            showToast('Invoice downloaded', 'success');
            logger.info(LOG_EVENTS.INVOICE_DOWNLOADED, { fileName, platform: 'web' });
            return true;
        }
    } catch (error) {
        logger.error(LOG_EVENTS.INVOICE_DOWNLOAD_FAILED, { error: error.message });
        showToast('Failed to download invoice: ' + error.message, 'error');
        return false;
    }
};

/**
 * Share simple text content
 * @param {object} options - Share options { title, text, url }
 * @returns {Promise<boolean>} Success status
 */
export const shareText = async (options) => {
    const { title, text, url, dialogTitle } = options;

    try {
        if (isNativePlatform()) {
            logger.info(LOG_EVENTS.SHARE_PLATFORM_NATIVE, { type: 'text' });
            const { Share } = await import('@capacitor/share');
            await Share.share({ title, text, url, dialogTitle });
            return true;
        } else {
            logger.info(LOG_EVENTS.SHARE_PLATFORM_WEB, { type: 'text' });
            if (navigator.share) {
                await navigator.share({ title, text, url });
                return true;
            } else {
                showToast('Sharing not supported on this device', 'info');
                return false;
            }
        }
    } catch (error) {
        logger.error(LOG_EVENTS.SHARE_FAILED, { error: error.message });
        if (error.name !== 'AbortError') {
            showToast('Failed to share: ' + error.message, 'error');
        }
        return false;
    }
};

/**
 * Download CSV file
 * @param {string} csvContent - CSV content string
 * @param {string} filename - File name
 * @returns {Promise<boolean>} Success status
 */
export const downloadCSV = async (csvContent, filename) => {
    try {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

        if (isNativePlatform()) {
            logger.info(LOG_EVENTS.DOWNLOAD_PLATFORM_NATIVE, { filename, type: 'csv' });
            await writeFileNative(filename, blob, 'Documents');
            showToast(`Exported: ${filename}`, 'success');
            return true;
        } else {
            logger.info(LOG_EVENTS.DOWNLOAD_PLATFORM_WEB, { filename, type: 'csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast(`Exported: ${filename}`, 'success');
            return true;
        }
    } catch (error) {
        logger.error(LOG_EVENTS.INVOICE_DOWNLOAD_FAILED, { error: error.message, filename });
        showToast('Failed to export: ' + error.message, 'error');
        return false;
    }
};

/**
 * Download PDF blob
 * @param {Blob} pdfBlob - PDF blob
 * @param {string} filename - File name
 * @returns {Promise<boolean>} Success status
 */
export const downloadPDFBlob = async (pdfBlob, filename) => {
    try {
        if (isNativePlatform()) {
            logger.info(LOG_EVENTS.DOWNLOAD_PLATFORM_NATIVE, { filename });
            await writeFileNative(filename, pdfBlob, 'Documents');
            showToast(`Exported: ${filename}`, 'success');
            return true;
        } else {
            logger.info(LOG_EVENTS.DOWNLOAD_PLATFORM_WEB, { filename });
            const url = URL.createObjectURL(pdfBlob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast(`Exported: ${filename}`, 'success');
            return true;
        }
    } catch (error) {
        logger.error(LOG_EVENTS.INVOICE_DOWNLOAD_FAILED, { error: error.message, filename });
        showToast('Failed to export: ' + error.message, 'error');
        return false;
    }
};
</file>

<file path="next.config.mjs">
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'export',
  images: {
    unoptimized: true,
  },
  env: {
    // Build-time flag for Diagnostics feature
    // Set to 'true' to include diagnostics in the build
    NEXT_PUBLIC_ENABLE_DIAGNOSTICS: process.env.NEXT_PUBLIC_ENABLE_DIAGNOSTICS || '',
  },
};

export default nextConfig;
</file>

<file path="android/app/src/main/AndroidManifest.xml">
<?xml version="1.0" encoding="utf-8" ?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:usesCleartextTraffic="true"
        android:theme="@style/AppTheme">
        <activity
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|locale|smallestScreenSize|screenLayout|uiMode|navigation"
            android:name=".MainActivity"
            android:label="@string/title_activity_main"
            android:theme="@style/AppTheme.NoActionBarLaunch"
            android:launchMode="singleTask"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>

        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="${applicationId}.fileprovider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data android:name="android.support.FILE_PROVIDER_PATHS" android:resource="@xml/file_paths" />
        </provider>
    </application>

    <!-- Permissions -->

    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="android.permission.CAMERA" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" android:maxSdkVersion="32" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="29" />
</manifest>
</file>

<file path="src/api/backendClient.js">
/**
 * Centralized Backend API Client
 * 
 * All data operations must go through this layer.
 * Frontend must never cache backend data as authoritative.
 * 
 * Base URL is resolved dynamically from:
 * 1. Capacitor Preferences (mobile)
 * 2. localStorage (web fallback)
 */

import { Preferences } from '@capacitor/preferences';

// Request timeout in milliseconds
const REQUEST_TIMEOUT_MS = 7000;

/**
 * Normalize a URL to ensure it ends with /api
 * This prevents endpoint drift from misconfigured env vars or user input
 */
const normalizeApiBase = (url) => {
    if (!url) return null;
    let cleanUrl = url.trim();
    // Remove trailing slash
    if (cleanUrl.endsWith('/')) {
        cleanUrl = cleanUrl.slice(0, -1);
    }
    // Ensure /api suffix
    if (!cleanUrl.endsWith('/api')) {
        cleanUrl = `${cleanUrl}/api`;
    }
    return cleanUrl;
};

// API_BASE is NOT initialized at module load - must be set dynamically
let API_BASE = null;
let isConfigured = false;

// Connection Listeners
const connectionListeners = new Set();
const notifyConnectionLost = () => {
    connectionListeners.forEach(l => l());
};

export const onConnectionError = (callback) => {
    connectionListeners.add(callback);
    return () => connectionListeners.delete(callback);
};

/**
 * Get localStorage value (web fallback)
 */
const getLocalStorageApiBase = () => {
    if (typeof window !== 'undefined') {
        return localStorage.getItem('api_base_url');
    }
    return null;
};

/**
 * Set localStorage value (web fallback)
 */
const setLocalStorageApiBase = (url) => {
    if (typeof window !== 'undefined') {
        if (url) {
            localStorage.setItem('api_base_url', url);
        } else {
            localStorage.removeItem('api_base_url');
        }
    }
};

/**
 * Initialize API base URL from persistent storage
 * Must be called before any API requests
 * @returns {Promise<string|null>} The configured API base URL
 */
export const getApiBase = async () => {
    try {
        // Try Capacitor Preferences first (mobile)
        const { value } = await Preferences.get({ key: 'api_base_url' });
        if (value) {
            API_BASE = normalizeApiBase(value);
            isConfigured = true;
            return API_BASE;
        }
    } catch (e) {
        // Capacitor not available (web), fall through to localStorage
    }

    // Fallback to localStorage (web)
    const localValue = getLocalStorageApiBase();
    if (localValue) {
        API_BASE = normalizeApiBase(localValue);
        isConfigured = true;
        return API_BASE;
    }

    // No configuration found
    API_BASE = null;
    isConfigured = false;
    return null;
};

/**
 * Set API base URL to persistent storage
 * @param {string} url - The backend URL to set
 */
export const setApiBase = async (url) => {
    // Normalize: trim, ensure /api suffix
    const cleanUrl = normalizeApiBase(url);
    if (!cleanUrl) {
        throw new Error('Invalid URL');
    }
    // Ensure protocol
    if (!/^https?:\/\//i.test(cleanUrl)) {
        throw new Error('Invalid URL protocol');
    }

    try {
        // Try Capacitor Preferences first (mobile)
        await Preferences.set({ key: 'api_base_url', value: cleanUrl });
    } catch (e) {
        // Capacitor not available, use localStorage
    }

    // Also set localStorage as fallback
    setLocalStorageApiBase(cleanUrl);

    API_BASE = cleanUrl;
    isConfigured = true;
};

/**
 * Check if backend is configured
 */
export const isBackendConfigured = () => isConfigured;

/**
 * Get the current API base URL (synchronous, for internal use)
 * Returns null if not configured
 */
export const getCurrentApiBase = () => API_BASE;

// Token management
const getToken = () => {
    if (typeof window !== 'undefined') {
        return localStorage.getItem('auth_token');
    }
    return null;
};

export const setToken = (token) => {
    if (typeof window !== 'undefined') {
        if (token) {
            localStorage.setItem('auth_token', token);
        } else {
            localStorage.removeItem('auth_token');
        }
    }
};

export const clearToken = () => setToken(null);

/**
 * Generate a UUID v4 string.
 * 
 * IMPORTANT: Do NOT use crypto.randomUUID() directly in frontend code.
 * It is not supported in Android WebView / Capacitor environments and will
 * throw a runtime error, blocking the entire API client.
 * 
 * This helper uses crypto.randomUUID() when available (modern browsers),
 * and falls back to a Math.random-based RFC-4122 v4 generator otherwise.
 * 
 * @returns {string} A UUID v4 string (e.g., "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx")
 */
const generateUUID = () => {
    // Use native crypto.randomUUID if available (not in Android WebView)
    if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {
        try {
            return crypto.randomUUID();
        } catch (e) {
            // Fall through to fallback
        }
    }

    // Fallback: Math.random-based RFC-4122 v4 UUID generator
    // Works in all environments including Android WebView / Capacitor
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
        const r = (Math.random() * 16) | 0;
        const v = c === 'x' ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
};

// Alias for semantic clarity in API calls
const generateRequestId = generateUUID;

/**
 * Custom API Error class
 */
export class ApiError extends Error {
    constructor(message, status, details, requestId) {
        super(message);
        this.name = 'ApiError';
        this.status = status;
        this.details = details;
        this.requestId = requestId;
    }
}

/**
 * Core request function with error handling and timeout
 */
async function request(method, endpoint, data = null, options = {}) {
    // Ensure API_BASE is configured
    if (!API_BASE) {
        // Try to load it dynamically
        await getApiBase();
        if (!API_BASE) {
            throw new ApiError('Backend URL not configured. Please configure the server connection.', 0, null);
        }
    }

    const url = `${API_BASE}${endpoint}`;

    const headers = {
        'Content-Type': 'application/json',
    };

    // Attach JWT token if available
    const token = getToken();
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }

    // Add idempotency key for mutative operations
    if (method === 'POST' || method === 'PUT') {
        headers['X-Request-Id'] = options.requestId || generateRequestId();
    }

    const config = {
        method,
        headers,
    };

    if (data && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
        config.body = JSON.stringify(data);
    }

    // Create AbortController for timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);
    config.signal = controller.signal;

    try {
        const response = await fetch(url, config);
        clearTimeout(timeoutId);

        // Handle 401 Unauthorized - clear token and throw error
        if (response.status === 401) {
            clearToken();
            throw new ApiError('Unauthorized', 401, null);
        }

        // Handle other errors
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new ApiError(
                errorData.error || `Request failed with status ${response.status}`,
                response.status,
                errorData.details || null,
                errorData.requestId
            );
        }

        // Handle 204 No Content
        if (response.status === 204) {
            return null;
        }

        return await response.json();
    } catch (error) {
        clearTimeout(timeoutId);

        if (error instanceof ApiError) {
            throw error;
        }

        // Handle timeout (AbortError)
        if (error.name === 'AbortError') {
            console.error('API Request Timeout:', url);
            notifyConnectionLost();
            throw new ApiError(
                'Request timed out - server may be unreachable',
                0,
                null
            );
        }

        // Network error or other fetch error
        console.error('API Request Failed:', error);
        notifyConnectionLost();

        throw new ApiError(
            error.message || 'Network error - backend may be unavailable',
            0,
            null
        );
    }
}

/**
 * API Client with all endpoints
 */
export const api = {
    // Utilities
    init: getApiBase,
    setApiBase,
    onConnectionError,
    getCurrentApiBase,

    // Raw request methods
    get: (endpoint) => request('GET', endpoint),
    post: (endpoint, data, options) => request('POST', endpoint, data, options),
    put: (endpoint, data, options) => request('PUT', endpoint, data, options),
    patch: (endpoint, data, options) => request('PATCH', endpoint, data, options),
    delete: (endpoint) => request('DELETE', endpoint),

    // Health check - checks CURRENT base URL with timeout
    health: async () => {
        if (!API_BASE) {
            await getApiBase();
            if (!API_BASE) {
                return false;
            }
        }
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);
        try {
            const response = await fetch(`${API_BASE.replace('/api', '')}/health`, {
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            return response.ok;
        } catch (e) {
            clearTimeout(timeoutId);
            return false;
        }
    },

    // Setup APIs (no auth required - for initial shop bootstrap)
    setup: {
        status: () => api.get('/setup/status'),
        bootstrap: (data) => api.post('/setup/bootstrap', data),
    },

    // Authentication & User Management
    auth: {
        requestOTP: (phone) => api.post('/auth/request-otp', { phone }),
        login: (credentials) => api.post('/auth/login', credentials),
        me: () => api.get('/auth/me'),
        logout: () => {
            clearToken();
            return Promise.resolve();
        },
        // User management (ADMIN only)
        listUsers: () => api.get('/auth/users'),
        createUser: (data) => api.post('/auth/users', data),
    },

    // Invoices
    invoices: {
        list: () => api.get('/invoices'),
        get: (id) => api.get(`/invoices/${id}`),
        create: (data) => api.post('/invoices', data),
        update: (id, data) => api.put(`/invoices/${id}`, data),
        delete: (id) => api.delete(`/invoices/${id}`),
        uploadPhoto: async (id, file) => {
            if (!API_BASE) {
                await getApiBase();
                if (!API_BASE) {
                    throw new ApiError('Backend URL not configured', 0, null);
                }
            }
            const formData = new FormData();
            formData.append('photo', file);
            const token = getToken();

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS * 3); // Longer timeout for uploads

            try {
                const response = await fetch(`${API_BASE}/invoices/${id}/photos`, {
                    method: 'POST',
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                    body: formData,
                    signal: controller.signal,
                });
                clearTimeout(timeoutId);
                if (!response.ok) throw new ApiError('Failed to upload photo', response.status);
                return response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new ApiError('Upload timed out', 0, null);
                }
                throw error;
            }
        },
    },

    // Customers
    customers: {
        list: () => api.get('/customers'),
        get: (id) => api.get(`/customers/${id}`),
        create: (data) => api.post('/customers', data),
        update: (id, data) => api.put(`/customers/${id}`, data),
        delete: (id) => api.delete(`/customers/${id}`),
    },

    // Vendors
    vendors: {
        list: () => api.get('/vendors'),
        get: (id) => api.get(`/vendors/${id}`),
        create: (data) => api.post('/vendors', data),
        update: (id, data) => api.put(`/vendors/${id}`, data),
        delete: (id) => api.delete(`/vendors/${id}`),
    },

    // Products
    products: {
        list: (filters = {}) => {
            const params = new URLSearchParams(filters).toString();
            return api.get(`/products${params ? `?${params}` : ''}`);
        },
        get: (id) => api.get(`/products/${id}`),
        create: (data) => api.post('/products', data),
        update: (id, data) => api.put(`/products/${id}`, data),
        delete: (id) => api.delete(`/products/${id}`),

        // Image operations - managed separately from product CRUD
        images: {
            /**
             * Upload an image to a product
             * @param {string} productId - Product ID
             * @param {File} file - Image file to upload
             * @returns {Promise<{id: string, url: string, createdAt: string}>}
             */
            upload: async (productId, file) => {
                if (!API_BASE) {
                    await getApiBase();
                    if (!API_BASE) {
                        throw new ApiError('Backend URL not configured', 0, null);
                    }
                }
                const formData = new FormData();
                formData.append('image', file); // Field name MUST be 'image' per API spec
                const token = getToken();

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS * 3); // Longer timeout for uploads

                try {
                    const response = await fetch(`${API_BASE}/products/${productId}/images`, {
                        method: 'POST',
                        headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                        body: formData,
                        signal: controller.signal,
                    });
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new ApiError(
                            errorData.error || 'Failed to upload image',
                            response.status,
                            errorData.details
                        );
                    }
                    return response.json();
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new ApiError('Upload timed out', 0, null);
                    }
                    throw error;
                }
            },

            /**
             * Delete an image from a product
             * @param {string} productId - Product ID
             * @param {string} imageId - Image ID to delete
             */
            delete: (productId, imageId) => api.delete(`/products/${productId}/images/${imageId}`),
        },
    },

    // Purchases
    purchases: {
        list: (filters = {}) => {
            const params = new URLSearchParams(filters).toString();
            return api.get(`/purchases${params ? `?${params}` : ''}`);
        },
        get: (id) => api.get(`/purchases/${id}`),
        create: (data) => api.post('/purchases', data),
        update: (id, data) => api.put(`/purchases/${id}`, data),
        delete: (id) => api.delete(`/purchases/${id}`),
    },

    // Payments
    payments: {
        list: () => api.get('/payments'),
        listByParty: (partyId) => api.get(`/payments?partyId=${partyId}`),
        get: (id) => api.get(`/payments/${id}`),
        create: (data) => api.post('/payments', data),
        delete: (id) => api.delete(`/payments/${id}`),
    },

    // Categories & Subcategories
    categories: {
        list: () => api.get('/categories'),
        get: (id) => api.get(`/categories/${id}`),
        create: (data) => api.post('/categories', data),
        update: (id, data) => api.put(`/categories/${id}`, data),
        delete: (id) => api.delete(`/categories/${id}`),
        addSubcategory: (categoryId, data) => api.post(`/categories/${categoryId}/subcategories`, data),
        deleteSubcategory: (categoryId, subcategoryId) =>
            api.delete(`/categories/${categoryId}/subcategories/${subcategoryId}`),
    },

    // Settings
    settings: {
        get: () => api.get('/settings'),
        update: (key, value) => api.put(`/settings/${key}`, { value }),
    },

    // Attendance
    attendance: {
        login: (userId) => api.post('/attendance/login', { userId }),
        logout: (logId) => api.post('/attendance/logout', { logId }),
        getHistory: (userId, limit = 30) => api.get(`/attendance/user/${userId}?limit=${limit}`),
        getByDate: (userId, date) => api.get(`/attendance/user/${userId}/date/${date}`),
        getAllByDate: (date) => api.get(`/attendance/date/${date}`),
    },

    // Photos
    photos: {
        getUrl: (id) => `${API_BASE}/photos/${id}`,
        /**
         * Convert a relative API URL to an absolute URL
         * Handles URLs like "/api/photos/..." returned from the backend
         * @param {string} relativeUrl - Relative URL from API response
         * @returns {string} Full URL with backend host
         */
        getFullUrl: (relativeUrl) => {
            if (!relativeUrl) return '';
            // If already absolute, return as-is
            if (relativeUrl.startsWith('http://') || relativeUrl.startsWith('https://')) {
                return relativeUrl;
            }
            // Get the base URL without /api suffix
            const baseHost = API_BASE ? API_BASE.replace('/api', '') : '';
            // Handle relative URLs that start with /api
            if (relativeUrl.startsWith('/api/')) {
                return `${baseHost}${relativeUrl}`;
            }
            // Handle relative URLs that start with /
            if (relativeUrl.startsWith('/')) {
                return `${baseHost}${relativeUrl}`;
            }
            return relativeUrl;
        },
    },

    // Expenses (if endpoint exists)
    expenses: {
        list: () => api.get('/expenses'),
        get: (id) => api.get(`/expenses/${id}`),
        create: (data) => api.post('/expenses', data),
        update: (id, data) => api.put(`/expenses/${id}`, data),
        delete: (id) => api.delete(`/expenses/${id}`),
    },

    // Audit logs (if endpoint exists)
    auditLogs: {
        create: (data) => api.post('/audit-logs', data),
    },

    // Operations (Backup)
    ops: {
        /**
         * Create a new backup of the database and file storage
         * @returns {Promise<{success: boolean, filename: string, sizeBytes: number, createdAt: string}>}
         * @throws {ApiError} 409 if backup already in progress
         */
        createBackup: () => api.post('/ops/backup'),

        /**
         * Get download URL for a backup file
         * @param {string} filename - Backup filename from createBackup response
         * @returns {string} Full URL for downloading the backup
         */
        downloadBackup: (filename) => {
            if (!API_BASE) {
                throw new Error('Backend URL not configured');
            }
            return `${API_BASE}/ops/backup/${filename}`;
        },

        /**
         * Restore database and files from a backup ZIP
         * @param {File} file - ZIP file to restore from
         * @returns {Promise<{success: boolean, restartRequired: boolean, photosRestored: number, emergencyBackupPath: string, restoredAt: string}>}
         * @throws {ApiError} 403 if not admin, 409 if restore in progress, 415 if not ZIP
         */
        restoreBackup: async (file) => {
            if (!API_BASE) {
                await getApiBase();
                if (!API_BASE) {
                    throw new ApiError('Backend URL not configured', 0, null);
                }
            }
            const formData = new FormData();
            formData.append('backup', file);
            const token = getToken();

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 min timeout for large files

            try {
                const response = await fetch(`${API_BASE}/ops/restore`, {
                    method: 'POST',
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                    body: formData,
                    signal: controller.signal,
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new ApiError(
                        errorData.error || 'Restore failed',
                        response.status,
                        errorData.details
                    );
                }
                return response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new ApiError('Restore timed out', 0, null);
                }
                throw error;
            }
        },
    },

    // Home snapshot
    home: {
        snapshot: () => api.get('/home/snapshot'),
    },
};

export default api;
</file>

<file path="src/app/parties/customer/add/page.js">
'use client';

import { useState } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import Link from 'next/link';
import { usePartyStore } from '@/lib/store/partyStore';
import { useInvoiceStore } from '@/lib/store/invoiceStore';
import { FiArrowLeft, FiPlusCircle, FiUpload, FiX } from 'react-icons/fi';
import styles from '../../form.module.css';

export default function AddCustomerPage() {
    const router = useRouter();
    const { addCustomer } = usePartyStore();
    const [formData, setFormData] = useState({
        name: '',
        phone: '',
        email: '',
        address: '',
        documents: []
    });
    const [showBillingAddress, setShowBillingAddress] = useState(false);

    const handleFileChange = (e) => {
        const files = Array.from(e.target.files);

        files.forEach(file => {
            const reader = new FileReader();
            reader.onloadend = () => {
                setFormData(prev => ({
                    ...prev,
                    documents: [...prev.documents, {
                        name: file.name,
                        type: file.type,
                        data: reader.result
                    }]
                }));
            };
            reader.readAsDataURL(file);
        });
    };

    const removeDocument = (index) => {
        setFormData(prev => ({
            ...prev,
            documents: prev.documents.filter((_, i) => i !== index)
        }));
    };

    const searchParams = useSearchParams();
    const returnUrl = searchParams.get('returnUrl');
    const { setCustomer } = useInvoiceStore();

    const handleSave = async () => {
        if (!formData.name) return alert('Name is required');
        if (formData.phone && formData.phone.length !== 10) return alert('Phone number must be 10 digits');
        const id = await addCustomer(formData);

        if (returnUrl) {
            // If returning to invoice, set the new customer as selected
            if (returnUrl.includes('invoice')) {
                setCustomer({ ...formData, id });
            }
            router.push(returnUrl);
        } else {
            router.push('/parties');
        }
    };

    return (
        <div className={styles.container}>
            <div className={styles.header}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                    <Link href="/parties"><FiArrowLeft size={24} /></Link>
                    Add Customer
                </div>
            </div>

            <div className={styles.sectionLabel}>Basic Details</div>
            <div className={styles.card}>
                <input
                    className={styles.input}
                    placeholder="Name *"
                    value={formData.name}
                    onChange={e => setFormData({ ...formData, name: e.target.value })}
                    style={{ marginBottom: 12 }}
                />
                <div className={styles.row} style={{ marginBottom: 12 }}>
                    <div style={{ padding: 12, background: '#f9fafb', border: '1px solid #e5e7eb', borderRadius: 8 }}>🇮🇳 +91</div>
                    <input
                        className={styles.input}
                        placeholder="Enter Phone Number"
                        value={formData.phone}
                        onChange={e => {
                            const value = e.target.value.replace(/\D/g, '').slice(0, 10);
                            setFormData({ ...formData, phone: value });
                        }}
                    />
                </div>
                <input
                    className={styles.input}
                    placeholder="Email"
                    value={formData.email}
                    onChange={e => setFormData({ ...formData, email: e.target.value })}
                />
            </div>

            <div className={styles.sectionLabel}>Billing Address (Optional)</div>
            <div className={styles.card}>
                {!showBillingAddress ? (
                    <div className={styles.actionRow} onClick={() => setShowBillingAddress(true)}>
                        <FiPlusCircle size={20} color="#6b7280" />
                        <span>Billing Address</span>
                    </div>
                ) : (
                    <textarea
                        className={styles.textarea}
                        placeholder="Enter Billing Address"
                        value={formData.address}
                        onChange={e => setFormData({ ...formData, address: e.target.value })}
                        autoFocus
                    />
                )}
            </div>

            <div className={styles.sectionLabel}>Documents (Optional)</div>
            <div className={styles.card}>
                <label className={styles.uploadBox}>
                    <input
                        type="file"
                        multiple
                        accept="image/*,application/pdf"
                        style={{ display: 'none' }}
                        onChange={handleFileChange}
                    />
                    <FiUpload className={styles.uploadIcon} />
                    <span className={styles.uploadText}>Upload Identity Documents (Image/PDF)</span>
                </label>

                {formData.documents.length > 0 && (
                    <div className={styles.fileList}>
                        {formData.documents.map((doc, index) => (
                            <div key={index} className={styles.fileItem}>
                                <span>{doc.name}</span>
                                <FiX
                                    style={{ cursor: 'pointer', color: '#ef4444' }}
                                    onClick={() => removeDocument(index)}
                                />
                            </div>
                        ))}
                    </div>
                )}
            </div>

            <div className={styles.footer}>
                <button className={styles.saveButton} onClick={handleSave}>Add Customer</button>
            </div>
        </div>
    );
}
</file>

<file path="src/app/parties/vendor/view/page.js">
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { usePartyStore } from '@/lib/store/partyStore';
import { usePurchaseStore } from '@/lib/store/purchaseStore';
import { api } from '@/api/backendClient';
import { shareText, downloadCSV, downloadPDFBlob } from '@/lib/utils/invoiceActions';
import { FiArrowLeft, FiPhone, FiMail, FiShare2, FiMessageCircle, FiEdit2, FiMoreHorizontal, FiFileText, FiFile, FiPlusSquare, FiGitMerge, FiTrash2 } from 'react-icons/fi';
import { motion, AnimatePresence } from 'framer-motion';
import { TransactionCard } from '@/components/TransactionCard';
import jsPDF from 'jspdf';

function VendorLedgerContent() {
    const router = useRouter();
    const searchParams = useSearchParams();
    const id = searchParams.get('id');
    const { getVendor, deleteVendor } = usePartyStore();
    const { purchases, loadPurchases } = usePurchaseStore ? usePurchaseStore() : { purchases: [], loadPurchases: () => { } };

    const [vendor, setVendor] = useState(null);
    const [transactions, setTransactions] = useState([]);
    const [activeTab, setActiveTab] = useState('ledger');
    const [isMenuOpen, setIsMenuOpen] = useState(false);

    const handleWhatsApp = () => {
        if (vendor.phone) {
            const cleanNumber = vendor.phone.replace(/\D/g, '');
            window.open(`https://wa.me/${cleanNumber}`, '_blank');
        } else {
            alert('Phone number not available');
        }
    };

    const handleCall = () => {
        if (vendor.phone) {
            window.open(`tel:${vendor.phone}`, '_self');
        } else {
            alert('Phone number not available');
        }
    };

    const handleEmail = () => {
        if (vendor.email) {
            window.open(`mailto:${vendor.email}`, '_self');
        } else {
            alert('Email not available');
        }
    };

    const handleShare = async () => {
        await shareText({
            title: 'Vendor Details',
            text: `Vendor: ${vendor.name}\nPhone: ${vendor.phone || 'N/A'}\nBalance: ₹${vendor.balance?.toFixed(2) || '0.00'}`,
            dialogTitle: 'Share Vendor Details'
        });
    };

    const handleDownloadExcel = async () => {
        const data = transactions.map(tx => ({
            Date: new Date(tx.date).toLocaleDateString(),
            Type: tx.type,
            Number: tx.number,
            Amount: tx.amount,
            Status: tx.status
        }));

        if (!data || !data.length) {
            alert('No transactions to export');
            return;
        }

        const headers = Object.keys(data[0]);
        const csvContent = [
            headers.join(','),
            ...data.map(row => headers.map(fieldName => {
                const value = row[fieldName];
                return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
            }).join(','))
        ].join('\n');

        await downloadCSV(csvContent, `${vendor.name}_ledger.csv`);
        setIsMenuOpen(false);
    };

    const handleDownloadPDF = async () => {
        const doc = new jsPDF();

        doc.setFontSize(20);
        doc.text(vendor.name, 14, 22);
        doc.setFontSize(12);
        doc.text(`Phone: ${vendor.phone || 'N/A'}`, 14, 30);
        doc.text(`Balance: ${vendor.balance?.toFixed(2)}`, 14, 38);

        let y = 50;
        doc.setFontSize(10);
        doc.setTextColor(100);
        doc.text('Date', 14, y);
        doc.text('Type', 60, y);
        doc.text('Number', 100, y);
        doc.text('Amount', 150, y);
        doc.text('Balance', 180, y);
        doc.line(14, y + 2, 200, y + 2);
        y += 10;
        doc.setTextColor(0);

        transactions.forEach(tx => {
            if (y > 280) { doc.addPage(); y = 20; }
            doc.text(new Date(tx.date).toLocaleDateString(), 14, y);
            doc.text(tx.type === 'payment_out' ? 'Payment Out' : tx.type === 'payment_in' ? 'Payment In' : 'Purchase', 60, y);
            doc.text(tx.number, 100, y);
            doc.text(tx.amount.toFixed(2), 150, y);
            doc.text(tx.balance !== undefined ? tx.balance.toFixed(2) : '-', 180, y);
            y += 8;
        });

        const pdfBlob = doc.output('blob');
        await downloadPDFBlob(pdfBlob, `${vendor.name}_ledger.pdf`);
        setIsMenuOpen(false);
    };

    const handleDeleteVendor = async () => {
        if (confirm('Are you sure you want to delete this vendor? This action cannot be undone.')) {
            await deleteVendor(vendor.id);
            router.push('/parties');
        }
    };

    const menuItemStyle = {
        display: 'flex', alignItems: 'center', gap: '12px', padding: '12px',
        fontSize: '16px', fontWeight: 500, color: '#374151', cursor: 'pointer',
        borderRadius: '8px', transition: 'background 0.2s'
    };

    useEffect(() => {
        if (id) {
            const v = getVendor(id);
            if (v) setVendor(v);
            if (loadPurchases) loadPurchases();
        }
    }, [id]);

    useEffect(() => {
        const loadData = async () => {
            if (vendor) {
                // Get Purchases from 'purchases' table (vendor invoices)
                const allPurchaseRecords = purchases?.filter(p =>
                    p.vendorId === vendor.id || p.vendor?.id === vendor.id
                ) || [];

                // Get Payments directly from backend API
                let vendorPayments = [];
                try {
                    vendorPayments = await api.payments.listByParty(vendor.id);
                    console.log('[VendorView] Payments from API:', vendorPayments);
                } catch (err) {
                    console.error('[VendorView] Failed to fetch payments:', err);
                }

                const purchaseTxs = allPurchaseRecords.map(p => ({
                    id: `pur-${p.id}`,
                    date: p.date,
                    type: 'purchase',
                    number: p.purchaseNumber,
                    amount: p.totals?.total || 0,
                    status: p.status || 'Unpaid',
                    balance: p.balanceDue !== undefined ? p.balanceDue : (p.totals?.total || 0),
                    data: p
                }));

                const paymentTxs = vendorPayments.map(pay => ({
                    id: `pay-${pay.id}`,
                    date: pay.date,
                    type: pay.type === 'OUT' ? 'payment_out' : 'payment_in',
                    number: pay.transactionNumber,
                    amount: pay.amount,
                    status: 'Paid',
                    balance: 0,
                    data: pay
                }));

                const allTxs = [...purchaseTxs, ...paymentTxs];
                allTxs.sort((a, b) => new Date(b.date) - new Date(a.date));
                setTransactions(allTxs);
            }
        };
        loadData();
    }, [vendor, purchases]);

    if (!vendor) return <div>Loading...</div>;

    return (
        <div style={{ background: '#f3f4f6', minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
            {/* Header */}
            <div style={{ background: 'white', padding: '16px', borderBottom: '1px solid #eee' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                    <FiArrowLeft size={24} onClick={() => router.back()} style={{ cursor: 'pointer' }} />
                    <div style={{ display: 'flex', gap: '16px', position: 'relative' }}>
                        <FiMoreHorizontal size={24} onClick={() => setIsMenuOpen(true)} style={{ cursor: 'pointer' }} />
                    </div>
                </div>

                {/* Menu Bottom Sheet */}
                <AnimatePresence>
                    {isMenuOpen && (
                        <>
                            <motion.div
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                exit={{ opacity: 0 }}
                                onClick={() => setIsMenuOpen(false)}
                                style={{
                                    position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', zIndex: 40
                                }}
                            />
                            <motion.div
                                initial={{ y: '100%' }}
                                animate={{ y: 0 }}
                                exit={{ y: '100%' }}
                                transition={{ type: 'spring', damping: 25, stiffness: 300 }}
                                style={{
                                    position: 'fixed', bottom: 0, left: 0, right: 0,
                                    background: 'white', borderTopLeftRadius: '20px', borderTopRightRadius: '20px',
                                    padding: '20px', zIndex: 50, maxHeight: '80vh', overflowY: 'auto'
                                }}
                            >
                                <div style={{ width: '40px', height: '4px', background: '#e5e7eb', borderRadius: '2px', margin: '0 auto 20px' }} />

                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                    <div onClick={() => { setIsMenuOpen(false); router.push(`/parties/vendor/edit?id=${vendor.id}`); }} style={menuItemStyle}>
                                        <FiEdit2 size={20} /> Edit Vendor
                                    </div>
                                    <div style={{ height: '1px', background: '#f3f4f6', margin: '4px 0' }} />

                                    <div onClick={handleDownloadExcel} style={menuItemStyle}>
                                        <FiFileText size={20} /> Download Ledger Excel
                                    </div>
                                    <div onClick={handleDownloadPDF} style={menuItemStyle}>
                                        <FiFile size={20} /> Download Ledger Pdf
                                    </div>
                                    <div style={{ height: '1px', background: '#f3f4f6', margin: '4px 0' }} />

                                    <div onClick={() => { setIsMenuOpen(false); router.push(`/purchase/create?vendorId=${vendor.id}`); }} style={menuItemStyle}>
                                        <FiPlusSquare size={20} /> Create Purchase Order
                                    </div>
                                    <div style={{ height: '1px', background: '#f3f4f6', margin: '4px 0' }} />

                                    <div onClick={() => alert('Merge functionality coming soon')} style={menuItemStyle}>
                                        <FiGitMerge size={20} /> Merge
                                    </div>
                                    <div style={{ height: '1px', background: '#f3f4f6', margin: '4px 0' }} />

                                    <div onClick={handleDeleteVendor} style={{ ...menuItemStyle, color: '#dc2626' }}>
                                        <FiTrash2 size={20} /> Delete Vendor
                                    </div>
                                </div>
                            </motion.div>
                        </>
                    )}
                </AnimatePresence>

                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '24px' }}>
                    <div style={{
                        width: '64px', height: '64px', borderRadius: '50%', background: '#fef3c7',
                        color: '#92400e', display: 'flex', alignItems: 'center', justifyContent: 'center',
                        fontSize: '24px', fontWeight: 'bold', marginBottom: '12px'
                    }}>
                        {vendor.name[0]}
                    </div>
                    <div style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '4px' }}>{vendor.name}</div>
                    <div style={{ fontSize: '16px', color: vendor.balance > 0 ? '#dc2626' : '#16a34a', fontWeight: 600 }}>
                        ₹ {Math.abs(vendor.balance || 0).toFixed(2)}
                        <span style={{ fontSize: '12px', marginLeft: '4px' }}>
                            {(vendor.balance || 0) > 0 ? '(You owe)' : (vendor.balance || 0) < 0 ? '(They owe)' : ''}
                        </span>
                    </div>
                </div>

                <div style={{ display: 'flex', justifyContent: 'space-around', paddingBottom: '8px' }}>
                    <div onClick={handleWhatsApp} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', cursor: 'pointer' }}>
                        <div style={{ padding: '10px', borderRadius: '50%', border: '1px solid #eee' }}><FiMessageCircle size={20} color="#2563eb" /></div>
                        <span style={{ fontSize: '12px', color: '#666' }}>WhatsApp</span>
                    </div>
                    <div onClick={handleCall} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', cursor: 'pointer' }}>
                        <div style={{ padding: '10px', borderRadius: '50%', border: '1px solid #eee' }}><FiPhone size={20} color="#2563eb" /></div>
                        <span style={{ fontSize: '12px', color: '#666' }}>Call</span>
                    </div>
                    <div onClick={handleEmail} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', cursor: 'pointer' }}>
                        <div style={{ padding: '10px', borderRadius: '50%', border: '1px solid #eee' }}><FiMail size={20} color="#2563eb" /></div>
                        <span style={{ fontSize: '12px', color: '#666' }}>Mail</span>
                    </div>
                    <div onClick={handleShare} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', cursor: 'pointer' }}>
                        <div style={{ padding: '10px', borderRadius: '50%', border: '1px solid #eee' }}><FiShare2 size={20} color="#2563eb" /></div>
                        <span style={{ fontSize: '12px', color: '#666' }}>Share</span>
                    </div>
                </div>
            </div>

            {/* Tabs */}
            <div style={{ background: 'white', display: 'flex', borderBottom: '1px solid #eee' }}>
                <div
                    onClick={() => setActiveTab('ledger')}
                    style={{
                        flex: 1, textAlign: 'center', padding: '16px', fontWeight: 600, cursor: 'pointer',
                        color: activeTab === 'ledger' ? '#2563eb' : '#6b7280',
                        borderBottom: activeTab === 'ledger' ? '2px solid #2563eb' : 'none'
                    }}
                >
                    Ledger
                </div>
                <div
                    onClick={() => setActiveTab('transactions')}
                    style={{
                        flex: 1, textAlign: 'center', padding: '16px', fontWeight: 600, cursor: 'pointer',
                        color: activeTab === 'transactions' ? '#2563eb' : '#6b7280',
                        borderBottom: activeTab === 'transactions' ? '2px solid #2563eb' : 'none'
                    }}
                >
                    Transactions
                </div>
            </div>

            {/* List */}
            <div style={{ flex: 1, overflowY: 'auto', paddingBottom: '80px' }}>
                {transactions.length === 0 ? (
                    <div style={{ textAlign: 'center', padding: '40px', color: '#9ca3af' }}>No transactions found</div>
                ) : (
                    transactions.map(tx => (
                        <TransactionCard
                            key={tx.id}
                            transaction={tx}
                            onClick={() => { }}
                        />
                    ))
                )}
            </div>

            {/* Footer Actions */}
            <div style={{
                position: 'fixed', bottom: 0, left: 0, right: 0, background: 'white', padding: '16px',
                display: 'flex', gap: '16px', boxShadow: '0 -2px 10px rgba(0,0,0,0.05)'
            }}>
                <button
                    onClick={() => router.push(`/parties/payment/create?vendorId=${vendor.id}&partyType=vendor&mode=out`)}
                    style={{
                        flex: 1, background: '#dc2626', color: 'white', padding: '16px', borderRadius: '8px',
                        border: 'none', fontWeight: 'bold', fontSize: '16px', cursor: 'pointer'
                    }}>
                    YOU GAVE ₹
                </button>
                <button
                    onClick={() => router.push(`/parties/payment/create?vendorId=${vendor.id}&partyType=vendor&mode=in`)}
                    style={{
                        flex: 1, background: '#16a34a', color: 'white', padding: '16px', borderRadius: '8px',
                        border: 'none', fontWeight: 'bold', fontSize: '16px', cursor: 'pointer'
                    }}>
                    YOU GOT ₹
                </button>
            </div>
        </div>
    );
}

export default function VendorLedgerPage() {
    return (
        <Suspense fallback={<div>Loading...</div>}>
            <VendorLedgerContent />
        </Suspense>
    );
}
</file>

<file path="src/app/parties/page.js">
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { usePartyStore } from '@/lib/store/partyStore';
import { FiUsers, FiFilter, FiPlus } from 'react-icons/fi';
import { PartyListItem } from '@/components/PartyListItem';
import styles from './page.module.css';

export default function PartiesPage() {
    const router = useRouter();
    const [activeTab, setActiveTab] = useState('customers');
    const { customers, vendors, loadParties } = usePartyStore();

    useEffect(() => {
        loadParties();
    }, []);

    const currentList = activeTab === 'customers' ? customers : vendors;

    // Calculate totals (ensure balance is a number)
    const totalCollect = customers.reduce((acc, c) => {
        const balance = Number(c.balance) || 0;
        return acc + (balance > 0 ? balance : 0);
    }, 0);
    const totalPay = customers.reduce((acc, c) => {
        const balance = Number(c.balance) || 0;
        return acc + (balance < 0 ? Math.abs(balance) : 0);
    }, 0);

    return (
        <div className={styles.container}>
            {/* Sticky Header Container */}
            <div style={{ position: 'sticky', top: 0, zIndex: 10, background: '#f3f4f6' }}>
                {/* Tabs */}
                <div className={styles.tabs}>
                    <div
                        className={`${styles.tab} ${activeTab === 'customers' ? styles.activeTab : ''}`}
                        onClick={() => setActiveTab('customers')}
                    >
                        Customers
                    </div>
                    <div
                        className={`${styles.tab} ${activeTab === 'vendors' ? styles.activeTab : ''}`}
                        onClick={() => setActiveTab('vendors')}
                    >
                        Vendors
                    </div>
                    <div style={{ marginLeft: 'auto', display: 'flex', alignItems: 'center', gap: '16px' }}>
                        <FiUsers size={20} color="#6b7280" />
                        <FiFilter size={20} color="#6b7280" />
                    </div>
                </div>

                {/* Summary Row */}
                <div className={styles.summaryRow}>
                    <div className={`${styles.summaryCard} ${styles.collectCard}`}>
                        <span className={styles.summaryLabel}>You Collect:</span>
                        <span className={styles.summaryAmount} style={{ color: '#16a34a' }}>₹ {totalCollect.toFixed(2)}</span>
                    </div>
                    <div className={`${styles.summaryCard} ${styles.payCard}`}>
                        <span className={styles.summaryLabel}>You Pay:</span>
                        <span className={styles.summaryAmount} style={{ color: '#dc2626' }}>₹ {totalPay.toFixed(2)}</span>
                    </div>
                </div>

                {/* Sort/Filter Row */}
                <div style={{ padding: '0 16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                    <div style={{ fontWeight: 600, color: '#111827', display: 'flex', gap: '16px' }}>
                        <span>Sort</span>
                        <span style={{ fontWeight: 700 }}>Default</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '4px', color: '#111827', fontWeight: 600 }}>
                        <FiFilter size={16} /> Filter
                    </div>
                </div>
            </div>

            {currentList.length === 0 ? (
                <div className={styles.emptyState}>
                    <FiUsers className={styles.emptyIcon} />
                    <div className={styles.emptyText}>
                        No {activeTab} to show
                    </div>
                    <Link href={`/parties/${activeTab === 'customers' ? 'customer' : 'vendor'}/add`} style={{ width: '100%' }}>
                        <button className={styles.addButton}>
                            Add {activeTab === 'customers' ? 'Customer' : 'Vendor'}
                        </button>
                    </Link>
                </div>
            ) : (
                <div className={styles.list}>
                    {currentList.map((item) => (
                        <PartyListItem
                            key={item.id}
                            party={item}
                            onClick={() => router.push(`/parties/${activeTab === 'customers' ? 'customer' : 'vendor'}/view?id=${item.id}`)}
                        />
                    ))}
                </div>
            )}

            <Link href={`/parties/${activeTab === 'customers' ? 'customer' : 'vendor'}/add`}>
                <button
                    style={{
                        position: 'fixed',
                        bottom: 90,
                        right: 16,
                        background: 'linear-gradient(90deg, #FBBF24 0%, #F59E0B 100%)',
                        color: 'white',
                        padding: '14px 20px',
                        borderRadius: '50px',
                        border: 'none',
                        boxShadow: '0 10px 25px -5px rgba(245, 194, 66, 0.5)',
                        fontWeight: 700,
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        zIndex: 40,
                        fontSize: '14px',
                        textTransform: 'uppercase'
                    }}
                >
                    <FiPlus size={20} /> {activeTab === 'customers' ? 'NEW CUSTOMER' : 'NEW VENDOR'}
                </button>
            </Link>
        </div>
    );
}
</file>

<file path="src/app/products/page.module.css">
.container {
    background-color: #f8fafc;
    min-height: 100vh;
    padding-bottom: 80px;
    /* Space for bottom nav */
}

.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    /* Adjusted for icon on right if needed */
    padding: 16px;
    background: white;
    /* border-bottom: 1px solid #f3f4f6; Removed to blend with search area if needed, but safe to keep */
}

.headerLeft {
    display: flex;
    align-items: center;
    gap: 12px;
}

.headerTitle {
    font-size: 18px;
    font-weight: 600;
    color: #111827;
}

.menuIcon {
    color: #374151;
    cursor: pointer;
}

.headerActions {
    display: flex;
    gap: 16px;
    color: #374151;
}

/* Search Bar */
.searchContainer {
    padding: 0 16px 12px;
    background: white;
    border-bottom: 1px solid #f3f4f6;
}

.searchBar {
    display: flex;
    align-items: center;
    background-color: #f9fafb;
    /* Light grey */
    border: 1px solid #e5e7eb;
    border-radius: 24px;
    /* Pill shape */
    padding: 10px 16px;
    gap: 8px;
}

.searchInput {
    border: none;
    background: transparent;
    outline: none;
    width: 100%;
    font-size: 15px;
    color: #1f2937;
}

.searchInput::placeholder {
    color: #9ca3af;
}

.filterSection {
    background: white;
    z-index: 20;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 12px;
    padding: 16px;
}

@media (min-width: 640px) {
    .grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 16px;
    }
}

.emptyState {
    padding: 40px;
    text-align: center;
    color: #6b7280;
    font-size: 14px;
}

/* FAB */
.fab {
    position: fixed;
    bottom: 90px;
    right: 16px;
    background: linear-gradient(90deg, #FBBF24 0%, #F59E0B 100%);
    color: white;
    padding: 14px 20px;
    border-radius: 50px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    box-shadow: 0 10px 25px -5px rgba(245, 194, 66, 0.5);
    z-index: 100;
    cursor: pointer;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* --- Restored Form Styles for Edit/Add Pages --- */
.sectionTitle {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 8px;
    color: #111827;
    margin-left: 4px;
    margin-top: 24px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
}

.input,
.select {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
    margin-bottom: 12px;
    background: #fff;
    /* White background */
    color: #1f2937;
    transition: all 0.2s;
}

.input:focus,
.select:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
}

.input::placeholder {
    color: #9ca3af;
}

.radioGroup {
    display: flex;
    gap: 24px;
    margin-bottom: 16px;
}

.radioLabel {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 15px;
    font-weight: 500;
    color: #111827;
    cursor: pointer;
}

.radioLabel input {
    width: 18px;
    height: 18px;
    accent-color: #2563eb;
}

.toggleRow {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0;
}

.toggleLabel {
    font-size: 14px;
    font-weight: 500;
    color: #374151;
}

.footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    padding: 16px;
    border-top: 1px solid #eee;
    z-index: 50;
    padding-bottom: env(safe-area-inset-bottom);
}

.saveButton {
    width: 100%;
    background: #0d6efd;
    color: white;
    padding: 14px;
    border-radius: 12px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    font-size: 16px;
}
</file>

<file path="src/app/page.module.css">
/* Homepage Styles - Golden Theme Redesign */

.container {
  padding: 16px;
  padding-bottom: 100px;
  background-color: var(--background);
  min-height: 100vh;
}

/* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 8px 0;
}

.brand {
  font-size: 28px;
  font-weight: 800;
  display: flex;
  align-items: center;
  gap: 8px;
  color: #111827;
  letter-spacing: -0.5px;
}

.headerRight {
  display: flex;
  align-items: center;
  gap: 16px;
}

.notificationBtn {
  color: #6B7280;
  font-size: 24px;
  display: flex;
  align-items: center;
}

.langToggle {
  display: flex;
  align-items: center;
  gap: 4px;
  background: white;
  border-radius: 20px;
  padding: 4px 10px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  border: 1px solid #E5E7EB;
  font-size: 12px;
  font-weight: 500;
  color: #6B7280;
}

/* Business Pulse Card */
.pulseCard {
  background: white;
  border-radius: 24px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
  position: relative;
  overflow: hidden;
}

.pulseDecoration {
  position: absolute;
  top: 0;
  right: 0;
  width: 120px;
  height: 120px;
  background: linear-gradient(135deg, #DCFCE7 0%, transparent 70%);
  border-radius: 0 0 0 100%;
  opacity: 0.7;
}

.pulseContent {
  position: relative;
  z-index: 1;
}

.pulseLabel {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 4px;
}

.pulseAmount {
  font-size: 32px;
  font-weight: 700;
  color: #111827;
  margin-bottom: 4px;
}

.pulseStats {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.pulseSubtext {
  font-size: 14px;
  color: var(--text-secondary);
}

.pulseBadge {
  display: inline-flex;
  align-items: center;
  gap: 2px;
  background: #DCFCE7;
  color: var(--success);
  font-size: 12px;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 4px;
}

.pulseNote {
  font-size: 12px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 4px;
}

.pulseChart {
  position: absolute;
  bottom: 16px;
  right: 16px;
  display: flex;
  align-items: flex-end;
  gap: 4px;
  height: 60px;
  opacity: 0.9;
}

.chartBar {
  width: 10px;
  border-radius: 3px 3px 0 0;
}

/* Quick Actions Section */
.actionsSection {
  background: linear-gradient(135deg, #FDE68A 0%, #F5C242 50%, #F59E0B 100%);
  border-radius: 24px;
  padding: 16px;
  margin-bottom: 20px;
  box-shadow: 0 4px 20px -2px rgba(245, 194, 66, 0.3);
}

.primaryActionCard {
  background: white;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 16px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  cursor: pointer;
  text-decoration: none;
  color: inherit;
}

.primaryActionCard:active {
  transform: scale(0.98);
}

.primaryIconBox {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  background: #F3F4F6;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  flex-shrink: 0;
}

.primaryIconBox svg {
  color: #4B5563;
}

.starBadge {
  position: absolute;
  bottom: -4px;
  right: -4px;
  width: 16px;
  height: 16px;
  background: #FBBF24;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid white;
}

.primaryActionInfo {
  flex: 1;
}

.primaryActionTitle {
  font-size: 18px;
  font-weight: 700;
  color: #111827;
}

.primaryActionSubtitle {
  font-size: 12px;
  color: var(--text-secondary);
}

.actionChevron {
  color: #D1D5DB;
  font-size: 24px;
}

.quickActionsGrid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.quickActionBtn {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(8px);
  border-radius: 12px;
  padding: 12px 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
  cursor: pointer;
  text-decoration: none;
  color: inherit;
  border: none;
  font-family: inherit;
}

.quickActionBtn:active {
  background: white;
  transform: scale(0.98);
}

.quickActionBtn svg {
  color: #374151;
  font-size: 18px;
}

.quickActionBtn span {
  font-size: 12px;
  font-weight: 600;
  color: #374151;
}

/* Recent Activity Section */
.activitySection {
  margin-bottom: 20px;
}

.sectionHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding: 0 4px;
}

.sectionTitle {
  font-size: 18px;
  font-weight: 700;
  color: #111827;
}

.seeAllLink {
  font-size: 14px;
  font-weight: 500;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 2px;
  text-decoration: none;
}

.activityList {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.activityCard {
  background: white;
  border-radius: 16px;
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
}

.activityAvatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: #F3F4F6;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  flex-shrink: 0;
  overflow: hidden;
}

.activityAvatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.avatarBadge {
  position: absolute;
  bottom: -2px;
  right: -2px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid white;
}

.avatarBadge.success {
  background: var(--success);
}

.avatarBadge.warning {
  background: var(--primary);
}

.avatarBadge.danger {
  background: #FDBA74;
}

.activityInfo {
  flex: 1;
  min-width: 0;
}

.activityTitle {
  font-size: 14px;
  font-weight: 600;
  color: #111827;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.activitySubtitle {
  font-size: 12px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.activityRight {
  text-align: right;
  flex-shrink: 0;
}

.activityAmount {
  font-size: 14px;
  font-weight: 700;
  color: #111827;
}

.activityStatus {
  font-size: 11px;
  font-weight: 500;
}

.activityStatus.overdue {
  color: var(--danger);
}

.activityStatus.paid {
  color: var(--success);
}

.activityStatus.risk {
  color: var(--text-secondary);
}

.unpaidCount {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: #FFF7ED;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
  color: #EA580C;
  flex-shrink: 0;
}

/* Streak Card */
.streakCard {
  background: white;
  border-radius: 24px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
  position: relative;
  overflow: hidden;
}

.streakContent {
  position: relative;
  z-index: 1;
  width: 65%;
}

.streakTitle {
  font-size: 18px;
  font-weight: 700;
  color: #111827;
  margin-bottom: 8px;
}

.streakSubtitle {
  font-size: 14px;
  font-weight: 600;
  color: #111827;
  margin-bottom: 4px;
}

.streakStats {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 12px;
}

.streakAmount {
  font-size: 24px;
  font-weight: 700;
  color: #111827;
}

.streakProgress {
  display: flex;
  gap: 6px;
}

.progressBar {
  height: 8px;
  width: 32px;
  border-radius: 4px;
}

.progressBar.filled {
  background: var(--primary);
}

.progressBar.partial {
  background: var(--primary);
  opacity: 0.5;
}

.progressBar.empty {
  background: #E5E7EB;
}

.streakBadge {
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  width: 80px;
  height: 80px;
}

.badgeOuter {
  width: 80px;
  height: 80px;
  background: #FEF3C7;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 3px solid rgba(245, 194, 66, 0.3);
}

.badgeInner {
  width: 56px;
  height: 56px;
  background: var(--primary);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(245, 194, 66, 0.4);
}

.badgeInner svg {
  color: white;
  font-size: 28px;
}

/* Floating Action Button */
.fab {
  position: fixed;
  bottom: 90px;
  right: 16px;
  background: linear-gradient(90deg, #FBBF24 0%, #F59E0B 100%);
  color: white;
  font-weight: 700;
  padding: 14px 20px;
  border-radius: 50px;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 10px 25px -5px rgba(245, 194, 66, 0.5);
  cursor: pointer;
  text-decoration: none;
  z-index: 40;
  border: none;
  font-family: inherit;
  font-size: 14px;
}

.fab:active {
  transform: scale(0.95);
}

.fab svg {
  font-size: 20px;
}
</file>

<file path="src/components/Auth/LoginFlow.js">
'use client';

import { useState } from 'react';
import { useAuthStore } from '@/lib/store/authStore';
import styles from './LoginFlow.module.css';
import LandingPage from '../LandingPage/LandingPage';

export default function LoginFlow() {
    const {
        currentStep,
        setStep,
        phoneNumber,
        requestOTP,
        verifyOTP,
        isLoading,
        isNotAssignedToShop,
        error: storeError
    } = useAuthStore();
    const [phone, setPhone] = useState(phoneNumber || '');
    const [otp, setOtp] = useState(['', '', '', '', '', '']);
    const [error, setError] = useState('');

    const handlePhoneSubmit = async () => {
        console.log('[LoginFlow] handlePhoneSubmit clicked');
        console.log('[LoginFlow] raw phone:', phone);

        const normalizedPhone = phone.replace(/\D/g, '');
        console.log('[LoginFlow] normalized phone:', normalizedPhone);

        if (normalizedPhone.length !== 10) {
            console.log('[LoginFlow] validation failed');
            setError('Please enter a valid 10-digit phone number');
            return;
        }

        setError('');
        console.log('[LoginFlow] calling requestOTP');
        const success = await requestOTP(normalizedPhone);
        console.log('[LoginFlow] requestOTP returned:', success);
        if (!success) {
            setError('Failed to send OTP. Please try again.');
        }
    };

    const handleOtpChange = (index, value) => {
        if (value.length > 1) return;
        const newOtp = [...otp];
        newOtp[index] = value;
        setOtp(newOtp);

        if (value && index < 5) {
            document.getElementById(`otp-${index + 1}`)?.focus();
        }
    };

    const handleOtpSubmit = async () => {
        const otpValue = otp.join('');
        const success = await verifyOTP(otpValue);
        if (!success) {
            setError('Invalid OTP. Please use 111111');
        }
    };

    if (currentStep === 'welcome') {
        return <LandingPage onGetStarted={() => setStep('phone')} />;
    }

    console.log('[LoginFlow] render - isLoading:', isLoading, 'currentStep:', currentStep);

    if (currentStep === 'phone') {
        return (
            <div className={styles.container}>
                <div className={styles.card}>
                    <h2 className={styles.title}>Enter Phone Number</h2>
                    <p className={styles.subtitle}>We'll send you an OTP</p>
                    <input
                        className={styles.input}
                        type="tel"
                        placeholder="10-digit mobile number"
                        value={phone}
                        onChange={(e) => setPhone(e.target.value.replace(/\D/g, '').slice(0, 10))}
                        maxLength={10}
                    />
                    {error && <div className={styles.error}>{error}</div>}
                    <button className={styles.button} onClick={handlePhoneSubmit} disabled={isLoading}>
                        {isLoading ? 'Sending...' : 'Send OTP'}
                    </button>
                    <button className={styles.backButton} onClick={() => setStep('welcome')}>
                        Back
                    </button>
                </div>
            </div>
        );
    }

    if (currentStep === 'otp') {
        return (
            <div className={styles.container}>
                <div className={styles.card}>
                    <h2 className={styles.title}>Enter OTP</h2>
                    <p className={styles.subtitle}>Sent to {phoneNumber}</p>
                    <div className={styles.otpContainer}>
                        {otp.map((digit, index) => (
                            <input
                                key={index}
                                id={`otp-${index}`}
                                className={styles.otpInput}
                                type="tel"
                                maxLength={1}
                                value={digit}
                                onChange={(e) => handleOtpChange(index, e.target.value)}
                            />
                        ))}
                    </div>
                    {error && <div className={styles.error}>{error}</div>}
                    <button className={styles.button} onClick={handleOtpSubmit} disabled={otp.join('').length !== 6}>
                        Verify OTP
                    </button>
                    <button className={styles.backButton} onClick={() => setStep('phone')}>
                        Change Number
                    </button>
                </div>
            </div>
        );
    }
    // Blocking message for users not assigned to any shop
    if (currentStep === 'notAssigned' || isNotAssignedToShop) {
        return (
            <div className={styles.container}>
                <div className={styles.card}>
                    <h2 className={styles.title}>Access Denied</h2>
                    <p className={styles.subtitle}>
                        You are not added to any shop.<br />
                        Please contact your administrator.
                    </p>
                    <div className={styles.error}>
                        {storeError || 'Your phone number is not registered with any shop.'}
                    </div>
                    <button
                        className={styles.backButton}
                        onClick={() => setStep('phone')}
                        style={{ marginTop: '16px' }}
                    >
                        Try Another Number
                    </button>
                </div>
            </div>
        );
    }

    return null;
}
</file>

<file path="src/components/BarcodeScanner.js">
'use client';

import { useEffect, useRef, useState, useCallback } from 'react';
import { Html5Qrcode } from 'html5-qrcode';
import { FiX, FiZap, FiZapOff, FiCamera, FiAlertCircle } from 'react-icons/fi';
import styles from './BarcodeScanner.module.css';
import { logger, LOG_EVENTS } from '@/lib/logger';

// Permission states
const PERMISSION_STATE = {
    CHECKING: 'checking',
    GRANTED: 'granted',
    DENIED: 'denied',
    PROMPT: 'prompt',
    UNSUPPORTED: 'unsupported',
    INSECURE: 'insecure'
};

export default function BarcodeScanner({ isOpen, onScan, onClose, onManualEntry }) {
    const scannerRef = useRef(null);
    const html5QrCodeRef = useRef(null);
    const [isFlashOn, setIsFlashOn] = useState(false);
    const [error, setError] = useState(null);
    const [permissionState, setPermissionState] = useState(PERMISSION_STATE.CHECKING);
    const [manualBarcode, setManualBarcode] = useState('');
    const [showManualInput, setShowManualInput] = useState(false);

    // Check if camera API is available
    const checkCameraSupport = useCallback(async () => {
        // Check HTTPS requirement (camera won't work on insecure origins except localhost)
        const isSecure = window.location.protocol === 'https:' ||
            window.location.hostname === 'localhost' ||
            window.location.hostname === '127.0.0.1';

        if (!isSecure && !window.Capacitor?.isNative) {
            setPermissionState(PERMISSION_STATE.INSECURE);
            setError('Camera requires a secure connection (HTTPS). Please access this page via HTTPS.');
            return false;
        }

        // Check if mediaDevices API is available
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            setPermissionState(PERMISSION_STATE.UNSUPPORTED);
            setError('Camera is not supported on this browser. Please try a different browser or use manual entry.');
            return false;
        }

        // Check camera permission status (if Permissions API is available)
        try {
            if (navigator.permissions && navigator.permissions.query) {
                const result = await navigator.permissions.query({ name: 'camera' });

                if (result.state === 'denied') {
                    setPermissionState(PERMISSION_STATE.DENIED);
                    setError('Camera permission was denied. Please enable camera access in your browser/device settings and try again.');
                    return false;
                } else if (result.state === 'granted') {
                    setPermissionState(PERMISSION_STATE.GRANTED);
                    return true;
                } else {
                    // 'prompt' - need to request permission
                    setPermissionState(PERMISSION_STATE.PROMPT);
                    return true;
                }
            } else {
                // Permissions API not available, try requesting directly
                setPermissionState(PERMISSION_STATE.PROMPT);
                return true;
            }
        } catch (err) {
            // Permissions API might not support 'camera' query, proceed anyway
            logger.info(LOG_EVENTS.PERMISSION_CHECK, { status: 'query_unsupported', error: err.message });
            setPermissionState(PERMISSION_STATE.PROMPT);
            return true;
        }
    }, []);

    // Request camera permission and start scanner
    const requestCameraAndStart = useCallback(async () => {
        try {
            setError(null);
            setPermissionState(PERMISSION_STATE.CHECKING);

            // First validate a stream can be obtained (triggers permission prompt if needed)
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' }
            });

            // Stop the test stream immediately
            stream.getTracks().forEach(track => track.stop());

            setPermissionState(PERMISSION_STATE.GRANTED);

            // Wait for the DOM element to be rendered
            let attempts = 0;
            let element = null;
            while (attempts < 50) { // Try for up to 2.5s
                element = document.getElementById('barcode-reader');
                if (element) break;
                await new Promise(resolve => setTimeout(resolve, 50));
                attempts++;
            }

            if (!element) {
                throw new Error("Scanner element could not be initialized (DOM element not found)");
            }

            // Now start the Html5Qrcode scanner
            html5QrCodeRef.current = new Html5Qrcode('barcode-reader');

            await html5QrCodeRef.current.start(
                { facingMode: 'environment' },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0
                },
                (decodedText) => {
                    // Successfully scanned
                    stopScanner();
                    logger.info(LOG_EVENTS.PRODUCT_SCAN, { barcode: decodedText });
                    onScan(decodedText);
                },
                (errorMessage) => {
                    // Ignore scan errors (no QR found in frame)
                }
            );
        } catch (err) {
            logger.error(LOG_EVENTS.PRODUCT_SCAN_ERROR, { error: err.message, name: err.name });

            // Handle specific error types
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                setPermissionState(PERMISSION_STATE.DENIED);
                setError('Camera permission denied. Please allow camera access in your browser settings to scan barcodes.');
            } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                setPermissionState(PERMISSION_STATE.UNSUPPORTED);
                setError('No camera found on this device. Please use the manual entry option.');
            } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                setError('Camera is in use by another application. Please close other apps using the camera and try again.');
            } else if (err.name === 'OverconstrainedError') {
                // Try again without facingMode constraint
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    stream.getTracks().forEach(track => track.stop());

                    html5QrCodeRef.current = new Html5Qrcode('barcode-reader');
                    await html5QrCodeRef.current.start(
                        { facingMode: 'user' },
                        { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 },
                        (decodedText) => { stopScanner(); onScan(decodedText); },
                        () => { }
                    );
                    setPermissionState(PERMISSION_STATE.GRANTED);
                    return;
                } catch (fallbackErr) {
                    setError('Could not access camera with required settings. Please try manual entry.');
                }
            } else {
                setError(`Camera error: ${err.message || 'Unknown error'}. Please try again or use manual entry.`);
            }
        }
    }, [onScan]);

    useEffect(() => {
        if (!isOpen) return;

        const startScanner = async () => {
            // Wait for DOM element to be available
            await new Promise(resolve => requestAnimationFrame(resolve));

            const canProceed = await checkCameraSupport();
            if (canProceed) {
                await requestCameraAndStart();
            }
        };

        startScanner();

        return () => {
            stopScanner();
        };
    }, [isOpen, checkCameraSupport, requestCameraAndStart]);

    const stopScanner = async () => {
        if (html5QrCodeRef.current) {
            try {
                const state = html5QrCodeRef.current.getState();
                // Only stop if actually scanning (state 2 = SCANNING, state 3 = PAUSED)
                if (state === 2 || state === 3) {
                    await html5QrCodeRef.current.stop();
                }
                html5QrCodeRef.current = null;
            } catch (err) {
                // Silently ignore stop errors
                logger.warn('SCANNER_STOP_WARNING', { error: err.message });
            }
        }
    };

    const handleClose = () => {
        stopScanner();
        onClose();
    };

    const handleRetry = async () => {
        // Clear error first - this triggers re-render to show the reader div
        setError(null);
        setPermissionState(PERMISSION_STATE.CHECKING);

        // Wait for React to re-render
        await new Promise(resolve => setTimeout(resolve, 100));

        const canProceed = await checkCameraSupport();
        if (canProceed) {
            await requestCameraAndStart();
        }
    };

    const toggleFlash = async () => {
        // Flash toggle requires torch capability
        // This may not work on all devices
        setIsFlashOn(!isFlashOn);
    };

    const handleManualSubmit = () => {
        if (manualBarcode.trim()) {
            onScan(manualBarcode.trim());
            setManualBarcode('');
            setShowManualInput(false);
        }
    };

    if (!isOpen) return null;

    return (
        <div className={styles.overlay}>
            {/* Header */}
            <div className={styles.header}>
                <button className={styles.headerBtn} onClick={handleClose}>
                    <FiX size={24} />
                    <span>Close</span>
                </button>
                <button className={styles.headerBtn} onClick={toggleFlash}>
                    {isFlashOn ? <FiZap size={24} /> : <FiZapOff size={24} />}
                    <span>Flash</span>
                </button>
            </div>

            {/* Scanner Area */}
            <div className={styles.scannerContainer}>
                {error ? (
                    <div className={styles.errorContainer}>
                        <FiAlertCircle size={48} color="#ef4444" />
                        <div className={styles.errorMessage}>{error}</div>
                        {permissionState !== PERMISSION_STATE.UNSUPPORTED &&
                            permissionState !== PERMISSION_STATE.INSECURE && (
                                <button className={styles.retryBtn} onClick={handleRetry}>
                                    <FiCamera size={18} />
                                    Try Again
                                </button>
                            )}
                    </div>
                ) : permissionState === PERMISSION_STATE.CHECKING ? (
                    <div className={styles.loadingMessage}>
                        <FiCamera size={48} color="#3b82f6" />
                        <div>Requesting camera access...</div>
                    </div>
                ) : (
                    <>
                        <div id="barcode-reader" className={styles.reader} ref={scannerRef}></div>
                        <div className={styles.scanFrame}>
                            <div className={styles.corner + ' ' + styles.topLeft}></div>
                            <div className={styles.corner + ' ' + styles.topRight}></div>
                            <div className={styles.corner + ' ' + styles.bottomLeft}></div>
                            <div className={styles.corner + ' ' + styles.bottomRight}></div>
                        </div>
                    </>
                )}
            </div>

            {/* Instructions */}
            <div className={styles.instructions}>
                {error ? 'Use manual entry below or fix the issue above' : 'Align the barcode within the frame'}
            </div>

            {/* Manual Entry */}
            {showManualInput ? (
                <div className={styles.manualInputContainer}>
                    <input
                        type="text"
                        className={styles.manualInput}
                        placeholder="Enter barcode..."
                        value={manualBarcode}
                        onChange={(e) => setManualBarcode(e.target.value)}
                        autoFocus
                    />
                    <button className={styles.submitBtn} onClick={handleManualSubmit}>
                        Submit
                    </button>
                </div>
            ) : (
                <button
                    className={styles.manualEntryBtn}
                    onClick={() => setShowManualInput(true)}
                >
                    Enter Barcode Manually
                </button>
            )}
        </div>
    );
}
</file>

<file path="src/components/BottomNav.js">
'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { FiHome, FiBox, FiUsers, FiGrid, FiFileText } from 'react-icons/fi';
import { RiBillLine } from 'react-icons/ri'; // This import will become unused but I'll keep it as per instructions to not make unrelated edits unless explicitly removed.
import clsx from 'clsx';
import styles from './BottomNav.module.css';

const navItems = [
    { label: 'Home', href: '/', icon: FiHome },
    { label: 'Bills', href: '/bills', icon: FiFileText },
    { label: 'Products', href: '/products', icon: FiBox },
    { label: 'Parties', href: '/parties', icon: FiUsers },
    { label: 'More', href: '/more', icon: FiGrid },
];

export default function BottomNav() {
    const pathname = usePathname();

    // Hide BottomNav on specific routes
    if (pathname.includes('/add') || pathname.includes('/create') || pathname.includes('/view') || pathname.includes('/edit')) {
        return null;
    }

    // Hide bottom nav on specific pages if needed (e.g., Create Invoice)
    if (pathname.startsWith('/invoice/create')) return null;

    return (
        <nav className={styles.nav}>
            {navItems.map((item) => {
                const Icon = item.icon;
                const isActive = pathname === item.href;
                return (
                    <Link key={item.label} href={item.href} className={clsx(styles.item, isActive && styles.active)}>
                        <Icon size={24} />
                        <span className={styles.label}>{item.label}</span>
                    </Link>
                );
            })}
        </nav>
    );
}
</file>

<file path="src/components/PurchaseForm.js">
'use client';

import { useRouter, useSearchParams } from 'next/navigation';
import { usePurchaseStore } from '@/lib/store/purchaseStore';
import { usePartyStore } from '@/lib/store/partyStore';
import { useEffect } from 'react';
import { formatCurrency } from '@/lib/utils/tax';
import { FiPlus, FiTrash2, FiCopy, FiCalendar, FiUser, FiBox, FiArrowLeft } from 'react-icons/fi';
import styles from './PurchaseForm.module.css';

export default function PurchaseForm() {
    const router = useRouter();
    const searchParams = useSearchParams();
    const prefillVendorId = searchParams?.get('vendorId');
    const { getVendor } = usePartyStore();

    const {
        id, purchaseNumber, date, dueDate, items, vendor,
        details, payment, roundOff, gstEnabled,
        addItem, updateItem, removeItem, duplicateItem, calculateTotals,
        updateDetails, updatePayment, toggleRoundOff, toggleGst,
        resetPurchase, savePurchase, setVendor, setDate, setDueDate
    } = usePurchaseStore();

    useEffect(() => {
        if (prefillVendorId && !vendor) {
            const v = getVendor(prefillVendorId);
            if (v) setVendor(v);
        }
    }, [prefillVendorId, vendor, getVendor, setVendor]);

    const totals = calculateTotals();

    const handleSave = async () => {
        if (!vendor) return alert('Please select a vendor');
        if (items.length === 0) return alert('Please add at least one item');

        try {
            const savedId = await savePurchase();
            resetPurchase();
            router.push(`/parties/vendor/view?id=${vendor.id}`);
        } catch (error) {
            console.error('Failed to save purchase:', error);
            alert('Failed to save purchase: ' + error.message);
        }
    };

    // Calculate item amount
    const getItemAmount = (item) => {
        const netWeight = Number(item.netWeight) || 0;
        const wastage = Number(item.wastage) || 0;
        const effectiveWeight = netWeight + wastage;
        const ratePerGram = Number(item.ratePerGram) || 0;
        return effectiveWeight * ratePerGram * (item.quantity || 1);
    };

    return (
        <div className={styles.container}>
            {/* Purchase Details Card */}
            <div className={styles.card}>
                <div className={styles.row}>
                    <div>
                        <div className={styles.label}>Purchase #</div>
                        <div className={styles.value}>{purchaseNumber}</div>
                    </div>
                    <div className={styles.value} style={{ color: '#f59e0b' }}>Edit</div>
                </div>
                <div className={styles.row}>
                    <div className={styles.label}>Date</div>
                    <input
                        type="date"
                        className={styles.input}
                        value={date}
                        onChange={(e) => setDate(e.target.value)}
                    />
                </div>
                <div className={styles.row}>
                    <div className={styles.label}>Due Date</div>
                    <input
                        type="date"
                        className={styles.input}
                        value={dueDate}
                        onChange={(e) => setDueDate(e.target.value)}
                    />
                </div>
            </div>

            {/* Vendor Selection */}
            <div className={styles.sectionTitle}>
                Vendor <FiUser size={14} />
            </div>
            <div className={styles.card}>
                {vendor ? (
                    <div className={styles.selectedVendor}>
                        <div className={styles.vendorInfo}>
                            <div className={styles.vendorName}>{vendor.name}</div>
                            {vendor.phone && <div className={styles.vendorPhone}>{vendor.phone}</div>}
                        </div>
                        <div className={styles.vendorActions}>
                            <button
                                className={styles.actionButton}
                                onClick={() => router.push('/purchase/create/select-vendor')}
                            >
                                Change
                            </button>
                        </div>
                    </div>
                ) : (
                    <button
                        className={styles.addButton}
                        onClick={() => router.push('/purchase/create/select-vendor')}
                    >
                        <FiPlus /> Select Vendor
                    </button>
                )}
            </div>

            {/* Items Section */}
            <div className={styles.sectionTitle}>
                Items <FiBox size={14} />
            </div>
            <div className={styles.card}>
                {items.map((item) => (
                    <div key={item.id} className={styles.itemRow}>
                        <div className={styles.itemHeader} style={{ marginBottom: 8, justifyContent: 'space-between', alignItems: 'flex-start' }}>
                            <div style={{ flex: 1 }}>
                                <div style={{ marginBottom: 8 }}>
                                    <label style={{ fontSize: 10, color: '#6b7280', display: 'block', marginBottom: 4 }}>Item Name / Description</label>
                                    <input
                                        className={styles.input}
                                        value={item.name}
                                        onChange={(e) => updateItem(item.id, 'name', e.target.value)}
                                        placeholder="Enter Item Description"
                                    />
                                </div>
                            </div>
                            <div className={styles.itemActions}>
                                <button
                                    className={styles.itemActionBtn}
                                    onClick={() => duplicateItem(item.id)}
                                    title="Duplicate"
                                >
                                    <FiCopy size={16} />
                                </button>
                                <button
                                    className={`${styles.itemActionBtn} ${styles.delete}`}
                                    onClick={() => removeItem(item.id)}
                                    title="Delete"
                                >
                                    <FiTrash2 size={16} />
                                </button>
                            </div>
                        </div>

                        {/* Row 1: Weight Fields */}
                        <div style={{ display: 'flex', gap: 8, marginBottom: 8 }}>
                            <div style={{ flex: 1 }}>
                                <label style={{ fontSize: 10, color: '#6b7280' }}>Net Weight (g)</label>
                                <input
                                    className={styles.input}
                                    type="number"
                                    value={item.netWeight || ''}
                                    onChange={(e) => updateItem(item.id, 'netWeight', e.target.value)}
                                    placeholder="0"
                                />
                            </div>
                            <div style={{ flex: 1 }}>
                                <label style={{ fontSize: 10, color: '#6b7280' }}>Gross Weight (g)</label>
                                <input
                                    className={styles.input}
                                    type="number"
                                    value={item.grossWeight || ''}
                                    onChange={(e) => updateItem(item.id, 'grossWeight', e.target.value)}
                                    placeholder="0"
                                />
                            </div>
                            <div style={{ flex: 1 }}>
                                <label style={{ fontSize: 10, color: '#6b7280' }}>Wastage (g)</label>
                                <input
                                    className={styles.input}
                                    type="number"
                                    value={item.wastage || ''}
                                    onChange={(e) => updateItem(item.id, 'wastage', e.target.value)}
                                    placeholder="0"
                                />
                            </div>
                        </div>

                        {/* Row 2: Rate */}
                        <div style={{ display: 'flex', gap: 8, marginBottom: 8 }}>
                            <div style={{ flex: 1 }}>
                                <label style={{ fontSize: 10, color: '#6b7280' }}>Rate per gram (₹)</label>
                                <input
                                    className={styles.input}
                                    type="number"
                                    value={item.ratePerGram || ''}
                                    onChange={(e) => updateItem(item.id, 'ratePerGram', e.target.value)}
                                    placeholder="Rate"
                                />
                            </div>
                            <div style={{ flex: 1 }}>
                                <label style={{ fontSize: 10, color: '#6b7280' }}>Quantity</label>
                                <input
                                    className={styles.input}
                                    type="number"
                                    value={item.quantity || 1}
                                    onChange={(e) => updateItem(item.id, 'quantity', Number(e.target.value))}
                                    placeholder="1"
                                    min="1"
                                />
                            </div>
                        </div>

                        {/* Row 3: Calculated Amount */}
                        <div style={{ display: 'flex', gap: 8, background: '#fef9c3', padding: 8, borderRadius: 6 }}>
                            <div style={{ flex: 1 }}>
                                <div style={{ fontSize: 10, color: '#6b7280' }}>Eff. Weight</div>
                                <div style={{ fontSize: 12, fontWeight: 500 }}>
                                    {((Number(item.netWeight) || 0) + (Number(item.wastage) || 0)).toFixed(2)}g
                                </div>
                            </div>
                            <div style={{ flex: 1, textAlign: 'right' }}>
                                <div style={{ fontSize: 10, color: '#6b7280' }}>Amount</div>
                                <div style={{ fontSize: 14, fontWeight: 600, color: '#d97706' }}>
                                    {formatCurrency(getItemAmount(item))}
                                </div>
                            </div>
                        </div>
                    </div>
                ))}

                <button
                    className={styles.addButton}
                    onClick={() => addItem()}
                    style={{ background: 'white', border: '1px solid #e5e7eb', color: '#4b5563' }}
                >
                    <FiPlus /> Add Item Row
                </button>
            </div>

            {/* GST Toggle */}
            <div className={styles.sectionTitle}>Tax Settings</div>
            <div className={styles.card}>
                <div className={styles.toggleRow}>
                    <div className={styles.toggleLabel}>Enable GST</div>
                    <div
                        className={`${styles.toggleSwitch} ${gstEnabled ? styles.active : ''}`}
                        onClick={toggleGst}
                    >
                        <div className={styles.toggleKnob} />
                    </div>
                </div>
                {gstEnabled && (
                    <div style={{ fontSize: 12, color: '#6b7280', marginTop: 8 }}>
                        CGST (1.5%) + SGST (1.5%) will be applied
                    </div>
                )}
            </div>

            {/* Optional Fields */}
            <div className={styles.sectionTitle}>Optional</div>
            <div className={styles.card} style={{ padding: 0 }}>
                {[
                    { icon: '📄', label: 'Add Reference', field: 'reference', type: 'text' },
                    { icon: '📝', label: 'Add Notes', field: 'notes', type: 'text' },
                    { icon: '📋', label: 'Add Terms', field: 'terms', type: 'text' },
                ].map((opt, idx) => (
                    <div key={idx} className={styles.optionalRow}>
                        <div className={styles.optionalLabel}>
                            <span style={{ width: 24, textAlign: 'center' }}>{opt.icon}</span>
                            {opt.label}
                        </div>
                        <input
                            type={opt.type}
                            className={styles.optionalInput}
                            placeholder={opt.label}
                            value={details[opt.field]}
                            onChange={(e) => updateDetails(opt.field, e.target.value)}
                        />
                    </div>
                ))}
            </div>

            {/* Payments */}
            <div className={styles.sectionTitle}>Payments</div>
            <div className={styles.card}>
                <div className={styles.checkboxRow}>
                    <input
                        type="checkbox"
                        checked={payment.isFullyPaid}
                        onChange={(e) => {
                            updatePayment('isFullyPaid', e.target.checked);
                            if (e.target.checked) updatePayment('amountPaid', totals.total);
                        }}
                        style={{ width: 18, height: 18 }}
                    />
                    <span style={{ fontWeight: 500 }}>Mark as fully paid</span>
                </div>

                <div className={styles.paymentGrid}>
                    <div>
                        <div className={styles.label}>Amount Paid</div>
                        <div className={styles.inputWrapper}>
                            <span style={{ color: '#6b7280' }}>₹</span>
                            <input
                                type="number"
                                className={styles.paymentInput}
                                value={payment.amountPaid}
                                onChange={(e) => updatePayment('amountPaid', e.target.value)}
                            />
                        </div>
                    </div>
                    <div>
                        <div className={styles.label}>Payment Mode</div>
                        <select
                            className={styles.select}
                            value={payment.mode}
                            onChange={(e) => updatePayment('mode', e.target.value)}
                        >
                            <option>Cash</option>
                            <option>UPI</option>
                            <option>Bank Transfer</option>
                            <option>Cheque</option>
                        </select>
                    </div>
                </div>

                <div style={{ marginTop: 12 }}>
                    <div className={styles.label}>Notes</div>
                    <input
                        className={styles.input}
                        placeholder="Payment notes..."
                        value={payment.notes}
                        onChange={(e) => updatePayment('notes', e.target.value)}
                    />
                </div>
            </div>

            {/* Footer */}
            <div className={styles.footer}>
                <div className={styles.footerLeft}>
                    <div className={styles.footerRow}>
                        <span>Sub Total</span>
                        <span>{formatCurrency(totals.subtotal)}</span>
                    </div>

                    {gstEnabled && (
                        <>
                            <div className={styles.footerRow} style={{ color: '#6b7280', fontSize: 12 }}>
                                <span>CGST (1.5%)</span>
                                <span>{formatCurrency(totals.cgst)}</span>
                            </div>
                            <div className={styles.footerRow} style={{ color: '#6b7280', fontSize: 12 }}>
                                <span>SGST (1.5%)</span>
                                <span>{formatCurrency(totals.sgst)}</span>
                            </div>
                        </>
                    )}

                    <div className={styles.footerRow}>
                        <span>Round Off</span>
                        <div
                            className={`${styles.toggleSwitch} ${roundOff ? styles.active : ''}`}
                            onClick={toggleRoundOff}
                            style={{ width: 36, height: 20 }}
                        >
                            <div className={styles.toggleKnob} style={{ width: 16, height: 16 }} />
                        </div>
                        <span>{totals.roundOffAmount.toFixed(2)}</span>
                    </div>
                    <div className={styles.totalAmount}>
                        <span>Total Amount</span>
                        <span style={{ marginLeft: 16 }}>{formatCurrency(totals.total)}</span>
                    </div>
                </div>
                <button className={styles.createButton} onClick={handleSave}>
                    {id ? 'Update' : 'Create'} <FiArrowLeft style={{ transform: 'rotate(180deg)' }} />
                </button>
            </div>
        </div>
    );
}
</file>

<file path="src/lib/utils/pdf.js">
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';
import { createRoot } from 'react-dom/client';
import { flushSync } from 'react-dom';
import { getTemplate } from '@/components/InvoiceTemplates';
import { logger, LOG_EVENTS } from '@/lib/logger';

export const generatePDF = async (data) => {
    const div = document.createElement('div');
    div.style.position = 'absolute';
    div.style.left = '-9999px';
    div.style.top = '0';
    document.body.appendChild(div);

    const TemplateComponent = getTemplate(data.templateId || 'modern').component;

    const root = createRoot(div);
    flushSync(() => {
        root.render(<TemplateComponent data={data} />);
    });

    // Wait for render? flushSync should handle it, but images might need load time.
    // Since we have no images yet, it's fine.

    try {
        const templateElement = div.querySelector('#invoice-template');
        if (!templateElement) {
            throw new Error('Invoice template failed to render. Check that all required invoice data (totals, items, customer) is present.');
        }

        const canvas = await html2canvas(templateElement, {
            scale: 2, // Higher quality
            logging: false,
            useCORS: true
        });

        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });

        const imgWidth = 210;
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

        if (data.returnBlob) {
            return pdf.output('blob');
        }

        pdf.save(`Invoice-${data.invoiceNumber}.pdf`);
    } catch (error) {
        console.error('Error generating PDF:', error);
    } finally {
        document.body.removeChild(div);
    }
};
</file>

<file path="integration.md">
# Swipe Backend Integration Guide

Complete API documentation for frontend integration with the Swipe Store Backend.

## Connection Details

| Setting | Value |
|---------|-------|
| **Base URL** | `http://localhost:3000/api` |
| **Health Check** | `GET /health` |
| **Content-Type** | `application/json` |

---

## Security Features

### Rate Limiting

The API implements rate limiting to protect against abuse:

**Auth Endpoints** (`/api/auth/*`):
- Limit: **10 requests per 10 minutes** per IP address
- Applies to: OTP requests, login, verification
- Headers: `RateLimit-*` standard headers included

**General API** (`/api/*`):
- Limit: **100 requests per 15 minutes** per IP address
- Applies to: All authenticated endpoints
- AdminJS routes are excluded from rate limiting

**Rate Limit Response (429):**
```json
{
  "error": "Too many requests from this IP, please try again later.",
  "requestId": "uuid"
}
```

The response includes a `Retry-After` header indicating seconds until the limit resets.

### Input Sanitization

All user-submitted text fields are automatically sanitized to prevent stored XSS attacks:

**Sanitized Fields:**
- Customer/Vendor: `name`, `address`
- Product: `name`, `description`, `vendorRef`, `hallmarkCert`
- Invoice: Customer snapshot `name`, item `description`
- Payment: `notes`
- Category: `name`

**Not Sanitized** (validated by type):
- IDs, UUIDs, numbers, dates, phone, email, GSTIN, enums, SKUs, barcodes

HTML tags are stripped from sanitized fields before storage. This happens transparently; no changes are required to request/response formats.

### Database Resilience

The SQLite database is configured with:
- **WAL mode** for concurrent read/write performance
- **5-second busy timeout** to automatically handle database lock contention
- Automatic retries when multiple users write simultaneously



---

## Multi-User Architecture

### Shop (Tenant) Model
- All business data belongs to a **Shop**
- Users authenticate and operate within exactly one shop
- Data is completely isolated between shops

### Shop Bootstrap (Initial Setup)

Before any user can login, a shop must be created via the setup API:

#### GET `/api/setup/status`
Check if shop exists.
```json
// Response
{ "setupComplete": false, "shop": null }
```

#### POST `/api/setup/bootstrap`
Create shop and admin user (one-time setup).
```json
// Request
{
  "shopName": "My Shop",
  "adminPhone": "9876543210",
  "setupSecret": "your-setup-secret"
}

// Response
{
  "success": true,
  "shop": { "id": "shop-uuid", "name": "My Shop" },
  "user": { "id": "user-uuid", "phone": "9876543210", "role": "ADMIN" }
}
```

> **Note:** `setupSecret` must match the `SETUP_SECRET` environment variable.

### Post-Setup Login Behavior
- **Registered users** → Normal OTP login
- **Unregistered users** → `403: User not registered. Contact your shop admin.`
- **Shops are never auto-created** during login

---

## Authentication

Phone-based OTP authentication with JWT tokens.

### POST `/api/auth/request-otp`
Request OTP for a phone number.
```json
// Request
{ "phone": "9876543210" }

// Response
{ "success": true, "message": "OTP sent successfully", "phone": "9876543210" }
```

### POST `/api/auth/verify-otp` or `/api/auth/login`
Verify OTP and get JWT token. **Dev OTP: `111111`**
```json
// Request
{ "phone": "9876543210", "otp": "111111" }

// Response
{
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "user": { 
    "id": "uuid", 
    "phone": "9876543210", 
    "name": "John",
    "role": "ADMIN",
    "shopId": "shop-uuid"
  }
}
```

### GET `/api/auth/me` *(Auth Required)*
Get current user info with shop details.
```json
// Response
{
  "id": "user-uuid",
  "phone": "9876543210",
  "name": "John",
  "role": "ADMIN",
  "shop": {
    "id": "shop-uuid",
    "name": "My Shop"
  }
}
```

### JWT Token Structure
```json
{
  "userId": "user-uuid",
  "shopId": "shop-uuid",
  "role": "ADMIN"
}
```

---

## User Management (ADMIN Only)

### GET `/api/auth/users`
List all users in your shop.
```json
// Response
[
  { "id": "uuid", "phone": "9876543210", "name": "John", "role": "ADMIN", "created_at": "..." }
]
```

### POST `/api/auth/users`
Create a new user in your shop.
```json
// Request
{ "phone": "1111111111", "name": "Sales Person", "role": "SALES" }

// Response
{ "id": "uuid", "phone": "1111111111", "name": "Sales Person", "role": "SALES", "shop": {...} }
```

> **Note:** Role defaults to `SALES` if not specified.

---

## Role Permissions

| Action | ADMIN | SALES |
|--------|-------|-------|
| Create (customers, products, etc.) | ✅ | ✅ |
| Read all data | ✅ | ✅ |
| Update records | ✅ | ✅ |
| Delete records | ✅ | ❌ |
| Change settings | ✅ | ❌ |
| Manage users | ✅ | ❌ |

---

## LAN Multi-User Setup

Run one backend on the local network:
```bash
npm start
# Server shows LAN URL: http://192.168.x.x:3000
```

Multiple devices can connect:
1. All devices point to the same backend URL
2. Each user logs in with their phone number
3. First login creates the shop; subsequent logins join as users (via admin invite)
4. All data syncs in real-time across devices

---

## Key Concepts

### Aggregate Objects
For entities like **Invoices**, you send/receive the complete object. The backend atomically handles the underlying tables.

### Idempotency Keys
Use `X-Request-Id: <UUID>` header on `POST /api/invoices` to prevent duplicate records on network retries.

### Server-Side Authority
The backend **always** recomputes totals, taxes, and balances. Client-sent calculations are ignored.

---

## Invoices

### GET `/api/invoices`
List all invoice headers.

### GET `/api/invoices/:id`
Get full invoice aggregate with items, totals, customer snapshot, and photos.

### POST `/api/invoices`
Create invoice. Supports `X-Request-Id` header for idempotency.
```json
{
  "customerId": "uuid (optional)",
  "type": "INVOICE",  // INVOICE | PROFORMA | LENDING
  "status": "UNPAID", // PAID | PARTIAL | UNPAID | PENDING
  "date": "2025-12-27",
  "dueDate": "2026-01-27",
  "placeOfSupply": "Karnataka",
  "customer": {
    "name": "John Doe",
    "phone": "+91...",
    "gstin": "...",
    "address": { "line1": "...", "pincode": "..." }
  },
  "items": [{
    "productId": "uuid (optional)",
    "description": "Gold Ring 22k",
    "quantity": 1,
    "rate": 65000,
    "taxRate": 3,
    "weight": { "gross": 5.2, "net": 4.8 },
    "amount": { "makingCharges": 500, "stoneCharges": 200 }
  }]
}
```
**Response includes server-computed `totals`:** subtotal, taxTotal, cgst, sgst, igst, roundOff, grandTotal.

### PUT `/api/invoices/:id`
Full replacement update.

### DELETE `/api/invoices/:id`
Soft delete.

### POST `/api/invoices/:id/photos`
Upload photo (multipart/form-data, field: `photo`).

**Limits:**
- Max file size: **5MB**
- Allowed types: `image/*` only

**Error Responses:**
```json
// 400: File too large
{ "error": "File too large. Maximum size is 5MB" }

// 400: Invalid type
{ "error": "Only image files are allowed" }
```

### DELETE `/api/invoices/:invoiceId/photos/:photoId`

---

## Customers

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/customers` | List all |
| GET | `/api/customers/:id` | Get one (includes `balance`) |
| POST | `/api/customers` | Create |
| PUT | `/api/customers/:id` | Update |
| DELETE | `/api/customers/:id` | Soft delete |

### Request (POST/PUT)
```json
{
  "name": "Jane Smith",
  "gstin": "...",
  "phone": "9999999999",
  "email": "jane@example.com",
  "address": { "line1": "...", "city": "...", "pincode": "..." }
}
```

### Response (all endpoints)
```json
{
  "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "name": "Jane Smith",
  "phone": "9999999999",
  "email": "jane@example.com",
  "gstin": "...",
  "balance": 0,
  "address": { "line1": "...", "city": "...", "pincode": "..." },
  "created_at": "2025-12-28T10:00:00.000Z",
  "updated_at": "2025-12-28T10:00:00.000Z"
}
```

> ⚠️ **IMPORTANT:** The `id` field is a **UUID generated by the backend**. Frontend must store and use this UUID for all subsequent operations (payments, invoices, etc.). Do NOT use local/IndexedDB IDs.

---

## Products

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/products` | List with images (filters: `?type=product`, `?categoryId=uuid`) |
| GET | `/api/products/:id` | Get with images |
| POST | `/api/products` | Create |
| PUT | `/api/products/:id` | Update (does NOT affect images) |
| DELETE | `/api/products/:id` | Soft delete |
| POST | `/api/products/:id/images` | Upload image (multipart) |
| DELETE | `/api/products/:productId/images/:imageId` | Delete image |

### Product JSON Schema
```json
{
  "type": "product",
  "name": "Diamond Earring",
  "sku": "DE-001",
  "sellingPrice": 120000,
  "taxRate": 3,
  "metal": { "purity": "18k", "type": "Rose Gold" },
  "gemstone": { "type": "Diamond", "carat": 0.5 }
}
```

### ⚠️ Image Handling (Important)

**Images are managed separately from product data.** The `PUT /api/products/:id` endpoint does **NOT** accept or modify images. Existing images persist across product updates.

#### Workflow
1. **Create/Update product** → `POST` or `PUT /api/products/:id` (no images in body)
2. **Add image** → `POST /api/products/:id/images` (multipart/form-data)
3. **Remove image** → `DELETE /api/products/:productId/images/:imageId`

#### Upload Request
```http
POST /api/products/:id/images
Content-Type: multipart/form-data

image: <binary file>   ← field name must be "image"
```

**Limits:**
- Max file size: **5MB**
- Allowed types: `image/*` only

**Error Responses:**
```json
// 400: File too large
{ "error": "File too large. Maximum size is 5MB" }

// 400: Invalid type
{ "error": "Only image files are allowed" }
```

#### Response from GET `/api/products/:id`
```json
{
  "id": "uuid",
  "name": "Diamond Earring",
  ...
  "images": [
    { "id": "image-uuid", "url": "/api/photos/image-uuid", "createdAt": "..." }
  ]
}
```

Images are linked via `product_id` foreign key and returned automatically when fetching a product.

---

## Payments

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/payments` | List (filters: `?partyId=uuid`, `?type=IN|OUT`) |
| GET | `/api/payments/:id` | Get with allocations |
| POST | `/api/payments` | Create (auto-updates invoice status & balance) |
| DELETE | `/api/payments/:id` | Delete (recalculates balances) |

```json
{
  "type": "IN",
  "partyType": "CUSTOMER",
  "partyId": "uuid",
  "amount": 10000,
  "date": "2025-12-27",
  "mode": "UPI",
  "allocations": [
    { "invoiceId": "uuid", "amount": 10000 }
  ]
}
```

---

## Categories

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/categories` | List all with subcategories |
| GET | `/api/categories/:id` | Get one |
| POST | `/api/categories` | Create: `{ "name": "Gold Jewelry", "type": "product" }` |
| PUT | `/api/categories/:id` | Update |
| DELETE | `/api/categories/:id` | Delete (cascades subcategories) |
| POST | `/api/categories/:id/subcategories` | Add: `{ "name": "Rings" }` |
| DELETE | `/api/categories/:categoryId/subcategories/:subcategoryId` | Delete |

---

## Vendors

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/vendors` | List all |
| GET | `/api/vendors/:id` | Get one (includes `balance`) |
| POST | `/api/vendors` | Create |
| PUT | `/api/vendors/:id` | Update |
| DELETE | `/api/vendors/:id` | Soft delete |

Same request/response schema as Customers.

> ⚠️ **IMPORTANT:** The `id` field is a **UUID generated by the backend**. Use this UUID for payments and purchases.

---

## Purchases

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/purchases` | List (filters: `?vendorId=uuid`, `?status=PAID|UNPAID`) |
| GET | `/api/purchases/:id` | Get with vendor info |
| POST | `/api/purchases` | Create |
| PUT | `/api/purchases/:id` | Update |
| DELETE | `/api/purchases/:id` | Soft delete |

```json
{
  "vendorId": "uuid",
  "date": "2025-12-27",
  "dueDate": "2026-01-27",
  "status": "UNPAID"
}
```

---

## Attendance

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/attendance/login` | Log login: `{ "userId": "uuid" }` |
| POST | `/api/attendance/logout` | Log logout: `{ "logId": "uuid" }` |
| GET | `/api/attendance/user/:userId` | History (`?limit=30`) |
| GET | `/api/attendance/user/:userId/date/:date` | Specific date |
| GET | `/api/attendance/date/:date` | All users (admin) |

---

## Photos

### GET `/api/photos/:id` *(Auth Required)*

Serve image file directly. Use photo ID from invoice/product responses.

**Security:**
- Requires authentication (`Authorization: Bearer <token>`)
- Shop-scoped: Only returns photos belonging to your shop
- Returns 401 if no token, 404 if photo not found or belongs to another shop

**Response:**
- `200 OK`: Binary image data with appropriate `Content-Type` header
- `401 Unauthorized`: Missing or invalid token
- `404 Not Found`: Photo doesn't exist or belongs to another shop

> ⚠️ **IMPORTANT:** Browser `<img src="...">` tags do NOT send `Authorization` headers automatically. You must load images programmatically with the auth header.

**Frontend Integration (JavaScript/Web):**
```javascript
// Load authenticated image and convert to displayable URL
async function loadAuthenticatedImage(photoId) {
  const response = await fetch(`/api/photos/${photoId}`, {
    headers: {
      'Authorization': `Bearer ${getToken()}`
    }
  });
  
  if (!response.ok) {
    throw new Error(`Failed to load image: ${response.status}`);
  }
  
  const blob = await response.blob();
  return URL.createObjectURL(blob);
}

// Usage
const imageUrl = await loadAuthenticatedImage('photo-uuid');
document.getElementById('my-image').src = imageUrl;

// Remember to revoke when done to prevent memory leaks
URL.revokeObjectURL(imageUrl);
```

**Frontend Integration (Swift/iOS):**
```swift
func loadAuthenticatedImage(photoId: String, token: String) async throws -> UIImage {
    var request = URLRequest(url: URL(string: "\(baseURL)/api/photos/\(photoId)")!)
    request.setValue("Bearer \(token)", forHTTPHeaderField: "Authorization")
    
    let (data, response) = try await URLSession.shared.data(for: request)
    
    guard let httpResponse = response as? HTTPURLResponse,
          httpResponse.statusCode == 200,
          let image = UIImage(data: data) else {
        throw ImageError.loadFailed
    }
    
    return image
}
```

**React Native / Expo:**
```javascript
// Use Image component with headers prop
<Image
  source={{
    uri: `/api/photos/${photoId}`,
    headers: { Authorization: `Bearer ${token}` }
  }}
/>
```

---

## Settings

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/settings` | Get all |
| GET | `/api/settings/:key` | Get one |
| PUT | `/api/settings/:key` | Set: `{ "value": ... }` |

---

## Home Snapshot

The home snapshot endpoint provides aggregated metrics for the home screen. All business logic is backend-owned.

### GET `/api/home/snapshot` *(Auth Required)*

Returns complete home screen data as a single deterministic snapshot.

**Response:**
```json
{
  "snapshotVersion": 1,
  "businessPulse": {
    "amountReceivedThisWeek": 50000,
    "percentChangeWoW": 25.5,
    "paymentsCompleted": 3
  },
  "primaryAction": {
    "mostUsed": "INVOICE"
  },
  "recentActivity": [
    {
      "type": "INVOICE",
      "title": "Overdue: INV-001",
      "subtitle": "Customer Name",
      "amount": 10000,
      "status": "OVERDUE",
      "date": "2025-12-15",
      "entityId": "invoice-uuid"
    }
  ],
  "riskSummary": {
    "unpaidInvoicesCount": 5,
    "unpaidAmount": 125000
  },
  "momentum": {
    "invoiceStreakDays": 7,
    "totalSentThisWeek": 12
  },
  "generatedAt": "2026-01-03T13:52:00.000Z"
}
```

**Field Descriptions:**

- `snapshotVersion`: Schema version (currently 1)
- `businessPulse`: Weekly payment metrics with WoW comparison
- `primaryAction.mostUsed`: `"INVOICE"` | `"PURCHASE"` | `"EXPENSE"` (based on last 30 days)
- `recentActivity`: Curated cards (max 3):
  - First: Oldest overdue invoice (if any)
  - Second: Last paid invoice (if any)
  - Third: Risk summary OR recent creation
- `riskSummary`: Aggregated unpaid/partial invoices
- `momentum.invoiceStreakDays`: Consecutive days with ≥1 invoice
- `generatedAt`: ISO timestamp of snapshot generation

**Caching:**

- Snapshots are cached server-side for 5 minutes
- Cache is automatically invalidated on invoice/payment/purchase mutations
- Subsequent calls within 5 minutes return cached data

**UI Guidelines:**

- Call once on home screen mount
- Render sections conditionally (check for empty arrays/zero counts)
- **NEVER** compute totals, percentages, or filters in UI
- All business logic is backend-owned


---

## Operations (Backup & Restore)

The operations endpoints provide manual backup functionality for local data safety.

### POST `/api/ops/backup` *(Auth Required)*

Create a full backup of the database and file storage as a single ZIP file.

**Security:**
- Requires authentication
- Prevents concurrent backups (409 Conflict if backup already running)
- Logs all backup creation to audit trail

**Request:**
```http
POST /api/ops/backup
Authorization: Bearer <token>
Content-Type: application/json
```

**Response (200 OK):**
```json
{
  "success": true,
  "filename": "swipe_backup_2026-01-03T14-30-00-000Z.zip",
  "sizeBytes": 1234567,
  "createdAt": "2026-01-03T14:30:00.000Z"
}
```

**Response (409 Conflict):**
```json
{
  "error": "Backup already in progress",
  "requestId": "uuid"
}
```

**Backup Contents:**
- SQLite database (`swipe.db`)
- All file storage (`storage/photos/`)
- Packaged as a single timestamped ZIP file

**Storage Location:** `storage/backups/`

---

### GET `/api/ops/backup/:filename` *(Auth Required)*

Download a previously created backup ZIP file.

**Security:**
- Requires authentication
- Strict filename validation (prevents path traversal attacks)
- Only allows filenames matching pattern: `swipe_backup_<timestamp>.zip`

**Request:**
```http
GET /api/ops/backup/swipe_backup_2026-01-03T14-30-00-000Z.zip
Authorization: Bearer <token>
```

**Response (200 OK):**
- Binary ZIP file download
- Content-Disposition header set for automatic download

**Response (400 Bad Request):**
```json
{
  "error": "Invalid backup filename",
  "requestId": "uuid"
}
```

**Response (404 Not Found):**
```json
{
  "error": "Backup file not found",
  "requestId": "uuid"
}
```

**Frontend Integration Example:**
```javascript
// 1. Create backup
const createBackup = async () => {
  const response = await fetch('/api/ops/backup', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  });
  
  if (response.status === 409) {
    alert('Backup already in progress');
    return;
  }
  
  const { filename } = await response.json();
  
  // 2. Download using fetch (Authorization header required)
  const downloadResponse = await fetch(`/api/ops/backup/${filename}`, {
    headers: { 'Authorization': `Bearer ${token}` }
  });
  
  if (!downloadResponse.ok) {
    throw new Error('Download failed');
  }
  
  // 3. Trigger browser download from blob
  const blob = await downloadResponse.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
};
```

> ⚠️ **IMPORTANT:** Do NOT use `window.location.href` for the download. Browser navigation does not include the `Authorization` header, causing a 401 error. Always use `fetch()` with the token.

**Best Practices:**
1. Show loading state during backup creation (can take several seconds)
2. Handle 409 errors gracefully (inform user, disable button)
3. Automatically trigger download on successful backup creation
4. Consider debouncing backup button clicks

---

### POST `/api/ops/restore` *(ADMIN Only)*

Restore database and file storage from a previously downloaded backup ZIP file.

> ⚠️ **CRITICAL:** This is a **destructive operation**. All current data will be replaced with backup contents. The server will **shut down** after successful restore and must be restarted manually.

**Security:**
- Requires authentication with **ADMIN role**
- Prevents concurrent restores (409 Conflict)
- Cannot run while backup is in progress
- Strict ZIP validation (path traversal prevention)
- Creates emergency backup before restore

**Request:**
```http
POST /api/ops/restore
Authorization: Bearer <token>
Content-Type: multipart/form-data

backup: <ZIP file>
```

**Limits:**
- Max file size: **100MB**
- Allowed types: `.zip` only

**Response (200 OK):**
```json
{
  "success": true,
  "restartRequired": true,
  "photosRestored": 42,
  "emergencyBackupPath": "emergency_pre_restore_2026-01-05T15-30-00-000Z.db",
  "restoredAt": "2026-01-05T15:30:00.000Z"
}
```

> **Note:** After this response, the server will exit. Restart required.

**Response (400 Bad Request):**
```json
{ "error": "Invalid backup: swipe.db not found at root", "requestId": "uuid" }
```

**Response (403 Forbidden):**
```json
{ "error": "Admin access required for restore operations", "requestId": "uuid" }
```

**Response (409 Conflict):**
```json
{ "error": "Restore already in progress", "requestId": "uuid" }
```

**Response (415 Unsupported Media Type):**
```json
{ "error": "Only ZIP files are allowed", "requestId": "uuid" }
```

**Frontend Integration Example:**
```javascript
const restoreFromBackup = async (file) => {
  const formData = new FormData();
  formData.append('backup', file);
  
  const response = await fetch('/api/ops/restore', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}` },
    body: formData
  });
  
  if (response.status === 403) {
    alert('Admin access required');
    return;
  }
  
  if (!response.ok) {
    const { error } = await response.json();
    throw new Error(error);
  }
  
  const result = await response.json();
  alert(`Restore complete! ${result.photosRestored} photos restored. Server will restart.`);
  // Connection will be lost - handle reconnection logic
};
```

**Best Practices:**
1. Show prominent warning before restore (data loss)
2. Require confirmation dialog
3. Handle connection loss after successful restore
4. Implement automatic reconnection with retry logic


---

## Error Responses


```json
{
  "error": "Short description",
  "details": {},
  "requestId": "uuid"
}
```

| Code | Meaning |
|------|---------|
| 400 | Validation failed |
| 401 | Auth required |
| 403 | Forbidden / Invalid token |
| 404 | Not found |
| 500 | Server error |

---

## Best Practices

1. **Dates:** Use ISO 8601 format (`YYYY-MM-DD`)
2. **Auth:** Include `Authorization: Bearer <token>` header for protected routes
3. **Idempotency:** Use `X-Request-Id` header for invoice creation
4. **Balances:** Always read balances from server; never calculate client-side
</file>

<file path="src/app/bills/page.js">
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { useInvoiceStore } from '@/lib/store/invoiceStore';
import { usePurchaseStore } from '@/lib/store/purchaseStore';
import { formatCurrency } from '@/lib/utils/tax';
import { FiPlus, FiHeadphones } from 'react-icons/fi';
import styles from './page.module.css';

import ComingSoon from '@/components/ComingSoon';

export default function BillsPage() {
    const [activeTab, setActiveTab] = useState('sales');
    const { invoices, loadInvoices } = useInvoiceStore();
    const { purchases, loadPurchases } = usePurchaseStore();

    useEffect(() => {
        loadInvoices();
        loadPurchases();
    }, [loadInvoices, loadPurchases]);

    const currentList = activeTab === 'sales' ? invoices : purchases;
    const createLink = activeTab === 'sales' ? '/invoice/create' : '/bills/purchase/create';
    const createLabel = activeTab === 'sales' ? 'INVOICE' : 'PURCHASE';

    if (activeTab === 'quotations') {
        return (
            <div className={styles.container}>
                <div className={styles.tabs}>
                    {['Sales', 'Purchases', 'Quotations'].map((tab) => (
                        <div
                            key={tab}
                            className={`${styles.tab} ${activeTab === tab.toLowerCase() ? styles.activeTab : ''}`}
                            onClick={() => setActiveTab(tab.toLowerCase())}
                        >
                            {tab}
                        </div>
                    ))}
                </div>
                <ComingSoon showBackButton={false} />
            </div>
        );
    }

    return (
        <div className={styles.container}>
            <div className={styles.tabs}>
                {['Sales', 'Purchases', 'Quotations'].map((tab) => (
                    <div
                        key={tab}
                        className={`${styles.tab} ${activeTab === tab.toLowerCase() ? styles.activeTab : ''}`}
                        onClick={() => setActiveTab(tab.toLowerCase())}
                    >
                        {tab}
                    </div>
                ))}
            </div>

            <div className={styles.summaryCard}>
                <div>
                    <div className={styles.summaryLabel}>Total Amount</div>
                    <div className={styles.summaryAmount}>₹0.00</div>
                </div>
                <div style={{ textAlign: 'right' }}>
                    <div className={styles.summaryLabel}>Pending</div>
                    <div className={`${styles.summaryAmount} ${styles.pending}`}>₹0.00</div>
                </div>
            </div>

            <div className={styles.filterRow}>
                <div className={`${styles.filterChip} ${styles.activeFilter}`}>All Transactions</div>
                <div className={styles.filterChip}>Paid</div>
                <div className={styles.filterChip}>Pending</div>
                <div className={styles.filterChip}>Cancelled</div>
            </div>

            {currentList.length === 0 ? (
                <div className={styles.emptyState}>
                    <div className={styles.emptySub}>
                        There are no {activeTab} for This Year. Please choose different dates or create a new {activeTab === 'sales' ? 'invoice' : 'purchase'}.
                    </div>
                    <Link href={createLink} className={styles.link}>
                        Create {activeTab === 'sales' ? 'Invoice' : 'Purchase'}
                    </Link>
                </div>
            ) : (
                <div>
                    {currentList.map((item) => (
                        <div key={item.id} className={styles.listItem} onClick={() => {
                            if (activeTab === 'sales') {
                                window.location.href = `/invoice/view?id=${item.id}`;
                            } else {
                                // Placeholder for purchase view
                                alert('Purchase view coming soon');
                            }
                        }}>
                            <div className={styles.itemMain}>
                                <div className={styles.itemTitle}>
                                    {item.invoiceNumber || item.purchaseNumber}
                                    <span style={{ gap: 4, display: 'flex', alignItems: 'center' }}>
                                        {item.type === 'PROFORMA' && (
                                            <span style={{ fontSize: 10, background: '#e0e7ff', color: '#4338ca', padding: '1px 4px', borderRadius: 2 }}>PRO FORMA</span>
                                        )}
                                        {item.type === 'LENDING' && (
                                            <span style={{ fontSize: 10, background: '#f3f4f6', color: '#374151', padding: '1px 4px', borderRadius: 2 }}>LENDING</span>
                                        )}
                                        <span className={styles.status}>{item.status}</span>
                                    </span>
                                </div>
                                <div className={styles.itemSub}>{item.date}</div>
                            </div>
                            <div className={styles.itemAmount}>
                                {formatCurrency(item.totals?.total || 0)}
                            </div>
                        </div>
                    ))}
                </div>
            )}

            <Link href={createLink}>
                <div className={styles.fab}>
                    <FiPlus /> {createLabel}
                </div>
            </Link>
        </div>
    );
}
</file>

<file path="src/app/globals.css">
:root {
  --primary: #F5C242;
  /* Golden Yellow */
  --primary-light: #FFFBEB;
  /* Light Yellow */
  --primary-gradient: linear-gradient(135deg, #FDE68A 0%, #F5C242 50%, #F59E0B 100%);
  /* Yellow Gradient */
  --background: #F7F8FA;
  /* Light Grey Background */
  --foreground: #111827;
  /* Ink Black */
  --card-bg: #FFFFFF;
  /* Surface White */
  --border: #E5E7EB;
  /* Light Grey */
  --text-secondary: #6B7280;
  /* Slate Grey */
  --success: #22C55E;
  /* Green */
  --danger: #EF4444;
  /* Red */
}

body {
  color: var(--foreground);
  background: var(--background);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  padding-bottom: 60px;
  /* Space for bottom nav */
}

* {
  box-sizing: border-box;
  padding: 0;
  margin: 0;
}

a {
  color: inherit;
  text-decoration: none;
}

button {
  cursor: pointer;
  border: none;
  background: none;
  font-family: inherit;
}

.main-content {
  padding-top: env(safe-area-inset-top);
  min-height: 100vh;
}

.page-transition-container {
  width: 100%;
  overflow-x: hidden;
}
</file>

<file path="src/components/InvoiceTemplates/Template1.js">
import React from 'react';
import { formatCurrency } from '@/lib/utils/tax';
import { numberToWords } from '@/lib/utils/numberToWords';
import { useSettingsStore } from '@/lib/store/settingsStore';

export const Template1 = ({ data }) => {
    const {
        invoiceNumber, date, dueDate, placeOfSupply, invoiceCopyType,
        items = [], customer, details = {}, payment
    } = data;

    // Ensure totals object has all required fields with safe defaults
    const totals = {
        subtotal: 0,
        cgst: 0,
        sgst: 0,
        igst: 0,
        total: 0,
        roundOffAmount: 0,
        ...data.totals
    };

    const companyDetails = data.companyDetails || useSettingsStore.getState().companyDetails;

    // Helper to format address
    const formatAddress = (addr) => {
        if (!addr) return '';
        if (typeof addr === 'string') return addr;
        const parts = [
            addr.addressLine1,
            addr.addressLine2,
            addr.city,
            addr.state ? `${addr.state}${addr.pincode ? ' - ' + addr.pincode : ''}` : addr.pincode
        ].filter(Boolean);
        return parts.join(', ');
    };

    return (
        <div style={{ padding: '40px', background: 'white', width: '800px', fontFamily: 'Inter, sans-serif', color: '#1f2937', fontSize: '12px' }} id="invoice-template">
            {/* Header Section */}
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '20px' }}>
                <div style={{ flex: 1 }}>
                    {companyDetails.logo && <img src={companyDetails.logo} alt="Logo" style={{ height: '60px', marginBottom: '10px' }} />}
                    <h2 style={{ fontSize: '20px', fontWeight: 800, margin: '0 0 4px 0', color: '#111827' }}>{companyDetails.name}</h2>
                    {data.type !== 'PROFORMA' && <p style={{ margin: 0 }}><strong>GSTIN:</strong> {companyDetails.gstin}</p>}
                    <p style={{ margin: 0, maxWidth: '300px' }}>{formatAddress(companyDetails.billingAddress)}</p>
                    <p style={{ margin: 0 }}><strong>Mobile:</strong> {companyDetails.phone}</p>
                </div>
                <div style={{ textAlign: 'right' }}>
                    <h1 style={{ fontSize: '24px', color: '#2563eb', margin: '0 0 4px 0', fontWeight: 800 }}>
                        {data.type === 'PROFORMA' ? 'PRO FORMA INVOICE' : data.type === 'LENDING' ? 'LENDING BILL' : 'TAX INVOICE'}
                    </h1>
                    <p style={{ fontSize: '10px', textTransform: 'uppercase', color: '#6b7280', margin: 0 }}>{invoiceCopyType}</p>

                    <div style={{ marginTop: '20px', display: 'grid', gridTemplateColumns: 'auto auto', gap: '4px 12px', justifyContent: 'end', textAlign: 'right' }}>
                        <span style={{ fontWeight: 600 }}>{data.type === 'PROFORMA' ? 'Pro Forma #:' : data.type === 'LENDING' ? 'Bill #:' : 'Invoice #:'}</span> <span>{invoiceNumber}</span>
                        <span style={{ fontWeight: 600 }}>Date:</span> <span>{date}</span>
                        {data.type !== 'LENDING' && <><span style={{ fontWeight: 600 }}>Due Date:</span> <span>{dueDate}</span></>}
                        {data.type !== 'PROFORMA' && data.type !== 'LENDING' && <><span style={{ fontWeight: 600 }}>Place of Supply:</span> <span>{placeOfSupply}</span></>}
                    </div>
                </div>
            </div>

            {/* Buyer & Shipping Details */}
            <div style={{ display: 'flex', gap: '40px', marginBottom: '30px', borderTop: '1px solid #e5e7eb', paddingTop: '20px' }}>
                <div style={{ flex: 1 }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 700, margin: '0 0 8px 0', color: '#374151' }}>Bill To:</h3>
                    {customer ? (
                        <>
                            <p style={{ fontWeight: 700, margin: '0 0 2px 0' }}>{customer.name}</p>
                            {data.type !== 'PROFORMA' && <p style={{ margin: '0 0 2px 0' }}><strong>GSTIN:</strong> {customer.gstin}</p>}
                            <p style={{ margin: '0 0 2px 0' }}><strong>Ph:</strong> {customer.phone}</p>
                            <p style={{ margin: 0, maxWidth: '300px' }}>{formatAddress(customer.billingAddress)}</p>
                        </>
                    ) : <p style={{ color: '#9ca3af' }}>No Customer Selected</p>}
                </div>
                <div style={{ flex: 1 }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 700, margin: '0 0 8px 0', color: '#374151' }}>Ship To:</h3>
                    {customer ? (
                        <>
                            <p style={{ fontWeight: 700, margin: '0 0 2px 0' }}>{customer.companyName || customer.name}</p>
                            <p style={{ margin: 0, maxWidth: '300px' }}>{formatAddress(customer.shippingAddress || customer.billingAddress)}</p>
                        </>
                    ) : <p style={{ color: '#9ca3af' }}>Same as Billing</p>}
                </div>
            </div>

            {/* Items Table */}
            <table style={{ width: '100%', borderCollapse: 'collapse', marginBottom: '20px' }}>
                <thead>
                    <tr style={{ background: '#2563eb', color: 'white' }}>
                        <th style={{ padding: '8px', textAlign: 'left', fontSize: '12px' }}>#</th>
                        <th style={{ padding: '8px', textAlign: 'left', fontSize: '12px', width: data.type === 'LENDING' ? '70%' : '40%' }}>Item</th>
                        {data.type !== 'LENDING' && <th style={{ padding: '8px', textAlign: 'center', fontSize: '12px' }}>HSN/SAC</th>}
                        {data.type !== 'LENDING' && <th style={{ padding: '8px', textAlign: 'right', fontSize: '12px' }}>Rate</th>}
                        <th style={{ padding: '8px', textAlign: 'center', fontSize: '12px' }}>Qty</th>
                        {data.type !== 'LENDING' && <th style={{ padding: '8px', textAlign: 'right', fontSize: '12px' }}>Amount</th>}
                    </tr>
                </thead>
                <tbody>
                    {items.map((item, index) => (
                        <React.Fragment key={index}>
                            <tr style={{ borderBottom: (item.netWeight || item.makingChargePerGram) ? 'none' : '1px solid #e5e7eb' }}>
                                <td style={{ padding: '8px' }}>{index + 1}</td>
                                <td style={{ padding: '8px' }}>
                                    <div style={{ fontWeight: 600 }}>{item.name}</div>
                                </td>
                                {data.type !== 'LENDING' && <td style={{ padding: '8px', textAlign: 'center' }}>{item.hsn || '-'}</td>}
                                {data.type !== 'LENDING' && <td style={{ padding: '8px', textAlign: 'right' }}>{formatCurrency(item.rate)}</td>}
                                <td style={{ padding: '8px', textAlign: 'center' }}>{item.quantity}</td>
                                {data.type !== 'LENDING' && <td style={{ padding: '8px', textAlign: 'right', fontWeight: 600 }}>{formatCurrency(item.quantity * item.rate)}</td>}
                            </tr>
                            {/* Jewellery Detail Row */}
                            {(item.netWeight || item.makingChargePerGram) > 0 && (
                                <tr style={{ borderBottom: '1px solid #e5e7eb', fontSize: '10px', color: '#1f2937', background: '#F7F7F7' }}>
                                    <td colSpan={6} style={{ padding: '8px 12px 8px 12px' }}>
                                        <div style={{ display: 'flex', gap: '8px 16px', flexWrap: 'wrap', marginLeft: '32px' }}>
                                            <span><strong>Gross Wt:</strong> {item.grossWeight || 0}g</span>
                                            <span><strong>Net Wt:</strong> {item.netWeight || 0}g</span>
                                            <span><strong>Rate/gm:</strong> {formatCurrency(item.ratePerGram || 0)}</span>
                                            <span><strong>MC/gm:</strong> {formatCurrency(item.makingChargePerGram || 0)}</span>
                                            <span><strong>Mat. Val.:</strong> {formatCurrency(item.materialValue || 0)}</span>
                                            <span><strong>Making Chg:</strong> {formatCurrency(item.makingCharge || 0)}</span>
                                        </div>
                                    </td>
                                </tr>
                            )}
                        </React.Fragment>
                    ))}
                </tbody>
            </table>

            {/* Totals & Tax Summary */}
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '20px' }}>
                <div style={{ flex: 1 }}>
                    <div style={{ fontSize: '12px', color: '#6b7280', marginBottom: '4px' }}>Total Items / Qty: {items.length} / {items.reduce((acc, item) => acc + (item.quantity || 0), 0)}</div>
                </div>
                {data.type === 'LENDING' ? (
                    <div style={{ width: '350px', background: '#f9fafb', padding: '16px', borderRadius: '8px' }}>
                        <h4 style={{ margin: '0 0 12px 0', borderBottom: '1px solid #e5e7eb', paddingBottom: '8px' }}>Weight Summary</h4>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                            <span>Gross Weight:</span>
                            <strong>{data.weightSummary?.grossWeight || '0'} g</strong>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span>Net Weight:</span>
                            <strong>{data.weightSummary?.netWeight || '0'} g</strong>
                        </div>
                    </div>
                ) : (
                    <div style={{ width: '350px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', borderBottom: '1px solid #f3f4f6' }}>
                            <span>Taxable Amount</span>
                            <span style={{ fontWeight: 600 }}>{formatCurrency(totals.subtotal)}</span>
                        </div>
                        {/* Conditional Tax Rendering */}
                        {data.type !== 'PROFORMA' && (totals.igst > 0 ? (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', borderBottom: '1px solid #f3f4f6' }}>
                                <span>IGST</span>
                                <span>{formatCurrency(totals.igst)}</span>
                            </div>
                        ) : (
                            <>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', borderBottom: '1px solid #f3f4f6' }}>
                                    <span>CGST (1.5%)</span>
                                    <span>{formatCurrency(totals.cgst)}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', borderBottom: '1px solid #f3f4f6' }}>
                                    <span>SGST (1.5%)</span>
                                    <span>{formatCurrency(totals.sgst)}</span>
                                </div>
                            </>
                        ))}

                        {totals.roundOffAmount != null && totals.roundOffAmount !== 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', borderBottom: '1px solid #f3f4f6' }}>
                                <span>Round Off</span>
                                <span>{Number(totals.roundOffAmount).toFixed(2)}</span>
                            </div>
                        )}

                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px 0', borderTop: '2px solid #e5e7eb', marginTop: '8px', fontSize: '16px', fontWeight: 800 }}>
                            <span>Total</span>
                            <span>{formatCurrency(totals.total)}</span>
                        </div>
                    </div>
                )}
            </div>

            {/* Amount in Words - Hide for Lending */}
            {
                data.type !== 'LENDING' && (
                    <div style={{ borderTop: '1px solid #e5e7eb', borderBottom: '1px solid #e5e7eb', padding: '8px 0', marginBottom: '20px', fontStyle: 'italic' }}>
                        <span style={{ fontWeight: 600 }}>Total amount (in words): </span>
                        INR {numberToWords(Math.round(totals.total))} Only.
                    </div>
                )
            }

            {/* Footer: Bank & Signature */}
            <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '40px' }}>
                <div style={{ width: '50%' }}>
                    {/* Payment / Bank Details */}
                    <h4 style={{ margin: '0 0 8px 0', fontSize: '14px' }}>Bank Details:</h4>
                    <div style={{ fontSize: '12px', lineHeight: '1.6' }}>
                        <div><strong>Bank:</strong> {companyDetails.bankDetails?.bankName || '-'}</div>
                        <div><strong>Account #:</strong> {companyDetails.bankDetails?.accountNumber || '-'}</div>
                        <div><strong>IFSC:</strong> {companyDetails.bankDetails?.ifscCode || '-'}</div>
                        <div><strong>Branch:</strong> {companyDetails.bankDetails?.branchName || '-'}</div>
                    </div>

                    {/* QR Code Placeholder */}
                    {companyDetails.upiId && (
                        <div style={{ marginTop: '12px' }}>
                            <p style={{ margin: '0 0 4px 0', fontWeight: 600 }}>Pay using UPI:</p>
                            <div style={{ width: '80px', height: '80px', background: '#f3f4f6', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '10px' }}>
                                QR CODE
                            </div>
                        </div>
                    )}
                </div>

                <div style={{ textAlign: 'right', display: 'flex', flexDirection: 'column', justifyContent: 'space-between' }}>
                    <div style={{ fontSize: '12px' }}>For {companyDetails.name}</div>
                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', marginTop: '40px' }}>
                        {companyDetails.signatureUrl && (
                            <img src={companyDetails.signatureUrl} alt="Signature" style={{ height: '50px', marginBottom: '4px' }} />
                        )}
                        <div style={{ borderTop: '1px solid #374151', width: '150px', paddingTop: '4px', fontSize: '12px', fontWeight: 600 }}>
                            {companyDetails.authorizedSignatoryLabel || 'Authorized Signatory'}
                        </div>
                    </div>
                </div>
            </div>

            {/* Terms & Notes */}
            <div style={{ marginTop: '30px', fontSize: '10px', color: '#4b5563' }}>
                {details.notes && (
                    <div style={{ marginBottom: '10px' }}>
                        <strong>Notes:</strong> {details.notes}
                    </div>
                )}
                {details.terms && (
                    <div>
                        <strong>Terms and Conditions:</strong> {details.terms}
                    </div>
                )}
            </div>

            <div style={{ marginTop: '20px', fontSize: '10px', textAlign: 'center', color: '#9ca3af' }}>
                This is a digitally signed document
            </div>
        </div >
    );
};
</file>

<file path="src/components/InvoiceTemplates/Template2.js">
import React from 'react';
import { formatCurrency } from '@/lib/utils/tax';
import { numberToWords } from '@/lib/utils/numberToWords';
import { useSettingsStore } from '@/lib/store/settingsStore';

export const Template2 = ({ data }) => {
    const {
        invoiceNumber, date, dueDate, placeOfSupply, invoiceCopyType,
        items = [], customer, details = {}, payment
    } = data;

    // Ensure totals object has all required fields with safe defaults
    const totals = {
        subtotal: 0,
        cgst: 0,
        sgst: 0,
        igst: 0,
        total: 0,
        roundOffAmount: 0,
        ...data.totals
    };

    const companyDetails = data.companyDetails || useSettingsStore.getState().companyDetails;

    // Helper to format address without trailing commas
    const formatAddress = (addr) => {
        if (!addr) return '';
        if (typeof addr === 'string') return addr;
        const parts = [
            addr.addressLine1,
            addr.addressLine2,
            addr.city,
            addr.state ? `${addr.state}${addr.pincode ? ' - ' + addr.pincode : ''}` : addr.pincode
        ].filter(Boolean);
        return parts.join(', ');
    };

    return (
        <div style={{ padding: '40px', background: 'white', width: '800px', fontFamily: "'Inter', 'Helvetica Neue', Helvetica, Arial, sans-serif", color: '#111827', fontSize: '12px', lineHeight: '1.5' }} id="invoice-template">
            {/* Header Section */}
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '30px' }}>
                <div style={{ width: '50%' }}>
                    {companyDetails.logo ? (
                        <img src={companyDetails.logo} alt="Logo" style={{ height: '60px', marginBottom: '15px', objectFit: 'contain' }} />
                    ) : (
                        <h2 style={{ fontSize: '24px', fontWeight: 800, color: '#2563eb', margin: '0 0 10px 0' }}>{companyDetails.name}</h2>
                    )}

                    {/* Seller Details - Mimicking Godrej Layout */}
                    {companyDetails.logo && <div style={{ fontWeight: 800, fontSize: '16px', marginBottom: '4px' }}>{companyDetails.name}</div>}
                    <div style={{ fontWeight: 700, marginBottom: '2px' }}>GSTIN {companyDetails.gstin}</div>
                    <div style={{ maxWidth: '300px', color: '#374151' }}>{formatAddress(companyDetails.billingAddress)}</div>
                    {companyDetails.phone && <div>Mobile {companyDetails.phone}</div>}
                </div>

                <div style={{ textAlign: 'right' }}>
                    <h1 style={{ fontSize: '20px', color: '#2563eb', fontWeight: 700, margin: '0 0 2px 0', textTransform: 'uppercase' }}>
                        {data.type === 'PROFORMA' ? 'PRO FORMA INVOICE' : data.type === 'LENDING' ? 'LENDING BILL' : 'TAX INVOICE'}
                    </h1>
                    <div style={{ fontSize: '10px', textTransform: 'uppercase', color: '#6b7280', marginBottom: '20px' }}>{invoiceCopyType || 'ORIGINAL FOR RECIPIENT'}</div>

                    <div style={{ display: 'grid', gridTemplateColumns: 'auto auto', gap: '4px 16px', justifyContent: 'end', textAlign: 'right' }}>
                        <span style={{ color: '#6b7280' }}>{data.type === 'PROFORMA' ? 'Pro Forma #:' : data.type === 'LENDING' ? 'Bill #:' : 'Invoice #:'}</span> <span style={{ fontWeight: 600 }}>{invoiceNumber}</span>
                        <span style={{ color: '#6b7280' }}>Date:</span> <span style={{ fontWeight: 600 }}>{date}</span>
                        {data.type !== 'LENDING' && <><span style={{ color: '#6b7280' }}>Due Date:</span> <span style={{ fontWeight: 600 }}>{dueDate}</span></>}
                        {data.type !== 'PROFORMA' && data.type !== 'LENDING' && <><span style={{ color: '#6b7280' }}>Place of Supply:</span> <span style={{ fontWeight: 600 }}>{placeOfSupply}</span></>}
                    </div>
                </div>
            </div>

            {/* Bill To / Ship To */}
            <div style={{ display: 'flex', gap: '40px', marginBottom: '30px' }}>
                <div style={{ flex: 1 }}>
                    <div style={{ fontSize: '12px', color: '#6b7280', marginBottom: '4px' }}>Bill To:</div>
                    {customer ? (
                        <>
                            <div style={{ fontWeight: 700, fontSize: '14px', marginBottom: '2px' }}>{customer.name}</div>
                            <div style={{ fontWeight: 700, marginBottom: '2px' }}>GSTIN: {customer.gstin}</div>
                            {customer.phone && <div style={{ marginBottom: '2px' }}>Ph: {customer.phone}</div>}
                            <div style={{ maxWidth: '250px', color: '#374151' }}>{formatAddress(customer.billingAddress)}</div>
                        </>
                    ) : <div style={{ color: '#9ca3af' }}>No Customer Selected</div>}
                </div>
                <div style={{ flex: 1 }}>
                    <div style={{ fontSize: '12px', color: '#6b7280', marginBottom: '4px' }}>Ship To:</div>
                    {customer ? (
                        <>
                            <div style={{ maxWidth: '250px', color: '#374151' }}>
                                {formatAddress(customer.shippingAddress || customer.billingAddress)}
                            </div>
                        </>
                    ) : <div style={{ color: '#9ca3af' }}>Same as Billing</div>}
                </div>
            </div>

            {/* Items Table */}
            <table style={{ width: '100%', borderCollapse: 'collapse', marginBottom: '20px' }}>
                <thead>
                    <tr style={{ background: '#2563eb', color: 'white' }}>
                        <th style={{ padding: '10px', textAlign: 'left', fontSize: '12px', fontWeight: 600, width: '40px' }}>#</th>
                        <th style={{ padding: '10px', textAlign: 'left', fontSize: '12px', fontWeight: 600, width: data.type === 'LENDING' ? '70%' : 'auto' }}>Item</th>
                        {data.type !== 'LENDING' && <th style={{ padding: '10px', textAlign: 'center', fontSize: '12px', fontWeight: 600 }}>HSN/SAC</th>}
                        {data.type !== 'LENDING' && <th style={{ padding: '10px', textAlign: 'right', fontSize: '12px', fontWeight: 600 }}>Rate/Item</th>}
                        <th style={{ padding: '10px', textAlign: 'center', fontSize: '12px', fontWeight: 600 }}>Qty</th>
                        {data.type !== 'LENDING' && <th style={{ padding: '10px', textAlign: 'right', fontSize: '12px', fontWeight: 600 }}>Amount</th>}
                    </tr>
                </thead>
                <tbody>
                    {items.map((item, index) => (
                        <React.Fragment key={index}>
                            <tr style={{ borderBottom: (item.netWeight || item.makingChargePerGram) ? 'none' : '1px solid #e5e7eb' }}>
                                <td style={{ padding: '12px 10px', verticalAlign: 'top' }}>{index + 1}</td>
                                <td style={{ padding: '12px 10px', verticalAlign: 'top' }}>
                                    <div style={{ fontWeight: 600, marginBottom: '4px' }}>{item.name}</div>
                                </td>
                                {data.type !== 'LENDING' && <td style={{ padding: '12px 10px', textAlign: 'center', verticalAlign: 'top' }}>{item.hsn || '-'}</td>}
                                {data.type !== 'LENDING' && <td style={{ padding: '12px 10px', textAlign: 'right', verticalAlign: 'top' }}>{formatCurrency(item.rate)}</td>}
                                <td style={{ padding: '12px 10px', textAlign: 'center', verticalAlign: 'top' }}>{item.quantity}</td>
                                {data.type !== 'LENDING' && <td style={{ padding: '12px 10px', textAlign: 'right', verticalAlign: 'top', fontWeight: 600 }}>{formatCurrency(item.quantity * item.rate)}</td>}
                            </tr>
                            {/* Jewellery Detail Row */}
                            {(item.netWeight || item.makingChargePerGram) > 0 && (
                                <tr style={{ borderBottom: '1px solid #e5e7eb', fontSize: '10px', color: '#1f2937', background: '#F7F7F7' }}>
                                    <td colSpan={6} style={{ padding: '8px 12px 8px 12px' }}>
                                        <div style={{ display: 'flex', gap: '8px 16px', flexWrap: 'wrap', marginLeft: '32px' }}>
                                            <span><strong>Gross Wt:</strong> {item.grossWeight || 0}g</span>
                                            <span><strong>Net Wt:</strong> {item.netWeight || 0}g</span>
                                            <span><strong>Rate/gm:</strong> {formatCurrency(item.ratePerGram || 0)}</span>
                                            <span><strong>MC/gm:</strong> {formatCurrency(item.makingChargePerGram || 0)}</span>
                                            <span><strong>Mat. Val.:</strong> {formatCurrency(item.materialValue || 0)}</span>
                                            <span><strong>Making Chg:</strong> {formatCurrency(item.makingCharge || 0)}</span>
                                        </div>
                                    </td>
                                </tr>
                            )}
                        </React.Fragment>
                    ))}
                    {/* Empty rows filler if needed, but keeping it dynamic is better */}
                </tbody>
            </table>

            {/* Footer Section */}
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '20px' }}>
                <div style={{ flex: 1, paddingRight: '40px' }}>
                    <div style={{ borderTop: '1px solid #e5e7eb', paddingTop: '8px', fontSize: '11px', color: '#6b7280' }}>
                        Total Items / Qty : {items.length} / {items.reduce((acc, item) => acc + (item.quantity || 0), 0)}
                    </div>
                </div>

                {data.type === 'LENDING' ? (
                    <div style={{ width: '350px', background: '#f9fafb', padding: '16px', borderRadius: '8px' }}>
                        <h4 style={{ margin: '0 0 12px 0', borderBottom: '1px solid #e5e7eb', paddingBottom: '8px' }}>Weight Summary</h4>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                            <span>Gross Weight:</span>
                            <strong>{data.weightSummary?.grossWeight || '0'} g</strong>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span>Net Weight:</span>
                            <strong>{data.weightSummary?.netWeight || '0'} g</strong>
                        </div>
                    </div>
                ) : (
                    <div style={{ width: '350px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '12px' }}>
                            <span style={{ fontWeight: 600 }}>Taxable Amount</span>
                            <span style={{ fontWeight: 600 }}>{formatCurrency(totals.subtotal)}</span>
                        </div>

                        {data.type !== 'PROFORMA' && (totals.igst > 0 ? (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '12px' }}>
                                <span>IGST</span>
                                <span>{formatCurrency(totals.igst)}</span>
                            </div>
                        ) : (
                            <>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '12px' }}>
                                    <span>CGST (1.5%)</span>
                                    <span>{formatCurrency(totals.cgst)}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '12px' }}>
                                    <span>SGST (1.5%)</span>
                                    <span>{formatCurrency(totals.sgst)}</span>
                                </div>
                            </>
                        ))}

                        {totals.roundOffAmount != null && totals.roundOffAmount !== 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '12px' }}>
                                <span>Round Off</span>
                                <span>{Number(totals.roundOffAmount).toFixed(2)}</span>
                            </div>
                        )}

                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px 0', borderTop: '1px solid #e5e7eb', borderBottom: '1px solid #e5e7eb', marginTop: '8px', marginBottom: '8px' }}>
                            <span style={{ fontSize: '18px', fontWeight: 800 }}>Total</span>
                            <span style={{ fontSize: '18px', fontWeight: 800 }}>{formatCurrency(totals.total)}</span>
                        </div>

                        <div style={{ fontSize: '11px', color: '#6b7280', textAlign: 'right' }}>
                            Amount Payable: <span style={{ color: '#000', fontWeight: 600 }}>{formatCurrency(totals.total)}</span>
                        </div>
                    </div>
                )}
            </div>

            {/* Amount in Words */}
            {data.type !== 'LENDING' && (
                <div style={{ borderBottom: '1px solid #e5e7eb', paddingBottom: '10px', marginBottom: '20px', fontSize: '12px' }}>
                    <span style={{ color: '#6b7280' }}>Total amount (in words): </span>
                    <span style={{ fontWeight: 600 }}>INR {numberToWords(Math.round(totals.total))} Only.</span>
                </div>
            )}

            {/* Bank & Signature */}
            <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '20px' }}>
                <div style={{ width: '50%' }}>
                    {/* UPI QR */}
                    <div style={{ display: 'flex', gap: '20px' }}>
                        {companyDetails.upiId && (
                            <div>
                                <div style={{ fontWeight: 600, marginBottom: '4px' }}>Pay using UPI:</div>
                                <div style={{ width: '80px', height: '80px', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontSize: '10px' }}>
                                    QR CODE
                                </div>
                            </div>
                        )}

                        <div>
                            <div style={{ fontWeight: 600, marginBottom: '8px' }}>Bank Details:</div>
                            <div style={{ display: 'grid', gridTemplateColumns: 'auto auto', gap: '2px 10px', fontSize: '12px' }}>
                                <span style={{ color: '#6b7280' }}>Bank:</span> <span style={{ fontWeight: 600 }}>{companyDetails.bankDetails?.bankName || '-'}</span>
                                <span style={{ color: '#6b7280' }}>Account #:</span> <span style={{ fontWeight: 600 }}>{companyDetails.bankDetails?.accountNumber || '-'}</span>
                                <span style={{ color: '#6b7280' }}>IFSC:</span> <span style={{ fontWeight: 600 }}>{companyDetails.bankDetails?.ifscCode || '-'}</span>
                                <span style={{ color: '#6b7280' }}>Branch:</span> <span style={{ fontWeight: 600 }}>{companyDetails.bankDetails?.branchName || '-'}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div style={{ textAlign: 'right', display: 'flex', flexDirection: 'column', justifyContent: 'flex-end' }}>
                    <div style={{ fontSize: '11px', color: '#6b7280', marginBottom: '40px' }}>For {companyDetails.name}</div>
                    {companyDetails.signatureUrl && (
                        <img src={companyDetails.signatureUrl} alt="Signature" style={{ height: '50px', alignSelf: 'flex-end', marginBottom: '4px' }} />
                    )}
                    <div style={{ width: '120px', height: '60px', border: '1px dashed #ccc', display: 'flex', alignItems: 'center', justifyContent: 'center', borderRadius: '50%', alignSelf: 'flex-end', color: '#2563eb', fontWeight: 700, fontSize: '10px', transform: 'rotate(-10deg)' }}>
                        {companyDetails.signatureUrl ? '' : 'SIGNATURE'}
                    </div>
                </div>
            </div>

            {/* Terms & Notes */}
            <div style={{ marginTop: '30px', fontSize: '10px', color: '#4b5563' }}>
                {details.notes && (
                    <div style={{ marginBottom: '8px' }}>
                        <div style={{ fontWeight: 700, marginBottom: '2px' }}>Notes:</div>
                        <div>{details.notes}</div>
                    </div>
                )}
                <div style={{ fontWeight: 700, marginBottom: '2px' }}>Terms and Conditions:</div>
                <div style={{ lineHeight: '1.4' }}>
                    {details.terms || '1. Goods once sold cannot be taken back or exchanged.\n2. We are not the manufacturers, company will stand for warranty as per their terms and conditions.\n3. Subject to local Jurisdiction.'}
                </div>
            </div>

            <div style={{ marginTop: '30px', fontSize: '10px', color: '#9ca3af', display: 'flex', justifyContent: 'space-between' }}>
                <span>Page 1/1</span>
                <span>This is a digitally signed document</span>
            </div>
        </div>
    );
};
</file>

<file path="src/components/InvoiceTemplates/Template3.js">
import React from 'react';
import { formatCurrency } from '@/lib/utils/tax';
import { numberToWords } from '@/lib/utils/numberToWords';
import { useSettingsStore } from '@/lib/store/settingsStore';

export const Template3 = ({ data }) => {
    const {
        invoiceNumber, date, dueDate, placeOfSupply, invoiceCopyType,
        items = [], customer, details = {}, payment
    } = data;

    // Ensure totals object has all required fields with safe defaults
    const totals = {
        subtotal: 0,
        cgst: 0,
        sgst: 0,
        igst: 0,
        total: 0,
        roundOffAmount: 0,
        ...data.totals
    };

    const companyDetails = data.companyDetails || useSettingsStore.getState().companyDetails;

    const formatAddress = (addr) => {
        if (!addr) return '';
        if (typeof addr === 'string') return addr;
        const parts = [
            addr.addressLine1,
            addr.addressLine2,
            addr.city,
            addr.state ? `${addr.state}${addr.pincode ? ' - ' + addr.pincode : ''}` : addr.pincode
        ].filter(Boolean);
        return parts.join(', ');
    };

    return (
        <div style={{ padding: '40px', background: 'white', width: '800px', fontFamily: 'Georgia, serif', color: '#444', fontSize: '12px' }} id="invoice-template">
            {/* Header */}
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '40px' }}>
                <div>
                    <h1 style={{ fontSize: '36px', color: '#c2410c', margin: '0 0 10px 0' }}>{data.type === 'PROFORMA' ? 'PRO FORMA' : data.type === 'LENDING' ? 'LENDING BILL' : 'INVOICE'}</h1>
                    <div style={{ fontSize: '14px', color: '#78716c' }}>#{invoiceNumber}</div>
                    <div style={{ fontSize: '12px', color: '#78716c', marginTop: '4px' }}>{invoiceCopyType}</div>
                </div>
                <div style={{ textAlign: 'right' }}>
                    {companyDetails.logo && <img src={companyDetails.logo} alt="Logo" style={{ height: '50px', marginBottom: '10px' }} />}
                    <div style={{ fontWeight: 'bold', fontSize: '16px', color: '#c2410c' }}>{companyDetails.name}</div>
                    <div>{formatAddress(companyDetails.billingAddress)}</div>
                    <div>GSTIN: {companyDetails.gstin}</div>
                </div>
            </div>

            <div style={{ display: 'flex', justifyContent: 'space-between', background: '#fff7ed', padding: '20px', borderRadius: '8px', marginBottom: '30px' }}>
                <div>
                    <h3 style={{ fontSize: '12px', textTransform: 'uppercase', color: '#c2410c', margin: '0 0 8px 0' }}>Billed To</h3>
                    {customer ? (
                        <>
                            <div style={{ fontWeight: 'bold', fontSize: '14px' }}>{customer.name}</div>
                            <div>{formatAddress(customer.billingAddress)}</div>
                            <div>GSTIN: {customer.gstin}</div>
                        </>
                    ) : <div>No Customer</div>}
                </div>
                <div style={{ textAlign: 'right' }}>
                    <h3 style={{ fontSize: '12px', textTransform: 'uppercase', color: '#c2410c', margin: '0 0 8px 0' }}>Invoice Details</h3>
                    <div><strong>Date:</strong> {date}</div>
                    <div><strong>Due Date:</strong> {dueDate}</div>
                    <div><strong>Place of Supply:</strong> {placeOfSupply}</div>
                </div>
            </div>

            {/* Table */}
            <table style={{ width: '100%', borderCollapse: 'collapse', marginBottom: '30px' }}>
                <thead>
                    <tr style={{ borderBottom: '2px solid #c2410c', color: '#c2410c' }}>
                        <th style={{ padding: '10px', textAlign: 'left' }}>Item</th>
                        {data.type !== 'LENDING' && <th style={{ padding: '10px', textAlign: 'center' }}>HSN</th>}
                        {data.type !== 'LENDING' && <th style={{ padding: '10px', textAlign: 'right' }}>Rate</th>}
                        <th style={{ padding: '10px', textAlign: 'center' }}>Qty</th>
                        {data.type !== 'LENDING' && <th style={{ padding: '10px', textAlign: 'right' }}>Amount</th>}
                    </tr>
                </thead>
                <tbody>
                    {items.map((item, index) => (
                        <React.Fragment key={index}>
                            <tr style={{ borderBottom: (item.netWeight || item.makingChargePerGram) ? 'none' : '1px solid #e7e5e4' }}>
                                <td style={{ padding: '10px' }}>
                                    <div style={{ fontWeight: 'bold' }}>{item.name}</div>
                                </td>
                                {data.type !== 'LENDING' && <td style={{ padding: '10px', textAlign: 'center' }}>{item.hsn || '-'}</td>}
                                {data.type !== 'LENDING' && <td style={{ padding: '10px', textAlign: 'right' }}>{formatCurrency(item.rate)}</td>}
                                <td style={{ padding: '10px', textAlign: 'center' }}>{item.quantity}</td>
                                {data.type !== 'LENDING' && <td style={{ padding: '10px', textAlign: 'right' }}>{formatCurrency(item.quantity * item.rate)}</td>}
                            </tr>
                            {/* Jewellery Detail Row */}
                            {(item.netWeight || item.makingChargePerGram) > 0 && (
                                <tr style={{ borderBottom: '1px solid #e7e5e4', fontSize: '10px', color: '#444', background: '#F7F7F7' }}>
                                    <td colSpan={5} style={{ padding: '8px 12px 8px 12px' }}>
                                        <div style={{ display: 'flex', gap: '8px 16px', flexWrap: 'wrap', marginLeft: '24px' }}>
                                            <span><strong>Gross Wt:</strong> {item.grossWeight || 0}g</span>
                                            <span><strong>Net Wt:</strong> {item.netWeight || 0}g</span>
                                            <span><strong>Rate/gm:</strong> {formatCurrency(item.ratePerGram || 0)}</span>
                                            <span><strong>MC/gm:</strong> {formatCurrency(item.makingChargePerGram || 0)}</span>
                                            <span><strong>Mat. Val.:</strong> {formatCurrency(item.materialValue || 0)}</span>
                                            <span><strong>Making Chg:</strong> {formatCurrency(item.makingCharge || 0)}</span>
                                        </div>
                                    </td>
                                </tr>
                            )}
                        </React.Fragment>
                    ))}
                </tbody>
            </table>

            {/* Totals */}
            {data.type === 'LENDING' ? (
                <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: '30px' }}>
                    <div style={{ width: '300px', background: '#fff7ed', padding: '10px', borderRadius: '4px' }}>
                        <h4 style={{ margin: '0 0 12px 0', borderBottom: '1px solid #fed7aa', paddingBottom: '8px', color: '#c2410c' }}>Weight Summary</h4>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                            <span>Gross Weight:</span>
                            <strong>{data.weightSummary?.grossWeight || '0'} g</strong>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span>Net Weight:</span>
                            <strong>{data.weightSummary?.netWeight || '0'} g</strong>
                        </div>
                    </div>
                </div>
            ) : (
                <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: '30px' }}>
                    <div style={{ width: '300px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '5px 0' }}>
                            <span>Subtotal</span>
                            <span>{formatCurrency(totals.subtotal)}</span>
                        </div>
                        {data.type !== 'PROFORMA' && (totals.igst > 0 ? (
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '5px 0' }}>
                                <span>IGST</span>
                                <span>{formatCurrency(totals.igst)}</span>
                            </div>
                        ) : (
                            <>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '5px 0' }}>
                                    <span>CGST (1.5%)</span>
                                    <span>{formatCurrency(totals.cgst)}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '5px 0' }}>
                                    <span>SGST (1.5%)</span>
                                    <span>{formatCurrency(totals.sgst)}</span>
                                </div>
                            </>
                        ))}
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderTop: '2px solid #c2410c', marginTop: '10px', color: '#c2410c', fontWeight: 'bold', fontSize: '16px' }}>
                            <span>Total</span>
                            <span>{formatCurrency(totals.total)}</span>
                        </div>
                    </div>
                </div>
            )}

            {data.type !== 'LENDING' && (
                <div style={{ background: '#fff7ed', padding: '10px', borderRadius: '4px', textAlign: 'center', marginBottom: '30px', fontStyle: 'italic' }}>
                    {numberToWords(Math.round(totals.total))} Rupees Only
                </div>
            )}

            {/* Footer */}
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <div>
                    <h4 style={{ color: '#c2410c', margin: '0 0 5px 0' }}>Bank Details</h4>
                    <div>{companyDetails.bankDetails?.bankName}</div>
                    <div>{companyDetails.bankDetails?.accountNumber}</div>
                    <div>{companyDetails.bankDetails?.ifscCode}</div>
                </div>
                <div style={{ textAlign: 'right' }}>
                    {companyDetails.signatureUrl && <img src={companyDetails.signatureUrl} alt="Signature" style={{ height: '40px' }} />}
                    <div style={{ borderTop: '1px solid #ccc', paddingTop: '5px', marginTop: '5px' }}>{companyDetails.authorizedSignatoryLabel}</div>
                </div>
            </div>
        </div>
    );
};
</file>

<file path="src/lib/store/settingsStore.js">
import { create } from 'zustand';
import { api } from '@/api/backendClient';
import { logger, LOG_EVENTS } from '@/lib/logger';

export const useSettingsStore = create((set, get) => ({
    companyDetails: {
        name: '',
        gstin: '',
        phone: '',
        email: '',
        tradeName: '',
        billingAddress: { addressLine1: '', addressLine2: '', pincode: '', city: '', state: '' },
        shippingAddress: { addressLine1: '', addressLine2: '', pincode: '', city: '', state: '' },
        panNumber: '',
        alternatePhone: '',
        website: '',
        customFields: [],
        logo: null,
        bankDetails: {
            bankName: '',
            accountNumber: '',
            ifscCode: '',
            branchName: '',
            accountHolderName: ''
        },
        signatureUrl: null,
        authorizedSignatoryLabel: 'Authorized Signatory',
        upiId: ''
    },
    userProfile: {
        name: '',
        email: '',
        phone: ''
    },
    templateId: 'modern',
    lendingBillTemplateId: 'modern',
    isLoading: false,
    error: null,

    loadSettings: async () => {
        set({ isLoading: true, error: null });
        try {
            const settings = await api.settings.get();

            // Map backend settings to store state
            if (settings.companyDetails) {
                set({ companyDetails: settings.companyDetails });
            }
            if (settings.userProfile) {
                set({ userProfile: settings.userProfile });
            }
            if (settings.templateId) {
                set({ templateId: settings.templateId });
            }
            if (settings.lendingBillTemplateId) {
                set({ lendingBillTemplateId: settings.lendingBillTemplateId });
            }

            set({ isLoading: false });
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_LOAD_ERROR, { store: 'settings', error: error.message });
            set({ error: error.message, isLoading: false });
        }
    },

    updateCompanyDetails: async (details) => {
        const newDetails = { ...get().companyDetails, ...details };
        set({ companyDetails: newDetails });
        try {
            await api.settings.update('companyDetails', newDetails);
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_UPDATE_ERROR, { store: 'settings_company', error: error.message });
            throw error;
        }
    },

    updateUserProfile: async (details) => {
        const newDetails = { ...get().userProfile, ...details };
        set({ userProfile: newDetails });
        try {
            await api.settings.update('userProfile', newDetails);
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_UPDATE_ERROR, { store: 'settings_profile', error: error.message });
            throw error;
        }
    },

    setTemplateId: async (id) => {
        set({ templateId: id });
        try {
            await api.settings.update('templateId', id);
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_UPDATE_ERROR, { store: 'settings_template', error: error.message });
            throw error;
        }
    },

    setLendingBillTemplateId: async (id) => {
        set({ lendingBillTemplateId: id });
        try {
            await api.settings.update('lendingBillTemplateId', id);
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_UPDATE_ERROR, { store: 'settings_lending_template', error: error.message });
            throw error;
        }
    },

    // Note: resetData would require a backend endpoint
    // For now, this resets local state only
    resetData: async () => {
        logger.warn('RESET_DATA_WARNING', { message: 'Full data reset requires backend support' });
        set({
            companyDetails: {
                name: '', gstin: '', phone: '', email: '', address: '', logo: null,
                bankDetails: { bankName: '', accountNumber: '', ifscCode: '', branchName: '', accountHolderName: '' },
                signatureUrl: null, authorizedSignatoryLabel: '', upiId: ''
            },
            userProfile: { name: '', email: '', phone: '' },
            templateId: 'modern',
            lendingBillTemplateId: 'modern'
        });
    },

    clearError: () => set({ error: null }),
}));
</file>

<file path="src/app/parties/customer/view/page.js">
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { usePartyStore } from '@/lib/store/partyStore';
import { useInvoiceStore } from '@/lib/store/invoiceStore';
import { api } from '@/api/backendClient';
import { shareText, downloadCSV, downloadPDFBlob } from '@/lib/utils/invoiceActions';
import { FiArrowLeft, FiPhone, FiMail, FiShare2, FiMessageCircle, FiEdit2, FiMoreHorizontal, FiFileText, FiFile, FiPlusSquare, FiGitMerge, FiTrash2 } from 'react-icons/fi';
import { motion, AnimatePresence } from 'framer-motion';
import { TransactionCard } from '@/components/TransactionCard';
import { InvoiceBottomSheet } from '@/components/InvoiceBottomSheet';
import jsPDF from 'jspdf';

function CustomerLedgerContent() {
    const router = useRouter();
    const searchParams = useSearchParams();
    const id = searchParams.get('id');
    const { getCustomer, deleteCustomer } = usePartyStore();
    const { invoices, loadInvoices } = useInvoiceStore();

    const [customer, setCustomer] = useState(null);
    const [transactions, setTransactions] = useState([]);
    const [activeTab, setActiveTab] = useState('ledger');
    const [selectedInvoice, setSelectedInvoice] = useState(null);
    const [isMenuOpen, setIsMenuOpen] = useState(false);

    const handleWhatsApp = () => {
        if (customer.phone) {
            // Remove non-numeric characters for the link
            const cleanNumber = customer.phone.replace(/\D/g, '');
            window.open(`https://wa.me/${cleanNumber}`, '_blank');
        } else {
            alert('Phone number not available');
        }
    };

    const handleCall = () => {
        if (customer.phone) {
            window.open(`tel:${customer.phone}`, '_self');
        } else {
            alert('Phone number not available');
        }
    };

    const handleEmail = () => {
        if (customer.email) {
            window.open(`mailto:${customer.email}`, '_self');
        } else {
            alert('Email not available');
        }
    };

    const handleShare = async () => {
        await shareText({
            title: 'Customer Details',
            text: `Customer: ${customer.name}\nPhone: ${customer.phone || 'N/A'}\nBalance: ₹${customer.balance?.toFixed(2) || '0.00'}`,
            dialogTitle: 'Share Customer Details'
        });
    };

    const handleDownloadExcel = async () => {
        const data = transactions.map(tx => ({
            Date: new Date(tx.date).toLocaleDateString(),
            Type: tx.type,
            Number: tx.number,
            Amount: tx.amount,
            Status: tx.status
        }));

        if (!data || !data.length) {
            alert('No transactions to export');
            return;
        }

        // Build CSV content
        const headers = Object.keys(data[0]);
        const csvContent = [
            headers.join(','),
            ...data.map(row => headers.map(fieldName => {
                const value = row[fieldName];
                return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
            }).join(','))
        ].join('\n');

        await downloadCSV(csvContent, `${customer.name}_ledger.csv`);
        setIsMenuOpen(false);
    };

    const handleDownloadPDF = async () => {
        const doc = new jsPDF();

        // Header
        doc.setFontSize(20);
        doc.text(customer.name, 14, 22);
        doc.setFontSize(12);
        doc.text(`Phone: ${customer.phone || 'N/A'}`, 14, 30);
        doc.text(`Balance: ${customer.balance?.toFixed(2)}`, 14, 38);

        // Table Header
        let y = 50;
        doc.setFontSize(10);
        doc.setTextColor(100);
        doc.text('Date', 14, y);
        doc.text('Type', 60, y);
        doc.text('Number', 100, y);
        doc.text('Amount', 150, y);
        doc.text('Balance', 180, y);

        doc.line(14, y + 2, 200, y + 2);
        y += 10;
        doc.setTextColor(0);

        // Table Rows
        transactions.forEach(tx => {
            if (y > 280) {
                doc.addPage();
                y = 20;
            }

            const date = new Date(tx.date).toLocaleDateString();
            const type = tx.type === 'payment_in' ? 'Payment In' :
                tx.type === 'payment_out' ? 'Payment Out' : 'Invoice';
            const number = tx.number;
            const amount = tx.amount.toFixed(2);
            const balance = tx.balance !== undefined ? tx.balance.toFixed(2) : '-';

            doc.text(date, 14, y);
            doc.text(type, 60, y);
            doc.text(number, 100, y);
            doc.text(amount, 150, y);
            doc.text(balance, 180, y);

            y += 8;
        });

        const pdfBlob = doc.output('blob');
        await downloadPDFBlob(pdfBlob, `${customer.name}_ledger.pdf`);
        setIsMenuOpen(false);
    };

    const handleDeleteCustomer = async () => {
        if (confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
            await deleteCustomer(customer.id);
            router.push('/parties');
        }
    };

    const menuItemStyle = {
        display: 'flex', alignItems: 'center', gap: '12px', padding: '12px',
        fontSize: '16px', fontWeight: 500, color: '#374151', cursor: 'pointer',
        borderRadius: '8px', transition: 'background 0.2s'
    };

    useEffect(() => {
        if (id) {
            const c = getCustomer(id);
            if (c) setCustomer(c);
            loadInvoices();
        }
    }, [id]);

    useEffect(() => {
        const loadData = async () => {
            if (customer) {
                console.log('[CustomerView] loadData called, customer.id:', customer.id);

                // Get Invoices and Legacy Payments from 'invoices' table
                const allInvoiceRecords = invoices.filter(inv =>
                    inv.customerId === customer.id || inv.customer?.id === customer.id
                );

                const realInvoices = allInvoiceRecords.filter(inv => !inv.type || inv.type === 'invoice');
                const legacyPayments = allInvoiceRecords.filter(inv => inv.type === 'payment_in' || inv.type === 'payment_out');

                // Get New Payments directly from backend API
                let newPayments = [];
                try {
                    newPayments = await api.payments.listByParty(customer.id);
                    console.log('[CustomerView] Payments from API:', newPayments);
                } catch (err) {
                    console.error('[CustomerView] Failed to fetch payments:', err);
                }

                const invoiceTxs = realInvoices.map(inv => ({
                    id: `inv-${inv.id}`,
                    date: inv.date,
                    type: 'invoice',
                    number: inv.invoiceNumber,
                    amount: inv.totals?.total || 0,
                    status: inv.status || 'Unpaid',
                    balance: inv.balanceDue !== undefined ? inv.balanceDue : (inv.totals?.total || 0),
                    data: inv
                }));

                const legacyPaymentTxs = legacyPayments.map(pay => ({
                    id: `inv-${pay.id}`,
                    date: pay.date,
                    type: pay.type, // 'payment_in' or 'payment_out'
                    number: pay.invoiceNumber,
                    amount: pay.totals?.total || 0,
                    status: 'Paid',
                    balance: 0,
                    data: pay
                }));

                const newPaymentTxs = newPayments.map(pay => ({
                    id: `pay-${pay.id}`,
                    date: pay.date,
                    type: pay.type === 'IN' ? 'payment_in' : 'payment_out',
                    number: pay.transactionNumber,
                    amount: pay.amount,
                    status: 'Paid',
                    balance: 0,
                    data: pay
                }));

                const allTxs = [...invoiceTxs, ...legacyPaymentTxs, ...newPaymentTxs];
                console.log('[CustomerView] allTxs total:', allTxs.length);

                // Sort by date descending
                allTxs.sort((a, b) => new Date(b.date) - new Date(a.date));

                setTransactions(allTxs);
            }
        };
        loadData();
    }, [customer, invoices]);

    if (!customer) return <div>Loading...</div>;

    return (
        <div style={{ background: '#f3f4f6', minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
            {/* Header */}
            <div style={{ background: 'white', padding: '16px', borderBottom: '1px solid #eee' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                    <FiArrowLeft size={24} onClick={() => router.back()} style={{ cursor: 'pointer' }} />
                    <div style={{ display: 'flex', gap: '16px', position: 'relative' }}>
                        <FiMoreHorizontal size={24} onClick={() => setIsMenuOpen(true)} style={{ cursor: 'pointer' }} />
                    </div>
                </div>

                {/* Menu Bottom Sheet */}
                <AnimatePresence>
                    {isMenuOpen && (
                        <>
                            <motion.div
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                exit={{ opacity: 0 }}
                                onClick={() => setIsMenuOpen(false)}
                                style={{
                                    position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', zIndex: 40
                                }}
                            />
                            <motion.div
                                initial={{ y: '100%' }}
                                animate={{ y: 0 }}
                                exit={{ y: '100%' }}
                                transition={{ type: 'spring', damping: 25, stiffness: 300 }}
                                style={{
                                    position: 'fixed', bottom: 0, left: 0, right: 0,
                                    background: 'white', borderTopLeftRadius: '20px', borderTopRightRadius: '20px',
                                    padding: '20px', zIndex: 50, maxHeight: '80vh', overflowY: 'auto'
                                }}
                            >
                                <div style={{ width: '40px', height: '4px', background: '#e5e7eb', borderRadius: '2px', margin: '0 auto 20px' }} />

                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                    <div onClick={() => { setIsMenuOpen(false); router.push(`/parties/customer/edit?id=${customer.id}`); }} style={menuItemStyle}>
                                        <FiEdit2 size={20} /> Edit Customer
                                    </div>
                                    <div style={{ height: '1px', background: '#f3f4f6', margin: '4px 0' }} />

                                    <div onClick={handleDownloadExcel} style={menuItemStyle}>
                                        <FiFileText size={20} /> Download Ledger Excel
                                    </div>
                                    <div onClick={handleDownloadPDF} style={menuItemStyle}>
                                        <FiFile size={20} /> Download Ledger Pdf
                                    </div>
                                    <div style={{ height: '1px', background: '#f3f4f6', margin: '4px 0' }} />

                                    <div onClick={() => { setIsMenuOpen(false); router.push(`/invoice/create?customerId=${customer.id}`); }} style={menuItemStyle}>
                                        <FiPlusSquare size={20} /> Create Invoice
                                    </div>
                                    <div style={{ height: '1px', background: '#f3f4f6', margin: '4px 0' }} />

                                    <div onClick={() => alert('Merge functionality coming soon')} style={menuItemStyle}>
                                        <FiGitMerge size={20} /> Merge
                                    </div>
                                    <div style={{ height: '1px', background: '#f3f4f6', margin: '4px 0' }} />

                                    <div onClick={handleDeleteCustomer} style={{ ...menuItemStyle, color: '#dc2626' }}>
                                        <FiTrash2 size={20} /> Delete Customer
                                    </div>
                                </div>
                            </motion.div>
                        </>
                    )}
                </AnimatePresence>

                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '24px' }}>
                    <div style={{
                        width: '64px', height: '64px', borderRadius: '50%', background: '#e0e7ff',
                        color: '#3730a3', display: 'flex', alignItems: 'center', justifyContent: 'center',
                        fontSize: '24px', fontWeight: 'bold', marginBottom: '12px'
                    }}>
                        {customer.name[0]}
                    </div>
                    <div style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '4px' }}>{customer.name}</div>
                    <div style={{ fontSize: '16px', color: '#dc2626', fontWeight: 600 }}>
                        ₹ {customer.balance?.toFixed(2) || '0.00'}
                    </div>
                </div>

                <div style={{ display: 'flex', justifyContent: 'space-around', paddingBottom: '8px' }}>
                    <div onClick={handleWhatsApp} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', cursor: 'pointer' }}>
                        <div style={{ padding: '10px', borderRadius: '50%', border: '1px solid #eee' }}><FiMessageCircle size={20} color="#2563eb" /></div>
                        <span style={{ fontSize: '12px', color: '#666' }}>WhatsApp</span>
                    </div>
                    <div onClick={handleCall} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', cursor: 'pointer' }}>
                        <div style={{ padding: '10px', borderRadius: '50%', border: '1px solid #eee' }}><FiPhone size={20} color="#2563eb" /></div>
                        <span style={{ fontSize: '12px', color: '#666' }}>Call</span>
                    </div>
                    <div onClick={handleEmail} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', cursor: 'pointer' }}>
                        <div style={{ padding: '10px', borderRadius: '50%', border: '1px solid #eee' }}><FiMail size={20} color="#2563eb" /></div>
                        <span style={{ fontSize: '12px', color: '#666' }}>Mail</span>
                    </div>
                    <div onClick={handleShare} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', cursor: 'pointer' }}>
                        <div style={{ padding: '10px', borderRadius: '50%', border: '1px solid #eee' }}><FiShare2 size={20} color="#2563eb" /></div>
                        <span style={{ fontSize: '12px', color: '#666' }}>Share</span>
                    </div>
                </div>
            </div>

            {/* Tabs */}
            <div style={{ background: 'white', display: 'flex', borderBottom: '1px solid #eee' }}>
                <div
                    onClick={() => setActiveTab('ledger')}
                    style={{
                        flex: 1, textAlign: 'center', padding: '16px', fontWeight: 600, cursor: 'pointer',
                        color: activeTab === 'ledger' ? '#2563eb' : '#6b7280',
                        borderBottom: activeTab === 'ledger' ? '2px solid #2563eb' : 'none'
                    }}
                >
                    Ledger
                </div>
                <div
                    onClick={() => setActiveTab('transactions')}
                    style={{
                        flex: 1, textAlign: 'center', padding: '16px', fontWeight: 600, cursor: 'pointer',
                        color: activeTab === 'transactions' ? '#2563eb' : '#6b7280',
                        borderBottom: activeTab === 'transactions' ? '2px solid #2563eb' : 'none'
                    }}
                >
                    Transactions
                </div>
            </div>

            {/* List */}
            <div style={{ flex: 1, overflowY: 'auto', paddingBottom: '80px' }}>
                {transactions.length === 0 ? (
                    <div style={{ textAlign: 'center', padding: '40px', color: '#9ca3af' }}>No transactions found</div>
                ) : (
                    transactions.map(tx => (
                        <TransactionCard
                            key={tx.id}
                            transaction={tx}
                            onClick={() => setSelectedInvoice(tx.data)}
                        />
                    ))
                )}
            </div>

            {/* Footer Actions */}
            <div style={{
                position: 'fixed', bottom: 0, left: 0, right: 0, background: 'white', padding: '16px',
                display: 'flex', gap: '16px', boxShadow: '0 -2px 10px rgba(0,0,0,0.05)'
            }}>
                <button
                    onClick={() => router.push(`/parties/payment/create?customerId=${customer.id}&mode=out`)}
                    style={{
                        flex: 1, background: '#dc2626', color: 'white', padding: '16px', borderRadius: '8px',
                        border: 'none', fontWeight: 'bold', fontSize: '16px', cursor: 'pointer'
                    }}>
                    YOU GAVE ₹
                </button>
                <button
                    onClick={() => router.push(`/parties/payment/create?customerId=${customer.id}`)}
                    style={{
                        flex: 1, background: '#16a34a', color: 'white', padding: '16px', borderRadius: '8px',
                        border: 'none', fontWeight: 'bold', fontSize: '16px', cursor: 'pointer'
                    }}>
                    YOU GOT ₹
                </button>
            </div>

            <InvoiceBottomSheet
                isOpen={!!selectedInvoice}
                onClose={() => setSelectedInvoice(null)}
                invoice={selectedInvoice}
                onRecordPayment={() => alert('Record Payment Coming Soon')}
                onShare={() => alert('Share functionality already implemented in Invoice View')}
            />
        </div>
    );
}

export default function CustomerLedgerPage() {
    return (
        <Suspense fallback={<div>Loading...</div>}>
            <CustomerLedgerContent />
        </Suspense>
    );
}
</file>

<file path="src/app/products/edit/page.js">
'use client';

import { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useProductStore } from '@/lib/store/productStore';
import { useMasterStore } from '@/lib/store/masterStore';
import { api } from '@/api/backendClient';
import { FiArrowLeft, FiPlusCircle, FiImage, FiMoreHorizontal, FiPlus, FiMinus, FiChevronDown, FiChevronUp, FiLock, FiUnlock, FiX, FiLoader, FiTrash2 } from 'react-icons/fi';
import styles from '../page.module.css'; // Reuse styles

export default function EditProductPage() {
    const router = useRouter();
    const searchParams = useSearchParams();
    const id = searchParams.get('id');
    const { updateProduct, uploadProductImage, deleteProductImage } = useProductStore();
    const { categories, loadCategories, subCategories, loadSubCategories } = useMasterStore();
    const [loading, setLoading] = useState(true);
    const [skuLocked, setSkuLocked] = useState(true);

    const [formData, setFormData] = useState({
        type: 'product',
        name: '',
        sellingPrice: '',
        purchasePrice: '',
        taxRate: 3,
        unit: 'gms',
        hsn: '',
        category: '',
        subCategory: '',
        sku: '',
        description: '',

        // Metal Attributes
        metalType: 'Gold',
        metalColor: 'Yellow',
        purity: '22K',
        grossWeight: '',
        netWeight: '',
        wastagePercentage: '',
        wastageWeight: '',
        makingCharges: '',
        makingChargesType: 'per_gram',
        metalRateRef: '',

        // Gemstone Attributes
        hasStones: false,
        stoneType: '',
        stoneCount: '',
        stoneWeight: '',
        stoneShape: '',
        stoneClarity: '',
        stoneColor: '',
        stoneCut: '',
        stoneCertification: '',
        stonePrice: '',
        stoneSetting: '',

        // Design & Dimensions
        size: '',
        pattern: '',
        customizable: false,
        engravingText: '',

        // Pricing & Inventory
        vendorRef: '',
        procurementDate: new Date().toISOString().split('T')[0],

        // Taxation & Compliance
        hallmarkCert: '',
        barcode: '',

        // Optional
        occasion: '',
        collection: '',
        launchDate: '',
        tags: '',

        showOnline: true,
        notForSale: false
    });

    // Existing images from the server (with id and url)
    const [existingImages, setExistingImages] = useState([]);
    // Pending new images to upload (File objects with preview URLs)
    const [pendingImages, setPendingImages] = useState([]);
    // Images being deleted (for UI feedback)
    const [deletingImages, setDeletingImages] = useState(new Set());
    const [isUploading, setIsUploading] = useState(false);
    const [uploadProgress, setUploadProgress] = useState({ current: 0, total: 0 });

    useEffect(() => {
        loadCategories();
        loadSubCategories();
    }, []);

    useEffect(() => {
        const loadProduct = async () => {
            if (!id) return;
            try {
                const product = await api.products.get(id);
                if (product) {
                    // Store existing images separately (use url from API response)
                    setExistingImages(product.images || []);

                    // Map product fields with null-safe defaults to prevent controlled component warnings
                    setFormData(prev => ({
                        ...prev,
                        type: product.type || 'product',
                        name: product.name || '',
                        sellingPrice: product.sellingPrice ?? '',
                        purchasePrice: product.purchasePrice ?? '',
                        taxRate: product.taxRate ?? 3,
                        unit: product.unit || 'gms',
                        hsn: product.hsn || '',
                        category: product.category || '',
                        subCategory: product.subCategory || '',
                        sku: product.sku || '',
                        description: product.description || '',
                        vendorRef: product.vendorRef || '',
                        procurementDate: product.procurementDate || new Date().toISOString().split('T')[0],
                        hallmarkCert: product.hallmarkCert || '',
                        barcode: product.barcode || '',
                        launchDate: product.launchDate || '',
                        occasion: product.occasion || '',
                        collection: product.collection || '',
                        tags: product.tags || '',
                        showOnline: product.showOnline ?? true,
                        notForSale: product.notForSale ?? false,

                        // Flatten Metal Attributes
                        metalType: product.metal?.type || 'Gold',
                        metalColor: product.metal?.color || 'Yellow',
                        purity: product.metal?.purity || '22K',
                        grossWeight: product.metal?.grossWeight ?? '',
                        netWeight: product.metal?.netWeight ?? '',
                        wastagePercentage: product.metal?.wastagePercentage ?? '',
                        wastageWeight: product.metal?.wastageWeight ?? '',
                        makingCharges: product.metal?.makingCharges ?? '',
                        makingChargesType: product.metal?.makingChargesType || 'per_gram',
                        metalRateRef: product.metal?.rateRef || '',

                        // Flatten Gemstone Attributes
                        hasStones: !!product.gemstone,
                        stoneType: product.gemstone?.type || '',
                        stoneCount: product.gemstone?.count ?? '',
                        stoneWeight: product.gemstone?.weight ?? '',
                        stoneShape: product.gemstone?.shape || '',
                        stoneClarity: product.gemstone?.clarity || '',
                        stoneColor: product.gemstone?.color || '',
                        stoneCut: product.gemstone?.cut || '',
                        stoneCertification: product.gemstone?.certification || '',
                        stonePrice: product.gemstone?.price ?? '',
                        stoneSetting: product.gemstone?.setting || '',

                        // Flatten Design Attributes
                        size: product.design?.size || '',
                        pattern: product.design?.pattern || '',
                        customizable: product.design?.customizable ?? false,
                        engravingText: product.design?.engravingText || ''
                    }));
                }
            } catch (error) {
                console.error('Failed to load product', error);
            } finally {
                setLoading(false);
            }
        };
        loadProduct();
    }, [id]);

    const handleSave = async () => {
        if (!formData.name) return alert('Product Name is required');

        // Audit Log for Manual SKU - via backend API
        if (!skuLocked) {
            try {
                await api.auditLogs.create({
                    entityType: 'product',
                    entityId: id,
                    action: 'MANUAL_SKU_OVERRIDE',
                    details: `SKU updated to ${formData.sku}`,
                });
            } catch (e) {
                console.error("Failed to log audit", e);
            }
        }

        // Product payload - NO images (managed separately per API spec)
        const payload = {
            type: formData.type,
            name: formData.name,
            sellingPrice: formData.sellingPrice ? Number(formData.sellingPrice) : null,
            purchasePrice: formData.purchasePrice ? Number(formData.purchasePrice) : null,
            taxRate: formData.taxRate,
            unit: formData.unit,
            hsn: formData.hsn,
            category: formData.category,
            subCategory: formData.subCategory,
            sku: formData.sku,
            description: formData.description,
            vendorRef: formData.vendorRef,
            procurementDate: formData.procurementDate,
            hallmarkCert: formData.hallmarkCert,
            barcode: formData.barcode,
            launchDate: formData.launchDate || null,
            showOnline: formData.showOnline,
            notForSale: formData.notForSale,
            occasion: formData.occasion,
            collection: formData.collection,
            tags: formData.tags,
            // images: NOT included - managed via separate API calls

            // Nested Objects
            metal: {
                type: formData.metalType,
                color: formData.metalColor,
                purity: formData.purity,
                grossWeight: Number(formData.grossWeight || 0),
                netWeight: Number(formData.netWeight || 0),
                wastagePercentage: Number(formData.wastagePercentage || 0),
                wastageWeight: Number(formData.wastageWeight || 0),
                makingCharges: Number(formData.makingCharges || 0),
                makingChargesType: formData.makingChargesType,
                rateRef: formData.metalRateRef
            },

            gemstone: formData.hasStones ? {
                type: formData.stoneType,
                count: Number(formData.stoneCount || 0),
                weight: Number(formData.stoneWeight || 0),
                shape: formData.stoneShape,
                clarity: formData.stoneClarity,
                color: formData.stoneColor,
                cut: formData.stoneCut,
                certification: formData.stoneCertification,
                price: Number(formData.stonePrice || 0),
                setting: formData.stoneSetting
            } : null,

            design: {
                size: formData.size,
                pattern: formData.pattern,
                customizable: formData.customizable,
                engravingText: formData.engravingText
            }
        };

        try {
            // Step 1: Update the product (images not affected)
            await updateProduct(id, payload);

            // Step 2: Upload pending new images (if any)
            if (pendingImages.length > 0) {
                setIsUploading(true);
                setUploadProgress({ current: 0, total: pendingImages.length });

                const uploadQueue = [...pendingImages];
                const concurrencyLimit = 2;
                const failedUploads = [];

                const uploadNext = async () => {
                    while (uploadQueue.length > 0) {
                        const img = uploadQueue.shift();
                        try {
                            const result = await uploadProductImage(id, img.file);
                            // Add to existing images for display
                            setExistingImages(prev => [...prev, result]);
                        } catch (error) {
                            console.error('Image upload failed:', error);
                            failedUploads.push(img.file.name);
                        }
                        setUploadProgress(prev => ({ ...prev, current: prev.current + 1 }));
                    }
                };

                await Promise.all(
                    Array(Math.min(concurrencyLimit, pendingImages.length))
                        .fill(null)
                        .map(() => uploadNext())
                );

                setIsUploading(false);
                setPendingImages([]);

                if (failedUploads.length > 0) {
                    alert(`Product updated, but ${failedUploads.length} image(s) failed to upload: ${failedUploads.join(', ')}`);
                }
            }

            // Cleanup preview URLs
            pendingImages.forEach(img => URL.revokeObjectURL(img.previewUrl));

            router.back();
        } catch (error) {
            console.error('Failed to update product:', error);
            alert('Failed to update product: ' + error.message);
        }
    };

    const handleImageSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
            const previewUrl = URL.createObjectURL(file);
            setPendingImages(prev => [...prev, { file, previewUrl, name: file.name }]);
        }
        e.target.value = '';
    };

    const handleRemovePendingImage = (index) => {
        setPendingImages(prev => {
            const removed = prev[index];
            URL.revokeObjectURL(removed.previewUrl);
            return prev.filter((_, i) => i !== index);
        });
    };

    const handleDeleteExistingImage = async (imageId) => {
        if (deletingImages.has(imageId)) return;

        setDeletingImages(prev => new Set(prev).add(imageId));

        try {
            await deleteProductImage(id, imageId);
            setExistingImages(prev => prev.filter(img => img.id !== imageId));
        } catch (error) {
            console.error('Failed to delete image:', error);
            alert('Failed to delete image: ' + error.message);
        } finally {
            setDeletingImages(prev => {
                const next = new Set(prev);
                next.delete(imageId);
                return next;
            });
        }
    };

    if (loading) return <div className={styles.container}>Loading...</div>;

    return (
        <div className={styles.container}>
            <div className={styles.header}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                    <FiArrowLeft size={24} onClick={() => router.back()} style={{ cursor: 'pointer' }} />
                    Edit Product
                </div>
                <FiMoreHorizontal size={24} />
            </div>

            {/* Core Product Metadata */}
            <div className={styles.sectionTitle}>Core Details</div>
            <div className={styles.card}>
                <div className={styles.radioGroup} style={{ marginBottom: 16 }}>
                    <label className={styles.radioLabel}>
                        <input
                            type="radio"
                            checked={formData.type === 'product'}
                            onChange={() => setFormData({ ...formData, type: 'product' })}
                        /> Product
                    </label>
                    <label className={styles.radioLabel}>
                        <input
                            type="radio"
                            checked={formData.type === 'service'}
                            onChange={() => setFormData({ ...formData, type: 'service' })}
                        /> Service
                    </label>
                </div>

                <input
                    className={styles.input}
                    placeholder="Product Name / Title"
                    value={formData.name}
                    onChange={e => setFormData({ ...formData, name: e.target.value })}
                />
                <div style={{ display: 'flex', gap: 12 }}>
                    <select
                        className={styles.select}
                        value={formData.category}
                        onChange={e => setFormData({ ...formData, category: e.target.value, subCategory: '' })}
                        style={{ flex: 1 }}
                    >
                        <option value="">Select Category</option>
                        {categories.map(c => (
                            <option key={c.id} value={c.name}>{c.name}</option>
                        ))}
                    </select>
                    <select
                        className={styles.select}
                        value={formData.subCategory}
                        onChange={e => setFormData({ ...formData, subCategory: e.target.value })}
                        style={{ flex: 1 }}
                        disabled={!formData.category}
                    >
                        <option value="">Select Sub-category</option>
                        {subCategories
                            .filter(sc => {
                                const parent = categories.find(c => c.name === formData.category);
                                return parent && sc.categoryId === parent.id;
                            })
                            .map(sc => (
                                <option key={sc.id} value={sc.name}>{sc.name}</option>
                            ))
                        }
                    </select>
                </div>
            </div>

            <div style={{ position: 'relative' }}>
                <input
                    className={styles.input}
                    placeholder="SKU / Product Code"
                    value={formData.sku}
                    onChange={e => setFormData({ ...formData, sku: e.target.value })}
                    disabled={skuLocked}
                    style={{ paddingRight: 40, backgroundColor: skuLocked ? '#f3f4f6' : 'white' }}
                />
                <div
                    onClick={() => setSkuLocked(!skuLocked)}
                    style={{
                        position: 'absolute', right: 12, top: '50%', transform: 'translateY(-50%)',
                        cursor: 'pointer', color: '#6b7280'
                    }}
                    title={skuLocked ? "Unlock to override" : "Lock to edit"}
                >
                    {skuLocked ? <FiLock /> : <FiUnlock />}
                </div>
            </div>

            <textarea
                className={styles.input}
                placeholder="Description"
                value={formData.description}
                onChange={e => setFormData({ ...formData, description: e.target.value })}
                rows={3}
                style={{ resize: 'none', paddingTop: 14, height: 'auto', minHeight: '80px' }}
            />


            {/* Metal-Specific Attributes */}
            <div className={styles.sectionTitle}>Metal Attributes</div>
            <div className={styles.card}>
                <div style={{ display: 'flex', gap: 12 }}>
                    <select
                        className={styles.select}
                        value={formData.metalType}
                        onChange={e => setFormData({ ...formData, metalType: e.target.value })}
                        style={{ flex: 1 }}
                    >
                        <option value="Gold">Gold</option>
                        <option value="Silver">Silver</option>
                        <option value="Platinum">Platinum</option>
                    </select>
                    <select
                        className={styles.select}
                        value={formData.metalColor}
                        onChange={e => setFormData({ ...formData, metalColor: e.target.value })}
                        style={{ flex: 1 }}
                    >
                        <option value="Yellow">Yellow</option>
                        <option value="White">White</option>
                        <option value="Rose">Rose</option>
                        <option value="Two-tone">Two-tone</option>
                    </select>
                </div>
                <div style={{ display: 'flex', gap: 12 }}>
                    <select
                        className={styles.select}
                        value={formData.purity}
                        onChange={e => setFormData({ ...formData, purity: e.target.value })}
                        style={{ flex: 1 }}
                    >
                        <option value="24K">24K (999)</option>
                        <option value="22K">22K (916)</option>
                        <option value="18K">18K (750)</option>
                        <option value="14K">14K (585)</option>
                    </select>
                    <input
                        className={styles.input}
                        type="number"
                        placeholder="Gross Weight (g)"
                        value={formData.grossWeight}
                        onChange={e => setFormData({ ...formData, grossWeight: e.target.value })}
                        style={{ flex: 1 }}
                    />
                </div>
                <div style={{ display: 'flex', gap: 12 }}>
                    <input
                        className={styles.input}
                        type="number"
                        placeholder="Net Metal Weight (g)"
                        value={formData.netWeight}
                        onChange={e => setFormData({ ...formData, netWeight: e.target.value })}
                        style={{ flex: 1 }}
                    />
                    <input
                        className={styles.input}
                        type="number"
                        placeholder="Wastage %"
                        value={formData.wastagePercentage}
                        onChange={e => setFormData({ ...formData, wastagePercentage: e.target.value })}
                        style={{ flex: 1 }}
                    />
                </div>
                <div style={{ display: 'flex', gap: 12 }}>
                    <input
                        className={styles.input}
                        type="number"
                        placeholder="Making Charges"
                        value={formData.makingCharges}
                        onChange={e => setFormData({ ...formData, makingCharges: e.target.value })}
                        style={{ flex: 2 }}
                    />
                    <select
                        className={styles.select}
                        value={formData.makingChargesType}
                        onChange={e => setFormData({ ...formData, makingChargesType: e.target.value })}
                        style={{ flex: 1 }}
                    >
                        <option value="per_gram">Per Gram</option>
                        <option value="fixed">Fixed</option>
                    </select>
                </div>
            </div>

            {/* Gemstone Attributes (Collapsible)*/}
            <div className={styles.card} style={{ padding: 0, overflow: 'hidden' }}>
                <div
                    onClick={() => setFormData({ ...formData, hasStones: !formData.hasStones })}
                    style={{
                        padding: 16, display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                        cursor: 'pointer', background: formData.hasStones ? '#f9fafb' : 'white'
                    }}
                >
                    <div style={{ fontWeight: 600, display: 'flex', alignItems: 'center', gap: 8 }}>
                        Gemstone / Diamond Attributes
                        {formData.hasStones && <span style={{ fontSize: 10, background: '#dcfce7', color: '#166534', padding: '2px 6px', borderRadius: 4 }}>Active</span>}
                    </div>
                    {formData.hasStones ? <FiMinus /> : <FiPlus />}
                </div>

                {formData.hasStones && (
                    <div style={{ padding: 16, borderTop: '1px solid #e5e7eb' }}>
                        <div style={{ display: 'flex', gap: 12 }}>
                            <input
                                className={styles.input}
                                placeholder="Stone Type (e.g. Diamond, Ruby)"
                                value={formData.stoneType}
                                onChange={e => setFormData({ ...formData, stoneType: e.target.value })}
                                style={{ flex: 1 }}
                            />
                            <input
                                className={styles.input}
                                type="number"
                                placeholder="Total Count"
                                value={formData.stoneCount}
                                onChange={e => setFormData({ ...formData, stoneCount: e.target.value })}
                                style={{ flex: 1 }}
                            />
                        </div>
                        <div style={{ display: 'flex', gap: 12 }}>
                            <input
                                className={styles.input}
                                type="number"
                                placeholder="Weight (carats)"
                                value={formData.stoneWeight}
                                onChange={e => setFormData({ ...formData, stoneWeight: e.target.value })}
                                style={{ flex: 1 }}
                            />
                            <input
                                className={styles.input}
                                placeholder="Shape (Round, Oval)"
                                value={formData.stoneShape}
                                onChange={e => setFormData({ ...formData, stoneShape: e.target.value })}
                                style={{ flex: 1 }}
                            />
                        </div>
                        <div style={{ display: 'flex', gap: 12 }}>
                            <input
                                className={styles.input}
                                placeholder="Clarity (SI, VS, VVS)"
                                value={formData.stoneClarity}
                                onChange={e => setFormData({ ...formData, stoneClarity: e.target.value })}
                                style={{ flex: 1 }}
                            />
                            <input
                                className={styles.input}
                                placeholder="Color (D, E, F...)"
                                value={formData.stoneColor}
                                onChange={e => setFormData({ ...formData, stoneColor: e.target.value })}
                                style={{ flex: 1 }}
                            />
                        </div>
                        <input
                            className={styles.input}
                            placeholder="Certification (GIA, IGI...)"
                            value={formData.stoneCertification}
                            onChange={e => setFormData({ ...formData, stoneCertification: e.target.value })}
                        />
                        <input
                            className={styles.input}
                            type="number"
                            placeholder="Stone Price / Charges"
                            value={formData.stonePrice}
                            onChange={e => setFormData({ ...formData, stonePrice: e.target.value })}
                        />
                    </div>
                )}
            </div>

            {/* Design & Dimensions (Collapsible) */}
            <div className={styles.card} style={{ padding: 0, overflow: 'hidden', marginTop: 16 }}>
                <div
                    onClick={() => setFormData(prev => ({ ...prev, showDesign: !prev.showDesign }))}
                    style={{
                        padding: 16, display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                        cursor: 'pointer', background: formData.showDesign ? '#f9fafb' : 'white'
                    }}
                >
                    <div style={{ fontWeight: 600 }}>Design & Dimension Attributes</div>
                    {formData.showDesign ? <FiMinus /> : <FiPlus />}
                </div>

                {formData.showDesign && (
                    <div style={{ padding: 16, borderTop: '1px solid #e5e7eb' }}>
                        <input
                            className={styles.input}
                            placeholder="Size (Ring size, Length)"
                            value={formData.size}
                            onChange={e => setFormData({ ...formData, size: e.target.value })}
                        />
                        <input
                            className={styles.input}
                            placeholder="Pattern / Design Details"
                            value={formData.pattern}
                            onChange={e => setFormData({ ...formData, pattern: e.target.value })}
                        />
                        <input
                            className={styles.input}
                            placeholder="Engraving Text"
                            value={formData.engravingText}
                            onChange={e => setFormData({ ...formData, engravingText: e.target.value })}
                        />
                        <div className={styles.toggleRow} style={{ marginTop: 8 }}>
                            <span className={styles.toggleLabel}>Customizable</span>
                            <input
                                type="checkbox"
                                checked={formData.customizable}
                                onChange={e => setFormData({ ...formData, customizable: e.target.checked })}
                            />
                        </div>
                    </div>
                )}
            </div>

            {/* Pricing & Inventory*/}
            <div className={styles.sectionTitle}>Pricing & Inventory</div>
            <div className={styles.card}>
                <input
                    className={styles.input}
                    type="number"
                    placeholder="Selling Price (Final)"
                    value={formData.sellingPrice}
                    onChange={e => setFormData({ ...formData, sellingPrice: e.target.value })}
                />
                <input
                    className={styles.input}
                    type="number"
                    placeholder="Purchase Price / Cost"
                    value={formData.purchasePrice}
                    onChange={e => setFormData({ ...formData, purchasePrice: e.target.value })}
                />
                <div style={{ display: 'flex', gap: 12 }}>
                    <input
                        className={styles.input}
                        placeholder="Vendor Reference"
                        value={formData.vendorRef}
                        onChange={e => setFormData({ ...formData, vendorRef: e.target.value })}
                        style={{ flex: 1 }}
                    />
                    <input
                        className={styles.input}
                        type="date"
                        placeholder="Procurement Date"
                        value={formData.procurementDate}
                        onChange={e => setFormData({ ...formData, procurementDate: e.target.value })}
                        style={{ flex: 1 }}
                    />
                </div>
            </div>

            {/* Taxation & Compliance*/}
            <div className={styles.sectionTitle}>Taxation & Compliance</div>
            <div className={styles.card}>
                <div style={{ display: 'flex', gap: 12 }}>
                    <input
                        className={styles.input}
                        placeholder="HSN Code"
                        value={formData.hsn}
                        onChange={e => setFormData({ ...formData, hsn: e.target.value })}
                        style={{ flex: 1 }}
                    />
                    <select
                        className={styles.select}
                        value={formData.taxRate}
                        onChange={e => setFormData({ ...formData, taxRate: Number(e.target.value) })}
                        style={{ flex: 1, marginBottom: 12 }}
                    >
                        <option value={0}>Tax Rate 0%</option>
                        <option value={3}>Tax Rate 3%</option>
                        <option value={5}>Tax Rate 5%</option>
                        <option value={12}>Tax Rate 12%</option>
                        <option value={18}>Tax Rate 18%</option>
                    </select>
                </div>
                <input
                    className={styles.input}
                    placeholder="BIS Hallmark Cert Number"
                    value={formData.hallmarkCert}
                    onChange={e => setFormData({ ...formData, hallmarkCert: e.target.value })}
                />
                <input
                    className={styles.input}
                    placeholder="Barcode (Auto-generated if empty)"
                    value={formData.barcode}
                    onChange={e => setFormData({ ...formData, barcode: e.target.value })}
                />
            </div>

            {/* Media & Attachments*/}
            <div className={styles.sectionTitle}>Product Images</div>
            <div className={styles.card}>
                <div style={{ fontSize: 12, color: '#6b7280', marginBottom: 12 }}>
                    Product images must be PNG or JPEG, recommended 1024 px by 1024 px or 1:1 aspect ratio.
                    {(existingImages.length > 0 || pendingImages.length > 0) && (
                        <span style={{ color: '#3b82f6', marginLeft: 8 }}>
                            ({existingImages.length} saved{pendingImages.length > 0 ? `, ${pendingImages.length} pending` : ''})
                        </span>
                    )}
                </div>
                <div style={{ display: 'flex', gap: 12, overflowX: 'auto' }}>
                    {/* Add new image button */}
                    <label style={{
                        width: 80, height: 80, border: '1px dashed #e5e7eb', borderRadius: 8,
                        display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',
                        cursor: 'pointer', flexShrink: 0
                    }}>
                        <input type="file" accept="image/*" style={{ display: 'none' }} onChange={handleImageSelect} />
                        <FiImage size={24} color="#3b82f6" />
                        <span style={{ fontSize: 10, fontWeight: 600, marginTop: 4 }}>New<br />Image</span>
                    </label>

                    {/* Existing images from server */}
                    {existingImages.map((img) => (
                        <div key={img.id} style={{ position: 'relative', flexShrink: 0 }}>
                            <img
                                src={api.photos.getFullUrl(img.url)}
                                alt=""
                                style={{
                                    width: 80, height: 80, borderRadius: 8, objectFit: 'cover',
                                    opacity: deletingImages.has(img.id) ? 0.5 : 1
                                }}
                            />
                            <button
                                onClick={() => handleDeleteExistingImage(img.id)}
                                disabled={deletingImages.has(img.id)}
                                style={{
                                    position: 'absolute', top: -6, right: -6,
                                    width: 20, height: 20, borderRadius: '50%',
                                    background: '#ef4444', border: 'none', color: 'white',
                                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                                    cursor: deletingImages.has(img.id) ? 'not-allowed' : 'pointer', fontSize: 12
                                }}
                            >
                                {deletingImages.has(img.id) ? <FiLoader size={10} /> : <FiTrash2 size={10} />}
                            </button>
                        </div>
                    ))}

                    {/* Pending new images (not yet uploaded) */}
                    {pendingImages.map((img, idx) => (
                        <div key={`pending-${idx}`} style={{ position: 'relative', flexShrink: 0 }}>
                            <img
                                src={img.previewUrl}
                                alt=""
                                style={{ width: 80, height: 80, borderRadius: 8, objectFit: 'cover', border: '2px dashed #3b82f6' }}
                            />
                            <button
                                onClick={() => handleRemovePendingImage(idx)}
                                style={{
                                    position: 'absolute', top: -6, right: -6,
                                    width: 20, height: 20, borderRadius: '50%',
                                    background: '#f97316', border: 'none', color: 'white',
                                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                                    cursor: 'pointer', fontSize: 12
                                }}
                            >
                                <FiX size={12} />
                            </button>
                            <span style={{
                                position: 'absolute', bottom: 4, left: 4, right: 4,
                                fontSize: 8, color: '#3b82f6', textAlign: 'center',
                                background: 'rgba(255,255,255,0.9)', borderRadius: 2, padding: '1px 2px'
                            }}>Pending</span>
                        </div>
                    ))}
                </div>
            </div>

            {/* Optional Metadata*/}
            <div className={styles.sectionTitle}>Optional Details</div>
            <div className={styles.card}>
                <input
                    className={styles.input}
                    placeholder="Occasion (Wedding, Daily...)"
                    value={formData.occasion}
                    onChange={e => setFormData({ ...formData, occasion: e.target.value })}
                />
                <input
                    className={styles.input}
                    placeholder="Collection Name"
                    value={formData.collection}
                    onChange={e => setFormData({ ...formData, collection: e.target.value })}
                />
                <input
                    className={styles.input}
                    placeholder="Tags (Comma separated)"
                    value={formData.tags}
                    onChange={e => setFormData({ ...formData, tags: e.target.value })}
                />

                <div className={styles.toggleRow} style={{ marginTop: 12, borderTop: '1px solid #f3f4f6', paddingTop: 12 }}>
                    <span className={styles.toggleLabel}>Show in online store</span>
                    <input
                        type="checkbox"
                        checked={formData.showOnline}
                        onChange={e => setFormData({ ...formData, showOnline: e.target.checked })}
                    />
                </div>
                <div className={styles.toggleRow}>
                    <span className={styles.toggleLabel}>Not For Sale</span>
                    <input
                        type="checkbox"
                        checked={formData.notForSale}
                        onChange={e => setFormData({ ...formData, notForSale: e.target.checked })}
                    />
                </div>
            </div>

            <div className={styles.footer}>
                <button
                    className={styles.saveButton}
                    onClick={handleSave}
                    disabled={isUploading}
                    style={isUploading ? { opacity: 0.7, cursor: 'not-allowed' } : {}}
                >
                    {isUploading ? (
                        <span style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                            <FiLoader style={{ animation: 'spin 1s linear infinite' }} />
                            Uploading {uploadProgress.current}/{uploadProgress.total}...
                        </span>
                    ) : (
                        'Update Product'
                    )}
                </button>
            </div>
        </div >
    );
}
</file>

<file path="src/app/layout.js">
import "./globals.css";
import BottomNav from "@/components/BottomNav";
import BackButtonHandler from "@/components/BackButtonHandler";
import { ToastProvider } from "@/components/Toast";

import AppBootstrap from '@/components/AppBootstrap/AppBootstrap';

export const metadata = {
  title: 'Swipe Invoice',
  description: 'Create invoices on the go',
  manifest: '/manifest.json',
};

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body>
        <AppBootstrap>
          <ToastProvider>
            <BackButtonHandler />
            <div className="main-content">
              {children}
            </div>
            <BottomNav />
          </ToastProvider>
        </AppBootstrap>
      </body>
    </html>
  );
}
</file>

<file path="src/lib/store/productStore.js">
import { create } from 'zustand';
import { api } from '@/api/backendClient';
import { logger, LOG_EVENTS } from '@/lib/logger';

export const useProductStore = create((set, get) => ({
    products: [],
    isLoading: false,
    error: null,

    loadProducts: async (filters = {}) => {
        set({ isLoading: true, error: null });
        try {
            const products = await api.products.list(filters);
            set({ products: products.reverse(), isLoading: false });
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_LOAD_ERROR, { store: 'products', error: error.message });
            set({ error: error.message, isLoading: false });
        }
    },

    getProductByBarcode: async (barcode) => {
        try {
            const products = await api.products.list({ barcode });
            return products.length > 0 ? products[0] : null;
        } catch (error) {
            logger.error(LOG_EVENTS.PRODUCT_SCAN_ERROR, { barcode, error: error.message });
            return null;
        }
    },

    // SKU is now generated by backend - this is just for display preview
    generateSKU: async (category, subCategory) => {
        if (!category || !subCategory) return '';
        const catPrefix = category.slice(0, 3).toUpperCase();
        const subPrefix = subCategory.slice(0, 3).toUpperCase();
        // Preview format - actual SKU assigned by backend
        return `${catPrefix}-${subPrefix}-XXXXXX`;
    },

    addProduct: async (product) => {
        set({ isLoading: true, error: null });
        try {
            // Backend generates ID and SKU
            const newProduct = await api.products.create(product);
            set((state) => ({
                products: [newProduct, ...state.products],
                isLoading: false
            }));
            return newProduct.id;
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_SAVE_ERROR, { store: 'product', error: error.message });
            set({ error: error.message, isLoading: false });
            throw error;
        }
    },

    deleteProduct: async (id) => {
        set({ isLoading: true, error: null });
        try {
            await api.products.delete(id);
            set((state) => ({
                products: state.products.filter(p => p.id !== id),
                isLoading: false
            }));
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_DELETE_ERROR, { store: 'product', id, error: error.message });
            set({ error: error.message, isLoading: false });
            throw error;
        }
    },

    updateProduct: async (id, updates) => {
        set({ isLoading: true, error: null });
        try {
            const updatedProduct = await api.products.update(id, updates);
            set((state) => ({
                products: state.products.map(p =>
                    p.id === id ? { ...p, ...updatedProduct } : p
                ),
                isLoading: false
            }));
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_UPDATE_ERROR, { store: 'product', id, error: error.message });
            set({ error: error.message, isLoading: false });
            throw error;
        }
    },

    /**
     * Upload an image to a product (optimistic update with rollback)
     * @param {string} productId - Product ID (must exist)
     * @param {File} file - Image file to upload
     * @returns {Promise<{id: string, url: string}>} The uploaded image info
     */
    uploadProductImage: async (productId, file) => {
        // Create optimistic image entry with temp ID
        const tempId = `temp_${Date.now()}`;
        const tempUrl = URL.createObjectURL(file);
        const optimisticImage = { id: tempId, url: tempUrl, uploading: true };

        // Optimistically add to state
        set((state) => ({
            products: state.products.map(p =>
                p.id === productId
                    ? { ...p, images: [...(p.images || []), optimisticImage] }
                    : p
            )
        }));

        try {
            const result = await api.products.images.upload(productId, file);

            // Replace temp image with real one
            set((state) => ({
                products: state.products.map(p =>
                    p.id === productId
                        ? {
                            ...p,
                            images: (p.images || []).map(img =>
                                img.id === tempId
                                    ? { id: result.id, url: result.url, createdAt: result.createdAt }
                                    : img
                            )
                        }
                        : p
                )
            }));

            // Cleanup blob URL
            URL.revokeObjectURL(tempUrl);
            return result;
        } catch (error) {
            // Rollback: remove the temp image
            set((state) => ({
                products: state.products.map(p =>
                    p.id === productId
                        ? { ...p, images: (p.images || []).filter(img => img.id !== tempId) }
                        : p
                )
            }));
            URL.revokeObjectURL(tempUrl);
            logger.error(LOG_EVENTS.STORE_SAVE_ERROR, { store: 'product_image', productId, error: error.message });
            throw error;
        }
    },

    /**
     * Delete an image from a product (optimistic update with rollback)
     * @param {string} productId - Product ID
     * @param {string} imageId - Image ID to delete
     */
    deleteProductImage: async (productId, imageId) => {
        // Store the image for potential rollback
        const state = get();
        const product = state.products.find(p => p.id === productId);
        const imageToDelete = product?.images?.find(img => img.id === imageId);

        if (!imageToDelete) {
            throw new Error('Image not found');
        }

        // Optimistically remove from state
        set((state) => ({
            products: state.products.map(p =>
                p.id === productId
                    ? { ...p, images: (p.images || []).filter(img => img.id !== imageId) }
                    : p
            )
        }));

        try {
            await api.products.images.delete(productId, imageId);
        } catch (error) {
            // Rollback: restore the image
            set((state) => ({
                products: state.products.map(p =>
                    p.id === productId
                        ? { ...p, images: [...(p.images || []), imageToDelete] }
                        : p
                )
            }));
            logger.error(LOG_EVENTS.STORE_DELETE_ERROR, { store: 'product_image', productId, imageId, error: error.message });
            throw error;
        }
    },

    clearError: () => set({ error: null }),
}));
</file>

<file path="src/lib/store/partyStore.js">
import { create } from 'zustand';
import { api } from '@/api/backendClient';
import { logger, LOG_EVENTS } from '@/lib/logger';

export const usePartyStore = create((set, get) => ({
    parties: [],
    customers: [],
    vendors: [],
    loading: false,
    error: null,

    loadParties: async () => {
        set({ loading: true, error: null });
        try {
            const [customers, vendors] = await Promise.all([
                api.customers.list(),
                api.vendors.list()
            ]);
            set({
                customers: customers || [],
                vendors: vendors || [],
                parties: [...(customers || []), ...(vendors || [])],
                loading: false
            });
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_LOAD_ERROR, { store: 'parties', error: error.message });
            set({ error: error.message, loading: false });
        }
    },

    // Customer Actions
    addCustomer: async (customerData) => {
        set({ loading: true });
        try {
            const newCustomer = await api.customers.create(customerData);
            await get().loadParties();
            logger.audit(LOG_EVENTS.PRODUCT_ADD, { type: 'customer', name: customerData.name }); // Reusing generic add event
            set({ loading: false });
            return newCustomer.id;
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_SAVE_ERROR, { store: 'customer', error: error.message });
            set({ error: error.message, loading: false });
            throw error;
        }
    },

    updateCustomer: async (id, customerData) => {
        set({ loading: true });
        try {
            await api.customers.update(id, customerData);
            await get().loadParties();
            logger.audit(LOG_EVENTS.PRODUCT_UPDATE, { type: 'customer', id });
            set({ loading: false });
            return true;
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_UPDATE_ERROR, { store: 'customer', id, error: error.message });
            set({ error: error.message, loading: false });
            throw error;
        }
    },

    deleteCustomer: async (id) => {
        set({ loading: true });
        try {
            await api.customers.delete(id);
            await get().loadParties();
            logger.audit(LOG_EVENTS.PRODUCT_DELETE, { type: 'customer', id });
            set({ loading: false });
            return true;
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_DELETE_ERROR, { store: 'customer', id, error: error.message });
            set({ error: error.message, loading: false });
            throw error;
        }
    },

    getCustomer: (id) => {
        return get().customers.find(c => c.id === id || c.id === parseInt(id));
    },

    // Vendor Actions
    addVendor: async (vendorData) => {
        set({ loading: true });
        try {
            const newVendor = await api.vendors.create(vendorData);
            await get().loadParties();
            logger.audit(LOG_EVENTS.PRODUCT_ADD, { type: 'vendor', name: vendorData.name });
            set({ loading: false });
            return newVendor.id;
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_SAVE_ERROR, { store: 'vendor', error: error.message });
            set({ error: error.message, loading: false });
            throw error;
        }
    },

    updateVendor: async (id, vendorData) => {
        set({ loading: true });
        try {
            await api.vendors.update(id, vendorData);
            await get().loadParties();
            logger.audit(LOG_EVENTS.PRODUCT_UPDATE, { type: 'vendor', id });
            set({ loading: false });
            return true;
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_UPDATE_ERROR, { store: 'vendor', id, error: error.message });
            set({ error: error.message, loading: false });
            throw error;
        }
    },

    deleteVendor: async (id) => {
        set({ loading: true });
        try {
            await api.vendors.delete(id);
            await get().loadParties();
            logger.audit(LOG_EVENTS.PRODUCT_DELETE, { type: 'vendor', id });
            set({ loading: false });
            return true;
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_DELETE_ERROR, { store: 'vendor', id, error: error.message });
            set({ error: error.message, loading: false });
            throw error;
        }
    },

    getVendor: (id) => {
        return get().vendors.find(v => v.id === id || v.id === parseInt(id));
    },

    // Payments - now handled via paymentStore
    // Balance is computed by backend, no frontend calculation needed
    addPayment: async (paymentData) => {
        // Redirect to payments API - balance updates handled by backend
        const payment = await api.payments.create({
            type: paymentData.mode === 'in' ? 'IN' : 'OUT',
            partyType: 'CUSTOMER',
            partyId: String(paymentData.customerId),
            amount: paymentData.amount,
            date: paymentData.date,
            mode: paymentData.type || 'CASH',
            notes: paymentData.notes,
            allocations: paymentData.allocations || []
        });

        // Refresh customers to get updated balance from backend
        const customers = await api.customers.list();
        set({ customers });

        return payment;
    },

    addVendorPayment: async (paymentData) => {
        // Redirect to payments API - balance updates handled by backend
        const payment = await api.payments.create({
            type: paymentData.mode === 'out' ? 'OUT' : 'IN',
            partyType: 'VENDOR',
            partyId: String(paymentData.vendorId),
            amount: paymentData.amount,
            date: paymentData.date,
            mode: paymentData.type || 'CASH',
            notes: paymentData.notes,
            allocations: paymentData.allocations || []
        });

        // Refresh vendors to get updated balance from backend
        const vendors = await api.vendors.list();
        set({ vendors });

        return payment;
    },

    clearError: () => set({ error: null }),
}));
</file>

<file path="src/app/products/add/page.js">
'use client';

import { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useProductStore } from '@/lib/store/productStore';
import { FiX, FiLoader } from 'react-icons/fi';
import { useMasterStore } from '@/lib/store/masterStore';
import { FiArrowLeft, FiPlusCircle, FiImage, FiMoreHorizontal, FiPlus, FiMinus, FiChevronDown, FiChevronUp, FiLock, FiUnlock, FiRefreshCw } from 'react-icons/fi';
import styles from '../page.module.css';

export default function AddProductPage() {
    const router = useRouter();
    const { addProduct, generateSKU, uploadProductImage } = useProductStore();
    const { categories, loadCategories, subCategories, loadSubCategories } = useMasterStore();

    const [skuLocked, setSkuLocked] = useState(true);

    useEffect(() => {
        loadCategories();
        loadSubCategories();
    }, []);

    const [formData, setFormData] = useState({
        type: 'product', // product, service
        name: '',
        sellingPrice: '',
        purchasePrice: '',
        taxRate: 3, // Default 3% for jewelry usually
        unit: 'gms', // Default unit
        unit: 'gms', // Default unit
        category: '',
        subCategory: '',
        sku: '',
        description: '',

        // Metal Attributes
        metalType: 'Gold', // Gold, Silver, Platinum
        metalColor: 'Yellow', // Yellow, White, Rose, Two-tone
        purity: '22K', // 24K, 22K, 18K, 14K
        grossWeight: '',
        netWeight: '',
        wastagePercentage: '',
        wastageWeight: '',
        makingCharges: '', // per gram or fixed
        makingChargesType: 'per_gram', // per_gram, fixed
        metalRateRef: '',

        // Gemstone Attributes
        hasStones: false,
        stoneType: '',
        stoneCount: '',
        stoneWeight: '',
        stoneShape: '',
        stoneClarity: '',
        stoneColor: '',
        stoneCut: '',
        stoneCertification: '',
        stonePrice: '',
        stoneSetting: '',

        // Design & Dimensions
        size: '',
        pattern: '',
        customizable: false,
        engravingText: '',

        // Pricing & Inventory
        vendorRef: '',
        procurementDate: new Date().toISOString().split('T')[0],

        // Taxation & Compliance
        hallmarkCert: '',
        barcode: '', // Auto-generated if empty

        // Optional
        launchDate: '',

        showOnline: true,
        notForSale: false
    });

    // Pending images to upload after product creation (File objects with preview URLs)
    const [pendingImages, setPendingImages] = useState([]);
    const [isUploading, setIsUploading] = useState(false);
    const [uploadProgress, setUploadProgress] = useState({ current: 0, total: 0 });

    const searchParams = useSearchParams();
    const returnUrl = searchParams.get('returnUrl');
    const initialBarcode = searchParams.get('barcode');

    // Prefill barcode from URL param (from scanner)
    useEffect(() => {
        if (initialBarcode) {
            setFormData(prev => ({ ...prev, barcode: initialBarcode }));
        }
    }, [initialBarcode]);

    // Auto-generate SKU
    useEffect(() => {
        const gen = async () => {
            if (formData.category && formData.subCategory && skuLocked) {
                const newSku = await generateSKU(formData.category, formData.subCategory);
                setFormData(prev => ({ ...prev, sku: newSku }));
            }
        };
        gen();
    }, [formData.category, formData.subCategory, skuLocked]);

    const handleSave = async () => {
        if (!formData.name) return alert('Product Name is required');

        // Audit Log for Manual SKU - via backend API
        if (!skuLocked) {
            try {
                const { api } = await import('@/api/backendClient');
                await api.auditLogs.create({
                    entityType: 'product',
                    entityId: null, // ID unknown yet
                    action: 'MANUAL_SKU_OVERRIDE',
                    details: `SKU set to ${formData.sku}`,
                });
            } catch (e) {
                console.error("Failed to log audit", e);
            }
        }

        // Product payload - NO images (managed separately per API spec)
        const payload = {
            type: formData.type,
            name: formData.name,
            sellingPrice: formData.sellingPrice ? Number(formData.sellingPrice) : null,
            purchasePrice: formData.purchasePrice ? Number(formData.purchasePrice) : null,
            taxRate: formData.taxRate,
            unit: formData.unit,
            category: formData.category,
            subCategory: formData.subCategory,
            sku: formData.sku,
            description: formData.description,
            vendorRef: formData.vendorRef,
            procurementDate: formData.procurementDate,
            hallmarkCert: formData.hallmarkCert,
            barcode: formData.barcode,
            launchDate: formData.launchDate || null,
            showOnline: formData.showOnline,
            notForSale: formData.notForSale,
            // images: NOT included - managed via separate API calls

            // Nested Objects
            metal: {
                type: formData.metalType,
                color: formData.metalColor,
                purity: formData.purity,
                grossWeight: Number(formData.grossWeight || 0),
                netWeight: Number(formData.netWeight || 0),
                wastagePercentage: Number(formData.wastagePercentage || 0),
                wastageWeight: Number(formData.wastageWeight || 0),
                makingCharges: Number(formData.makingCharges || 0),
                makingChargesType: formData.makingChargesType,
                rateRef: formData.metalRateRef
            },

            gemstone: formData.hasStones ? {
                type: formData.stoneType,
                count: Number(formData.stoneCount || 0),
                weight: Number(formData.stoneWeight || 0),
                shape: formData.stoneShape,
                clarity: formData.stoneClarity,
                color: formData.stoneColor,
                cut: formData.stoneCut,
                certification: formData.stoneCertification,
                price: Number(formData.stonePrice || 0),
                setting: formData.stoneSetting
            } : null,

            design: {
                size: formData.size,
                pattern: formData.pattern,
                customizable: formData.customizable,
                engravingText: formData.engravingText
            }
        };

        try {
            // Step 1: Create the product first
            const productId = await addProduct(payload);

            // Step 2: Upload pending images (if any) AFTER product exists
            if (pendingImages.length > 0 && productId) {
                setIsUploading(true);
                setUploadProgress({ current: 0, total: pendingImages.length });

                // Upload with concurrency limit (2 at a time to avoid mobile radio saturation)
                const uploadQueue = [...pendingImages];
                const concurrencyLimit = 2;
                const failedUploads = [];

                const uploadNext = async () => {
                    while (uploadQueue.length > 0) {
                        const img = uploadQueue.shift();
                        try {
                            await uploadProductImage(productId, img.file);
                        } catch (error) {
                            console.error('Image upload failed:', error);
                            failedUploads.push(img.file.name);
                        }
                        setUploadProgress(prev => ({ ...prev, current: prev.current + 1 }));
                    }
                };

                // Start concurrent uploads
                await Promise.all(
                    Array(Math.min(concurrencyLimit, pendingImages.length))
                        .fill(null)
                        .map(() => uploadNext())
                );

                setIsUploading(false);

                if (failedUploads.length > 0) {
                    alert(`Product saved, but ${failedUploads.length} image(s) failed to upload: ${failedUploads.join(', ')}`);
                }
            }

            // Cleanup preview URLs
            pendingImages.forEach(img => URL.revokeObjectURL(img.previewUrl));

            if (returnUrl) {
                router.push(returnUrl);
            } else {
                router.push('/products');
            }
        } catch (error) {
            console.error('Failed to save product:', error);
            alert('Failed to save product: ' + error.message);
        }
    };

    const handleImageSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
            // Store file object with preview URL (not base64)
            const previewUrl = URL.createObjectURL(file);
            setPendingImages(prev => [...prev, { file, previewUrl, name: file.name }]);
        }
        // Reset input to allow selecting same file again
        e.target.value = '';
    };

    const handleRemovePendingImage = (index) => {
        setPendingImages(prev => {
            const removed = prev[index];
            URL.revokeObjectURL(removed.previewUrl);
            return prev.filter((_, i) => i !== index);
        });
    };

    return (
        <div className={styles.container}>
            <div className={styles.header}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                    <FiArrowLeft size={24} onClick={() => router.back()} style={{ cursor: 'pointer' }} />
                    Add Product
                </div>
                <FiMoreHorizontal size={24} />
            </div>

            {/* Core Product Metadata */}
            <div className={styles.sectionTitle}>Core Details</div>
            <div className={styles.card}>
                <div className={styles.radioGroup} style={{ marginBottom: 16 }}>
                    <label className={styles.radioLabel}>
                        <input
                            type="radio"
                            checked={formData.type === 'product'}
                            onChange={() => setFormData({ ...formData, type: 'product' })}
                        /> Product
                    </label>
                    <label className={styles.radioLabel}>
                        <input
                            type="radio"
                            checked={formData.type === 'service'}
                            onChange={() => setFormData({ ...formData, type: 'service' })}
                        /> Service
                    </label>
                </div>

                <input
                    className={styles.input}
                    placeholder="Product Name / Title"
                    value={formData.name}
                    onChange={e => setFormData({ ...formData, name: e.target.value })}
                />
                <div style={{ display: 'flex', gap: 12 }}>
                    <select
                        className={styles.select}
                        value={formData.category}
                        onChange={e => setFormData({ ...formData, category: e.target.value, subCategory: '' })}
                        style={{ flex: 1 }}
                    >
                        <option value="">Select Category</option>
                        {categories.map(c => (
                            <option key={c.id} value={c.name}>{c.name}</option>
                        ))}
                    </select>
                    <select
                        className={styles.select}
                        value={formData.subCategory}
                        onChange={e => setFormData({ ...formData, subCategory: e.target.value })}
                        style={{ flex: 1 }}
                        disabled={!formData.category}
                    >
                        <option value="">Select Sub-category</option>
                        {subCategories
                            .filter(sc => {
                                const parent = categories.find(c => c.name === formData.category);
                                return parent && sc.categoryId === parent.id;
                            })
                            .map(sc => (
                                <option key={sc.id} value={sc.name}>{sc.name}</option>
                            ))
                        }
                    </select>
                </div>
                <div style={{ position: 'relative' }}>
                    <input
                        className={styles.input}
                        placeholder="SKU / Product Code"
                        value={formData.sku}
                        onChange={e => setFormData({ ...formData, sku: e.target.value })}
                        disabled={skuLocked}
                        style={{ paddingRight: 40, backgroundColor: skuLocked ? '#f3f4f6' : 'white' }}
                    />
                    <div
                        onClick={() => setSkuLocked(!skuLocked)}
                        style={{
                            position: 'absolute', right: 12, top: '50%', transform: 'translateY(-50%)',
                            cursor: 'pointer', color: '#6b7280'
                        }}
                        title={skuLocked ? "Unlock to override" : "Lock to auto-generate"}
                    >
                        {skuLocked ? <FiLock /> : <FiUnlock />}
                    </div>
                </div>

                <textarea
                    className={styles.input}
                    placeholder="Description"
                    value={formData.description}
                    onChange={e => setFormData({ ...formData, description: e.target.value })}
                    rows={3}
                    style={{ resize: 'none', paddingTop: 14, height: 'auto', minHeight: '80px' }}
                />
            </div>

            {/* Metal-Specific Attributes */}
            <div className={styles.sectionTitle}>Metal Attributes</div>
            <div className={styles.card}>
                <div style={{ display: 'flex', gap: 12 }}>
                    <select
                        className={styles.select}
                        value={formData.metalType}
                        onChange={e => setFormData({ ...formData, metalType: e.target.value })}
                        style={{ flex: 1 }}
                    >
                        <option value="Gold">Gold</option>
                        <option value="Silver">Silver</option>
                        <option value="Platinum">Platinum</option>
                    </select>
                    <select
                        className={styles.select}
                        value={formData.metalColor}
                        onChange={e => setFormData({ ...formData, metalColor: e.target.value })}
                        style={{ flex: 1 }}
                    >
                        <option value="Yellow">Yellow</option>
                        <option value="White">White</option>
                        <option value="Rose">Rose</option>
                        <option value="Two-tone">Two-tone</option>
                    </select>
                </div>
                <div style={{ display: 'flex', gap: 12 }}>
                    <select
                        className={styles.select}
                        value={formData.purity}
                        onChange={e => setFormData({ ...formData, purity: e.target.value })}
                        style={{ flex: 1 }}
                    >
                        <option value="24K">24K (999)</option>
                        <option value="22K">22K (916)</option>
                        <option value="18K">18K (750)</option>
                        <option value="14K">14K (585)</option>
                    </select>
                    <input
                        className={styles.input}
                        type="number"
                        placeholder="Gross Weight (g)"
                        value={formData.grossWeight}
                        onChange={e => setFormData({ ...formData, grossWeight: e.target.value })}
                        style={{ flex: 1 }}
                    />
                </div>
                <div style={{ display: 'flex', gap: 12 }}>
                    <input
                        className={styles.input}
                        type="number"
                        placeholder="Net Metal Weight (g)"
                        value={formData.netWeight}
                        onChange={e => setFormData({ ...formData, netWeight: e.target.value })}
                        style={{ flex: 1 }}
                    />
                    <input
                        className={styles.input}
                        type="number"
                        placeholder="Wastage %"
                        value={formData.wastagePercentage}
                        onChange={e => setFormData({ ...formData, wastagePercentage: e.target.value })}
                        style={{ flex: 1 }}
                    />
                </div>
                <div style={{ display: 'flex', gap: 12 }}>
                    <input
                        className={styles.input}
                        type="number"
                        placeholder="Making Charges"
                        value={formData.makingCharges}
                        onChange={e => setFormData({ ...formData, makingCharges: e.target.value })}
                        style={{ flex: 2 }}
                    />
                    <select
                        className={styles.select}
                        value={formData.makingChargesType}
                        onChange={e => setFormData({ ...formData, makingChargesType: e.target.value })}
                        style={{ flex: 1 }}
                    >
                        <option value="per_gram">Per Gram</option>
                        <option value="fixed">Fixed</option>
                    </select>
                </div>
            </div>

            {/* Gemstone Attributes (Collapsible) */}
            <div className={styles.card} style={{ padding: 0, overflow: 'hidden' }}>
                <div
                    onClick={() => setFormData({ ...formData, hasStones: !formData.hasStones })}
                    style={{
                        padding: 16, display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                        cursor: 'pointer', background: formData.hasStones ? '#f9fafb' : 'white'
                    }}
                >
                    <div style={{ fontWeight: 600, display: 'flex', alignItems: 'center', gap: 8 }}>
                        Gemstone / Diamond Attributes
                        {formData.hasStones && <span style={{ fontSize: 10, background: '#dcfce7', color: '#166534', padding: '2px 6px', borderRadius: 4 }}>Active</span>}
                    </div>
                    {formData.hasStones ? <FiMinus /> : <FiPlus />}
                </div>

                {formData.hasStones && (
                    <div style={{ padding: 16, borderTop: '1px solid #e5e7eb' }}>
                        <div style={{ display: 'flex', gap: 12 }}>
                            <input
                                className={styles.input}
                                placeholder="Stone Type (e.g. Diamond, Ruby)"
                                value={formData.stoneType}
                                onChange={e => setFormData({ ...formData, stoneType: e.target.value })}
                                style={{ flex: 1 }}
                            />
                            <input
                                className={styles.input}
                                type="number"
                                placeholder="Total Count"
                                value={formData.stoneCount}
                                onChange={e => setFormData({ ...formData, stoneCount: e.target.value })}
                                style={{ flex: 1 }}
                            />
                        </div>
                        <div style={{ display: 'flex', gap: 12 }}>
                            <input
                                className={styles.input}
                                type="number"
                                placeholder="Weight (carats)"
                                value={formData.stoneWeight}
                                onChange={e => setFormData({ ...formData, stoneWeight: e.target.value })}
                                style={{ flex: 1 }}
                            />
                            <input
                                className={styles.input}
                                placeholder="Shape (Round, Oval)"
                                value={formData.stoneShape}
                                onChange={e => setFormData({ ...formData, stoneShape: e.target.value })}
                                style={{ flex: 1 }}
                            />
                        </div>
                        <div style={{ display: 'flex', gap: 12 }}>
                            <input
                                className={styles.input}
                                placeholder="Clarity (SI, VS, VVS)"
                                value={formData.stoneClarity}
                                onChange={e => setFormData({ ...formData, stoneClarity: e.target.value })}
                                style={{ flex: 1 }}
                            />
                            <input
                                className={styles.input}
                                placeholder="Color (D, E, F...)"
                                value={formData.stoneColor}
                                onChange={e => setFormData({ ...formData, stoneColor: e.target.value })}
                                style={{ flex: 1 }}
                            />
                        </div>
                        <input
                            className={styles.input}
                            placeholder="Certification (GIA, IGI...)"
                            value={formData.stoneCertification}
                            onChange={e => setFormData({ ...formData, stoneCertification: e.target.value })}
                        />
                        <input
                            className={styles.input}
                            type="number"
                            placeholder="Stone Price / Charges"
                            value={formData.stonePrice}
                            onChange={e => setFormData({ ...formData, stonePrice: e.target.value })}
                        />
                    </div>
                )}
            </div>

            {/* Design & Dimensions (Collapsible) */}
            <div className={styles.card} style={{ padding: 0, overflow: 'hidden', marginTop: 16 }}>
                <div
                    onClick={() => setFormData(prev => ({ ...prev, showDesign: !prev.showDesign }))}
                    style={{
                        padding: 16, display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                        cursor: 'pointer', background: formData.showDesign ? '#f9fafb' : 'white'
                    }}
                >
                    <div style={{ fontWeight: 600 }}>Design & Dimension Attributes</div>
                    {formData.showDesign ? <FiMinus /> : <FiPlus />}
                </div>

                {formData.showDesign && (
                    <div style={{ padding: 16, borderTop: '1px solid #e5e7eb' }}>
                        <input
                            className={styles.input}
                            placeholder="Size (Ring size, Length)"
                            value={formData.size}
                            onChange={e => setFormData({ ...formData, size: e.target.value })}
                        />
                        <input
                            className={styles.input}
                            placeholder="Pattern / Design Details"
                            value={formData.pattern}
                            onChange={e => setFormData({ ...formData, pattern: e.target.value })}
                        />
                        <input
                            className={styles.input}
                            placeholder="Engraving Text"
                            value={formData.engravingText}
                            onChange={e => setFormData({ ...formData, engravingText: e.target.value })}
                        />
                        <div className={styles.toggleRow} style={{ marginTop: 8 }}>
                            <span className={styles.toggleLabel}>Customizable</span>
                            <input
                                type="checkbox"
                                checked={formData.customizable}
                                onChange={e => setFormData({ ...formData, customizable: e.target.checked })}
                            />
                        </div>
                    </div>
                )}
            </div>

            {/* Pricing & Inventory */}
            <div className={styles.sectionTitle}>Pricing & Inventory</div>
            <div className={styles.card}>
                <input
                    className={styles.input}
                    type="number"
                    placeholder="Selling Price (Final)"
                    value={formData.sellingPrice}
                    onChange={e => setFormData({ ...formData, sellingPrice: e.target.value })}
                />
                <input
                    className={styles.input}
                    type="number"
                    placeholder="Purchase Price / Cost"
                    value={formData.purchasePrice}
                    onChange={e => setFormData({ ...formData, purchasePrice: e.target.value })}
                />
                <div style={{ display: 'flex', gap: 12 }}>
                    <input
                        className={styles.input}
                        placeholder="Vendor Reference"
                        value={formData.vendorRef}
                        onChange={e => setFormData({ ...formData, vendorRef: e.target.value })}
                        style={{ flex: 1 }}
                    />
                    <input
                        className={styles.input}
                        type="date"
                        placeholder="Procurement Date"
                        value={formData.procurementDate}
                        onChange={e => setFormData({ ...formData, procurementDate: e.target.value })}
                        style={{ flex: 1 }}
                    />
                </div>
            </div>

            {/* Taxation & Compliance */}
            <div className={styles.sectionTitle}>Taxation & Compliance</div>
            <div className={styles.card}>
                <div style={{ display: 'flex', gap: 12 }}>
                    <select
                        className={styles.select}
                        value={formData.taxRate}
                        onChange={e => setFormData({ ...formData, taxRate: Number(e.target.value) })}
                        style={{ flex: 1, marginBottom: 12 }}
                    >
                        <option value={0}>Tax Rate 0%</option>
                        <option value={3}>Tax Rate 3%</option>
                        <option value={5}>Tax Rate 5%</option>
                        <option value={12}>Tax Rate 12%</option>
                        <option value={18}>Tax Rate 18%</option>
                    </select>
                </div>
                <input
                    className={styles.input}
                    placeholder="BIS Hallmark Cert Number"
                    value={formData.hallmarkCert}
                    onChange={e => setFormData({ ...formData, hallmarkCert: e.target.value })}
                />
                <input
                    className={styles.input}
                    placeholder="Barcode (Auto-generated if empty)"
                    value={formData.barcode}
                    onChange={e => setFormData({ ...formData, barcode: e.target.value })}
                />
            </div>

            {/* Media & Attachments */}
            <div className={styles.sectionTitle}>Product Images</div>
            <div className={styles.card}>
                <div style={{ fontSize: 12, color: '#6b7280', marginBottom: 12 }}>
                    Product images must be PNG or JPEG, recommended 1024 px by 1024 px or 1:1 aspect ratio.
                    {pendingImages.length > 0 && (
                        <span style={{ color: '#3b82f6', marginLeft: 8 }}>
                            ({pendingImages.length} image{pendingImages.length > 1 ? 's' : ''} ready to upload)
                        </span>
                    )}
                </div>
                <div style={{ display: 'flex', gap: 12, overflowX: 'auto' }}>
                    <label style={{
                        width: 80, height: 80, border: '1px dashed #e5e7eb', borderRadius: 8,
                        display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',
                        cursor: 'pointer', flexShrink: 0
                    }}>
                        <input type="file" accept="image/*" style={{ display: 'none' }} onChange={handleImageSelect} />
                        <FiImage size={24} color="#3b82f6" />
                        <span style={{ fontSize: 10, fontWeight: 600, marginTop: 4 }}>New<br />Image</span>
                    </label>
                    {pendingImages.map((img, idx) => (
                        <div key={idx} style={{ position: 'relative', flexShrink: 0 }}>
                            <img src={img.previewUrl} alt="" style={{ width: 80, height: 80, borderRadius: 8, objectFit: 'cover' }} />
                            <button
                                onClick={() => handleRemovePendingImage(idx)}
                                style={{
                                    position: 'absolute', top: -6, right: -6,
                                    width: 20, height: 20, borderRadius: '50%',
                                    background: '#ef4444', border: 'none', color: 'white',
                                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                                    cursor: 'pointer', fontSize: 12
                                }}
                            >
                                <FiX size={12} />
                            </button>
                        </div>
                    ))}
                </div>
            </div>

            {/* Optional Metadata */}
            <div className={styles.sectionTitle}>Optional Details</div>
            <div className={styles.card}>

                <div className={styles.toggleRow} style={{ marginTop: 12, borderTop: '1px solid #f3f4f6', paddingTop: 12 }}>
                    <span className={styles.toggleLabel}>Show in online store</span>
                    <input
                        type="checkbox"
                        checked={formData.showOnline}
                        onChange={e => setFormData({ ...formData, showOnline: e.target.checked })}
                    />
                </div>
                <div className={styles.toggleRow}>
                    <span className={styles.toggleLabel}>Not For Sale</span>
                    <input
                        type="checkbox"
                        checked={formData.notForSale}
                        onChange={e => setFormData({ ...formData, notForSale: e.target.checked })}
                    />
                </div>
            </div>

            <div className={styles.footer}>
                <button
                    className={styles.saveButton}
                    onClick={handleSave}
                    disabled={isUploading}
                    style={isUploading ? { opacity: 0.7, cursor: 'not-allowed' } : {}}
                >
                    {isUploading ? (
                        <span style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                            <FiLoader style={{ animation: 'spin 1s linear infinite' }} />
                            Uploading {uploadProgress.current}/{uploadProgress.total}...
                        </span>
                    ) : (
                        'Add Product'
                    )}
                </button>
            </div>
        </div >
    );
}
</file>

<file path="src/app/products/page.js">
'use client';

import { useEffect, useState, useMemo } from 'react';
import Link from 'next/link';
import { useRouter, useSearchParams } from 'next/navigation';
import { useProductStore } from '@/lib/store/productStore';
import { useMasterStore } from '@/lib/store/masterStore';
import { useInvoiceStore } from '@/lib/store/invoiceStore';
import { shareText } from '@/lib/utils/invoiceActions';
import { FiMenu, FiPlus, FiSearch, FiMoreHorizontal, FiDownload, FiUpload, FiArrowLeft, FiCheck } from 'react-icons/fi';
import { RiBarcodeLine } from 'react-icons/ri';
import ProductCard from './components/ProductCard';
import FilterBar from './components/FilterBar';
import Pagination from './components/Pagination';
import BottomSheet from '@/components/BottomSheet';
import BarcodeScanner from '@/components/BarcodeScanner';
import ScanResultModal from '@/components/ScanResultModal';
import { BulkUploadService } from '@/lib/services/bulkUploadService';
import styles from './page.module.css';

const ITEMS_PER_PAGE = 12;

export default function ProductsPage() {
    const router = useRouter();
    const searchParams = useSearchParams();
    const { products, loadProducts, addProduct, getProductByBarcode } = useProductStore();
    const { categories, loadCategories } = useMasterStore();
    const { items: invoiceItems, addOrUpdateItem } = useInvoiceStore();

    // Detect selection mode from query params
    const isSelectMode = searchParams.get('mode') === 'select';
    const returnUrl = searchParams.get('returnUrl') || '/invoice/create';

    const [search, setSearch] = useState('');
    const [isMenuOpen, setIsMenuOpen] = useState(false);

    // Barcode Scanner State
    const [isScannerOpen, setIsScannerOpen] = useState(false);
    const [scanResult, setScanResult] = useState({ isOpen: false, product: null, barcode: '' });

    // Filter State
    const [filters, setFilters] = useState({
        purity: [],
        weight: [],
        gender: [],
        category: []
    });

    // Pagination State
    const [currentPage, setCurrentPage] = useState(1);

    useEffect(() => {
        loadProducts();
        loadCategories();
    }, []);

    // --- Filtering Logic ---
    const filteredProducts = useMemo(() => {
        return products.filter(product => {
            // 1. Search
            if (search && !product.name.toLowerCase().includes(search.toLowerCase())) return false;

            // 2. Purity
            if (filters.purity.length > 0) {
                const productPurity = product.purity || '';
                if (!filters.purity.some(f => productPurity.includes(f))) return false;
            }

            // 3. Weight
            if (filters.weight.length > 0) {
                const weight = Number(product.grossWeight || 0);
                const matchesWeight = filters.weight.some(range => {
                    if (range === '0-5g') return weight >= 0 && weight <= 5;
                    if (range === '5-10g') return weight > 5 && weight <= 10;
                    return false;
                });
                if (!matchesWeight) return false;
            }

            // 4. Gender
            if (filters.gender.length > 0) {
                const genderText = (product.category + ' ' + product.name + ' ' + (product.tags || '')).toLowerCase();
                const matchesGender = filters.gender.some(g => genderText.includes(g.toLowerCase()));
                if (!matchesGender) return false;
            }

            // 5. Category
            if (filters.category.length > 0) {
                if (!filters.category.includes(product.category)) return false;
            }

            return true;
        });
    }, [products, search, filters]);

    // --- Pagination Logic ---
    const totalPages = Math.ceil(filteredProducts.length / ITEMS_PER_PAGE);
    const paginatedProducts = filteredProducts.slice(
        (currentPage - 1) * ITEMS_PER_PAGE,
        currentPage * ITEMS_PER_PAGE
    );

    // --- Get quantity in invoice for a product ---
    const getItemQuantity = (productId) => {
        const item = invoiceItems.find(i => i.productId === productId);
        return item ? item.quantity : 0;
    };

    // --- Handlers ---
    const handleAddToTray = (product) => {
        if (isSelectMode) {
            // Add to invoice store
            addOrUpdateItem(product, 1);
        } else {
            console.log("Added to tray:", product.name);
            // TODO: Implement standalone Tray Logic if needed
        }
    };

    const handleShare = async (product) => {
        await shareText({
            title: product.name,
            text: `Check out this ${product.name}`,
            url: window.location.href
        });
    };

    // --- Barcode Scan Handlers ---
    const handleBarcodeScan = async (barcode) => {
        setIsScannerOpen(false);
        const product = await getProductByBarcode(barcode);
        setScanResult({ isOpen: true, product, barcode });
    };

    const handleScanAddToTray = (product) => {
        if (isSelectMode) {
            addOrUpdateItem(product, 1);
        }
        setScanResult({ isOpen: false, product: null, barcode: '' });
    };

    const handleScanAgain = () => {
        setScanResult({ isOpen: false, product: null, barcode: '' });
        setIsScannerOpen(true);
    };

    const handleAddManually = (barcode) => {
        setScanResult({ isOpen: false, product: null, barcode: '' });
        router.push(`/products/add?barcode=${encodeURIComponent(barcode)}&returnUrl=${encodeURIComponent(window.location.pathname + window.location.search)}`);
    };

    return (
        <div className={styles.container}>
            {/* Header - Context Aware */}
            <div className={styles.header}>
                <div className={styles.headerLeft}>
                    {isSelectMode ? (
                        <FiArrowLeft size={24} className={styles.menuIcon} onClick={() => router.push(returnUrl)} />
                    ) : (
                        <Link href="/">
                            <FiMenu size={24} className={styles.menuIcon} />
                        </Link>
                    )}
                    <span className={styles.headerTitle}>
                        {isSelectMode ? 'Select Products' : 'Products & Services'}
                    </span>
                </div>
                <div className={styles.headerActions}>
                    <RiBarcodeLine size={24} onClick={() => setIsScannerOpen(true)} style={{ cursor: 'pointer' }} />
                    {isSelectMode ? (
                        <button
                            onClick={() => router.push(returnUrl)}
                            style={{
                                background: '#2563eb',
                                color: 'white',
                                border: 'none',
                                padding: '8px 16px',
                                borderRadius: '8px',
                                fontWeight: 600,
                                fontSize: '14px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '6px',
                                cursor: 'pointer'
                            }}
                        >
                            <FiCheck size={16} />
                            Done ({invoiceItems.length})
                        </button>
                    ) : (
                        <FiMoreHorizontal size={24} onClick={() => setIsMenuOpen(true)} />
                    )}
                </div>
            </div>

            {/* Search Bar */}
            <div className={styles.searchContainer}>
                <div className={styles.searchBar}>
                    <FiSearch color="#9ca3af" size={20} />
                    <input
                        className={styles.searchInput}
                        placeholder="Search..."
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                    />
                </div>
            </div>

            {/* Filter Bar */}
            <div className={styles.filterSection}>
                <FilterBar
                    filters={filters}
                    onFilterChange={(newFilters) => {
                        setFilters(newFilters);
                        setCurrentPage(1);
                    }}
                    categories={categories}
                />
            </div>

            {/* Product Grid */}
            <div className={styles.grid}>
                {paginatedProducts.map(product => (
                    <ProductCard
                        key={product.id}
                        product={product}
                        onAddToTray={handleAddToTray}
                        onShare={handleShare}
                        quantity={isSelectMode ? getItemQuantity(product.id) : 0}
                        isSelectMode={isSelectMode}
                    />
                ))}
            </div>

            {/* Empty State */}
            {filteredProducts.length === 0 && (
                <div className={styles.emptyState}>
                    No products found.
                </div>
            )}

            {/* Pagination */}
            {filteredProducts.length > 0 && (
                <Pagination
                    currentPage={currentPage}
                    totalPages={totalPages}
                    onPageChange={setCurrentPage}
                    onRecentlyViewed={() => console.log('Recently Viewed')}
                />
            )}

            {/* Floating Create Button - Hidden in Select Mode */}
            {!isSelectMode && (
                <Link href="/products/add">
                    <div className={styles.fab}>
                        <FiPlus size={18} />
                        NEW PRODUCT
                    </div>
                </Link>
            )}


            {/* Bulk Actions Menu - Hidden in Select Mode */}
            {!isSelectMode && (
                <BottomSheet isOpen={isMenuOpen} onClose={() => setIsMenuOpen(false)}>
                    <div style={{ display: 'flex', flexDirection: 'column', padding: '0 16px 20px' }}>
                        <div className={styles.menuItem} onClick={() => { BulkUploadService.downloadAllProducts(); setIsMenuOpen(false); }}>
                            <FiDownload size={20} />
                            <span>Bulk Download</span>
                        </div>
                        <Link href="/products/bulk-upload" onClick={() => setIsMenuOpen(false)}>
                            <div className={styles.menuItem}>
                                <FiUpload size={20} />
                                <span>Bulk Upload</span>
                            </div>
                        </Link>
                    </div>
                </BottomSheet>
            )}

            {/* Barcode Scanner */}
            <BarcodeScanner
                isOpen={isScannerOpen}
                onScan={handleBarcodeScan}
                onClose={() => setIsScannerOpen(false)}
            />

            {/* Scan Result Modal */}
            <ScanResultModal
                isOpen={scanResult.isOpen}
                product={scanResult.product}
                barcode={scanResult.barcode}
                onAddToTray={handleScanAddToTray}
                onScanAgain={handleScanAgain}
                onAddManually={handleAddManually}
                onClose={() => setScanResult({ isOpen: false, product: null, barcode: '' })}
            />
        </div>
    );
}
</file>

<file path="src/lib/db/index.js">
/**
 * @deprecated This file is deprecated. The application now uses the backend API
 * via src/api/backendClient.js instead of IndexedDB/Dexie.
 * 
 * This file remains for reference only. All data operations should use the
 * Zustand stores which internally call the backend API.
 * 
 * Migration completed: All stores now use backend API endpoints.
 */

// Export empty stubs to prevent import errors in any remaining test files
export const db = {
  invoices: { toArray: () => Promise.resolve([]), get: () => Promise.resolve(null) },
  purchases: { toArray: () => Promise.resolve([]), get: () => Promise.resolve(null) },
  customers: { toArray: () => Promise.resolve([]), get: () => Promise.resolve(null) },
  vendors: { toArray: () => Promise.resolve([]), get: () => Promise.resolve(null) },
  products: { toArray: () => Promise.resolve([]), get: () => Promise.resolve(null), where: () => ({ equals: () => ({ first: () => Promise.resolve(null), toArray: () => Promise.resolve([]) }) }) },
  payments: { toArray: () => Promise.resolve([]), get: () => Promise.resolve(null), where: () => ({ equals: () => ({ and: () => ({ toArray: () => Promise.resolve([]) }), toArray: () => Promise.resolve([]) }) }) },
  categories: { toArray: () => Promise.resolve([]), get: () => Promise.resolve(null) },
  subCategories: { toArray: () => Promise.resolve([]), get: () => Promise.resolve(null) },
  settings: { get: () => Promise.resolve(null), put: () => Promise.resolve() },
  audit_logs: { add: () => Promise.resolve() },
  attendance_log: { where: () => ({ equals: () => ({ first: () => Promise.resolve(null) }) }), orderBy: () => ({ reverse: () => ({ limit: () => ({ toArray: () => Promise.resolve([]) }), toArray: () => Promise.resolve([]) }) }) },
  bulk_upload_logs: { add: () => Promise.resolve() },
  transaction: () => Promise.resolve(),
};

import { logger } from '@/lib/logger';

export const resetDatabase = async () => {
  logger.warn('DEPRECATED_FUNCTION_CALL', { function: 'resetDatabase', message: 'Data managed by backend API' });
};
</file>

<file path="src/app/more/page.js">
'use client';

import { useEffect, useMemo, useState, useRef } from 'react';
import Link from 'next/link';
import { useSettingsStore } from '@/lib/store/settingsStore';
import { api } from '@/api/backendClient';
import { FiUser, FiSettings, FiChevronRight, FiBriefcase, FiUsers, FiFileText, FiCreditCard, FiEdit3, FiBookOpen, FiBox, FiTerminal, FiDownload, FiUpload } from 'react-icons/fi';
import { DIAGNOSTICS_ENABLED } from '@/lib/utils/isDiagnosticsEnabled';
import styles from './page.module.css';

const baseMenuItems = [
    {
        title: 'Profile',
        items: [
            { label: 'Company Details', icon: FiBriefcase, href: '/more/company' },
            { label: 'User Profile', icon: FiUser, href: '/more/profile' },
            { label: 'Users & Roles', icon: FiUsers, href: '/coming-soon' },
        ]
    },
    {
        title: 'Bills',
        items: [
            { label: 'Expenses', icon: FiCreditCard, href: '/more/bills/expenses' },
        ]
    },
    {
        title: 'Masters',
        items: [
            { label: 'Product Master', icon: FiBox, href: '/more/masters/products' },
        ]
    },
    {
        title: 'Settings',
        items: [
            { label: 'Document Settings', icon: FiFileText, href: '/coming-soon' },
            { label: 'General Settings', icon: FiSettings, href: '/coming-soon' },
            { label: 'Server Config', icon: FiSettings, href: '/more/server-config' },
            { label: 'Invoice Templates', icon: FiFileText, href: '/more/templates' },
            { label: 'Lending Bill Template', icon: FiFileText, href: '/more/templates/lending' },
            { label: 'Label Templates', icon: FiFileText, href: '/more/label-templates' },
            { label: 'Bank', icon: FiCreditCard, href: '/coming-soon' },
            { label: 'Signature', icon: FiEdit3, href: '/coming-soon' },
            { label: 'Notes & Terms', icon: FiBookOpen, href: '/coming-soon' },
        ]
    }
];

export default function MorePage() {
    const { companyDetails, loadSettings } = useSettingsStore();
    const [backupLoading, setBackupLoading] = useState(false);
    const [backupError, setBackupError] = useState(null);
    const [restoreLoading, setRestoreLoading] = useState(false);
    const [restoreError, setRestoreError] = useState(null);
    const [showRestoreConfirm, setShowRestoreConfirm] = useState(false);
    const [pendingRestoreFile, setPendingRestoreFile] = useState(null);
    const fileInputRef = useRef(null);

    useEffect(() => {
        loadSettings();
    }, []);

    const handleCreateBackup = async () => {
        setBackupLoading(true);
        setBackupError(null);

        try {
            const result = await api.ops.createBackup();

            // Fetch the file with Authorization header
            const downloadUrl = api.ops.downloadBackup(result.filename);
            const token = localStorage.getItem('auth_token');

            const response = await fetch(downloadUrl, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to download backup');
            }

            // Create blob and trigger download
            const blob = await response.blob();
            const blobUrl = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = blobUrl;
            link.download = result.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Clean up blob URL
            URL.revokeObjectURL(blobUrl);

        } catch (error) {
            console.error('Backup failed:', error);

            // Handle specific error cases
            if (error.status === 409) {
                setBackupError('Backup already in progress. Please wait.');
            } else {
                setBackupError(error.message || 'Failed to create backup. Please try again.');
            }

            // Clear error after 5 seconds
            setTimeout(() => setBackupError(null), 5000);
        } finally {
            setBackupLoading(false);
        }
    };

    const handleRestoreClick = () => {
        fileInputRef.current?.click();
    };

    const handleFileSelect = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        // Validate file type
        if (!file.name.endsWith('.zip')) {
            setRestoreError('Only ZIP files are allowed');
            setTimeout(() => setRestoreError(null), 5000);
            return;
        }

        // Show confirmation dialog
        setPendingRestoreFile(file);
        setShowRestoreConfirm(true);

        // Reset file input
        e.target.value = '';
    };

    const handleRestoreConfirm = async () => {
        if (!pendingRestoreFile) return;

        setShowRestoreConfirm(false);
        setRestoreLoading(true);
        setRestoreError(null);

        try {
            const result = await api.ops.restoreBackup(pendingRestoreFile);

            // Show success message - server will shut down
            alert(`Restore complete! ${result.photosRestored} photos restored. The server will restart - please wait and refresh the page.`);

        } catch (error) {
            console.error('Restore failed:', error);

            if (error.status === 403) {
                setRestoreError('Admin access required for restore operations');
            } else if (error.status === 409) {
                setRestoreError('Restore already in progress. Please wait.');
            } else if (error.status === 415) {
                setRestoreError('Only ZIP files are allowed');
            } else {
                setRestoreError(error.message || 'Failed to restore backup. Please try again.');
            }

            setTimeout(() => setRestoreError(null), 5000);
        } finally {
            setRestoreLoading(false);
            setPendingRestoreFile(null);
        }
    };

    const handleRestoreCancel = () => {
        setShowRestoreConfirm(false);
        setPendingRestoreFile(null);
    };

    // Conditionally add menu items
    const menuItems = useMemo(() => {
        return baseMenuItems.map(section => {
            if (section.title === 'Settings') {
                // Find position after Server Config for backup
                const serverConfigIndex = section.items.findIndex(item => item.label === 'Server Config');
                const insertIndex = serverConfigIndex >= 0 ? serverConfigIndex + 1 : section.items.length;

                const newItems = [...section.items];
                // Add backup option after Server Config
                newItems.splice(insertIndex, 0, { label: 'Create Backup', icon: FiDownload, onClick: 'backup' });
                // Add restore option after backup
                newItems.splice(insertIndex + 1, 0, { label: 'Restore Backup', icon: FiUpload, onClick: 'restore' });

                // Add Diagnostics at the end if enabled
                if (DIAGNOSTICS_ENABLED) {
                    newItems.push({ label: 'Diagnostics', icon: FiTerminal, href: '/more/diagnostics' });
                }

                return {
                    ...section,
                    items: newItems
                };
            }
            return section;
        });
    }, []);

    return (
        <div className={styles.container}>
            {backupError && (
                <div style={{
                    background: '#FEE2E2',
                    color: '#991B1B',
                    padding: '12px 16px',
                    borderRadius: '8px',
                    marginBottom: '16px',
                    fontSize: '14px',
                    fontWeight: '500'
                }}>
                    {backupError}
                </div>
            )}

            {restoreError && (
                <div style={{
                    background: '#FEE2E2',
                    color: '#991B1B',
                    padding: '12px 16px',
                    borderRadius: '8px',
                    marginBottom: '16px',
                    fontSize: '14px',
                    fontWeight: '500'
                }}>
                    {restoreError}
                </div>
            )}

            {/* Hidden file input for restore */}
            <input
                type="file"
                ref={fileInputRef}
                accept=".zip"
                style={{ display: 'none' }}
                onChange={handleFileSelect}
            />

            {/* Restore confirmation dialog */}
            {showRestoreConfirm && (
                <div style={{
                    position: 'fixed',
                    inset: 0,
                    background: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 100,
                    padding: '16px'
                }}>
                    <div style={{
                        background: 'white',
                        borderRadius: '16px',
                        padding: '24px',
                        maxWidth: '400px',
                        width: '100%'
                    }}>
                        <div style={{ fontSize: '18px', fontWeight: '700', marginBottom: '12px', color: '#DC2626' }}>
                            ⚠️ Confirm Restore
                        </div>
                        <div style={{ fontSize: '14px', color: '#374151', marginBottom: '8px' }}>
                            This will <strong>permanently replace all current data</strong> with the backup contents.
                        </div>
                        <div style={{ fontSize: '13px', color: '#6B7280', marginBottom: '20px' }}>
                            File: {pendingRestoreFile?.name}
                        </div>
                        <div style={{ display: 'flex', gap: '12px' }}>
                            <button
                                onClick={handleRestoreCancel}
                                style={{
                                    flex: 1,
                                    padding: '12px',
                                    borderRadius: '8px',
                                    border: '1px solid #D1D5DB',
                                    background: 'white',
                                    fontWeight: '600',
                                    cursor: 'pointer'
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleRestoreConfirm}
                                style={{
                                    flex: 1,
                                    padding: '12px',
                                    borderRadius: '8px',
                                    border: 'none',
                                    background: '#DC2626',
                                    color: 'white',
                                    fontWeight: '600',
                                    cursor: 'pointer'
                                }}
                            >
                                Restore
                            </button>
                        </div>
                    </div>
                </div>
            )}

            <div className={styles.profileCard}>
                <div className={styles.avatar}>
                    {companyDetails.name ? companyDetails.name[0].toUpperCase() : 'S'}
                </div>
                <div className={styles.profileInfo}>
                    <div className={styles.profileName}>{companyDetails.name || 'Set Company Name'}</div>
                    <div className={styles.profileSub}>{companyDetails.gstin || 'Add GST Details'}</div>
                </div>
            </div>

            {menuItems.map((section, idx) => (
                <div key={idx}>
                    <div className={styles.sectionTitle}>{section.title}</div>
                    <div className={styles.menuGroup}>
                        {section.items.map((item, itemIdx) => {
                            // Handle backup action (not a link)
                            if (item.onClick === 'backup') {
                                return (
                                    <div
                                        key={itemIdx}
                                        className={styles.menuItem}
                                        onClick={backupLoading ? undefined : handleCreateBackup}
                                        style={{
                                            cursor: backupLoading ? 'not-allowed' : 'pointer',
                                            opacity: backupLoading ? 0.6 : 1
                                        }}
                                    >
                                        <div className={styles.menuIcon}>
                                            <item.icon />
                                        </div>
                                        <div className={styles.menuLabel}>
                                            {backupLoading ? 'Creating Backup...' : item.label}
                                        </div>
                                        {backupLoading ? (
                                            <div style={{
                                                width: '16px',
                                                height: '16px',
                                                border: '2px solid #E5E7EB',
                                                borderTop: '2px solid #3B82F6',
                                                borderRadius: '50%',
                                                animation: 'spin 1s linear infinite'
                                            }} />
                                        ) : (
                                            <FiChevronRight className={styles.menuArrow} />
                                        )}
                                    </div>
                                );
                            }

                            // Handle restore action
                            if (item.onClick === 'restore') {
                                return (
                                    <div
                                        key={itemIdx}
                                        className={styles.menuItem}
                                        onClick={restoreLoading ? undefined : handleRestoreClick}
                                        style={{
                                            cursor: restoreLoading ? 'not-allowed' : 'pointer',
                                            opacity: restoreLoading ? 0.6 : 1
                                        }}
                                    >
                                        <div className={styles.menuIcon}>
                                            <item.icon />
                                        </div>
                                        <div className={styles.menuLabel}>
                                            {restoreLoading ? 'Restoring...' : item.label}
                                        </div>
                                        {restoreLoading ? (
                                            <div style={{
                                                width: '16px',
                                                height: '16px',
                                                border: '2px solid #E5E7EB',
                                                borderTop: '2px solid #3B82F6',
                                                borderRadius: '50%',
                                                animation: 'spin 1s linear infinite'
                                            }} />
                                        ) : (
                                            <FiChevronRight className={styles.menuArrow} />
                                        )}
                                    </div>
                                );
                            }

                            // Regular link items
                            return (
                                <Link key={itemIdx} href={item.href} className={styles.menuItem}>
                                    <div className={styles.menuIcon}>
                                        <item.icon />
                                    </div>
                                    <div className={styles.menuLabel}>{item.label}</div>
                                    <FiChevronRight className={styles.menuArrow} />
                                </Link>
                            );
                        })}
                    </div>
                </div>
            ))}
        </div>
    );
}
</file>

<file path="src/app/page.js">
'use client';

import { useEffect } from 'react';
import Link from 'next/link';
import { FiBell, FiChevronRight, FiCheck, FiArrowUp, FiArrowDown, FiAlertCircle } from 'react-icons/fi';
import { FaReceipt, FaShoppingBag, FaWallet, FaFileAlt, FaStar } from 'react-icons/fa';
import { useHomeStore } from '@/lib/store/homeStore';
import styles from './page.module.css';

// Action configuration - deterministic mapping
const ACTION_CONFIG = {
  INVOICE: {
    label: 'Create Invoice',
    route: '/invoice/create',
    icon: FaReceipt
  },
  PURCHASE: {
    label: 'Purchase',
    route: '/bills/purchase/create',
    icon: FaShoppingBag
  },
  EXPENSE: {
    label: 'Expense',
    route: '/more/bills/expenses/create',
    icon: FaWallet
  }
};

// Format currency to Indian Rupees
const formatCurrency = (amount) => {
  if (amount == null || isNaN(amount)) return '₹0';
  return `₹${amount.toLocaleString('en-IN')}`;
};

// Format relative time from date string
const formatRelativeTime = (dateString) => {
  if (!dateString) return '';

  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now - date;
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffMinutes = Math.floor(diffMs / (1000 * 60));

  if (diffDays > 0) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
  if (diffHours > 0) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
  if (diffMinutes > 0) return `${diffMinutes} min${diffMinutes > 1 ? 's' : ''} ago`;
  return 'just now';
};

// Get activity icon based on type
const getActivityIcon = (type) => {
  switch (type) {
    case 'INVOICE':
      return <FaReceipt size={20} color="#6B7280" />;
    case 'PAYMENT':
      return <FiCheck size={20} color="#6B7280" />;
    default:
      return <FiAlertCircle size={20} color="#6B7280" />;
  }
};

export default function Home() {
  const { snapshot, loading, error, fetchSnapshot } = useHomeStore();

  // Fetch snapshot on mount
  useEffect(() => {
    fetchSnapshot();
  }, [fetchSnapshot]);

  // Get primary action config with fallback to INVOICE
  const mostUsed = snapshot?.primaryAction?.mostUsed || 'INVOICE';
  const primaryAction = ACTION_CONFIG[mostUsed] || ACTION_CONFIG.INVOICE;
  const PrimaryIcon = primaryAction.icon;

  return (
    <div className={styles.container}>
      {/* Header */}
      <header className={styles.header}>
        <div className={styles.brand}>
          swipe <span>🇮🇳</span>
        </div>
        <div className={styles.headerRight}>
          <button className={styles.notificationBtn}>
            <FiBell />
          </button>
          <div className={styles.langToggle}>
            <span>HI</span>
            <span>🇮🇳</span>
          </div>
        </div>
      </header>

      {/* Error State */}
      {error && (
        <div style={{
          background: '#FEF2F2',
          border: '1px solid #FECACA',
          borderRadius: '12px',
          padding: '16px',
          marginBottom: '16px',
          display: 'flex',
          alignItems: 'center',
          gap: '12px'
        }}>
          <FiAlertCircle size={20} color="#DC2626" />
          <div style={{ flex: 1 }}>
            <div style={{ fontSize: '14px', fontWeight: 600, color: '#DC2626', marginBottom: '4px' }}>
              {error}
            </div>
            <button
              onClick={fetchSnapshot}
              style={{
                fontSize: '13px',
                fontWeight: 500,
                color: '#DC2626',
                background: 'none',
                border: 'none',
                padding: 0,
                cursor: 'pointer',
                textDecoration: 'underline'
              }}
            >
              Retry
            </button>
          </div>
        </div>
      )}

      {/* Business Pulse Card */}
      <section className={styles.pulseCard}>
        <div className={styles.pulseDecoration}></div>
        <div className={styles.pulseContent}>
          <div className={styles.pulseLabel}>Business Pulse</div>

          {loading ? (
            // Skeleton loading
            <>
              <div style={{
                height: '38px',
                width: '60%',
                background: '#E5E7EB',
                borderRadius: '8px',
                marginBottom: '8px'
              }} />
              <div style={{
                height: '20px',
                width: '40%',
                background: '#E5E7EB',
                borderRadius: '6px'
              }} />
            </>
          ) : snapshot?.businessPulse ? (
            <>
              <div className={styles.pulseAmount}>
                {formatCurrency(snapshot.businessPulse.amountReceivedThisWeek)}
              </div>
              <div className={styles.pulseStats}>
                <span className={styles.pulseSubtext}>received this week</span>
                {snapshot.businessPulse.percentChangeWoW !== 0 && (
                  <span className={styles.pulseBadge}>
                    {snapshot.businessPulse.percentChangeWoW > 0 ? (
                      <FiArrowUp size={10} />
                    ) : (
                      <FiArrowDown size={10} />
                    )}
                    {Math.abs(snapshot.businessPulse.percentChangeWoW)}%
                  </span>
                )}
              </div>
              {snapshot.businessPulse.paymentsCompleted > 0 && (
                <div className={styles.pulseNote}>
                  {snapshot.businessPulse.paymentsCompleted} payment{snapshot.businessPulse.paymentsCompleted > 1 ? 's' : ''} completed - Great job! 🎉
                </div>
              )}
            </>
          ) : (
            <>
              <div className={styles.pulseAmount}>₹0</div>
              <div className={styles.pulseStats}>
                <span className={styles.pulseSubtext}>received this week</span>
              </div>
            </>
          )}
        </div>
      </section>

      {/* Quick Actions Section */}
      <section className={styles.actionsSection}>
        {/* Primary Action - Most Used */}
        <Link href={primaryAction.route} className={styles.primaryActionCard}>
          <div className={styles.primaryIconBox}>
            <PrimaryIcon size={22} />
            <div className={styles.starBadge}>
              <FaStar size={8} color="white" />
            </div>
          </div>
          <div className={styles.primaryActionInfo}>
            <div className={styles.primaryActionTitle}>{primaryAction.label}</div>
            <div className={styles.primaryActionSubtitle}>Most used</div>
          </div>
          <FiChevronRight className={styles.actionChevron} size={24} />
        </Link>

        {/* Quick Action Buttons */}
        <div className={styles.quickActionsGrid}>
          <Link href="/bills/purchase/create" className={styles.quickActionBtn}>
            <FaShoppingBag size={16} />
            <span>Purchase</span>
          </Link>
          <Link href="/more/bills/expenses/create" className={styles.quickActionBtn}>
            <FaWallet size={16} />
            <span>Expense</span>
          </Link>
          <Link href="/invoice/create?type=proforma" className={styles.quickActionBtn}>
            <FaFileAlt size={16} />
            <span>Pro Forma</span>
          </Link>
        </div>
      </section>

      {/* Recent Activity Section */}
      {(!loading && snapshot?.recentActivity && snapshot.recentActivity.length > 0) && (
        <section className={styles.activitySection}>
          <div className={styles.sectionHeader}>
            <h3 className={styles.sectionTitle}>Recent Activity</h3>
            <Link href="/invoice" className={styles.seeAllLink}>
              See All <FiChevronRight size={16} />
            </Link>
          </div>

          <div className={styles.activityList}>
            {snapshot.recentActivity.map((activity, index) => {
              // Determine card rendering based on status
              const isOverdue = activity.status === 'OVERDUE';
              const isPaid = activity.status === 'PAID';
              const isRisk = activity.type === 'RISK_SUMMARY';

              return (
                <div key={index} className={styles.activityCard}>
                  {isRisk ? (
                    // Risk summary card
                    <>
                      <div className={styles.unpaidCount}>
                        {snapshot.riskSummary?.unpaidInvoicesCount || 0}
                      </div>
                      <div className={styles.activityInfo}>
                        <div className={styles.activityTitle}>{activity.title}</div>
                        <div className={styles.activitySubtitle}>{activity.subtitle}</div>
                      </div>
                      <div className={styles.activityRight}>
                        <div className={styles.activityAmount}>
                          {formatCurrency(activity.amount)}
                        </div>
                        <div className={`${styles.activityStatus} ${styles.risk}`}>
                          {activity.status || 'At risk'}
                        </div>
                      </div>
                    </>
                  ) : (
                    // Regular activity card
                    <>
                      <div className={styles.activityAvatar}>
                        {getActivityIcon(activity.type)}
                        {(isOverdue || isPaid) && (
                          <div className={`${styles.avatarBadge} ${isPaid ? styles.success : styles.warning}`}>
                            {isPaid ? (
                              <FiCheck size={10} color="white" />
                            ) : (
                              <FiArrowDown size={10} color="white" />
                            )}
                          </div>
                        )}
                      </div>
                      <div className={styles.activityInfo}>
                        <div className={styles.activityTitle}>{activity.title}</div>
                        <div className={styles.activitySubtitle}>
                          {activity.subtitle}
                        </div>
                      </div>
                      <div className={styles.activityRight}>
                        <div className={styles.activityAmount}>
                          {formatCurrency(activity.amount)}
                          {isPaid && (
                            <span style={{ fontWeight: 400, fontSize: 11, color: '#22C55E', marginLeft: 4 }}>
                              Paid!
                            </span>
                          )}
                        </div>
                        <div className={`${styles.activityStatus} ${isOverdue ? styles.overdue : isPaid ? styles.paid : styles.risk}`}>
                          {activity.date ? formatRelativeTime(activity.date) : activity.status}
                        </div>
                      </div>
                    </>
                  )}
                </div>
              );
            })}
          </div>
        </section>
      )}

      {/* Floating Action Button */}
      <Link href="/invoice/create" className={styles.fab}>
        <FiCheck size={20} />
        Create Invoice
        <FiChevronRight size={16} />
      </Link>
    </div>
  );
}
</file>

<file path="src/lib/store/invoiceStore.js">
import { create } from 'zustand';
import { api } from '@/api/backendClient';
import { logger, LOG_EVENTS } from '@/lib/logger';

export const useInvoiceStore = create((set, get) => ({
    // Invoice number is now assigned by backend
    invoiceNumber: '',
    date: new Date().toISOString().split('T')[0],
    dueDate: new Date().toISOString().split('T')[0],
    placeOfSupply: '',
    invoiceCopyType: 'Original for Recipient',
    customer: null,
    items: [],
    invoices: [], // List of all invoices
    type: 'INVOICE', // 'INVOICE' | 'PROFORMA' | 'LENDING'
    isLoading: false,
    error: null,

    // New Fields
    details: {
        reference: '',
        notes: '',
        terms: '',
        extraDiscount: 0,
        shippingCharges: 0,
        packagingCharges: 0,
    },
    weightSummary: {
        grossWeight: '',
        netWeight: '',
    },
    toggles: {
        tds: false,
        tcs: false,
        rcm: false,
    },
    payment: {
        isFullyPaid: false,
        amountReceived: 0,
        mode: 'Cash',
        notes: '',
    },
    roundOff: false,
    id: null, // For editing

    // Load invoices from backend
    loadInvoices: async () => {
        set({ isLoading: true, error: null });
        try {
            const invoices = await api.invoices.list();
            set({ invoices: invoices.reverse(), isLoading: false });
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_LOAD_ERROR, { store: 'invoices', error: error.message });
            set({ error: error.message, isLoading: false });
        }
    },

    // Get single invoice with full details
    getInvoice: async (id) => {
        try {
            return await api.invoices.get(id);
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_LOAD_ERROR, { type: 'invoice_detail', id, error: error.message });
            throw error;
        }
    },

    // Setters for form state
    setInvoiceNumber: (num) => set({ invoiceNumber: num }),
    setDate: (date) => set({ date }),
    setDueDate: (date) => set({ dueDate: date }),
    setPlaceOfSupply: (pos) => set({ placeOfSupply: pos }),
    setInvoiceCopyType: (type) => set({ invoiceCopyType: type }),
    setCustomer: (customer) => set({ customer }),
    setInvoiceType: (type) => set({ type }),

    setWeightSummary: (field, value) => set((state) => ({
        weightSummary: { ...state.weightSummary, [field]: value }
    })),

    // Load invoice into form for editing
    setInvoice: (invoice) => {
        // Transform API items to form-compatible format
        const transformedItems = (invoice.items || []).map(item => {
            const netWeight = Number(item.weight?.net || item.netWeight) || 0;
            const makingCharges = Number(item.amount?.makingCharges) || 0;
            // Derive makingChargePerGram from total makingCharges
            const makingChargePerGram = netWeight > 0 ? makingCharges / netWeight : 0;

            return {
                id: item.id || Date.now(),
                productId: item.productId,
                name: item.description || item.name || '',
                rate: item.rate || 0,
                quantity: item.quantity || 1,
                gstRate: item.taxRate || 3,
                hsn: item.hsn || '',
                grossWeight: Number(item.weight?.gross || item.grossWeight) || 0,
                netWeight: netWeight,
                ratePerGram: item.rate || 0,
                makingChargePerGram: makingChargePerGram,
                purity: item.purity || ''
            };
        });

        set({
            id: invoice.id,
            invoiceNumber: invoice.invoiceNumber,
            date: invoice.date?.split('T')[0] || invoice.date,
            dueDate: (invoice.dueDate || invoice.date)?.split('T')[0] || invoice.dueDate || invoice.date,
            placeOfSupply: invoice.placeOfSupply || '',
            invoiceCopyType: invoice.invoiceCopyType || 'Original for Recipient',
            customer: invoice.customer,
            items: transformedItems,
            details: invoice.details || { reference: '', notes: '', terms: '', extraDiscount: 0, shippingCharges: 0, packagingCharges: 0 },
            weightSummary: invoice.weightSummary || { grossWeight: '', netWeight: '' },
            toggles: invoice.toggles || { tds: false, tcs: false, rcm: false },
            payment: invoice.payment || { isFullyPaid: false, amountReceived: 0, mode: 'Cash', notes: '' },
            roundOff: invoice.totals?.roundOff !== 0,
            type: invoice.type || 'INVOICE'
        });
    },

    updateDetails: (field, value) => set((state) => ({
        details: { ...state.details, [field]: value }
    })),
    toggleSwitch: (field) => set((state) => ({
        toggles: { ...state.toggles, [field]: !state.toggles[field] }
    })),
    updatePayment: (field, value) => set((state) => ({
        payment: { ...state.payment, [field]: value }
    })),
    toggleRoundOff: () => set((state) => ({ roundOff: !state.roundOff })),

    resetInvoice: () => set({
        id: null,
        invoiceNumber: '', // Backend assigns
        date: new Date().toISOString().split('T')[0],
        dueDate: new Date().toISOString().split('T')[0],
        placeOfSupply: '',
        invoiceCopyType: 'Original for Recipient',
        customer: null,
        items: [],
        details: { reference: '', notes: '', terms: '', extraDiscount: 0, shippingCharges: 0, packagingCharges: 0 },
        weightSummary: { grossWeight: '', netWeight: '' },
        toggles: { tds: false, tcs: false, rcm: false },
        payment: { isFullyPaid: false, amountReceived: 0, mode: 'Cash', notes: '' },
        roundOff: false,
        type: 'INVOICE'
    }),

    // Item management (local state only)
    addItem: () => set((state) => ({
        items: [...state.items, {
            id: Date.now(), // Temporary local ID
            name: '',
            rate: 0,
            quantity: 1,
            gstRate: 0,
            hsn: '',
            netWeight: 0,
            grossWeight: 0,
            ratePerGram: 0,
            makingChargePerGram: 0,
            purity: ''
        }]
    })),

    updateItem: (id, field, value) => set((state) => ({
        items: state.items.map(item =>
            item.id === id ? { ...item, [field]: value } : item
        )
    })),

    removeItem: (id) => set((state) => ({
        items: state.items.filter(item => item.id !== id)
    })),

    addOrUpdateItem: (product, change) => set((state) => {
        const existingItem = state.items.find(item => item.productId === product.id);

        if (existingItem) {
            const newQuantity = existingItem.quantity + change;
            if (newQuantity <= 0) {
                return { items: state.items.filter(item => item.productId !== product.id) };
            }
            return {
                items: state.items.map(item =>
                    item.productId === product.id
                        ? { ...item, quantity: newQuantity }
                        : item
                )
            };
        } else if (change > 0) {
            const itemName = product.subCategory || product.name;
            const ratePerGram = Number(product.sellingPrice) || 0;
            // Extract attributes from metal object or fallback
            const makingChargePerGram = Number(product.metal?.makingCharges || product.makingCharges) || 0;
            const grossWeight = Number(product.metal?.grossWeight || product.grossWeight) || 0;
            const netWeight = Number(product.metal?.netWeight || product.netWeight) || 0;
            const purity = product.metal?.purity || product.purity || '';

            return {
                items: [...state.items, {
                    id: Date.now(),
                    productId: product.id,
                    name: itemName,
                    rate: 0,
                    quantity: change,
                    gstRate: 0,
                    hsn: product.hsn || '',
                    grossWeight,
                    netWeight,
                    ratePerGram,
                    makingChargePerGram,
                    purity,
                    // Computed values - backend will recalculate
                    materialValue: netWeight * ratePerGram,
                    makingCharge: netWeight * makingChargePerGram,
                    itemTotal: (netWeight * ratePerGram) + (netWeight * makingChargePerGram)
                }]
            };
        }
        return state;
    }),

    // Save invoice to backend
    saveInvoice: async () => {
        const state = get();
        const { date, dueDate, placeOfSupply, invoiceCopyType, customer, items, details, weightSummary, toggles, payment, id, type } = state;

        if (!customer) throw new Error('Customer is required');

        set({ isLoading: true, error: null });

        // Prepare items for backend
        const preparedItems = items.map(item => ({
            productId: item.productId,
            description: item.name,
            quantity: item.quantity || 1,
            rate: item.ratePerGram || item.rate || 0,
            taxRate: item.gstRate || 3,
            weight: {
                gross: Number(item.grossWeight) || 0,
                net: Number(item.netWeight) || 0
            },
            amount: {
                makingCharges: (Number(item.netWeight) || 0) * (Number(item.makingChargePerGram) || 0),
                stoneCharges: 0
            },
            hsn: item.hsn || '',
            purity: item.purity || ''
        }));

        // Prepare invoice data - backend computes totals
        const invoiceData = {
            customerId: customer.id,
            type: type || 'INVOICE',
            date,
            dueDate,
            placeOfSupply,
            invoiceCopyType,
            customer: {
                name: customer.name,
                phone: customer.phone,
                gstin: customer.gstin,
                address: customer.address
            },
            items: preparedItems,
            details,
            weightSummary,
            toggles,
            roundOff: state.roundOff,
            payment: {
                amountReceived: Number(payment.amountReceived) || 0,
                mode: payment.mode,
                notes: payment.notes
            }
        };

        try {
            let savedInvoice;
            if (id) {
                // Update
                savedInvoice = await api.invoices.update(id, invoiceData);
                logger.audit(LOG_EVENTS.INVOICE_UPDATED, { type: 'invoice', id, invoiceNumber: state.invoiceNumber });
            } else {
                // Create
                savedInvoice = await api.invoices.create(invoiceData);
                logger.audit(LOG_EVENTS.INVOICE_CREATED, { type: 'invoice', invoiceNumber: savedInvoice.invoiceNumber });
            }

            // Reload invoices from backend
            const invoices = await api.invoices.list();
            set({ invoices: invoices.reverse(), isLoading: false });

            return savedInvoice.id;
        } catch (error) {
            logger.error(LOG_EVENTS.INVOICE_SAVE_FAILED, { error: error.message });
            set({ error: error.message, isLoading: false });
            throw error;
        }
    },

    deleteInvoice: async (id) => {
        set({ isLoading: true, error: null });
        try {
            await api.invoices.delete(id);
            logger.audit(LOG_EVENTS.INVOICE_DELETED, { type: 'invoice', id });
            const invoices = await api.invoices.list();
            set({ invoices: invoices.reverse(), isLoading: false });
        } catch (error) {
            logger.error(LOG_EVENTS.STORE_DELETE_ERROR, { store: 'invoices', id, error: error.message });
            set({ error: error.message, isLoading: false });
            throw error;
        }
    },

    // Calculate totals for UI preview only - backend is authoritative
    calculateTotals: () => {
        const { items, details, roundOff, type } = get();
        let subtotal = 0;

        items.forEach(item => {
            let itemTotal = 0;
            if (item.productId || (item.netWeight !== undefined)) {
                const netWeight = Number(item.netWeight) || 0;
                const ratePerGram = Number(item.ratePerGram) || 0;
                const mcPerGram = Number(item.makingChargePerGram) || 0;
                const materialValue = netWeight * ratePerGram;
                const makingCharge = netWeight * mcPerGram;
                itemTotal = (materialValue + makingCharge) * (item.quantity || 1);
            } else {
                itemTotal = (item.rate || 0) * (item.quantity || 1);
            }
            subtotal += itemTotal;
        });

        // LENDING BILL: No pricing
        if (type === 'LENDING') {
            return {
                subtotal: 0, totalTax: 0, total: 0, roundOffAmount: 0,
                rawTotal: 0, cgst: 0, sgst: 0, igst: 0
            };
        }

        // Tax calculation (preview only)
        let cgstAmount = 0, sgstAmount = 0, totalTax = 0;
        if (type !== 'PROFORMA') {
            cgstAmount = (subtotal * 1.5) / 100;
            sgstAmount = (subtotal * 1.5) / 100;
            totalTax = cgstAmount + sgstAmount;
        }

        let total = subtotal + totalTax;
        total += Number(details.shippingCharges || 0);
        total += Number(details.packagingCharges || 0);
        total -= Number(details.extraDiscount || 0);

        let finalTotal = total;
        let roundOffAmount = 0;
        if (roundOff) {
            finalTotal = Math.round(total);
            roundOffAmount = finalTotal - total;
        }

        return {
            subtotal, totalTax, total: finalTotal, roundOffAmount,
            rawTotal: total, cgst: cgstAmount, sgst: sgstAmount, igst: 0
        };
    },

    clearError: () => set({ error: null }),
}));
</file>

<file path="src/app/invoice/view/page.js">
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useInvoiceStore } from '@/lib/store/invoiceStore';
import { formatCurrency } from '@/lib/utils/tax';
import { shareInvoicePDF, downloadInvoicePDF } from '@/lib/utils/invoiceActions';
import BottomSheet from '@/components/BottomSheet';
import {
    FiArrowLeft, FiEdit, FiMoreHorizontal, FiShare2, FiPrinter, FiDownload,
    FiCopy, FiClock, FiRefreshCw, FiSettings, FiMail, FiMessageSquare,
    FiTruck, FiFileText, FiXCircle
} from 'react-icons/fi';
import CancelInvoiceModal from '@/components/CancelInvoiceModal';

function InvoiceViewContent() {
    const router = useRouter();
    const searchParams = useSearchParams();
    const id = searchParams.get('id');
    const [invoice, setInvoice] = useState(null);
    const [isMenuOpen, setIsMenuOpen] = useState(false);
    const { getInvoice, deleteInvoice } = useInvoiceStore();

    useEffect(() => {
        const loadInvoice = async () => {
            if (id) {
                try {
                    const inv = await getInvoice(id);
                    setInvoice(inv);
                } catch (error) {
                    console.error('Failed to load invoice:', error);
                }
            }
        };
        loadInvoice();
    }, [id, getInvoice]);

    const handleShare = async () => {
        if (!invoice) return;
        await shareInvoicePDF(invoice);
    };

    const handleDownload = async () => {
        if (!invoice) return;
        await downloadInvoicePDF(invoice);
    };

    const [isCancelModalOpen, setIsCancelModalOpen] = useState(false);

    const handleCancelInvoice = async (reason) => {
        if (invoice) {
            await deleteInvoice(invoice.id);
            setIsCancelModalOpen(false);
            router.push('/'); // Redirect to home/dashboard after deletion
        }
    };

    if (!invoice) return <div style={{ padding: 20 }}>Loading...</div>;

    const menuGridItems = [
        { label: 'Edit', icon: FiEdit, onClick: () => router.push(`/invoice/edit?id=${invoice.id}`) },
        {
            label: 'View PDF', icon: FiDownload, onClick: async () => {
                await handleDownload();
                setIsMenuOpen(false);
            }
        },

        {
            label: 'Send Bill', icon: FiShare2, onClick: () => {
                handleShare();
                setIsMenuOpen(false);
            }
        },
    ];

    const menuListItems = [
        { label: 'Duplicate', icon: FiCopy },
        { label: 'Thermal Print', icon: FiPrinter },
        { label: 'Activity', icon: FiClock },
        { label: 'Convert', icon: FiRefreshCw, sub: '(3 free trials left)' },
        { label: 'Document Settings', icon: FiSettings },
        { label: 'Send Email', icon: FiMail },
        { label: 'Send SMS', icon: FiMessageSquare },

        {
            label: 'Cancel Invoice',
            icon: FiXCircle,
            danger: true,
            action: true,
            onClick: () => {
                setIsMenuOpen(false);
                setIsCancelModalOpen(true);
            }
        },
    ];

    return (
        <div style={{ background: '#f3f4f6', minHeight: '100vh', paddingBottom: 100 }}>
            {/* Header */}
            <div style={{
                background: 'white',
                padding: '16px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                borderBottom: '1px solid #e5e7eb'
            }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                    <FiArrowLeft size={24} onClick={() => router.push('/')} style={{ cursor: 'pointer' }} />
                    <div>
                        <div style={{ fontWeight: 700, fontSize: 16 }}>{invoice.invoiceNumber}</div>
                        <div style={{ fontSize: 12, color: '#6b7280' }}>Invoice</div>
                    </div>
                </div>
                <div style={{ display: 'flex', gap: 12 }}>
                    <button
                        onClick={() => router.push(`/invoice/edit?id=${invoice.id}`)}
                        style={{
                            display: 'flex', alignItems: 'center', gap: 6,
                            background: '#fef3c7', color: '#d97706',
                            border: 'none', padding: '6px 12px', borderRadius: 6, fontWeight: 600
                        }}>
                        <FiEdit size={14} /> Edit
                    </button>
                    <FiMoreHorizontal size={24} onClick={() => setIsMenuOpen(true)} style={{ cursor: 'pointer' }} />
                </div>
            </div>

            <div style={{ padding: 16 }}>
                {/* Customer Details */}
                <div style={{ fontSize: 14, fontWeight: 600, marginBottom: 8, color: '#374151' }}>Customer Details</div>
                <div style={{ background: 'white', padding: 16, borderRadius: 12, marginBottom: 16 }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>
                        <div style={{ fontSize: 12, color: '#6b7280' }}>Customer Details</div>
                        <div style={{
                            background: invoice.status === 'Paid' ? '#dcfce7' : '#fee2e2',
                            color: invoice.status === 'Paid' ? '#166534' : '#991b1b',
                            fontSize: 10, fontWeight: 600, padding: '2px 8px', borderRadius: 4
                        }}>
                            {invoice.status.toUpperCase()}
                        </div>
                    </div>
                    <div style={{ fontWeight: 600, fontSize: 16, marginBottom: 12 }}>{invoice.customer.name}</div>

                    <div style={{ marginBottom: 12 }}>
                        <div style={{ fontSize: 12, color: '#6b7280', display: 'flex', alignItems: 'center', gap: 4 }}>
                            Invoice date <FiEdit size={10} />
                        </div>
                        <div style={{ fontWeight: 600, fontSize: 14 }}>{invoice.date}</div>
                    </div>

                    <div>
                        <div style={{ fontSize: 12, color: '#6b7280' }}>Billing Address</div>
                        <div style={{ fontWeight: 600, fontSize: 14 }}>{invoice.customer.address || 'NA'}</div>
                    </div>
                </div>

                {/* Items */}
                <div style={{ fontSize: 14, fontWeight: 600, marginBottom: 8, color: '#374151' }}>
                    Items <span style={{ color: '#6b7280', fontWeight: 400 }}>({invoice.items?.length || 0} Product)</span>
                </div>
                <div style={{ background: 'white', borderRadius: 12, overflow: 'hidden', marginBottom: 16 }}>
                    {invoice.items?.map((item, idx) => (
                        <div key={idx} style={{ padding: 16, borderBottom: '1px solid #f3f4f6' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                                <div style={{ fontWeight: 600 }}>{item.description || item.name || 'Unnamed Item'}</div>
                                <div style={{ fontWeight: 600 }}>{formatCurrency(item.rate || 0)}</div>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 12, color: '#6b7280' }}>
                                <div>x {item.quantity || 1}</div>
                                <div>&gt;</div>
                            </div>
                        </div>
                    ))}
                    <div style={{ padding: 16, background: '#f9fafb' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4, fontSize: 14, color: '#6b7280' }}>
                            <div>Subtotal</div>
                            <div>{formatCurrency(invoice.totals?.subtotal || 0)}</div>
                        </div>
                        {/* Add other charges here if present */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', fontWeight: 700, fontSize: 14 }}>
                            <div>Total Amount</div>
                            <div>{formatCurrency(invoice.totals?.grandTotal || invoice.totals?.total || 0)}</div>
                        </div>
                    </div>
                </div>

                {/* Payments */}
                <div style={{ fontSize: 14, fontWeight: 600, marginBottom: 8, color: '#374151' }}>Payments</div>
                <div style={{ background: 'white', padding: 16, borderRadius: 12, marginBottom: 16 }}>
                    {invoice.payment?.amountReceived > 0 ? (
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                    <span style={{ fontWeight: 600 }}>{invoice.date}</span>
                                    <span style={{ background: '#dcfce7', color: '#166534', fontSize: 10, padding: '2px 6px', borderRadius: 4 }}>
                                        {invoice.payment?.mode}
                                    </span>
                                </div>
                                <div style={{ fontSize: 12, color: '#6b7280' }}>PAYIN-1</div>
                            </div>
                            <div style={{ textAlign: 'right' }}>
                                <div style={{ fontWeight: 600 }}>{formatCurrency(invoice.payment?.amountReceived || 0)}</div>
                                <button style={{
                                    background: '#2563eb', color: 'white', border: 'none',
                                    padding: '4px 8px', borderRadius: 4, fontSize: 10, marginTop: 4
                                }}>
                                    📄 View Receipt
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div style={{ color: '#6b7280', fontSize: 14 }}>No payments recorded</div>
                    )}
                </div>

            </div>

            {/* Bottom Actions */}
            <div style={{
                position: 'fixed', bottom: 0, left: 0, right: 0,
                background: 'white', padding: 16, borderTop: '1px solid #e5e7eb',
                display: 'flex', gap: 12, overflowX: 'auto'
            }}>
                <button
                    onClick={handleDownload}
                    style={{
                        flex: 1, padding: '12px', borderRadius: 24, border: '1px solid #e5e7eb',
                        background: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8,
                        minWidth: 120
                    }}>
                    <FiDownload /> View PDF
                </button>
                <button style={{
                    flex: 1, padding: '12px', borderRadius: 24, border: '1px solid #e5e7eb',
                    background: '#f3f4f6', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8,
                    minWidth: 140
                }}>
                    <FiPrinter /> Thermal Print
                </button>
                <button
                    onClick={handleShare}
                    style={{
                        flex: 1, padding: '12px', borderRadius: 24, border: 'none',
                        background: '#2563eb', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8,
                        minWidth: 120
                    }}>
                    <FiShare2 /> Send Bill
                </button>
            </div>

            <BottomSheet isOpen={isMenuOpen} onClose={() => setIsMenuOpen(false)}>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12, marginBottom: 24 }}>
                    {menuGridItems.map((item, idx) => (
                        <div key={idx} onClick={item.onClick} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 8 }}>
                            <div style={{
                                width: 48, height: 48, borderRadius: 12, background: 'white',
                                border: '1px solid #e5e7eb', display: 'flex', alignItems: 'center', justifyContent: 'center',
                                boxShadow: '0 1px 2px rgba(0,0,0,0.05)'
                            }}>
                                <item.icon size={20} />
                            </div>
                            <div style={{ fontSize: 11, fontWeight: 600, textAlign: 'center', lineHeight: 1.2 }}>{item.label}</div>
                        </div>
                    ))}
                </div>

                <div style={{ display: 'flex', flexDirection: 'column' }}>
                    {menuListItems.map((item, idx) => (
                        <div key={idx}
                            onClick={item.onClick || (() => alert(`${item.label} coming soon`))}
                            style={{
                                display: 'flex', alignItems: 'center', gap: 16, padding: '16px 0',
                                borderBottom: idx < menuListItems.length - 1 ? '1px solid #f3f4f6' : 'none',
                                color: item.danger ? '#ef4444' : 'inherit'
                            }}
                        >
                            <item.icon size={20} />
                            <div style={{ flex: 1 }}>
                                <div style={{ fontSize: 14, fontWeight: 500 }}>{item.label}</div>
                                {item.sub && <div style={{ fontSize: 11, color: '#9ca3af' }}>{item.sub}</div>}
                            </div>
                            {item.action && (
                                <div style={{
                                    width: 24, height: 24, borderRadius: 12, background: item.danger ? '#fee2e2' : '#f3f4f6',
                                    display: 'flex', alignItems: 'center', justifyContent: 'center'
                                }}>
                                    <div style={{
                                        width: 0, height: 0,
                                        borderTop: '4px solid transparent', borderBottom: '4px solid transparent',
                                        borderLeft: `6px solid ${item.danger ? '#ef4444' : '#6b7280'}`
                                    }} />
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            </BottomSheet>

            <CancelInvoiceModal
                isOpen={isCancelModalOpen}
                onClose={() => setIsCancelModalOpen(false)}
                onConfirm={handleCancelInvoice}
            />
        </div>
    );
}

export default function InvoiceViewPage() {
    return (
        <Suspense fallback={<div>Loading...</div>}>
            <InvoiceViewContent />
        </Suspense>
    );
}
</file>

<file path="src/components/InvoiceForm.js">
'use client';

import { useRouter, useSearchParams } from 'next/navigation';
import { useInvoiceStore } from '@/lib/store/invoiceStore';
import { usePartyStore } from '@/lib/store/partyStore';
import { useSettingsStore } from '@/lib/store/settingsStore';
import { useEffect } from 'react';
import { formatCurrency } from '@/lib/utils/tax';
import { generatePDF } from '@/lib/utils/pdf';
import { FiPlus, FiTrash2, FiCalendar, FiUser, FiBox, FiArrowLeft } from 'react-icons/fi';
import styles from './InvoiceForm.module.css';

export default function InvoiceForm() {
    const router = useRouter();
    const searchParams = useSearchParams(); // Need to import this
    const prefillCustomerId = searchParams?.get('customerId');
    const { getCustomer } = usePartyStore(); // Need to import this

    const {
        id, invoiceNumber, date, dueDate, placeOfSupply, invoiceCopyType, items, customer,
        details, toggles, payment, roundOff, type, // Add type
        addItem, updateItem, removeItem, calculateTotals,
        updateDetails, toggleSwitch, updatePayment, toggleRoundOff, resetInvoice, saveInvoice,
        setDueDate, setPlaceOfSupply, setInvoiceCopyType, setCustomer
    } = useInvoiceStore();

    useEffect(() => {
        if (prefillCustomerId && !customer) {
            const c = getCustomer(prefillCustomerId);
            if (c) setCustomer(c);
        }
    }, [prefillCustomerId, customer, getCustomer, setCustomer]);

    const totals = calculateTotals();

    const handleSave = async () => {
        if (!customer) return alert('Please select a customer');
        if (items.length === 0) return alert('Please add at least one item');

        try {
            const savedId = await saveInvoice();
            resetInvoice(); // Clear form
            router.push(`/invoice/view?id=${savedId}`);
        } catch (error) {
            console.error('Failed to save invoice:', error);
            alert('Failed to save invoice: ' + error.message);
        }
    };

    const handleDownloadPDF = async () => {
        const { templateId, lendingBillTemplateId } = useSettingsStore.getState();

        await generatePDF({
            invoiceNumber,
            date,
            items,
            totals,
            type,
            templateId: type === 'LENDING' ? (lendingBillTemplateId || 'modern') : (templateId || 'modern')
        });
    };

    return (
        <div className={styles.container}>
            <div className={styles.card}>
                <div className={styles.row}>
                    <div>
                        <div className={styles.label}>{type === 'PROFORMA' ? 'Pro Forma #' : type === 'LENDING' ? 'Lending Bill #' : 'Invoice #'}</div>
                        <div className={styles.value}>{invoiceNumber}</div>
                        {type === 'PROFORMA' && <span style={{ fontSize: 10, background: '#e0e7ff', color: '#4338ca', padding: '2px 6px', borderRadius: 4 }}>PRO FORMA</span>}
                        {type === 'LENDING' && <span style={{ fontSize: 10, background: '#f3f4f6', color: '#374151', padding: '2px 6px', borderRadius: 4 }}>LENDING BILL</span>}
                    </div>
                    <div className={styles.value} style={{ color: 'var(--primary)' }}>Edit</div>
                </div>
                <div className={styles.row}>
                    <div className={styles.label}>Date</div>
                    <input type="date" className={styles.input} value={date} onChange={(e) => useInvoiceStore.getState().setDate(e.target.value)} />
                </div>
                <div className={styles.row}>
                    <div className={styles.label}>Due Date</div>
                    <input type="date" className={styles.input} value={dueDate} onChange={(e) => setDueDate(e.target.value)} />
                </div>

            </div>

            <div className={styles.sectionTitle}>
                Customer <FiUser size={14} />
            </div>
            <div className={styles.card}>
                {customer ? (
                    <div className={styles.selectedCustomer}>
                        <div className={styles.customerInfo}>
                            <div className={styles.customerName}>{customer.name}</div>
                            {customer.phone && <div className={styles.customerPhone}>{customer.phone}</div>}
                        </div>
                        <div className={styles.customerActions}>
                            <button
                                className={styles.actionButton}
                                onClick={() => router.push('/invoice/create/select-customer')}
                            >
                                View
                            </button>
                            <button
                                className={styles.actionButton}
                                onClick={() => router.push('/invoice/create/select-customer')}
                            >
                                Change
                            </button>
                        </div>
                    </div>
                ) : (
                    <button
                        className={styles.addButton}
                        onClick={() => router.push('/invoice/create/select-customer')}
                    >
                        <FiPlus /> Select Customer
                    </button>
                )}
            </div>

            <div className={styles.sectionTitle}>
                Products <FiBox size={14} />
            </div>
            {/* Products List with Jewellery Fields */}
            <div className={styles.card}>
                {type !== 'LENDING' && (
                    <button
                        className={styles.addButton}
                        onClick={() => router.push('/invoice/create/select-product')}
                        style={{ marginBottom: '12px' }}
                    >
                        <FiPlus /> Select Products
                    </button>
                )}

                {items.map((item) => (
                    <div key={item.id} className={styles.itemRow} style={{ borderBottom: '1px solid #f3f4f6', paddingBottom: 16 }}>
                        <div className={styles.itemHeader} style={{ marginBottom: 8, justifyContent: 'space-between', alignItems: 'flex-start' }}>
                            <div style={{ flex: 1 }}>
                                {type === 'LENDING' ? (
                                    <div style={{ marginBottom: 8 }}>
                                        <label style={{ fontSize: 10, color: '#6b7280', display: 'block', marginBottom: 4 }}>Item Description / Subcategory</label>
                                        <input
                                            className={styles.input}
                                            value={item.name}
                                            onChange={(e) => updateItem(item.id, 'name', e.target.value)}
                                            placeholder="Enter Item Description (e.g. Gold Ring)"
                                        />
                                    </div>
                                ) : (
                                    <div style={{ fontWeight: 600 }}>{item.name}</div>
                                )}
                            </div>
                            <button onClick={() => removeItem(item.id)} style={{ color: 'red', border: 'none', background: 'none', marginLeft: 8, padding: 4 }}>
                                <FiTrash2 />
                            </button>
                        </div>

                        {type === 'LENDING' ? (
                            <div style={{ display: 'flex', gap: 16 }}>
                                <div style={{ width: 100 }}>
                                    <label style={{ fontSize: 10, color: '#6b7280' }}>Quantity</label>
                                    <input
                                        className={styles.input}
                                        type="number"
                                        value={item.quantity}
                                        onChange={(e) => updateItem(item.id, 'quantity', Number(e.target.value))}
                                        placeholder="1"
                                    />
                                </div>
                            </div>
                        ) : (
                            <>
                                {/* Row 1: Weights (Read Only) */}
                                <div style={{ display: 'flex', gap: 8, marginBottom: 8 }}>
                                    <div style={{ flex: 1 }}>
                                        <label style={{ fontSize: 10, color: '#6b7280' }}>Gross Wt</label>
                                        <input
                                            className={styles.input}
                                            value={item.grossWeight || ''}
                                            readOnly
                                            placeholder="0"
                                            style={{ background: '#f9fafb' }}
                                        />
                                    </div>
                                    <div style={{ flex: 1 }}>
                                        <label style={{ fontSize: 10, color: '#6b7280' }}>Net Wt (g)</label>
                                        <input
                                            className={styles.input}
                                            type="number"
                                            value={item.netWeight || ''}
                                            onChange={(e) => updateItem(item.id, 'netWeight', e.target.value)}
                                            placeholder="0"
                                            // Manual items might need editable weight
                                            readOnly={!!item.productId}
                                            style={{ background: item.productId ? '#f9fafb' : 'white' }}
                                        />
                                    </div>
                                    <div style={{ flex: 1 }}>
                                        <label style={{ fontSize: 10, color: '#6b7280' }}>Purity</label>
                                        <input
                                            className={styles.input}
                                            value={item.purity || ''}
                                            readOnly
                                            placeholder="-"
                                            style={{ background: '#f9fafb' }}
                                        />
                                    </div>
                                </div>

                                {/* Row 2: Pricing Inputs */}
                                <div style={{ display: 'flex', gap: 8, marginBottom: 8 }}>
                                    <div style={{ flex: 1 }}>
                                        <label style={{ fontSize: 10, color: '#6b7280' }}>Rate/gm</label>
                                        <input
                                            className={styles.input}
                                            type="number"
                                            value={item.ratePerGram || ''}
                                            onChange={(e) => updateItem(item.id, 'ratePerGram', e.target.value)}
                                            placeholder="Rate"
                                        />
                                    </div>
                                    <div style={{ flex: 1 }}>
                                        <label style={{ fontSize: 10, color: '#6b7280' }}>MC/gm</label>
                                        <input
                                            className={styles.input}
                                            type="number"
                                            value={item.makingChargePerGram || ''}
                                            onChange={(e) => updateItem(item.id, 'makingChargePerGram', e.target.value)}
                                            placeholder="MC"
                                        />
                                    </div>
                                </div>

                                {/* Row 3: Totals (Computed) */}
                                <div style={{ display: 'flex', gap: 8, background: '#f8fafc', padding: 8, borderRadius: 6 }}>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ fontSize: 10, color: '#6b7280' }}>Mat. Value</div>
                                        <div style={{ fontSize: 12, fontWeight: 500 }}>
                                            {formatCurrency((Number(item.netWeight) || 0) * (Number(item.ratePerGram) || 0))}
                                        </div>
                                    </div>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ fontSize: 10, color: '#6b7280' }}>Making Chg</div>
                                        <div style={{ fontSize: 12, fontWeight: 500 }}>
                                            {formatCurrency((Number(item.netWeight) || 0) * (Number(item.makingChargePerGram) || 0))}
                                        </div>
                                    </div>
                                    <div style={{ flex: 1, textAlign: 'right' }}>
                                        <div style={{ fontSize: 10, color: '#6b7280' }}>Total</div>
                                        <div style={{ fontSize: 14, fontWeight: 600, color: '#2563eb' }}>
                                            {formatCurrency(
                                                ((Number(item.netWeight) || 0) * (Number(item.ratePerGram) || 0)) +
                                                ((Number(item.netWeight) || 0) * (Number(item.makingChargePerGram) || 0))
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                ))}

                <button
                    className={styles.addButton}
                    onClick={() => {
                        useInvoiceStore.getState().addItem();
                    }}
                    style={{ background: 'white', border: '1px solid #e5e7eb', color: '#4b5563' }}
                >
                    <FiPlus /> {type === 'LENDING' ? 'Add Item' : 'Add Manual Item'}
                </button>
            </div>

            {/* Weight Summary for Lending Bill */}
            {type === 'LENDING' && (
                <>
                    <div className={styles.sectionTitle}>
                        Weight Summary <FiBox size={14} />
                    </div>
                    <div className={styles.card}>
                        <div style={{ display: 'flex', gap: 16 }}>
                            <div style={{ flex: 1 }}>
                                <label className={styles.label}>Gross Weight (g)</label>
                                <input
                                    type="number"
                                    className={styles.input}
                                    value={useInvoiceStore.getState().weightSummary?.grossWeight || ''}
                                    onChange={(e) => useInvoiceStore.getState().setWeightSummary('grossWeight', e.target.value)}
                                    placeholder="0.000"
                                />
                            </div>
                            <div style={{ flex: 1 }}>
                                <label className={styles.label}>Net Weight (g)</label>
                                <input
                                    type="number"
                                    className={styles.input}
                                    value={useInvoiceStore.getState().weightSummary?.netWeight || ''}
                                    onChange={(e) => useInvoiceStore.getState().setWeightSummary('netWeight', e.target.value)}
                                    placeholder="0.000"
                                />
                            </div>
                        </div>
                    </div>
                </>
            )}

            {/* Optional Fields */}
            <div className={styles.sectionTitle}>Optional</div>
            <div className={styles.card} style={{ padding: 0 }}>
                {[
                    { icon: '📄', label: 'Add Reference', field: 'reference', type: 'text' },
                    { icon: '📋', label: 'Add Terms', field: 'terms', type: 'text' },
                ].map((opt, idx) => (
                    <div key={idx} className={styles.optionalRow}>
                        <div className={styles.optionalLabel}>
                            <span style={{ width: 24, textAlign: 'center' }}>{opt.icon}</span>
                            {opt.label}
                        </div>
                        <input
                            type={opt.type}
                            className={styles.optionalInput}
                            placeholder={opt.label}
                            value={details[opt.field]}
                            onChange={(e) => updateDetails(opt.field, e.target.value)}
                        />
                    </div>
                ))}
            </div>


            {/* Payments - Hide for Lending Bill */}
            {type !== 'LENDING' && (
                <>
                    <div className={styles.sectionTitle}>Payments</div>
                    <div className={styles.card}>
                        <div className={styles.checkboxRow}>
                            <input
                                type="checkbox"
                                checked={payment.isFullyPaid}
                                onChange={(e) => {
                                    updatePayment('isFullyPaid', e.target.checked);
                                    if (e.target.checked) updatePayment('amountReceived', totals.total);
                                }}
                                style={{ width: 18, height: 18 }}
                            />
                            <span style={{ fontWeight: 500 }}>Mark as fully paid</span>
                        </div>

                        <div className={styles.paymentGrid}>
                            <div>
                                <div className={styles.label}>Amount Received</div>
                                <div className={styles.inputWrapper}>
                                    <span style={{ color: '#6b7280' }}>₹</span>
                                    <input
                                        type="number"
                                        className={styles.paymentInput}
                                        value={payment.amountReceived}
                                        onChange={(e) => updatePayment('amountReceived', e.target.value)}
                                    />
                                </div>
                            </div>
                            <div>
                                <div className={styles.label}>Payment Mode</div>
                                <select
                                    className={styles.select}
                                    value={payment.mode}
                                    onChange={(e) => updatePayment('mode', e.target.value)}
                                >
                                    <option>Cash</option>
                                    <option>UPI</option>
                                    <option>Bank Transfer</option>
                                    <option>Cheque</option>
                                </select>
                            </div>
                        </div>

                        <div style={{ marginTop: 12 }}>
                            <div className={styles.label}>Notes</div>
                            <input
                                className={styles.input}
                                placeholder="Advance Received, UTR Number etc.,"
                                value={payment.notes}
                                onChange={(e) => updatePayment('notes', e.target.value)}
                            />
                        </div>
                    </div>
                </>
            )}

            {/* Footer */}
            <div className={styles.footer}>
                <div className={styles.footerLeft}>
                    {type === 'LENDING' ? (
                        <div style={{ fontSize: 12, color: '#6b7280' }}>
                            Total Items: {items.length} | Total Qty: {items.reduce((acc, i) => acc + (i.quantity || 0), 0)}
                        </div>
                    ) : (
                        <>
                            <div className={styles.footerRow}>
                                <span>Sub Total</span>
                                <span>{formatCurrency(totals.subtotal)}</span>
                            </div>

                            {/* Tax Breakdown (Only for Regular Invoices) */}
                            {type !== 'PROFORMA' && (
                                <>
                                    <div className={styles.footerRow} style={{ color: '#6b7280', fontSize: 12 }}>
                                        <span>CGST (1.5%)</span>
                                        <span>{formatCurrency(totals.cgst)}</span>
                                    </div>
                                    <div className={styles.footerRow} style={{ color: '#6b7280', fontSize: 12 }}>
                                        <span>SGST (1.5%)</span>
                                        <span>{formatCurrency(totals.sgst)}</span>
                                    </div>
                                </>
                            )}

                            <div className={styles.footerRow}>
                                <span>Round Off</span>
                                <div
                                    className={`${styles.toggleSwitch} ${roundOff ? styles.active : ''}`}
                                    onClick={toggleRoundOff}
                                    style={{ width: 36, height: 20 }}
                                >
                                    <div className={styles.toggleKnob} style={{ width: 16, height: 16 }} />
                                </div>
                                <span>{totals.roundOffAmount.toFixed(2)}</span>
                            </div>
                            <div className={styles.totalAmount}>
                                <span>Total Amount</span>
                                <span>{formatCurrency(totals.total)}</span>
                            </div>
                        </>
                    )}
                </div>
                <button className={styles.createButton} onClick={handleSave}>
                    {id ? 'Update' : 'Create'} <FiArrowLeft style={{ transform: 'rotate(180deg)' }} />
                </button>
            </div>
        </div>
    );
}
</file>

<file path="package.json">
{
  "name": "swipe-app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "mobile:build": "next build && npx cap sync",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "cypress:open": "cypress open",
    "cypress:run": "cypress run"
  },
  "dependencies": {
    "@babel/parser": "^7.28.5",
    "@babel/traverse": "^7.28.5",
    "@capacitor/android": "^7.4.4",
    "@capacitor/app": "^7.1.0",
    "@capacitor/assets": "^3.0.5",
    "@capacitor/cli": "^7.4.4",
    "@capacitor/core": "^7.4.4",
    "@capacitor/filesystem": "^7.1.5",
    "@capacitor/preferences": "^7.0.3",
    "@capacitor/share": "^7.0.2",
    "clsx": "^2.1.1",
    "framer-motion": "^12.23.24",
    "html2canvas": "^1.4.1",
    "html5-qrcode": "^2.3.8",
    "jspdf": "^3.0.4",
    "minisearch": "^7.2.0",
    "next": "^16.0.7",
    "papaparse": "^5.5.3",
    "react": "^19.2.1",
    "react-dom": "^19.2.1",
    "react-icons": "^5.5.0",
    "uuid": "^13.0.0",
    "zustand": "^5.0.8"
  },
  "packageManager": "pnpm@10.10.0+sha512.d615db246fe70f25dcfea6d8d73dee782ce23e2245e3c4f6f888249fb568149318637dca73c2c5c8ef2a4ca0d5657fb9567188bfab47f566d1ee6ce987815c39",
  "devDependencies": {
    "@testing-library/dom": "^10.4.1",
    "@testing-library/jest-dom": "^6.9.1",
    "@testing-library/react": "^16.3.0",
    "@testing-library/user-event": "^14.6.1",
    "@types/uuid": "^11.0.0",
    "cypress": "^14.5.4",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "msw": "^2.12.4"
  }
}
</file>

</files>
